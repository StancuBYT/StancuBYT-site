<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | PromoÈ›ii & Concursuri</title>
  <style>
    :root{
      --blue-tech:#0066ff;
      --green-growth:#00ff88;
      --purple-innov:#8a2be2;
      --neon-cyan:#00ffff;
      --dark-bg:#0a0a1f;
      --darker-bg:#050510;
      --orange-alert:#ff9500;
      --danger:#ff4d4d;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family: Arial, sans-serif;}
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,102,255,0.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(0,255,136,0.14), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(138,43,226,0.12), transparent 60%),
        linear-gradient(180deg, var(--darker-bg), var(--dark-bg));
      color:#fff;
      padding: 26px 14px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:16px 16px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      position:sticky;top:12px;backdrop-filter: blur(8px);
      z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:40px;height:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
    .brand .t1{font-weight:900;letter-spacing:0.5px;}
    .brand .t2{font-size:12px;opacity:0.8;margin-top:2px;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,0.25);
      font-size:12px;opacity:0.92;
    }
    .chip b{font-weight:800;}
    .btn{
      cursor:pointer;border:none;
      padding:11px 14px;border-radius:12px;
      background:linear-gradient(45deg, var(--blue-tech), var(--green-growth));
      color:#001018;font-weight:900;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:hover{transform: translateY(-1px);filter:brightness(1.05);}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      border:1px solid var(--border);
      color:#fff;font-weight:800;
    }
    .btn.danger{
      background:rgba(255,77,77,0.14);
      border:1px solid rgba(255,77,77,0.35);
      color:#fff;
    }
    .hero{
      text-align:center;
      padding: 28px 10px 10px;
    }
    h1{
      font-size: 2.3rem;
      background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan), var(--purple-innov));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle{opacity:0.85;line-height:1.5;max-width:860px;margin:0 auto;}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      margin-top: 18px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      padding:16px;
      overflow:hidden;
      position:relative;
    }
    .card.has-bg::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.80));
      z-index:0;
    }
    .card > *{position:relative;z-index:1;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;font-weight:900;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      margin-bottom:10px;
    }
    .badge.live{border-color:rgba(0,255,136,0.35);background:rgba(0,255,136,0.10);}
    .badge.dead{border-color:rgba(255,77,77,0.35);background:rgba(255,77,77,0.10);}
    .meta{display:flex;flex-wrap:wrap;gap:10px;opacity:0.9;margin-top:10px;font-size:13px;}
    .meta span{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid var(--border);}
    .kicker{font-weight:900;color:var(--neon-cyan);margin-bottom:8px;}
    .title{font-weight:950;font-size:1.2rem;margin-bottom:6px;}
    .text{opacity:0.9;line-height:1.5;white-space:pre-wrap;}
    .divider{height:1px;background:rgba(255,255,255,0.12);margin:12px 0;}
    .form{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,0.05);
      padding:16px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .row.one{grid-template-columns:1fr;}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#fff;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;}
    label{font-size:12px;opacity:0.85;}
    small.help{display:block;margin-top:8px;opacity:0.75;line-height:1.35;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .admin-login{
      margin-top: 20px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.28);
    }
    .admin-login h2{font-size:1.2rem;margin-bottom:8px;}
    .admin-desc{opacity:0.85;line-height:1.4;margin-bottom:10px;}
    .admin-login-box{display:flex;gap:10px;flex-wrap:wrap;}
    .admin-login-box input{flex:1;min-width:230px;}
    .admin-status-row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;}
    .admin-badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:12px;}
    .admin-badge-on{background:rgba(0,255,156,0.12);border-color:rgba(0,255,156,0.35);}
    .admin-badge-off{background:rgba(255,77,77,0.10);border-color:rgba(255,77,77,0.35);}
    .admin-user-label{opacity:0.85;font-size:12px;}
    .admin-msg{margin-top:10px;font-size:13px;}
    .admin-only{display:none;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      font-size:12px;opacity:0.9;
    }
    .img-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .img-strip img{height:44px;width:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border);opacity:0.95;}
    .rulebox{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,0.22);opacity:0.92;}
  
  :root {
    --promo-card-h: 560px;
    --promo-media-h: 200px;
  }
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
    gap: 14px;
  }
  .promo-card {
    height: var(--cardH, var(--promo-card-h));
    display:flex;
    flex-direction:column;
    overflow:hidden;
    position:relative;
  }
  .promo-media {
    height: var(--mediaH, var(--promo-media-h));
    background: rgba(255,255,255,0.05);
    background-size: cover;
    background-position: center;
    position:relative;
    flex: 0 0 auto;
  }
  .promo-overlay {
    position:absolute;
    left: calc(var(--overlayX, 6) * 1%);
    top:  calc(var(--overlayY, 8) * 1%);
    transform: translate(0,0);
    max-width: calc(100% - 12%);
    padding: 8px 10px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.35);
    line-height: 1.15;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    white-space: pre-wrap;
    overflow-wrap:anywhere;
  }
  .promo-overlay[data-align="center"] { text-align:center; }
  .promo-overlay[data-align="right"] { text-align:right; }
  .promo-body {
    padding: 12px 12px 10px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    flex: 1 1 auto;
    min-height: 0;
  }
  .promo-desc {
    opacity: 0.92;
    font-size: 0.98rem;
    overflow:auto;
    padding-right: 4px;
  }
  .promo-meta {
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .promo-footer {
    padding: 10px 12px 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
    display:flex;
    flex-direction:column;
    gap: 10px;
    flex: 0 0 auto;
    background: rgba(0,0,0,0.12);
  }
  .join-row {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .join-row.one { grid-template-columns: 1fr; }
  .join-row input, .join-row button {
    width:100%;
  }
  .leaderboard-mini {
    height: 200px;
    overflow:auto;
    border-radius: 14px;
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 8px;
  }
  .leaderboard-mini table {
    width:100%;
    border-collapse: collapse;
    font-size: 0.92rem;
  }
  .leaderboard-mini th, .leaderboard-mini td {
    padding: 6px 6px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    text-align:left;
    vertical-align: top;
  }
  .leaderboard-mini tr:last-child td { border-bottom:none; }

  .admin-actions {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .admin-actions .btn {
    padding: 10px 12px;
    border-radius: 14px;
  }

  @media (max-width: 520px) {
    :root {
      --promo-card-h: 620px;
      --promo-media-h: 190px;
    }
    .join-row { grid-template-columns: 1fr; }
    .promo-overlay {
      left: calc(var(--overlayX, 6) * 1%);
      top: calc(var(--overlayY, 6) * 1%);
      max-width: calc(100% - 10%);
    }
  }
  
.promo-media { position: relative; }
.promo-media .admin-actions{
  position:absolute;
  top:10px; right:10px;
  z-index:4;
  display:flex;
  gap:8px;
}
.promo-media .admin-actions .btn{
  padding:10px 12px;
  font-size:0.9rem;
  border-radius:999px;
}

/* Stiluri pentru cele douÄƒ carduri separate */
.promo-right-column {
  flex: 1 1 0;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.participants-card {
  flex: 1;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
  padding: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 340px;
}

.winners-card {
  flex: 1;
  border: 2px solid transparent;
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5));
  padding: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 340px;
  border-image: linear-gradient(135deg,
    rgba(0,255,255,0.95),
    rgba(138,43,226,0.95),
    rgba(0,255,136,0.95),
    rgba(0,102,255,0.95)
  ) 1;
  box-shadow:
    0 0 18px rgba(0,255,255,0.10),
    0 0 26px rgba(138,43,226,0.08);
}

/* Border animat pentru cardul cÃ¢È™tigÄƒtori */
.winners-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(0,255,255,0.8) 20%,
    rgba(138,43,226,0.8) 40%,
    rgba(0,255,136,0.8) 60%,
    rgba(0,102,255,0.8) 80%,
    transparent 100%
  );
  animation: shine 3s infinite linear;
}

@keyframes shine {
  0% { background-position: -200px 0; }
  100% { background-position: 200px 0; }
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.card-header h3 {
  font-weight: 900;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.participants-card .card-header h3 {
  color: var(--neon-cyan);
}

.winners-card .card-header h3 {
  background: linear-gradient(45deg, #ffd700, #c0c0c0, #cd7f32);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.participants-count, .winners-count {
  font-size: 0.9rem;
  opacity: 0.8;
}

.participants-list {
  flex: 1;
  overflow-y: auto;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 8px;
}

.winners-list {
  flex: 1;
  overflow-y: auto;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 8px;
}

.winner-line {
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.15);
  background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: transform 0.2s ease;
}

.winner-line:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.winner-line:last-child {
  margin-bottom: 0;
}

.winner-rank {
  font-weight: 900;
  font-size: 0.9rem;
  min-width: 30px;
  text-align: center;
}

.winner-rank.gold { color: #ffd700; }
.winner-rank.silver { color: #c0c0c0; }
.winner-rank.bronze { color: #cd7f32; }

.winner-info-compact {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
}

.winner-name-compact {
  font-weight: 900;
  font-size: 0.95rem;
  color: var(--neon-cyan);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.winner-email-compact {
  opacity: 0.8;
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.winner-prize-compact {
  font-weight: 800;
  color: #ffd700;
  font-size: 0.9rem;
  text-align: right;
  min-width: 150px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.winner-stats-compact {
  display: flex;
  gap: 6px;
  align-items: center;
  font-size: 0.85rem;
  opacity: 0.9;
}

.winner-stats-compact b {
  color: #00ff88;
}

.no-winners {
  text-align: center;
  padding: 40px 20px;
  opacity: 0.7;
  font-size: 0.95rem;
}

.no-winners i {
  font-size: 1.2rem;
  margin-bottom: 10px;
  display: block;
}

.promo-block{
  margin: 14px 0;
  border-radius: 24px;
  padding: 12px;
  background: transparent;
  border: 2px solid transparent;
  border-image: linear-gradient(135deg,
    rgba(0,255,255,0.95),
    rgba(138,43,226,0.95),
    rgba(0,255,136,0.95),
    rgba(0,102,255,0.95)
  ) 1;
  box-shadow:
    0 0 18px rgba(0,255,255,0.10),
    0 0 26px rgba(138,43,226,0.08);
  display:flex;
  gap: 16px;
  align-items: stretch;
}
.promo-block > .promo-main-card{
  flex: 1 1 0;
  min-width: 0;
}

@media (max-width: 980px){
  .promo-block{ 
    flex-direction: column; 
    gap: 16px;
  }
  
  .promo-right-column {
    width: 100%;
  }
  
  .participants-card,
  .winners-card {
    height: 340px;
  }
}

#promoList{ display:flex !important; flex-direction:column !important; gap: 16px !important; }
.promo-block{ width:100%; }

.promo-main-card {
  height: auto !important;
  min-height: 820px;
  max-height: 820px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.promo-content{
  overflow: visible !important;
  gap: 10px;
}
.promo-desc{
  max-height: 120px;
  overflow:auto;
  padding-right: 6px;
}
.divider{ margin: 10px 0; }

.promo-join .form-row{
  align-items: stretch;
}
.promo-join .form-row input{
  width: 100%;
}
.promo-join .form-row button{
  width: 100%;
  min-width: 0 !important;
}
@media (min-width: 720px){
  .promo-join .form-row{
    flex-wrap: nowrap;
  }
  .promo-join .form-row button{
    width: auto;
    min-width: 160px !important;
  }
}

.prize-item{ display:block; width:100%; white-space:pre-wrap; padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.18); }
.prize-item b{ font-weight:900; }
.prize-gold{ border-color: rgba(255,215,0,0.55); box-shadow: 0 0 18px rgba(255,215,0,0.10); }
.prize-silver{ border-color: rgba(192,192,192,0.55); box-shadow: 0 0 18px rgba(192,192,192,0.08); }
.prize-bronze{ border-color: rgba(205,127,50,0.55); box-shadow: 0 0 18px rgba(205,127,50,0.08); }
.prize-tierA{ border-color: rgba(0,255,255,0.45); box-shadow: 0 0 18px rgba(0,255,255,0.08); }
.prize-tierB{ border-color: rgba(0,255,136,0.40); box-shadow: 0 0 18px rgba(0,255,136,0.06); }
.prize-tierC{ border-color: rgba(138,43,226,0.40); box-shadow: 0 0 18px rgba(138,43,226,0.06); }
.prize-subtitle{ font-weight:900; margin: 10px 0 8px; opacity:0.95; }

.promo-content{
  overflow: visible !important;
}

/* AjustÄƒri pentru tabelele din cardul participanÈ›i */
.participants-list table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.participants-list th, .participants-list td {
  padding: 6px 8px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  text-align: left;
  vertical-align: middle;
}

.participants-list tr:last-child td {
  border-bottom: none;
}

.participants-list tr:hover {
  background: rgba(255,255,255,0.05);
}

.rank-cell {
  font-weight: 900;
  width: 40px;
}

.name-cell {
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.email-cell {
  max-width: 100px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  opacity: 0.8;
}

.code-cell {
  font-family: monospace;
  font-size: 0.8rem;
  opacity: 0.9;
}

.ref-cell {
  text-align: center;
  width: 60px;
}

/* Stiluri pentru butoanele admin Ã®n cardul cÃ¢È™tigÄƒtori */
.winners-admin-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  justify-content: center;
}

.winners-admin-actions .btn {
  padding: 8px 12px;
  font-size: 0.85rem;
  border-radius: 12px;
}

/* Banner fosforescent intermitent */
.status-banner {
  margin-top: 20px;
  padding: 25px 20px;
  border-radius: 20px;
  text-align: center;
  font-weight: 900;
  font-size: 2.5rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(0,255,255,0.3);
}

.status-banner.active {
  background: linear-gradient(135deg, 
    rgba(0,255,255,0.2),
    rgba(0,255,136,0.2),
    rgba(138,43,226,0.2)
  );
  color: #00ffff;
  border: 3px solid;
  border-image: linear-gradient(45deg, #00ffff, #00ff88, #8a2be2) 1;
  animation: pulse 2s infinite;
}

.status-banner.expired {
  background: linear-gradient(135deg, 
    rgba(255,77,77,0.2),
    rgba(255,215,0,0.2),
    rgba(138,43,226,0.2)
  );
  color: #ff4d4d;
  border: 3px solid;
  border-image: linear-gradient(45deg, #ff4d4d, #ff9500, #8a2be2) 1;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 20px rgba(0,255,255,0.3),
                0 0 40px rgba(0,255,255,0.2),
                0 0 60px rgba(0,255,255,0.1);
  }
  50% {
    box-shadow: 0 0 40px rgba(0,255,255,0.5),
                0 0 80px rgba(0,255,255,0.3),
                0 0 120px rgba(0,255,255,0.1);
  }
  100% {
    box-shadow: 0 0 20px rgba(0,255,255,0.3),
                0 0 40px rgba(0,255,255,0.2),
                0 0 60px rgba(0,255,255,0.1);
  }
}

/* Glow effect pentru text */
.glow-text {
  text-shadow: 
    0 0 10px currentColor,
    0 0 20px currentColor,
    0 0 30px currentColor;
}

/* Responsive adjustments pentru banner */
@media (max-width: 768px) {
  .status-banner {
    font-size: 1.8rem;
    padding: 20px 15px;
  }
}

@media (max-width: 480px) {
  .status-banner {
    font-size: 1.5rem;
    padding: 18px 12px;
    letter-spacing: 2px;
  }
}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <!-- Firebase Functions (callable) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

    const cfg = window.firebaseConfig;
    if (!cfg || !cfg.projectId) {
      console.error("Firebase config missing projectId; cannot init Functions.");
    } else {
      let app;
      if (!getApps().length) {
        app = initializeApp(cfg);
      } else {
        app = getApps()[0];
      }

      const functions = getFunctions(app, "europe-west1");

      window.sendPromoSignupEmail = httpsCallable(functions, "sendPromoSignupEmail");
      window.sendPromoWinnerEmail = httpsCallable(functions, "sendPromoWinnerEmail");

      console.log("Functions callable ready:", { projectId: cfg.projectId, region: "europe-west1" });
    }
  </script>
  
  <script>
  function parseEndsMs(ends){
    try{
      if(!ends) return NaN;
      if(typeof ends === "object"){
        if(typeof ends.toDate === "function") return ends.toDate().getTime();
        if(typeof ends.seconds === "number") return ends.seconds*1000;
      }
      if(typeof ends === "number") return ends;
      const s = String(ends).trim();
      const d1 = new Date(s);
      if(!isNaN(d1.getTime())) return d1.getTime();
      const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})(?:,?\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        const dd = parseInt(m[1],10);
        const mm = parseInt(m[2],10);
        const yy = parseInt(m[3],10);
        const hh = m[4] ? parseInt(m[4],10) : 0;
        const mi = m[5] ? parseInt(m[5],10) : 0;
        const ss = m[6] ? parseInt(m[6],10) : 0;
        return new Date(yy, mm-1, dd, hh, mi, ss).getTime();
      }
      return NaN;
    }catch(e){ return NaN; }
  }
  function isExpiredPromo(p){
    const ms = parseEndsMs(p && p.ends);
    return Number.isFinite(ms) ? (Date.now() >= ms) : false;
  }
  function formatEndsLocal(ends){
    const ms = parseEndsMs(ends);
    if(!Number.isFinite(ms)) return "â€”";
    return new Date(ms).toLocaleString("ro-RO");
  }

  window.firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    storageBucket: "stancubyt-fc2b9.firebasestorage.app",
    messagingSenderId: "263244200492",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89",
    measurementId: "G-272S9HSY3K"
  };
  try {
    if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
      firebase.initializeApp(window.firebaseConfig);
    }
  } catch (e) {
    console.warn("Firebase init warning:", e);
  }
  </script>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">ğŸ PromoÈ›ii & Concursuri â€” StancuBYT</div>
      <div class="subtitle">Carduri separate pentru participanÈ›i È™i cÃ¢È™tigÄƒtori, fiecare cu scroll individual.</div>

      <div class="actions admin-only" style="justify-content:center; margin-top:14px; display:none;">
        <button class="btn" type="button" onclick="openPromoForm('promo')">â• AdaugÄƒ PromoÈ›ie</button>
        <button class="btn secondary" type="button" onclick="openPromoForm('giveaway')">ğŸ† AdaugÄƒ Concurs / Giveaway</button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <span class="pill">ğŸ“± Mobile-first</span>
        <span class="pill">ğŸ–¼ï¸ Auto-resize imagini</span>
        <span class="pill">ğŸ‘¥ ParticipanÈ›i & CÃ¢È™tigÄƒtori</span>
        <span class="pill">ğŸ“§ Email automat</span>
      </div>
    </div>

    <div class="card">
      <div class="kicker">ğŸ“Œ PromoÈ›ii / Giveaway-uri</div>
      <div id="promoList" class="grid"></div>

      <div id="promoForm" class="form admin-only" style="display:none;">
        <div class="kicker">âœ¨ CreeazÄƒ promoÈ›ie / concurs</div>

        <div class="row">
          <div>
            <label>Tip</label>
            <select id="promoKind">
              <option value="promo">ğŸ“£ PromoÈ›ie</option>
              <option value="giveaway">ğŸ Concurs / Giveaway</option>
            </select>
          </div>
          <div>
            <label>Data & ora expirÄƒrii</label>
            <input id="promoEnds" type="datetime-local">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Titlu</label>
            <input id="promoTitle" type="text" maxlength="120" placeholder="Ex: Giveaway SBYT â€” 7 zile + premii pe niveluri">
          </div>
          <div>
            <label>Puncte / acÈ›iune (gamification)</label>
            <input id="promoPoints" type="number" min="1" step="1" value="10" placeholder="Ex: 10">
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Hook (1â€“2 fraze, mesaj scurt de impact)</label>
            <textarea id="promoHook" rows="2" placeholder="Ex: IntrÄƒ Ã®n TOP 5 È™i cÃ¢È™tigÄƒ bonusuri! Fiecare share = +10 puncte."></textarea>
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Descriere (beneficiu + cum funcÈ›ioneazÄƒ)</label>
            <textarea id="promoDesc" placeholder="Ex: ParticipÄƒ, strÃ¢nge puncte È™i intrÄƒ Ã®n clasament. La final, primele locuri primesc premii, iar participanÈ›ii activi primesc bonusuri."></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kicker">ğŸ¨ Vizual (banner + imagini de fundal)</div>
        <div class="row">
          <div>
            <label>Banner (recomandat)</label>
            <input id="promoBanner" type="file" accept="image/*">
          </div>
          <div>
            <label>Imagini fundal (max 3 recomandat)</label>
            <input id="promoBg" type="file" accept="image/*" multiple>
          </div>
        </div>
        <small class="help">SalveazÄƒ Ã®n Firestore: <b>stats/visits</b> (cÃ¢mpuri <b>promos</b> + <b>participants</b>). Upload imagini Ã®n Storage: <b>/news/**</b>.</small>

        <div class="divider"></div>

        <div class="kicker">ğŸ† Premii (distribuÈ›ie atractivÄƒ)</div>
        <div class="row">
          <div><label>Premiul I</label><input id="prize1" type="text" maxlength="180" placeholder="Ex: 10.000 SBYT + rol VIP"></div>
          <div><label>Premiul II</label><input id="prize2" type="text" maxlength="180" placeholder="Ex: 5.000 SBYT"></div>
        </div>
        <div class="row">
          <div><label>Premiul III</label><input id="prize3" type="text" maxlength="180" placeholder="Ex: 2.500 SBYT"></div>
          <div><label>Primele 5 locuri (dupÄƒ podium)</label><input id="prizeTop5" type="text" maxlength="180" placeholder="Ex: 500 SBYT fiecare"></div>
        </div>
        <div class="row">
          <div><label>UrmÄƒtoarele 10 locuri</label><input id="prizeNext10" type="text" maxlength="180" placeholder="Ex: 200 SBYT fiecare"></div>
          <div><label>Bonus participare / surprizÄƒ</label><input id="prizeBonus" type="text" maxlength="180" placeholder="Ex: 50 SBYT pentru cei cu min. 3 acÈ›iuni"></div>
        </div>

        <div class="divider"></div>

        <div class="kicker">ğŸ“œ Regulament & condiÈ›ii</div>
        <div class="row one">
          <div>
            <label>Regulament (clar, pe paÈ™i)</label>
            
<div class="form-row" style="flex-direction:column; gap:10px;">
  <div style="font-weight:900;">ğŸ“œ Reguli (5 puncte + text)</div>
  <input id="rule1" type="text" placeholder="Regula 1 (ex: UrmÄƒreÈ™te contul / Subscribe)" maxlength="120">
  <input id="rule2" type="text" placeholder="Regula 2" maxlength="120">
  <input id="rule3" type="text" placeholder="Regula 3" maxlength="120">
  <input id="rule4" type="text" placeholder="Regula 4" maxlength="120">
  <input id="rule5" type="text" placeholder="Regula 5" maxlength="120">
  <textarea id="rulesText" placeholder="Text reguli (opÈ›ional, 5-6 rÃ¢nduri)" rows="6" style="width:100%;"></textarea>
</div>

          </div>
        </div>

        <div class="actions">
          <button id="promoSaveBtn" class="btn" type="button" onclick="savePromo()">ğŸ’¾ SalveazÄƒ</button>
          <button class="btn secondary" type="button" onclick="cancelPromo()">âŒ AnuleazÄƒ</button>
        </div>

        <small class="help">
          SalveazÄƒ Ã®n Firestore: <b>promos</b> (È™i subcolecÈ›ie <b>participants</b>). Scrierea necesitÄƒ autentificare admin.
        </small>
      </div>
    </div>

    <div class="admin-login" id="admin-login">
      <h2>ğŸ” Administrator Login</h2>
      <p class="admin-desc">
        Autentificare (Firebase Auth) necesarÄƒ pentru adÄƒugare/È™tergere concursuri È™i promoÈ›ii.
        Pentru ca salvarea Ã®n Firestore sÄƒ funcÈ›ioneze, contul logat trebuie sÄƒ fie permis de Firestore Rules (de obicei <b>stancubyt@gmail.com</b>).
      </p>

      <div class="admin-login-box">
        <input type="email" id="adminEmail" placeholder="Email administrator" autocomplete="username">
        <input type="password" id="adminPass" placeholder="Parola administrator" autocomplete="current-password">
        <button class="btn" type="button" onclick="adminSignIn()">Autentificare</button>
        <button class="btn secondary" type="button" onclick="adminSignOut()" id="adminLogoutBtn" style="display:none;">Delogare</button>
      </div>

      <div class="admin-status-row">
        <span id="adminStatusBadge" class="admin-badge admin-badge-off">Neautentificat</span>
        <span id="adminUserLabel" class="admin-user-label"></span>
      </div>

      <p id="adminLoginMsg" class="admin-msg"></p>
    </div>

    <div class="footer">
      <div class="footer-inner">
        <span style="opacity:.8;">Â© StancuBYT</span>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;','\\':'&#92;'}[ch]||ch));
  const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

  const ADMIN_EMAIL = "stancubyt@gmail.com";
  const auth = ()=> (window.firebase && firebase.auth) ? firebase.auth() : null;
  const fs = ()=> (window.firebase && firebase.firestore) ? firebase.firestore() : null;
  const st = ()=> (window.firebase && firebase.storage) ? firebase.storage() : null;

  let __isAdmin = false;
  let __user = null;
  let __editingPromoId = null;
  let __statsUnsub = null;
  let __statsCache = { promos: [], participants: {} };
  window.__statsCache = __statsCache;

  function statsRef(){
    const d = fs();
    if(!d) return null;
    return d.collection('stats').doc('visits');
  }

  function normalizeStats(data){
    const promos = Array.isArray(data?.promos) ? data.promos : [];
    const participants = (data?.participants && typeof data.participants === 'object') ? data.participants : {};
    return { promos, participants };
  }

  function setAdminUI(isAdmin, user){
    __isAdmin = !!isAdmin;
    __user = user || null;
    window.__SBYT_ADMIN = __isAdmin;
    window.__SBYT_USER_EMAIL = (__user && __user.email) ? __user.email : "";

    document.querySelectorAll('.admin-only').forEach(el=>{
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });

    const badge = $('adminStatusBadge');
    const label = $('adminUserLabel');
    const logoutBtn = $('adminLogoutBtn');
    if (badge) {
      badge.textContent = __isAdmin ? 'Autentificat' : 'Neautentificat';
      badge.className = __isAdmin ? 'admin-badge admin-badge-on' : 'admin-badge admin-badge-off';
    }
    if (label) label.textContent = __isAdmin && user ? user.email : '';
    if (logoutBtn) logoutBtn.style.display = __isAdmin ? 'inline-flex' : 'none';
  }

  async function computeIsAdmin(user){
    return !!(user && (user.email||'').toLowerCase() === ADMIN_EMAIL.toLowerCase());
  }

  window.adminSignIn = async function adminSignIn(){
    const a = auth();
    const msg = $('adminLoginMsg');
    if(!a) {
      if(msg) msg.textContent = 'Firebase Auth nu este disponibil.';
      return;
    }
    const email = ($('adminEmail')?.value||'').trim();
    const pass  = ($('adminPass')?.value||'').trim();
    if(!email || !pass) {
      if(msg) msg.textContent = 'CompleteazÄƒ email + parolÄƒ.';
      return;
    }
    try {
      await a.signInWithEmailAndPassword(email, pass);
      if(msg) msg.textContent = '';
    } catch(e) {
      console.error('adminSignIn:', e);
      if(msg) msg.textContent = 'Eroare autentificare. VerificÄƒ datele.';
    }
  };

  window.adminSignOut = async function adminSignOut(){
    const a = auth();
    if(!a) return;
    try { await a.signOut(); } catch(e) { console.warn(e); }
  };

  window.openPromoForm = function openPromoForm(kind, promoId){
    const f = $('promoForm');
    if(!f) return;
    __editingPromoId = promoId || null;

    f.style.display = 'block';
    $('promoSaveBtn')?.setAttribute('data-mode', promoId ? 'edit' : 'add');

    if ($('promoKind')) $('promoKind').value = kind || 'promo';

    if(!promoId){
      ['promoEnds','promoTitle','promoPoints','promoHook','promoDesc','prize1','prize2','prize3','promoRules','cardHeight','mediaHeight','overlayText','overlayFontSize','overlayX','overlayY','overlayAlign','overlayColor'].forEach(id=>{ if($(id)) $(id).value=''; });
      if($('promoPoints')) $('promoPoints').value = 10;
      if($('cardHeight')) $('cardHeight').value = 560;
      if($('mediaHeight')) $('mediaHeight').value = 200;
      if($('overlayFontSize')) $('overlayFontSize').value = 22;
      if($('overlayX')) $('overlayX').value = 6;
      if($('overlayY')) $('overlayY').value = 8;
      if($('overlayAlign')) $('overlayAlign').value = 'left';
      if($('overlayColor')) $('overlayColor').value = '#ffffff';
      if($('promoBanner')) $('promoBanner').value = '';
      if($('promoBg')) $('promoBg').value = '';
      return;
    }

    const p = (__statsCache.promos || []).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    if($('promoKind')) $('promoKind').value = p.kind || kind || 'promo';
    if($('promoEnds')) $('promoEnds').value = p.ends || '';
    if($('promoTitle')) $('promoTitle').value = p.title || '';
    if($('promoPoints')) $('promoPoints').value = Number(p.points||10);
    if($('promoHook')) $('promoHook').value = p.hook || '';
    if($('promoDesc')) $('promoDesc').value = p.desc || '';
    if($('prize1')) $('prize1').value = (p.prizes && p.prizes.p1) ? p.prizes.p1 : '';
    if($('prize2')) $('prize2').value = (p.prizes && p.prizes.p2) ? p.prizes.p2 : '';
    if($('prize3')) $('prize3').value = (p.prizes && p.prizes.p3) ? p.prizes.p3 : '';
    if($('prizeTop5')) $('prizeTop5').value = (p.prizes && p.prizes.top5) ? p.prizes.top5 : '';
    if($('prizeNext10')) $('prizeNext10').value = (p.prizes && p.prizes.next10) ? p.prizes.next10 : '';
    if($('prizeBonus')) $('prizeBonus').value = (p.prizes && p.prizes.bonus) ? p.prizes.bonus : '';
    if($('promoRules')) $('promoRules').value = p.rules || '';

    if($('cardHeight')) $('cardHeight').value = p.ui?.cardH ?? 560;
    if($('mediaHeight')) $('mediaHeight').value = p.ui?.mediaH ?? 200;
    if($('overlayText')) $('overlayText').value = p.ui?.overlay?.text ?? '';
    if($('overlayFontSize')) $('overlayFontSize').value = p.ui?.overlay?.size ?? 22;
    if($('overlayX')) $('overlayX').value = p.ui?.overlay?.x ?? 6;
    if($('overlayY')) $('overlayY').value = p.ui?.overlay?.y ?? 8;
    if($('overlayAlign')) $('overlayAlign').value = p.ui?.overlay?.align ?? 'left';
    if($('overlayColor')) $('overlayColor').value = p.ui?.overlay?.color ?? '#ffffff';

    if($('promoBanner')) $('promoBanner').value = '';
    if($('promoBg')) $('promoBg').value = '';
  };

  window.cancelPromo = function cancelPromo(){
    const f = $('promoForm');
    if(f) f.style.display = 'none';
    __editingPromoId = null;
  };

  async function resizeImageFile(file, opts={}){
    const maxW = Number(opts.maxW || 1600);
    const maxH = Number(opts.maxH || 1600);
    const quality = clamp(Number(opts.quality || 0.86), 0.4, 0.92);

    const bmp = await createImageBitmap(file);
    let w = bmp.width, h = bmp.height;
    const ratio = Math.min(maxW / w, maxH / h, 1);
    w = Math.round(w * ratio);
    h = Math.round(h * ratio);

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.drawImage(bmp, 0, 0, w, h);

    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    const name = (file.name || 'image').replace(/\.[^.]+$/, '') + '_resized.jpg';
    return new File([blob], name, { type: 'image/jpeg' });
  }

  async function uploadResizedImage(file, storagePath){
    const storage = st();
    if(!storage) throw new Error('Storage indisponibil');
    const ref = storage.ref().child(storagePath);
    const resized = await resizeImageFile(file, { maxW: 1600, maxH: 1600, quality: 0.86 });
    const snap = await ref.put(resized, { contentType: 'image/jpeg' });
    const url = await snap.ref.getDownloadURL();
    return { url, path: storagePath };
  }

  function makeId(prefix='p'){
    return prefix + '_' + Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(3);
  }

  async function readStatsOnce(){
    const ref = statsRef();
    if(!ref) return { promos: [], participants: {} };
    const doc = await ref.get();
    return normalizeStats(doc.exists ? doc.data() : {});
  }

  async function writeStats(next){
    const ref = statsRef();
    if(!ref) throw new Error('statsRef null');
    await ref.set(next, { merge: true });
  }

  window.savePromo = async function savePromo(){
    if(!__isAdmin) {
      alert('Trebuie sÄƒ fii logat ca admin.');
      return;
    }

    const kind = ($('promoKind')?.value || 'promo').trim();
    const ends = ($('promoEnds')?.value || '').trim();
    const title = ($('promoTitle')?.value || '').trim();
    const points = Number(($('promoPoints')?.value || '10'));
    const hook = ($('promoHook')?.value || '').trim();
    const desc = ($('promoDesc')?.value || '').trim();

    const rulesObj = {
      r1: (document.getElementById('rule1')?.value || '').trim(),
      r2: (document.getElementById('rule2')?.value || '').trim(),
      r3: (document.getElementById('rule3')?.value || '').trim(),
      r4: (document.getElementById('rule4')?.value || '').trim(),
      r5: (document.getElementById('rule5')?.value || '').trim(),
      text: (document.getElementById('rulesText')?.value || '').trim()
    };
    const rulesLegacy = [rulesObj.r1, rulesObj.r2, rulesObj.r3, rulesObj.r4, rulesObj.r5, rulesObj.text].filter(Boolean).join('\n');
    const rules = rulesLegacy;

    if(!title) return alert('CompleteazÄƒ: Titlu');
    if(!desc) return alert('CompleteazÄƒ: Descriere');
    if(!ends) return alert('CompleteazÄƒ: Data & ora expirÄƒrii');

    const ui = {
      cardH: clamp(Number($('cardHeight')?.value || 560), 360, 1200),
      mediaH: clamp(Number($('mediaHeight')?.value || 200), 120, 520),
      overlay: {
        text: ($('overlayText')?.value || '').trim(),
        size: clamp(Number($('overlayFontSize')?.value || 22), 10, 72),
        x: clamp(Number($('overlayX')?.value || 6), 0, 90),
        y: clamp(Number($('overlayY')?.value || 8), 0, 90),
        align: ($('overlayAlign')?.value || 'left'),
        color: ($('overlayColor')?.value || '#ffffff')
      }
    };

    const prizes = {
      p1: ($('prize1')?.value || '').trim(),
      p2: ($('prize2')?.value || '').trim(),
      p3: ($('prize3')?.value || '').trim(),
      top5: ($('prizeTop5')?.value || '').trim(),
      next10: ($('prizeNext10')?.value || '').trim(),
      bonus: ($('prizeBonus')?.value || '').trim()
    };

    const bannerFile = $('promoBanner')?.files?.[0] || null;
    const bgFiles = Array.from($('promoBg')?.files || []).slice(0, 3);

    try {
      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      const participants = (stats.participants && typeof stats.participants === 'object') ? stats.participants : {};

      const now = Date.now();
      const id = __editingPromoId || makeId(kind==='giveaway' ? 'g' : 'p');

      const idx = promos.findIndex(p => String(p.id) === String(id));
      const prev = idx >= 0 ? promos[idx] : null;

      let banner = prev?.banner || null;
      let bgs = Array.isArray(prev?.bgs) ? prev.bgs : [];

      if (bannerFile) {
        const storagePath = `news/promos/${id}/banner_${Date.now()}_${bannerFile.name}`.replace(/\s+/g,'_');
        banner = await uploadResizedImage(bannerFile, storagePath);
      }
      if (bgFiles.length) {
        const uploads = [];
        for (const f of bgFiles) {
          const storagePath = `news/promos/${id}/bg_${Date.now()}_${f.name}`.replace(/\s+/g,'_');
          uploads.push(uploadResizedImage(f, storagePath));
        }
        bgs = await Promise.all(uploads);
      }

      const promoObj = {
        id,
        kind,
        ends,
        title,
        points: Number.isFinite(points) ? points : 10,
        hook,
        desc,
        rulesObj,
        rules,
        prizes,
        ui,
        banner,
        bgs,
        createdAt: prev?.createdAt || now,
        updatedAt: now
      };

      if (idx >= 0) promos[idx] = promoObj;
      else promos.unshift(promoObj);

      if (!participants[String(id)]) participants[String(id)] = participants[String(id)] || [];

      await writeStats({ promos, participants });
      __editingPromoId = null;
      cancelPromo();
      alert('Salvat âœ”ï¸');
    } catch(e) {
      console.error('savePromo:', e);
      alert('Eroare la salvare (verificÄƒ Auth/Storage).');
    }
  };

  window.editPromo = function editPromo(promoId){
    if(!__isAdmin) return;
    const p = (__statsCache.promos||[]).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    openPromoForm(p.kind || 'promo', promoId);
    $('promoForm')?.scrollIntoView({ behavior:'smooth', block:'start' });
  };

  async function tryDeleteStorageFiles(promo){
    try {
      if(!__isAdmin) return;
      const storage = st();
      if(!storage) return;
      const paths = [];
      if(promo?.banner?.path) paths.push(promo.banner.path);
      if(Array.isArray(promo?.bgs)) promo.bgs.forEach(x=>x?.path && paths.push(x.path));
      for (const p of paths) {
        try { await storage.ref().child(p).delete(); } catch(e) { }
      }
    } catch(e){}
  }

  window.deletePromo = async function deletePromo(promoId){
    if(!__isAdmin) return alert('Doar admin poate È™tergi.');
    if(!confirm('Sigur vrei sÄƒ È™tergi aceastÄƒ promoÈ›ie/concurs?')) return;

    try {
      const stats = await readStatsOnce();
      const promos = (stats.promos||[]).slice();
      const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};

      const idx = promos.findIndex(p=>String(p.id)===String(promoId));
      const promo = idx>=0 ? promos[idx] : null;
      if(idx>=0) promos.splice(idx,1);
      delete participants[String(promoId)];

      await writeStats({ promos, participants });
      await tryDeleteStorageFiles(promo);
    } catch(e) {
      console.error('deletePromo:', e);
      alert('Eroare la È™tergere.');
    }
  };

  function maskEmail(em){
    const s = String(em||'');
    const at = s.indexOf('@');
    if(at<=1) return s ? (s[0] + '***') : '';
    const name = s.slice(0, at);
    const dom = s.slice(at);
    return name.slice(0,2) + '***' + dom;
  }
  function maskCode(code){
    const s = String(code||'');
    if(s.length<=2) return s;
    return s.slice(0,2) + 'â€¢'.repeat(Math.min(12, s.length-2));
  }
  function genCode(){
    return Math.random().toString(36).slice(2, 10).toUpperCase();
  }

  async function addParticipant(promoId, payload){
    const stats = await readStatsOnce();
    const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};
    const arr = Array.isArray(participants[String(promoId)]) ? participants[String(promoId)].slice() : [];

    const walletKey = String(payload.wallet||'').toLowerCase();
    if(walletKey && arr.some(x => String(x.wallet||'').toLowerCase() === walletKey)) {
      throw new Error('Acest wallet este deja Ã®nscris.');
    }

    const emailKey = String(payload.email||'').toLowerCase();
    if(emailKey && arr.some(x => String(x.email||'').toLowerCase() === emailKey)) {
      throw new Error('Acest email este deja Ã®nscris.');
    }

    const id = 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
    const code = genCode();
    const participant = {
      id,
      name: payload.name || 'Anonim',
      email: payload.email || '',
      wallet: payload.wallet || '',
      code,
      referral: (payload.referral||'').trim(),
      joinedAt: Date.now()
    };
    arr.push(participant);
    participants[String(promoId)] = arr;

    await writeStats({ participants });
    return participant;
  }

  // FuncÈ›ie pentru calculul scorurilor de referral
  function calculateReferralScores(participants) {
    const scores = {};
    const codeToEmail = {};
    
    // MapÄƒm codurile la email-uri
    participants.forEach(p => {
      if (p.code && p.email) {
        codeToEmail[p.code] = p.email;
      }
    });
    
    // CalculÄƒm scorurile
    participants.forEach(p => {
      if (p.email && p.referral) {
        const referralCode = p.referral.trim().toUpperCase();
        const referrerEmail = codeToEmail[referralCode];
        if (referrerEmail && referrerEmail !== p.email) {
          scores[referrerEmail] = (scores[referrerEmail] || 0) + 1;
        }
      }
    });
    
    return scores;
  }

  // FuncÈ›ie pentru construirea listei de participanÈ›i
  function buildParticipantsList(participants) {
    if(!participants.length) {
      return '<div style="padding:20px;text-align:center;opacity:0.7;">ğŸ‘¥ Nu existÄƒ participanÈ›i Ã®ncÄƒ.</div>';
    }

    const scores = calculateReferralScores(participants);
    
    const rows = participants.map(u=> {
      const referrals = scores[u.email] || 0;
      return {
        name: u.name||'Anonim',
        email: u.email||'',
        wallet: u.wallet||'',
        code: u.code||'',
        referrals,
        joinedAt: Number(u.joinedAt||0)
      };
    }).sort((a,b)=> b.referrals - a.referrals || a.joinedAt - b.joinedAt);

    let html = `<table>
      <tr><th>#</th><th>Nume</th><th>Email</th><th>Cod</th><th>Ref</th></tr>`;
    
    rows.slice(0, 20).forEach((r,i)=> {
      const isTop3 = i < 3;
      const rankClass = isTop3 ? 
        (i===0 ? 'gold' : i===1 ? 'silver' : 'bronze') : '';
      const topStyle = isTop3 ? 'style="font-weight:800; color:' + 
        (i===0 ? '#ffd700' : i===1 ? '#c0c0c0' : '#cd7f32') + ';"' : '';
      html += `<tr ${topStyle}>
        <td class="rank-cell ${rankClass}">${i+1}</td>
        <td class="name-cell" title="${esc(r.name)}">${esc(r.name)}</td>
        <td class="email-cell" title="${esc(r.email)}">${esc(maskEmail(r.email))}</td>
        <td class="code-cell">${esc(maskCode(r.code))}</td>
        <td class="ref-cell">${r.referrals}</td>
      </tr>`;
    });
    html += `</table>`;
    
    return html;
  }

  // FuncÈ›ie pentru construirea listei de cÃ¢È™tigÄƒtori Ã®n linie
  function buildWinnersList(promo, participants) {
    if (!promo.winners || Object.keys(promo.winners).length === 0) {
      if (__isAdmin && isExpiredPromo(promo)) {
        return `
          <div class="no-winners">
            <i>ğŸ¯</i>
            <div>Concurs Ã®ncheiat. SelecteazÄƒ cÃ¢È™tigÄƒtorii.</div>
            <div class="winners-admin-actions admin-only">
              <button class="btn small" onclick="selectWinners('${esc(promo.id)}')">ğŸ¯ SelecteazÄƒ CÃ¢È™tigÄƒtori</button>
            </div>
            <div id="winners_preview_${esc(promo.id)}"></div>
          </div>
        `;
      }
      return '<div class="no-winners"><i>ğŸ†</i><div>ÃncÄƒ nu sunt cÃ¢È™tigÄƒtori. ReveniÈ›i dupÄƒ Ã®ncheierea concursului.</div></div>';
    }

    const scores = calculateReferralScores(participants);
    const winners = promo.winners;
    
    // CombinÄƒm toÈ›i cÃ¢È™tigÄƒtorii Ã®ntr-o singurÄƒ listÄƒ
    const allWinners = [
      ...(winners.firstPlace || []).map(w => ({ ...w, rank: 'ğŸ¥‡', rankClass: 'gold' })),
      ...(winners.secondPlace || []).map(w => ({ ...w, rank: 'ğŸ¥ˆ', rankClass: 'silver' })),
      ...(winners.thirdPlace || []).map(w => ({ ...w, rank: 'ğŸ¥‰', rankClass: 'bronze' })),
      ...(winners.top5 || []).map(w => ({ ...w, rank: 'ğŸ…', rankClass: 'other' })),
      ...(winners.next10 || []).map(w => ({ ...w, rank: 'â­', rankClass: 'other' })),
      ...(winners.bonus || []).map(w => ({ ...w, rank: 'ğŸ', rankClass: 'other' }))
    ];

    let html = '';
    
    allWinners.forEach((winner, index) => {
      const score = scores[winner.email] || 0;
      html += `
        <div class="winner-line">
          <div class="winner-rank ${winner.rankClass}">${winner.rank}</div>
          <div class="winner-info-compact">
            <div class="winner-name-compact">${esc(winner.name)}</div>
            <div class="winner-email-compact">${esc(maskEmail(winner.email))}</div>
            <div class="winner-stats-compact">${score} referral-uri</div>
          </div>
          <div class="winner-prize-compact" title="${esc(winner.prize || 'â€”')}">${esc(winner.prize || 'â€”')}</div>
        </div>
      `;
    });
    
    return html;
  }

  function pickMediaUrl(p){
    return p?.banner?.url || (Array.isArray(p?.bgs) && p.bgs[0]?.url) || '';
  }

  function renderPromos(){
    const list = $('promoList');
    if(!list) return;
    const promos = Array.isArray(__statsCache.promos) ? __statsCache.promos : [];
    list.innerHTML = '';

    if(!promos.length){
      list.innerHTML = `<div style="opacity:.85; padding:20px; text-align:center;">ğŸ“­ Nu existÄƒ promoÈ›ii/concursuri Ã®ncÄƒ.</div>`;
      return;
    }

    promos.forEach(p=> {
      const mediaUrl = pickMediaUrl(p);
      const ui = p.ui || {};
      const cardH = clamp(Number(ui.cardH ?? 560), 360, 1200);
      const mediaH = clamp(Number(ui.mediaH ?? 200), 120, 520);
      const overlay = ui.overlay || {};
      const overlayText = (overlay.text||'').trim();
      const overlaySize = clamp(Number(overlay.size ?? 22), 10, 72);
      const overlayX = clamp(Number(overlay.x ?? 6), 0, 90);
      const overlayY = clamp(Number(overlay.y ?? 8), 0, 90);
      const overlayAlign = (overlay.align || 'left');
      const overlayColor = (overlay.color || '#ffffff');

      const participants = Array.isArray(__statsCache.participants?.[String(p.id)]) ? __statsCache.participants[String(p.id)] : [];
      const expired = isExpiredPromo(p);

      const mainCard = document.createElement('div');
      mainCard.className = 'card promo-main-card';
      mainCard.style.setProperty('--cardH', cardH + 'px');
      mainCard.style.setProperty('--mediaH', mediaH + 'px');
      mainCard.innerHTML = `
        <div class="promo-media" style="${mediaUrl ? `background-image:url('${esc(mediaUrl)}')` : ''}">

          <div class="admin-actions admin-only">
            <button class="btn secondary" type="button" onclick="editPromo('${esc(p.id)}')">âœï¸ EditeazÄƒ</button>
            <button class="btn" type="button" onclick="deletePromo('${esc(p.id)}')">ğŸ—‘ï¸ È˜terge</button>
          </div>

          ${overlayText ? `
            <div class="promo-overlay" data-align="${esc(overlayAlign)}" style="color:${esc(overlayColor)}; font-size:${overlaySize}px; --overlayX:${overlayX}; --overlayY:${overlayY};">
              ${esc(overlayText)}
            </div>` : ''}
        </div>

        <div class="promo-body">
          <div class="promo-meta">
            <span class="pill">${p.kind==='giveaway' ? 'ğŸ Giveaway' : 'ğŸ“£ PromoÈ›ie'}</span>
            <span class="pill">â³ ${ isExpiredPromo(p) ? (p.kind==='giveaway' ? 'Giveaway Ã®ncheiat' : 'PromoÈ›ie Ã®ncheiatÄƒ') : formatEndsLocal(p.ends) }</span>
            <span class="pill">â­ +${Number(p.points||10)} puncte</span>
          </div>

          <div style="font-weight:800; font-size:1.1rem;">${esc(p.title||'')}</div>
          ${p.hook ? `<div style="opacity:.95; font-weight:700;">${esc(p.hook)}</div>` : ''}
          
          <div class="promo-desc">${esc(p.desc||'')}</div>

          <div class="divider"></div>

          <div style="margin-top:14px;">
            <div style="font-weight:900; margin-bottom:10px;">ğŸ† Premii</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="prize-item prize-gold">ğŸ† <b>Premiul I:</b> ${esc(p.prizes?.p1 || 'â€”')}</div>
              <div class="prize-item prize-silver">ğŸ¥ˆ <b>Premiul II:</b> ${esc(p.prizes?.p2 || 'â€”')}</div>
              <div class="prize-item prize-bronze">ğŸ¥‰ <b>Premiul III:</b> ${esc(p.prizes?.p3 || 'â€”')}</div>
              <div class="prize-item prize-tierA">ğŸ–ï¸ <b>Primele 5 locuri:</b> ${esc(p.prizes?.top5 || 'â€”')}</div>
              <div class="prize-item prize-tierB">ğŸ… <b>UrmÄƒtoarele 10 locuri:</b> ${esc(p.prizes?.next10 || 'â€”')}</div>
              <div class="prize-item prize-tierC">ğŸ <b>Bonus participare:</b> ${esc(p.prizes?.bonus || 'â€”')}</div>
            </div>

            <div class="divider"></div>
            <div class="kicker">ğŸ“œ Reguli</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>1.</b> ${esc((p.rulesObj&&p.rulesObj.r1)||'â€”')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>2.</b> ${esc((p.rulesObj&&p.rulesObj.r2)||'â€”')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>3.</b> ${esc((p.rulesObj&&p.rulesObj.r3)||'â€”')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>4.</b> ${esc((p.rulesObj&&p.rulesObj.r4)||'â€”')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>5.</b> ${esc((p.rulesObj&&p.rulesObj.r5)||'â€”')}</div>
              ${(p.rulesObj&&p.rulesObj.text) ? `<div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>Detalii:</b> ${esc(p.rulesObj.text)}</div>` : ''}
            </div>

            <div class="divider"></div>
            <div class="kicker">âœ… Ãnscriere</div>
            <div class="join-row">
              <input id="name_${esc(p.id)}" type="text" placeholder="Nume" maxlength="80">
              <input id="email_${esc(p.id)}" type="email" placeholder="Email" maxlength="120">
            </div>
            <div class="join-row">
              <input id="wallet_${esc(p.id)}" type="text" placeholder="Wallet (0x...)" maxlength="80">
              <input id="ref_${esc(p.id)}" type="text" placeholder="Referral (opÈ›ional)" maxlength="40">
            </div>
            <div class="join-row one">
              <button class="btn" type="button" ${expired ? 'disabled title="Ãnscrieri Ã®nchise"' : '' } onclick="joinPromo('${esc(p.id)}')">âœ… Ãnscrie-te</button>
            </div>
          </div>
        </div>

        <!-- Banner fosforescent -->
        <div class="status-banner ${expired ? 'expired' : 'active'}">
          <div class="glow-text">${expired ? 'FINALIZAT' : 'ÃN CURS'}</div>
        </div>
      `;

      // Cardul pentru ParticipanÈ›i
      const participantsCard = document.createElement('div');
      participantsCard.className = 'participants-card';
      participantsCard.innerHTML = `
        <div class="card-header">
          <h3>ğŸ‘¥ ParticipanÈ›i</h3>
          <span class="participants-count">${participants.length}</span>
        </div>
        <div class="participants-list" id="participants_${esc(p.id)}">
          ${buildParticipantsList(participants)}
        </div>
      `;

      // Cardul pentru CÃ¢È™tigÄƒtori
      const winnersCard = document.createElement('div');
      winnersCard.className = 'winners-card';
      winnersCard.innerHTML = `
        <div class="card-header">
          <h3>ğŸ† CÃ¢È™tigÄƒtori</h3>
          ${p.winners ? `<span class="winners-count">${Object.values(p.winners).flat().length}</span>` : '<span class="winners-count">0</span>'}
        </div>
        <div class="winners-list" id="winners_${esc(p.id)}">
          ${buildWinnersList(p, participants)}
        </div>
      `;

      // Coloana dreapta cu cele douÄƒ carduri
      const rightColumn = document.createElement('div');
      rightColumn.className = 'promo-right-column';
      rightColumn.appendChild(participantsCard);
      rightColumn.appendChild(winnersCard);

      // Container principal
      const block = document.createElement('div');
      block.className = 'promo-block';
      
      const promoMainCard = document.createElement('div');
      promoMainCard.className = 'promo-main-card';
      promoMainCard.appendChild(mainCard);
      
      block.appendChild(promoMainCard);
      block.appendChild(rightColumn);
      
      list.appendChild(block);
    });

    document.querySelectorAll('.admin-only').forEach(el=>{
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });
  }

  window.joinPromo = async function joinPromo(promoId){
    try{
      const C = (window.__statsCache || __statsCache || {promos:[]});
      const promo = (C.promos||[]).find(p=>String(p.id)===String(promoId));
      if(promo && promo.ends){
        const endsMs = new Date(promo.ends).getTime();
        if(Number.isFinite(endsMs) && Date.now() >= endsMs){
          return alert(promo.kind==='giveaway' ? 'Giveaway Ã®ncheiat. Ãnscrierile sunt Ã®nchise.' : 'PromoÈ›ie Ã®ncheiatÄƒ. Ãnscrierile sunt Ã®nchise.');
        }
      }
    }catch(e){}

    const name = ($(`name_${promoId}`)?.value || '').trim();
    const email = ($(`email_${promoId}`)?.value || '').trim();
    const wallet = ($(`wallet_${promoId}`)?.value || '').trim();
    const referral = ($(`ref_${promoId}`)?.value || '').trim();

    if(!name) return alert('CompleteazÄƒ numele.');
    if(!email) return alert('CompleteazÄƒ email.');

    try {
      const u = await addParticipant(promoId, { name, email, wallet, referral });
      $(`name_${promoId}`).value = '';
      $(`email_${promoId}`).value = '';
      $(`wallet_${promoId}`).value = '';
      $(`ref_${promoId}`).value = '';

      alert(`Ãnscriere reuÈ™itÄƒ!\nCodul tÄƒu: ${u.code}`);
      
      // === TRIMITE EMAIL LA ÃNSCRIERE ===
      try {
        if (typeof window.sendPromoSignupEmail === 'function') {
          const promo = (__statsCache.promos || []).find(x => String(x.id) === String(promoId)) || {};
          await window.sendPromoSignupEmail({
            toEmail: email,
            name: name,
            referralCode: u.code,
            promoTitle: promo.title || (promo.kind === 'giveaway' ? 'Giveaway' : 'PromoÈ›ie'),
            promoEndsAt: promo.ends || null,
            promoUrl: window.location.href
          });
          console.log('Email de Ã®nscriere trimis cÄƒtre:', email);
        } else {
          console.warn('sendPromoSignupEmail callable nu este disponibil.');
        }
      } catch (mailErr) {
        console.warn('Eroare la trimiterea email-ului de Ã®nscriere:', mailErr);
      }
      
    } catch(e) {
      console.error('joinPromo:', e);
      alert(e?.message || 'Eroare la Ã®nscriere.');
    }
  };

  function startStatsListener(){
    const ref = statsRef();
    if(!ref) return;

    if(__statsUnsub) { try{__statsUnsub();}catch(e){} __statsUnsub=null; }

    __statsUnsub = ref.onSnapshot(snap=>{
      const data = snap.exists ? snap.data() : {};
      __statsCache = normalizeStats(data);
      renderPromos();
    }, err=>{
      console.warn('stats onSnapshot error:', err);
      readStatsOnce().then(x=>{ __statsCache=x; renderPromos(); }).catch(()=>{});
    });
  }

  // FuncÈ›ii pentru selectarea È™i salvarea cÃ¢È™tigÄƒtorilor
  async function getPromoDataFromFirestore(promoId){
    try {
      const db = fs();
      if(!db) throw new Error("Firestore nu este disponibil");
      
      const statsDoc = await db.collection('stats').doc('visits').get();
      if(!statsDoc.exists) throw new Error("Documentul stats/visits nu existÄƒ");
      
      const data = statsDoc.data();
      const promos = Array.isArray(data?.promos) ? data.promos : [];
      const participants = (data?.participants && typeof data.participants === 'object') ? data.participants : {};
      
      const promo = promos.find(p => String(p.id) === String(promoId));
      if(!promo) throw new Error("PromoÈ›ia nu a fost gÄƒsitÄƒ");
      
      const promoParticipants = Array.isArray(participants[String(promoId)]) ? participants[String(promoId)] : [];
      
      return { promo, participants: promoParticipants };
    } catch(error) {
      console.error("Eroare la citirea din Firestore:", error);
      throw error;
    }
  }

  function __hash32(str){
    str = String(str || "");
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  
  function __mulberry32(seed){
    let a = seed >>> 0;
    return function(){
      a |= 0; a = (a + 0x6D2B79F5) | 0;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  async function __isAdminNow(){
    try{
      if (window.__SBYT_ADMIN === true) return true;
      if (typeof __isAdmin !== "undefined" && __isAdmin === true) return true;
      if (window.firebase && firebase.auth) {
        const u = firebase.auth().currentUser;
        if (u && u.email && String(u.email).toLowerCase() === "stancubyt@gmail.com") return true;
      }
    }catch(e){}
    return false;
  }

  window.selectWinners = async function selectWinners(promoId){
    if(!__isAdminNow()) { 
      alert('Trebuie sÄƒ fii logat ca admin.');
      return;
    }

    try{
      const winnersList = document.getElementById(`winners_${promoId}`);
      if(!winnersList) {
        alert("Containerul pentru cÃ¢È™tigÄƒtori nu a fost gÄƒsit.");
        return;
      }
      
      const previewDiv = document.createElement('div');
      previewDiv.id = `winners_preview_${promoId}`;
      previewDiv.innerHTML = `<div style="padding:10px;text-align:center;opacity:0.8;">â³ Se calculeazÄƒ cÃ¢È™tigÄƒtorii...</div>`;
      
      // Ãnlocuim conÈ›inutul listei de cÃ¢È™tigÄƒtori cu preview
      winnersList.innerHTML = '';
      winnersList.appendChild(previewDiv);
      
      let promo, participants;
      
      try {
        const data = await getPromoDataFromFirestore(promoId);
        promo = data.promo;
        participants = data.participants;
        
        const idx = (window.__statsCache.promos || []).findIndex(p => String(p.id) === String(promoId));
        if(idx >= 0) {
          window.__statsCache.promos[idx] = promo;
        }
        window.__statsCache.participants[String(promoId)] = participants;
        
      } catch(firestoreError) {
        console.warn("Nu s-au putut obÈ›ine datele din Firestore, folosim cache:", firestoreError);
        
        promo = (window.__statsCache && window.__statsCache.promos || []).find(p=>String(p.id)===String(promoId));
        participants = Array.isArray(window.__statsCache.participants?.[String(promoId)]) ? window.__statsCache.participants[String(promoId)] : [];
      }
      
      if(!promo) {
        previewDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;">âŒ PromoÈ›ia nu a fost gÄƒsitÄƒ.</div>`;
        return;
      }
      
      if(!participants || participants.length === 0) {
        previewDiv.innerHTML = `<div style="padding:20px;text-align:center;opacity:0.8;">ğŸ“ Nu existÄƒ participanÈ›i Ã®ncÄƒ.</div>`;
        return;
      }

      // CalculÄƒm scorurile
      const scores = calculateReferralScores(participants);
      
      const ranking = participants
        .filter(u=>u && u.code)
        .map(u=>{
          return {
            ...u,
            score: scores[u.email] || 0
          };
        })
        .sort((a,b)=> b.score - a.score || a.joinedAt - b.joinedAt);

      const seed = `${promoId}|${promo.ends||""}|${participants.length}`;
      const rng = __mulberry32(__hash32(seed));

      const firstPlace = ranking.slice(0, 1);
      const secondPlace = ranking.slice(1, 2);
      const thirdPlace = ranking.slice(2, 3);
      
      const remaining = ranking.slice(3);
      
      const top5 = [];
      const poolTop5 = remaining.slice();
      for(let i=0; i<Math.min(5, poolTop5.length); i++) {
        const idx = Math.floor(rng() * poolTop5.length);
        top5.push(poolTop5.splice(idx, 1)[0]);
      }
      
      const next10 = [];
      const poolNext10 = poolTop5.slice();
      for(let i=0; i<Math.min(10, poolNext10.length); i++) {
        const idx = Math.floor(rng() * poolNext10.length);
        next10.push(poolNext10.splice(idx, 1)[0]);
      }
      
      const bonus = [];
      const poolBonus = poolNext10.slice();
      if(poolBonus.length > 0) {
        const idx = Math.floor(rng() * poolBonus.length);
        bonus.push(poolBonus[idx]);
      }

      const winners = {
        firstPlace: firstPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p1 || ''
        })),
        secondPlace: secondPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p2 || ''
        })),
        thirdPlace: thirdPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p3 || ''
        })),
        top5: top5.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.top5 || ''
        })),
        next10: next10.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.next10 || ''
        })),
        bonus: bonus.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.bonus || ''
        })),
        selectedAt: new Date().toISOString()
      };

      // AfiÈ™Äƒm preview-ul cÃ¢È™tigÄƒtorilor
      const allWinners = [
        ...firstPlace.map(w => ({ ...w, rank: 'ğŸ¥‡', rankClass: 'gold' })),
        ...secondPlace.map(w => ({ ...w, rank: 'ğŸ¥ˆ', rankClass: 'silver' })),
        ...thirdPlace.map(w => ({ ...w, rank: 'ğŸ¥‰', rankClass: 'bronze' })),
        ...top5.map(w => ({ ...w, rank: 'ğŸ…', rankClass: 'other' })),
        ...next10.map(w => ({ ...w, rank: 'â­', rankClass: 'other' })),
        ...bonus.map(w => ({ ...w, rank: 'ğŸ', rankClass: 'other' }))
      ];

      let previewHtml = `
        <div style="margin-bottom:15px;">
          <div style="font-weight:900; margin-bottom:10px; color: #ffd700;">ğŸ¯ CÃ¢È™tigÄƒtori selectaÈ›i</div>
          <div style="opacity:0.8; font-size:0.9rem; margin-bottom:15px;">AceÈ™ti cÃ¢È™tigÄƒtori au fost selectaÈ›i automat.</div>
        </div>
      `;
      
      allWinners.forEach((winner, index) => {
        previewHtml += `
          <div class="winner-line">
            <div class="winner-rank ${winner.rankClass}">${winner.rank}</div>
            <div class="winner-info-compact">
              <div class="winner-name-compact">${esc(winner.name)}</div>
              <div class="winner-email-compact">${esc(maskEmail(winner.email))}</div>
              <div class="winner-stats-compact">${winner.score} referral-uri</div>
            </div>
            <div class="winner-prize-compact" title="${esc(winner.prize || 'â€”')}">${esc(winner.prize || 'â€”')}</div>
          </div>
        `;
      });

      previewHtml += `
        <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
          <button class="btn" onclick="saveWinners('${esc(promoId)}')">ğŸ’¾ SalveazÄƒ CÃ¢È™tigÄƒtori</button>
          <button class="btn secondary" onclick="winnersList.innerHTML = buildWinnersList(window.__statsCache.promos.find(p=>String(p.id)==='${esc(promoId)}'), participants)">âŒ AnuleazÄƒ</button>
        </div>
        <div id="save_winners_msg_${esc(promoId)}" style="margin-top:10px; text-align:center;"></div>
      `;
      
      previewDiv.innerHTML = previewHtml;
      
      previewDiv.scrollIntoView({ behavior:"smooth", block:"nearest" });
      
    }catch(e){
      console.error("Eroare la selectarea cÃ¢È™tigÄƒtorilor:", e);
      const previewDiv = document.getElementById(`winners_preview_${promoId}`);
      if(previewDiv) {
        previewDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;">âŒ Eroare: ${esc(e?.message || "NecunoscutÄƒ")}</div>`;
      }
    }
  };

  window.saveWinners = async function saveWinners(promoId){
    if(!__isAdminNow()) { 
      alert('Trebuie sÄƒ fii logat ca admin.');
      return;
    }

    const msgBox = document.getElementById(`save_winners_msg_${promoId}`);
    if(msgBox) msgBox.innerHTML = `<div style="opacity:0.8; text-align:center;">â³ Se salveazÄƒ cÃ¢È™tigÄƒtorii...</div>`;

    try {
      const data = await getPromoDataFromFirestore(promoId);
      const promo = data.promo;
      const participants = data.participants;

      // CalculÄƒm scorurile
      const scores = calculateReferralScores(participants);
      
      const ranking = participants
        .filter(u=>u && u.code)
        .map(u=>{
          return {
            ...u,
            score: scores[u.email] || 0
          };
        })
        .sort((a,b)=> b.score - a.score || a.joinedAt - b.joinedAt);

      const seed = `${promoId}|${promo.ends||""}|${participants.length}`;
      const rng = __mulberry32(__hash32(seed));

      const firstPlace = ranking.slice(0, 1);
      const secondPlace = ranking.slice(1, 2);
      const thirdPlace = ranking.slice(2, 3);
      
      const remaining = ranking.slice(3);
      
      const top5 = [];
      const poolTop5 = remaining.slice();
      for(let i=0; i<Math.min(5, poolTop5.length); i++) {
        const idx = Math.floor(rng() * poolTop5.length);
        top5.push(poolTop5.splice(idx, 1)[0]);
      }
      
      const next10 = [];
      const poolNext10 = poolTop5.slice();
      for(let i=0; i<Math.min(10, poolNext10.length); i++) {
        const idx = Math.floor(rng() * poolNext10.length);
        next10.push(poolNext10.splice(idx, 1)[0]);
      }
      
      const bonus = [];
      const poolBonus = poolNext10.slice();
      if(poolBonus.length > 0) {
        const idx = Math.floor(rng() * poolBonus.length);
        bonus.push(poolBonus[idx]);
      }

      const winners = {
        firstPlace: firstPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p1 || ''
        })),
        secondPlace: secondPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p2 || ''
        })),
        thirdPlace: thirdPlace.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.p3 || ''
        })),
        top5: top5.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.top5 || ''
        })),
        next10: next10.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.next10 || ''
        })),
        bonus: bonus.map(u => ({ 
          name: u.name, 
          email: u.email, 
          score: scores[u.email] || 0,
          prize: promo.prizes?.bonus || ''
        })),
        selectedAt: new Date().toISOString()
      };

      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      
      const idx = promos.findIndex(p => String(p.id) === String(promoId));
      if(idx >= 0) {
        promos[idx].winners = winners;
        
        await writeStats({ promos });
        
        if(msgBox) msgBox.innerHTML = `<div style="color:#00ff88; font-weight:700; text-align:center;">âœ… CÃ¢È™tigÄƒtorii au fost salvaÈ›i!</div>`;
        
        // ActualizÄƒm cache-ul local
        const cacheIdx = (window.__statsCache.promos || []).findIndex(p => String(p.id) === String(promoId));
        if(cacheIdx >= 0) {
          window.__statsCache.promos[cacheIdx].winners = winners;
        }
        
        // ActualizÄƒm afiÈ™area dupÄƒ 1.5 secunde
        setTimeout(() => {
          const winnersList = document.getElementById(`winners_${promoId}`);
          if(winnersList) {
            const promoWithWinners = { ...promos[idx], winners };
            winnersList.innerHTML = buildWinnersList(promoWithWinners, participants);
          }
        }, 1500);

        // === TRIMITE EMAIL-URI PERSONALIZATE CÃ‚È˜TIGÄ‚TORILOR ===
        try {
          if (typeof window.sendPromoWinnerEmail === 'function') {
            const allWinners = [
              ...firstPlace.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'Premiul I',
                prize: promo.prizes?.p1 || ''
              })),
              ...secondPlace.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'Premiul II',
                prize: promo.prizes?.p2 || ''
              })),
              ...thirdPlace.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'Premiul III',
                prize: promo.prizes?.p3 || ''
              })),
              ...top5.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'Primele 5 locuri dupÄƒ podium',
                prize: promo.prizes?.top5 || ''
              })),
              ...next10.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'UrmÄƒtoarele 10 locuri',
                prize: promo.prizes?.next10 || ''
              })),
              ...bonus.map(u => ({ 
                ...u, 
                score: scores[u.email] || 0,
                prizeCategory: 'Bonus participare',
                prize: promo.prizes?.bonus || ''
              }))
            ];

            let emailCount = 0;
            for (const winner of allWinners) {
              if (winner.email) {
                try {
                  await window.sendPromoWinnerEmail({
                    toEmail: winner.email,
                    name: winner.name,
                    prizeCategory: winner.prizeCategory,
                    prize: winner.prize,
                    referralCount: winner.score,
                    promoTitle: promo.title || (promo.kind === 'giveaway' ? 'Giveaway' : 'PromoÈ›ie'),
                    promoUrl: window.location.href
                  });
                  emailCount++;
                  console.log(`Email personalizat trimis cÄƒtre: ${winner.email} (${winner.prizeCategory}, ${winner.prize})`);
                } catch(emailErr) {
                  console.warn(`Eroare la trimiterea email-ului cÄƒtre ${winner.email}:`, emailErr);
                }
              }
            }
            console.log(`Total email-uri personalizate trimise: ${emailCount}`);
          } else {
            console.warn('sendPromoWinnerEmail callable nu este disponibil.');
          }
        } catch(emailError) {
          console.warn('Eroare generalÄƒ la trimiterea email-urilor:', emailError);
        }
      } else {
        if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b; text-align:center;">âŒ PromoÈ›ia nu a fost gÄƒsitÄƒ.</div>`;
      }
    } catch(e) {
      console.error("Eroare la salvarea cÃ¢È™tigÄƒtorilor:", e);
      if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b; text-align:center;">âŒ Eroare: ${esc(e?.message || "NecunoscutÄƒ")}</div>`;
    }
  };

  function boot(){
    startStatsListener();

    const a = auth();
    if(a) {
      a.onAuthStateChanged(async (user)=>{
        const isAdmin = await computeIsAdmin(user);
        setAdminUI(isAdmin, user);
      });
    } else {
      setAdminUI(false, null);
    }
  }

  document.addEventListener('DOMContentLoaded', boot);

  if(!window.__expiryUiTimer){
    window.__expiryUiTimer = setInterval(()=>{ try{ renderPromos(); }catch(e){} }, 120000);
  }
})();
  </script>
</body>
</html>
