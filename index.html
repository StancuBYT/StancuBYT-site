<!DOCTYPE html>
<html lang="ro">
<head>
  <!-- [HEAD-ul rÄƒmÃ¢ne identic pÃ¢nÄƒ la script] -->
</head>
<body>
  <!-- [BODY-ul rÄƒmÃ¢ne identic pÃ¢nÄƒ la script] -->

<script>
(function(){
  // [Codul anterior rÄƒmÃ¢ne identic pÃ¢nÄƒ la funcÈ›ia saveWinners]
  
  // FUNCÈšIE CRITICÄ‚ REPARATÄ‚ - SalveazÄƒ cÃ¢È™tigÄƒtorii È™i trimite email-uri cu premiile corecte
  window.saveWinners = async function saveWinners(promoId){
    if(!__isAdminNow()) { 
      alert('Trebuie sÄƒ fii logat ca admin.');
      return;
    }

    const msgBox = document.getElementById(`save_winners_msg_${promoId}`);
    if(msgBox) msgBox.innerHTML = `<div style="opacity:0.8;">â³ Se salveazÄƒ cÃ¢È™tigÄƒtorii...</div>`;

    try {
      const data = await getPromoDataFromFirestore(promoId);
      const promo = data.promo;
      const participants = data.participants;

      const { scoreByCode } = __buildScores(participants);
      
      const ranking = participants
        .filter(u=>u && u.code)
        .map(u=>{
          const code = String(u.code);
          return {
            ...u,
            score: scoreByCode.get(code) || 0
          };
        })
        .sort((a,b)=> b.score - a.score || a.joinedAt - b.joinedAt);

      const seed = `${promoId}|${promo.ends||""}|${participants.length}`;
      const rng = __mulberry32(__hash32(seed));

      const firstPlace = ranking.slice(0, 1).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const secondPlace = ranking.slice(1, 2).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const thirdPlace = ranking.slice(2, 3).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const remaining = ranking.slice(3);
      
      const top5 = [];
      const poolTop5 = remaining.slice();
      for(let i=0; i<Math.min(5, poolTop5.length); i++) {
        const idx = Math.floor(rng() * poolTop5.length);
        const u = poolTop5.splice(idx, 1)[0];
        top5.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const next10 = [];
      const poolNext10 = poolTop5.slice();
      for(let i=0; i<Math.min(10, poolNext10.length); i++) {
        const idx = Math.floor(rng() * poolNext10.length);
        const u = poolNext10.splice(idx, 1)[0];
        next10.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const bonus = [];
      const poolBonus = poolNext10.slice();
      if(poolBonus.length > 0) {
        const idx = Math.floor(rng() * poolBonus.length);
        const u = poolBonus[idx];
        bonus.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }

      const winners = {
        firstPlace,
        secondPlace,
        thirdPlace,
        top5,
        next10,
        bonus,
        selectedAt: new Date().toISOString()
      };

      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      
      const idx = promos.findIndex(p => String(p.id) === String(promoId));
      if(idx >= 0) {
        promos[idx].winners = winners;
        
        await writeStats({ 
          promos,
          participants: stats.participants
        });
        
        if(msgBox) msgBox.innerHTML = `<div style="color:#00ff88; font-weight:700;">âœ… CÃ¢È™tigÄƒtorii au fost salvaÈ›i!</div>`;
        
        await loadAllWinners();
        
        setTimeout(() => {
          const previewBox = document.getElementById(`winners_preview_${promoId}`);
          if(previewBox) previewBox.innerHTML = '';
          
          const winnersDiv = document.getElementById(`lb_winners_${promoId}`);
          if(winnersDiv) {
            const promoWithWinners = { ...promos[idx], winners };
            winnersDiv.innerHTML = buildWinnersSection(promoWithWinners);
          }
          
          const selectButtonContainer = document.querySelector(`[onclick="selectWinners('${promoId}')"]`)?.parentElement?.parentElement;
          if(selectButtonContainer) {
            selectButtonContainer.style.display = 'none';
          }
        }, 1500);

        // ========== PARTEA CRITICÄ‚ REPARATÄ‚ ==========
        // VERIFICARE: AfiÈ™eazÄƒ premiile Ã®n consolÄƒ pentru debugging
        console.log('ğŸ† Premii disponibile Ã®n promoÈ›ie:', promo.prizes);
        
        // Mapare explicitÄƒ Ã®ntre categorie È™i premiu
        const prizeMapping = {
          firstPlace: promo.prizes?.p1 || 'Premiul I nedefinit',
          secondPlace: promo.prizes?.p2 || 'Premiul II nedefinit',
          thirdPlace: promo.prizes?.p3 || 'Premiul III nedefinit',
          top5: promo.prizes?.top5 || 'Premiu Top 5 nedefinit',
          next10: promo.prizes?.next10 || 'Premiu Next 10 nedefinit',
          bonus: promo.prizes?.bonus || 'Premiu Bonus nedefinit'
        };
        
        console.log('ğŸ“‹ Mapare categorie-premiu:', prizeMapping);

        // Trimite email-uri cu premiile corecte pentru fiecare categorie
        try {
          if (typeof window.sendPromoWinnerEmail === 'function') {
            let emailsSent = 0;
            let errors = 0;

            // ItereazÄƒ prin fiecare categorie de cÃ¢È™tigÄƒtori CU PREMIUL CORESPUNZÄ‚TOR
            const categories = [
              { key: 'firstPlace', winners: winners.firstPlace, prize: prizeMapping.firstPlace },
              { key: 'secondPlace', winners: winners.secondPlace, prize: prizeMapping.secondPlace },
              { key: 'thirdPlace', winners: winners.thirdPlace, prize: prizeMapping.thirdPlace },
              { key: 'top5', winners: winners.top5, prize: prizeMapping.top5 },
              { key: 'next10', winners: winners.next10, prize: prizeMapping.next10 },
              { key: 'bonus', winners: winners.bonus, prize: prizeMapping.bonus }
            ];

            for (const category of categories) {
              if (!category.winners || category.winners.length === 0) continue;
              
              console.log(`ğŸ“§ Trimitere email-uri pentru ${category.key}: ${category.prize}`);
              
              // Trimite email fiecÄƒrui cÃ¢È™tigÄƒtor din aceastÄƒ categorie CU PREMIUL CORECT
              for (const winner of category.winners) {
                if (winner.email) {
                  try {
                    const emailData = {
                      toEmail: winner.email,
                      name: winner.name,
                      prize: category.prize, // PREMIUL CORECT pentru aceastÄƒ categorie
                      score: winner.score || 0,
                      referrals: winner.referrals || 0,
                      promoTitle: promo.title || (promo.kind === 'giveaway' ? 'Giveaway' : 'PromoÈ›ie'),
                      promoUrl: window.location.href,
                      category: getCategoryLabel(category.key),
                      sbytAmount: calculateSBYTFromPrize(category.prize)
                    };
                    
                    console.log(`âœ‰ï¸  Trimis cÄƒtre ${winner.email}:`, emailData);
                    
                    await window.sendPromoWinnerEmail(emailData);
                    emailsSent++;
                    
                    // Mic delay pentru a nu suprasolicita serverul
                    await new Promise(resolve => setTimeout(resolve, 500));
                  } catch(emailErr) {
                    console.error(`âŒ Eroare la trimiterea email-ului cÄƒtre ${winner.email}:`, emailErr);
                    errors++;
                  }
                }
              }
            }

            console.log(`ğŸ“Š Total email-uri trimise: ${emailsSent}, erori: ${errors}`);
            
            if (errors > 0) {
              alert(`CÃ¢È™tigÄƒtorii au fost salvaÈ›i, dar ${errors} email-uri nu au putut fi trimise.`);
            } else {
              alert(`âœ… CÃ¢È™tigÄƒtorii salvaÈ›i È™i ${emailsSent} email-uri trimise cu succes!\n\nFiecare cÃ¢È™tigÄƒtor a primit detaliile premiului specific categoriei sale.`);
            }
          } else {
            console.warn('âš ï¸ sendPromoWinnerEmail callable nu este disponibil.');
            alert('âœ… CÃ¢È™tigÄƒtorii salvaÈ›i, dar funcÈ›ia de email nu este disponibilÄƒ.');
          }
        } catch(emailError) {
          console.warn('âŒ Eroare generalÄƒ la trimiterea email-urilor:', emailError);
          alert('âœ… CÃ¢È™tigÄƒtorii salvaÈ›i, dar a apÄƒrut o eroare la trimiterea email-urilor.');
        }
        // ========== FINAL PARTEA CRITICÄ‚ ==========
        
      } else {
        if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b;">âŒ PromoÈ›ia nu a fost gÄƒsitÄƒ.</div>`;
      }
    } catch(e) {
      console.error("âŒ Eroare la salvarea cÃ¢È™tigÄƒtorilor:", e);
      if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b;">âŒ Eroare: ${esc(e?.message || "NecunoscutÄƒ")}</div>`;
    }
  };

  // FUNCÈšIE CRITICÄ‚ REPARATÄ‚ - Retrimite email-urile cu premiile corecte
  window.resendWinnerEmails = async function(promoId) {
    if (!__isAdmin) {
      alert('Doar administratorii pot retrimite email-uri.');
      return;
    }
    
    const winnerDoc = __allWinners.find(w => w.id === promoId);
    if (!winnerDoc) return;
    
    if (!confirm(`Sigur doriÈ›i sÄƒ retrimiteÈ›i email-urile pentru ${winnerDoc.promoTitle}?`)) {
      return;
    }
    
    try {
      const promo = __statsCache.promos.find(p => p.id === promoId);
      if (!promo) {
        alert('PromoÈ›ia nu a fost gÄƒsitÄƒ Ã®n cache.');
        return;
      }
      
      // Mapare corectÄƒ Ã®ntre categorie È™i premiu
      const prizeMapping = {
        firstPlace: promo.prizes?.p1 || 'Premiul I nedefinit',
        secondPlace: promo.prizes?.p2 || 'Premiul II nedefinit',
        thirdPlace: promo.prizes?.p3 || 'Premiul III nedefinit',
        top5: promo.prizes?.top5 || 'Premiu Top 5 nedefinit',
        next10: promo.prizes?.next10 || 'Premiu Next 10 nedefinit',
        bonus: promo.prizes?.bonus || 'Premiu Bonus nedefinit'
      };
      
      console.log('ğŸ”„ Retrimitere email-uri cu maparea:', prizeMapping);
      
      let emailsSent = 0;
      let errors = 0;
      
      // ItereazÄƒ prin fiecare categorie de cÃ¢È™tigÄƒtori CU PREMIUL CORESPUNZÄ‚TOR
      const categories = [
        { key: 'firstPlace', winners: winnerDoc.winners.firstPlace, prize: prizeMapping.firstPlace },
        { key: 'secondPlace', winners: winnerDoc.winners.secondPlace, prize: prizeMapping.secondPlace },
        { key: 'thirdPlace', winners: winnerDoc.winners.thirdPlace, prize: prizeMapping.thirdPlace },
        { key: 'top5', winners: winnerDoc.winners.top5, prize: prizeMapping.top5 },
        { key: 'next10', winners: winnerDoc.winners.next10, prize: prizeMapping.next10 },
        { key: 'bonus', winners: winnerDoc.winners.bonus, prize: prizeMapping.bonus }
      ];
      
      for (const category of categories) {
        if (!category.winners || category.winners.length === 0) continue;
        
        console.log(`ğŸ“§ Retrimitere pentru ${category.key}: ${category.prize}`);
        
        // Trimite email fiecÄƒrui cÃ¢È™tigÄƒtor din aceastÄƒ categorie CU PREMIUL CORECT
        for (const winner of category.winners) {
          if (winner.email) {
            try {
              if (typeof window.sendPromoWinnerEmail === 'function') {
                const emailData = {
                  toEmail: winner.email,
                  name: winner.name,
                  prize: category.prize, // PREMIUL CORECT pentru aceastÄƒ categorie
                  promoTitle: promo.title || 'PromoÈ›ie',
                  promoUrl: window.location.href,
                  score: winner.score || 0,
                  referrals: winner.referrals || 0,
                  category: getCategoryLabel(category.key),
                  sbytAmount: calculateSBYTFromPrize(category.prize)
                };
                
                console.log(`âœ‰ï¸  Retrimis cÄƒtre ${winner.email}:`, emailData);
                
                await window.sendPromoWinnerEmail(emailData);
                emailsSent++;
                
                // Mic delay pentru a nu suprasolicita serverul
                await new Promise(resolve => setTimeout(resolve, 500));
              } else {
                console.warn('sendPromoWinnerEmail nu este disponibil');
                break;
              }
            } catch (emailErr) {
              console.error(`âŒ Eroare la retrimiterea email-ului cÄƒtre ${winner.email}:`, emailErr);
              errors++;
            }
          }
        }
      }
      
      alert(`Email-uri retrimise: ${emailsSent} cu succes, ${errors} erori.\n\nFiecare cÃ¢È™tigÄƒtor a primit din nou premiul specific categoriei sale.`);
      
    } catch (error) {
      console.error('Eroare la retrimiterea email-urilor:', error);
      alert('Eroare la retrimiterea email-urilor.');
    }
  };

  // Restul codului rÄƒmÃ¢ne identic...
  
  function getCategoryLabel(category) {
    const labels = {
      firstPlace: 'ğŸ† Premiul I',
      secondPlace: 'ğŸ¥ˆ Premiul II',
      thirdPlace: 'ğŸ¥‰ Premiul III',
      top5: 'ğŸ–ï¸ Primele 5 locuri',
      next10: 'ğŸ… UrmÄƒtoarele 10 locuri',
      bonus: 'ğŸ Bonus participare'
    };
    return labels[category] || category;
  }

  // [Restul codului rÄƒmÃ¢ne identic]
  
})();
</script>
</body>
</html>
