<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Statistici</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1"></script>

  <style>
        :root {
            --blue-tech: #0066ff;
            --green-growth: #00ff88;
            --purple-innov: #8a2be2;
            --neon-cyan: #00ffff;
            --dark-bg: #0a0a1f;
            --darker-bg: #050510;
            --orange-alert: #ff9500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: white;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 60%, rgba(0, 255, 136, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 20%);
        }

        #particles-js { position: fixed; width: 100%; height: 100%; z-index: -1; }

        .btn-refresh-modern {
            background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 5px 20px rgba(0, 102, 255, 0.3);
        }

        .btn-refresh-modern:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 30px rgba(0, 102, 255, 0.5); }
        .btn-refresh-modern:active { transform: translateY(0) scale(1); }

        .refresh-icon { font-size: 1.3rem; transition: transform 0.5s ease; }
        .btn-refresh-modern:hover .refresh-icon { animation: rotate360 1s linear infinite; }

        .refresh-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 50px;
            background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan));
            opacity: 0;
            z-index: -1;
            animation: pulseEffect 2s infinite;
        }

        @keyframes rotate360 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseEffect {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        .btn-refresh-modern.loading { background: linear-gradient(45deg, #666, #888); cursor: wait; }
        .btn-refresh-modern.loading .refresh-icon { animation: rotate360 1s linear infinite; }
        .btn-refresh-modern.loading .refresh-text { opacity: 0.7; }

        @keyframes successFlash {
            0%, 100% { background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov)); }
            50% { background: linear-gradient(45deg, var(--green-growth), #00cc66); }
        }
        .btn-refresh-modern.success { animation: successFlash 0.5s ease 2; }

        .page-section {
            min-height: 100vh;
            padding: 120px 2rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            display: none;
            position: relative;
            overflow: hidden;
        }
        .active-section { display: block; }

        .data-visualization {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        /* === CHART CARD (mai mic + mai frumos) === */
        .chart-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(0,255,136,0.18);
            border-radius: 16px;
            padding: 14px 14px 10px;
            margin-top: 10px;
            box-shadow:
              0 0 20px rgba(0, 102, 255, 0.16),
              0 0 40px rgba(0, 255, 136, 0.10);
        }

        .chart-toprow {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .chart-container {
            position: relative;
            height: 240px; /* <-- mai mic (era 400) */
            margin: 10px 0 6px;
        }

        /* controale mai compacte */
        .chart-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 0;
        }

        .period-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 102, 255, 0.3);
            color: white;
            padding: 0.42rem 0.7rem;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            user-select: none;
        }

        .period-btn.active {
            background: rgba(0, 102, 255, 0.35);
            border-color: rgba(0, 255, 136, 0.55);
            box-shadow: 0 0 10px rgba(0,255,136,0.15);
        }
        .period-btn:hover { background: rgba(0, 102, 255, 0.2); transform: translateY(-1px); }

        /* toggle modern (Line / Candles) */
        .toggle {
            display: inline-flex;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(0, 102, 255, 0.25);
            border-radius: 999px;
            padding: 3px;
            gap: 3px;
        }
        .toggle button {
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.85);
            padding: 0.42rem 0.8rem;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .toggle button.active {
            background: linear-gradient(45deg, rgba(0,102,255,0.55), rgba(0,255,136,0.25));
            color: #fff;
        }

        /* mini info row */
        .chart-meta {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.88rem;
            opacity: 0.85;
            padding: 6px 2px 2px;
        }

        .pill {
            display:inline-flex;
            align-items:center;
            gap:8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0,255,136,0.10);
            border: 1px solid rgba(0,255,136,0.18);
        }

        /* grid stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--neon-cyan);
            margin: 0.5rem 0;
        }

        .neon-glow {
            box-shadow:
                0 0 20px rgba(0, 102, 255, 0.3),
                0 0 40px rgba(0, 255, 136, 0.2),
                inset 0 0 20px rgba(138, 43, 226, 0.1);
        }

        .token-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .info-card:hover { transform: translateY(-10px); border-color: var(--green-growth); }

        @media (max-width: 768px) {
            .chart-container { height: 210px; }
            .btn-refresh-modern { padding: 0.8rem 1.5rem; font-size: 1rem; }
            .token-info-grid { grid-template-columns: 1fr; }
            .period-btn { font-size: 0.85rem; padding: 0.4rem 0.65rem; }
            .toggle button { font-size: 0.85rem; padding: 0.4rem 0.7rem; }
        }
  </style>
</head>

<body>
  <section id="statistici" class="page-section active-section">
        <div style="text-align: center; margin-bottom: 3rem; padding-top: 20px;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">AnalizƒÉ »òtiin»õificƒÉ √Æn Timp Real</h1>
            <p>Date live preluate de pe Etherscan</p>

            <button onclick="fetchAllData()" class="btn-refresh-modern" id="refreshButton">
                <span class="refresh-icon">üîÑ</span>
                <span class="refresh-text">Re√ÆmprospƒÉteazƒÉ Datele</span>
                <span class="refresh-pulse"></span>
            </button>
        </div>

        <div class="data-visualization neon-glow">
            <h3>üìà Pre»õ √Æn Timp Real</h3>

            <div id="sbyt-price-box" style="margin-top:14px; margin-bottom:10px;">
              <div style="font-size:18px; opacity:.85;">1 SBYT √Æn USD</div>
              <div id="sbyt-price" style="font-size:32px; font-weight:bold; color:var(--green-growth);">Se √ÆncarcƒÉ...</div>
            </div>

            <!-- CHART (mai mic + mai modern) -->
            <div class="chart-card">
              <div class="chart-toprow">
                <div class="chart-controls" aria-label="Perioada grafic">
                    <button class="period-btn active" onclick="changeChartPeriod('1h')">1H</button>
                    <button class="period-btn" onclick="changeChartPeriod('24h')">24H</button>
                    <button class="period-btn" onclick="changeChartPeriod('7d')">7 Zile</button>
                    <button class="period-btn" onclick="changeChartPeriod('1m')">1 LunƒÉ</button>
                </div>

                <div class="toggle" aria-label="Tip grafic">
                  <button id="btnLine" class="active" onclick="changeChartType('line')">Linie</button>
                  <button id="btnCandle" onclick="changeChartType('candlestick')">Lum√¢nƒÉri</button>
                </div>
              </div>

              <div class="chart-container">
                  <canvas id="priceChart"></canvas>
              </div>

              <div class="chart-meta">
                <div class="pill">üïí <span id="chartUpdatedAt">‚Äî</span></div>
                <div class="pill">üìå <span id="chartPoints">0</span> puncte</div>
              </div>

              <div id="priceData" class="loading" style="margin-top:6px; opacity:.85;">Se √ÆncarcƒÉ datele live...</div>
            </div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>üìä Metrici Contract - coinmarketcap LIVE</h3>
            <div class="stats-grid" id="etherscanStats">
                <div class="stat-item">
                    <div>Holders</div>
                    <div class="stat-value" id="holdersCount">-</div>
                    <div>De»õinƒÉtori</div>
                </div>
                <div class="stat-item">
                    <div>Total Supply REAL</div>
                    <div class="stat-value" id="totalSupply">-</div>
                    <div>SBYT</div>
                </div>
                <div class="stat-item">
                    <div>Tranzac»õii</div>
                    <div class="stat-value" id="transactionsCount">-</div>
                    <div>Total TX</div>
                </div>
                <div class="stat-item">
                    <div>Market Cap</div>
                    <div class="stat-value" id="marketCap">-</div>
                    <div>USD</div>
                </div>
                <div class="stat-item">
                    <div>Volum 24h</div>
                    <div class="stat-value" id="volume24h">-</div>
                    <div>USD</div>
                </div>
            </div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>üìã Detalii Contract</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div>
                    <p><strong>Token Name:</strong> <span id="tokenName">StancuBYT</span></p>
                    <p><strong>Symbol:</strong> <span id="tokenSymbol">SBYT</span></p>
                    <p><strong>Decimals:</strong> <span id="tokenDecimals">18</span></p>
                    <p><strong>Creation Date:</strong> <span id="creationDate">26.10.2025</span></p>
                </div>
                <div>
                    <p><strong>Contract Address:</strong> <span id="contractCreator">0x44Cf220399be798baeaE45fd7C4fF44623713833</span></p>
                    <p><strong>Contract Age:</strong> <span id="contractAge">-</span> zile</p>
                    <p><strong>Last Update:</strong> <span id="lastUpdateTime">-</span></p>
                    <p><strong>Contract verificat pe Etherscan</strong></p>
                </div>
            </div>
        </div>

        <div class="token-info-grid">
            <div class="info-card">
                <h3>üîç Vezi pe Etherscan</h3>
                <a href="https://etherscan.io/token/0x44Cf220399be798baeaE45fd7C4fF44623713833"
                   target="_blank" style="color: var(--neon-cyan); text-decoration: none;">
                    AnalizƒÉ detaliatƒÉ Etherscan ‚Ä∫
                </a>
            </div>
            <div class="info-card">
                <h3>üìà Vezi pe DexTools</h3>
                <a href="https://www.dextools.io/app/ether/pair-explorer/0xad4140b82dc8e2249af076b5669a8d868d2d55be8920f0a3882b7149dc507b18?t=1764524205462"
                   target="_blank" style="color: var(--neon-cyan); text-decoration: none;">
                    Chart live DexTools ‚Ä∫
                </a>
            </div>
            <div class="info-card">
                <h3>ü¶ç Vezi pe Apespace</h3>
                <a href="https://apespace.io/eth/0x83ced65e291d19c436a6f85aaa0a24e47f6e4368"
                   target="_blank" style="color: var(--neon-cyan); text-decoration: none;">
                    AnalizƒÉ Apespace ‚Ä∫
                </a>
            </div>

            <div class="info-card">
                <h3>ü¶é Vezi pe GeckoTerminal</h3>
                <a href="https://www.geckoterminal.com/eth/pools/0xabfa4bdb1b4485e0c590bba4adc93a3980f591e44e7ca17d61aa7420e6b81d07?utm_source=coingecko&utm_medium=referral&utm_campaign=searchresults"
                   target="_blank" style="color: var(--neon-cyan); text-decoration: none;">
                    Pool & tranzac»õionare GeckoTerminal ‚Ä∫
                </a>
            </div>
            <div class="info-card">
                <h3>üìå Vezi pe CoinMarketCap DEX</h3>
                <a href="https://dex.coinmarketcap.com/token/ethereum/0x44cf220399be798baeae45fd7c4ff44623713833/"
                   target="_blank" style="color: var(--neon-cyan); text-decoration: none;">
                    coinmarketcap DEX ‚Ä∫
                </a>
            </div>
        </div>
  </section>

  <script>
/* ===================== ENDPOINTS ===================== */
const SBYT_PRICE_ENDPOINT = "https://europe-west1-stancubyt-fc2b9.cloudfunctions.net/sbytPrice";
const HOLDERS_ENDPOINT       = "https://sbytholdersfree-jfka2frgwa-uc.a.run.app";
const TOTALSUPPLY_ENDPOINT   = "https://sbyttotalsupplyfree-jfka2frgwa-uc.a.run.app";
const TX_ENDPOINT            = "https://sbyttxcountfree-jfka2frgwa-uc.a.run.app";
const CONTRACT_INFO_ENDPOINT = "https://sbytcontractinfofree-jfka2frgwa-uc.a.run.app";
const POOL_STATS_ENDPOINT    = "https://europe-west1-stancubyt-fc2b9.cloudfunctions.net/sbytPoolStats";

/* ===================== CONTRACT CREATION (FIXED + AUTO AGE) ===================== */
const CONTRACT_CREATION_LOCAL = { y: 2025, m: 9, d: 26 }; // Oct (0=Ian)

function contractCreationMsLocalMidnight() {
  return new Date(CONTRACT_CREATION_LOCAL.y, CONTRACT_CREATION_LOCAL.m, CONTRACT_CREATION_LOCAL.d, 0, 0, 0).getTime();
}

function calcAgeDaysFromLocalMidnight(msLocalMidnight) {
  if (!Number.isFinite(msLocalMidnight)) return null;
  const now = new Date();
  const todayLocalMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).getTime();
  const diff = todayLocalMidnight - msLocalMidnight;
  if (!Number.isFinite(diff)) return null;
  return Math.max(0, Math.floor(diff / 86400000));
}

function renderContractDatesFixed() {
  const ms = contractCreationMsLocalMidnight();
  const creationEl = document.getElementById("creationDate");
  const ageEl      = document.getElementById("contractAge");

  if (creationEl) creationEl.textContent = "26.10.2025"; // FIX, fara shift
  const ageDays = calcAgeDaysFromLocalMidnight(ms);
  if (ageEl) ageEl.textContent = (ageDays == null) ? "‚Äî" : ageDays.toLocaleString("ro-RO");
}

/* ===================== PRICE HISTORY STORAGE ===================== */
const STORAGE_KEY = "sbyt_price_samples_v1";
const MAX_KEEP_DAYS = 31;

/* ===================== UI STATE ===================== */
let currentPeriod = "24h";
let currentMode   = "line";
let priceChart    = null;

let CURRENT_PRICE_USD  = null;
let CURRENT_SUPPLY     = null;
let CURRENT_VOLUME_24H = null;

function nowMs(){ return Date.now(); }

function loadSamples() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = JSON.parse(raw || "[]");
    if (!Array.isArray(arr)) return [];
    return arr
      .map(s => ({ t: Number(s.t), p: Number(s.p) }))
      .filter(s => Number.isFinite(s.t) && Number.isFinite(s.p))
      .sort((a,b) => a.t - b.t);
  } catch {
    return [];
  }
}

function saveSamples(arr) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch {}
}

function trimSamples(arr) {
  const cutoff = nowMs() - MAX_KEEP_DAYS * 24*60*60*1000;
  return arr.filter(s => s.t >= cutoff);
}

function addSample(price) {
  let arr = loadSamples();
  arr.push({ t: nowMs(), p: price });
  arr = trimSamples(arr).sort((a,b)=>a.t-b.t);
  if (arr.length > 20000) arr = arr.slice(arr.length - 20000);
  saveSamples(arr);
  return arr;
}

function periodWindowMs(period) {
  switch(period){
    case "1h":  return 1*60*60*1000;
    case "24h": return 24*60*60*1000;
    case "7d":  return 7*24*60*60*1000;
    case "1m":  return 30*24*60*60*1000;
    default:    return 24*60*60*1000;
  }
}

function bucketSizeMs(period) {
  switch(period){
    case "1h":  return 60*1000;
    case "24h": return 15*60*1000;
    case "7d":  return 12*60*60*1000;  // mai smooth
    case "1m":  return 24*60*60*1000;
    default:    return 15*60*1000;
  }
}

function fmtLabel(ts){
  const d = new Date(ts);
  if (currentPeriod === "1h" || currentPeriod === "24h") {
    return d.toLocaleTimeString("ro-RO", { hour: "2-digit", minute: "2-digit" });
  }
  if (currentPeriod === "7d") {
    return d.toLocaleDateString("ro-RO", { weekday: "short" });
  }
  return d.toLocaleDateString("ro-RO", { day: "2-digit", month: "2-digit" });
}

function destroyChart() {
  try { if (priceChart) priceChart.destroy(); } catch {}
  priceChart = null;
}

function buildLineSeries(samples, period) {
  const start = nowMs() - periodWindowMs(period);
  const inRange = samples.filter(s => s.t >= start);
  if (!inRange.length) return { labels: [], values: [] };

  if (period === "7d" || period === "1m") {
    const bms = bucketSizeMs(period);
    const buckets = new Map();
    for (const s of inRange){
      const b = Math.floor(s.t / bms) * bms;
      buckets.set(b, s.p);
    }
    const keys = Array.from(buckets.keys()).sort((a,b)=>a-b);
    return { labels: keys.map(fmtLabel), values: keys.map(k => buckets.get(k)) };
  }

  const maxPoints = 220; // mai compact
  const step = Math.max(1, Math.floor(inRange.length / maxPoints));
  const labels = [];
  const values = [];
  for (let i=0; i<inRange.length; i+=step){
    labels.push(fmtLabel(inRange[i].t));
    values.push(inRange[i].p);
  }
  const last = inRange[inRange.length-1];
  if (labels.length && labels[labels.length-1] !== fmtLabel(last.t)) {
    labels.push(fmtLabel(last.t));
    values.push(last.p);
  }
  return { labels, values };
}

function buildCandlesSeries(samples, period) {
  const start = nowMs() - periodWindowMs(period);
  const bms = bucketSizeMs(period);
  const inRange = samples.filter(s => s.t >= start);
  if (!inRange.length) return { labels: [], ohlc: [] };

  const buckets = new Map();
  for (const s of inRange){
    const b = Math.floor(s.t / bms) * bms;
    const cur = buckets.get(b);
    if (!cur) buckets.set(b, { o: s.p, h: s.p, l: s.p, c: s.p });
    else { cur.h = Math.max(cur.h, s.p); cur.l = Math.min(cur.l, s.p); cur.c = s.p; }
  }
  const keys = Array.from(buckets.keys()).sort((a,b)=>a-b);
  return { labels: keys.map(fmtLabel), ohlc: keys.map(k => ({ ...buckets.get(k) })) };
}

function updateChartMeta(pointsCount){
  const u = document.getElementById("chartUpdatedAt");
  const p = document.getElementById("chartPoints");
  if (u) u.textContent = new Date().toLocaleTimeString("ro-RO", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  if (p) p.textContent = String(pointsCount ?? 0);
}

/* ---- CHART STYLING HELPERS (fara culori hardcode in dataset) ---- */
function applyChartOptionsCommon(options){
  // grid/ticks mai soft + fara margini prea mari
  options.layout = options.layout || {};
  options.layout.padding = { left: 6, right: 10, top: 8, bottom: 4 };

  options.plugins = options.plugins || {};
  options.plugins.legend = { display: false };
  options.plugins.tooltip = {
    enabled: true,
    mode: "index",
    intersect: false,
    displayColors: false,
    callbacks: {
      label: (ctx) => {
        const v = ctx.parsed?.y;
        if (!Number.isFinite(v)) return "‚Äî";
        return "SBYT: $" + Number(v).toFixed(8);
      }
    }
  };

  options.scales = options.scales || {};
  options.scales.x = {
    ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
    grid: { display: false }
  };
  options.scales.y = {
    beginAtZero: false,
    ticks: {
      callback: (v) => (Number(v) >= 1 ? "$" + Number(v).toFixed(2) : "$" + Number(v).toFixed(6))
    },
    grid: { color: "rgba(255,255,255,0.06)" }
  };

  return options;
}

function renderPriceChart(samples) {
  const canvas = document.getElementById("priceChart");
  if (!canvas) return;
  if (typeof Chart === "undefined") return;

  const ctx = canvas.getContext("2d");
  destroyChart();

  if (currentMode === "candlestick") {
    const { labels, ohlc } = buildCandlesSeries(samples, currentPeriod);
    priceChart = new Chart(ctx, {
      type: "candlestick",
      data: { labels, datasets: [{ label: "SBYT", data: ohlc }] },
      options: applyChartOptionsCommon({
        responsive: true,
        maintainAspectRatio: false,
        parsing: false
      })
    });
    updateChartMeta(ohlc.length);
  } else {
    const { labels, values } = buildLineSeries(samples, currentPeriod);

    // gradient fill (din canvas) - vizual mai ‚Äúpremium‚Äù
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height || 240);
    gradient.addColorStop(0, "rgba(0, 255, 136, 0.22)");
    gradient.addColorStop(1, "rgba(0, 255, 136, 0.00)");

    priceChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "SBYT",
          data: values,
          tension: 0.35,
          pointRadius: 0,
          borderWidth: 2,
          borderColor: "rgba(0,255,136,0.85)",
          backgroundColor: gradient,
          fill: true
        }]
      },
      options: applyChartOptionsCommon({
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        elements: { line: { capBezierPoints: true } }
      })
    });

    updateChartMeta(values.length);
  }
}

function setLastUpdate() {
  const el = document.getElementById("lastUpdateTime");
  if (!el) return;
  el.textContent = new Date().toLocaleString("ro-RO");
}

function updateMarketCapUI() {
  const el = document.getElementById("marketCap");
  if (!el) return;
  if (!Number.isFinite(CURRENT_PRICE_USD) || !Number.isFinite(CURRENT_SUPPLY)) { el.textContent = "‚Äî"; return; }
  const mc = CURRENT_PRICE_USD * CURRENT_SUPPLY;
  el.textContent = Number.isFinite(mc) ? mc.toLocaleString("ro-RO", { maximumFractionDigits: 0 }) : "‚Äî";
}

function updateVolumeUI() {
  const el = document.getElementById("volume24h");
  if (!el) return;
  el.textContent = Number.isFinite(CURRENT_VOLUME_24H)
    ? CURRENT_VOLUME_24H.toLocaleString("ro-RO", { maximumFractionDigits: 0 })
    : "‚Äî";
}

/* ===================== LIVE UPDATERS ===================== */
async function updateSBYTPrice() {
  const priceEl = document.getElementById("sbyt-price");
  const priceDataEl = document.getElementById("priceData");
  if (!priceEl) return;

  try {
    const res = await fetch(SBYT_PRICE_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const data = await res.json();

    const p = Number(data?.priceUsd);
    if (data?.ok && Number.isFinite(p)) {
      priceEl.innerText = "$" + p.toFixed(8);
      CURRENT_PRICE_USD = p;
      updateMarketCapUI();

      const samples = addSample(p);
      renderPriceChart(samples);

      if (priceDataEl) priceDataEl.textContent = "Ultima citire: $" + p.toFixed(8);
      setLastUpdate();
      return;
    }

    priceEl.innerText = "‚Äî";
    if (priceDataEl) priceDataEl.textContent = "Nu am primit pre»õ valid.";
  } catch {
    priceEl.innerText = "‚Äî";
    if (priceDataEl) priceDataEl.textContent = "Eroare la √ÆncƒÉrcarea pre»õului.";
  }
}

async function updateHolders() {
  const el = document.getElementById("holdersCount");
  if (!el) return;
  el.textContent = "‚Ä¶";
  try {
    const r = await fetch(HOLDERS_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    const v = Number(d?.holders);
    el.textContent = (d?.ok && Number.isFinite(v)) ? v.toLocaleString("ro-RO") : "0";
    setLastUpdate();
  } catch {
    el.textContent = "0";
  }
}

async function updateTotalSupply() {
  const el = document.getElementById("totalSupply");
  if (!el) return;
  el.textContent = "‚Ä¶";
  try {
    const r = await fetch(TOTALSUPPLY_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    const supplyNum = parseFloat(String(d?.supply ?? ""));
    if (d?.ok && Number.isFinite(supplyNum)) {
      el.textContent = supplyNum.toLocaleString("ro-RO", { maximumFractionDigits: 0 });
      CURRENT_SUPPLY = supplyNum;
      updateMarketCapUI();
      setLastUpdate();
    } else {
      el.textContent = "‚Äî";
      CURRENT_SUPPLY = null;
      updateMarketCapUI();
    }
  } catch {
    el.textContent = "‚Äî";
    CURRENT_SUPPLY = null;
    updateMarketCapUI();
  }
}

async function updateTransactions() {
  const el = document.getElementById("transactionsCount");
  if (!el) return;
  el.textContent = "‚Ä¶";
  try {
    const r = await fetch(TX_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    const v = Number(d?.txCount);
    el.textContent = (d?.ok && Number.isFinite(v)) ? v.toLocaleString("ro-RO") : "0";
    setLastUpdate();
  } catch {
    el.textContent = "0";
  }
}

async function updateContractInfo() {
  renderContractDatesFixed();
  setLastUpdate();
}

async function updatePoolStats() {
  const el = document.getElementById("volume24h");
  if (el) el.textContent = "‚Ä¶";
  try {
    const r = await fetch(POOL_STATS_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    const v = Number(d?.volumeUsd24h);
    CURRENT_VOLUME_24H = (d?.ok && Number.isFinite(v)) ? v : null;
    updateVolumeUI();
    setLastUpdate();
  } catch {
    CURRENT_VOLUME_24H = null;
    updateVolumeUI();
  }
}

/* ===================== BUTTON HANDLERS ===================== */
function syncActiveButtons(){
  // period buttons
  document.querySelectorAll(".period-btn").forEach(btn => {
    const oc = (btn.getAttribute("onclick") || "").replace(/\s+/g, "");
    const isPeriod = oc.includes("changeChartPeriod");
    let active = false;
    if (isPeriod) active = oc.includes(`'${currentPeriod}'`) || oc.includes(`"${currentPeriod}"`);
    btn.classList.toggle("active", active);
  });

  // toggle buttons
  const btnLine = document.getElementById("btnLine");
  const btnCandle = document.getElementById("btnCandle");
  if (btnLine) btnLine.classList.toggle("active", currentMode === "line");
  if (btnCandle) btnCandle.classList.toggle("active", currentMode === "candlestick");
}

window.changeChartPeriod = function(period){
  currentPeriod = period;
  syncActiveButtons();
  renderPriceChart(loadSamples());
};

window.changeChartType = function(mode){
  currentMode = (mode === "candlestick") ? "candlestick" : "line";
  syncActiveButtons();
  renderPriceChart(loadSamples());
};

window.fetchAllData = async function(){
  const btn = document.getElementById("refreshButton");
  if (btn) btn.classList.add("loading");

  try{
    await Promise.allSettled([
      updateSBYTPrice(),
      updateHolders(),
      updateTotalSupply(),
      updateTransactions(),
      updateContractInfo(),
      updatePoolStats()
    ]);

    if (btn) {
      btn.classList.remove("loading");
      btn.classList.add("success");
      setTimeout(()=>btn.classList.remove("success"), 1200);
    }
  } catch {
    if (btn) btn.classList.remove("loading");
  }
};

/* ===================== BOOT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  renderContractDatesFixed();

  syncActiveButtons();
  renderPriceChart(loadSamples());

  updateSBYTPrice();
  updateHolders();
  updateTotalSupply();
  updateTransactions();
  updateContractInfo();
  updatePoolStats();

  setInterval(updateSBYTPrice, 30000);
  setInterval(updateHolders, 300000);
  setInterval(updateTotalSupply, 300000);
  setInterval(updateTransactions, 300000);
  setInterval(updateContractInfo, 3600000);
  setInterval(updatePoolStats, 300000);

  // age corect daca pagina ramane deschisa peste miezul noptii
  setInterval(renderContractDatesFixed, 60 * 60 * 1000);
});
  </script>
</body>
</html>

