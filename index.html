<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Giveaway & PromoÈ›ii</title>

  <style>
    :root{
      --bg0:#050510;
      --bg1:#0a0a1f;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --neon-cyan:#00ffff;
      --blue-tech:#0066ff;
      --green:#00ff88;
      --purple:#8a2be2;
      --gold:#ffd166;
      --red:#ff4d4d;
      --orange:#ff9500;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 8px 26px rgba(0,0,0,.45);
      --r: 22px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; }
    body{
      color: var(--txt);
      background:
        radial-gradient(1000px 520px at 18% 12%, rgba(0,255,255,.12), transparent 60%),
        radial-gradient(900px 480px at 82% 18%, rgba(138,43,226,.16), transparent 60%),
        radial-gradient(1100px 560px at 50% 92%, rgba(0,255,136,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }

    .wrap{ max-width:1200px; margin: 0 auto; padding: 22px 16px 70px; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding: 14px 16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      position: sticky;
      top: 10px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 220px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 30%, rgba(0,255,255,.45), transparent 52%),
        radial-gradient(circle at 70% 20%, rgba(138,43,226,.45), transparent 55%),
        radial-gradient(circle at 40% 75%, rgba(0,255,136,.35), transparent 58%),
        rgba(255,255,255,.06);
      display:grid; place-items:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; opacity:.9; }
    .brand h1{ font-size: 16px; letter-spacing:.2px; }
    .brand .sub{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .top-actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      font-size:13px;
      white-space:nowrap;
    }
    .btn{
      cursor:pointer;
      border:none;
      border-radius: 14px;
      padding: 11px 14px;
      color: #061018;
      font-weight: 700;
      letter-spacing:.2px;
      box-shadow: 0 16px 45px rgba(0,0,0,.45);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:hover{ filter: brightness(1.05); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(.3); }
    .btn-primary{
      background: linear-gradient(90deg, rgba(0,255,255,.95), rgba(0,102,255,.95));
    }
    .btn-accent{
      background: linear-gradient(90deg, rgba(255,209,102,.96), rgba(255,149,0,.96));
    }
    .btn-ghost{
      color: var(--txt);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: none;
    }

    /* Hero */
    .hero{
      margin-top: 16px;
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background:
        radial-gradient(680px 340px at 22% 25%, rgba(0,255,255,.16), transparent 60%),
        radial-gradient(680px 340px at 78% 18%, rgba(138,43,226,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(0,255,255,.14), rgba(138,43,226,.14), rgba(0,255,136,.12));
      filter: blur(32px);
      opacity:.8;
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      padding: 22px 18px;
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .hero h2{ font-size: 22px; margin-bottom: 6px; }
    .hero p{ color: var(--muted); line-height:1.5; max-width: 72ch; }
    .hero .hint{ margin-top:10px; font-size: 12px; color: rgba(255,255,255,.65); }
    .hero .quick{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 14px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(255,255,255,.84);
    }

    /* Grid */
    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      align-items:start;
    }
    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .panel .hd h3{ font-size: 14px; letter-spacing:.2px; }
    .panel .bd{ padding: 14px; }

    .admin-col{ grid-column: span 4; }
    .list-col{ grid-column: span 8; }

    @media (max-width: 980px){
      .admin-col{ grid-column: span 12; }
      .list-col{ grid-column: span 12; }
    }

    /* Login */
    .login-box{
      display:flex; flex-direction:column; gap:10px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.55); }
    .two > *{ flex: 1 1 180px; }
    .three > *{ flex: 1 1 140px; }
    .msg{
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.82);
      line-height: 1.4;
    }
    .msg.ok{ border-color: rgba(0,255,136,.30); background: rgba(0,255,136,.08); }
    .msg.bad{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.08); }

    .admin-only{ display:none; }

    /* Promo cards */
    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
    }
    @media (max-width: 900px){
      .cards{ grid-template-columns: 1fr; }
    }

    .promo-card{
      border: 1px solid rgba(255,255,255,.16);
      border-radius: calc(var(--r) + 4px);
      overflow:hidden;
      position:relative;
      box-shadow: var(--shadow);
      min-height: 360px;
      background: rgba(0,0,0,.25);
    }
    .promo-bg{
      position:absolute; inset:0;
      background:
        radial-gradient(700px 360px at 30% 20%, rgba(0,255,255,.18), transparent 60%),
        radial-gradient(740px 360px at 80% 25%, rgba(138,43,226,.20), transparent 60%),
        radial-gradient(760px 380px at 50% 92%, rgba(0,255,136,.15), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.65));
      filter: saturate(1.05);
      transform: scale(1.03);
    }
    .promo-bg.has-img{
      background-size: cover;
      background-position: center;
    }
    .promo-overlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.72));
    }
    .promo-inner{
      position:relative;
      padding: 16px 16px 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      height:100%;
    }
    .promo-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
    }
    .badge.live{
      background: linear-gradient(90deg, rgba(0,255,136,.18), rgba(0,255,255,.14));
      border-color: rgba(0,255,136,.30);
    }
    .badge.ended{
      background: rgba(255,77,77,.10);
      border-color: rgba(255,77,77,.28);
      color: rgba(255,255,255,.88);
    }

    .promo-title{
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .promo-sub{
      color: rgba(255,255,255,.75);
      font-size: 12.5px;
      line-height:1.45;
    }

    .promo-meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: rgba(255,255,255,.78);
      font-size: 12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    .promo-prizes{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    .prize{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 10px 10px;
      min-height: 78px;
    }
    .prize b{ display:block; font-size:12px; color: rgba(255,255,255,.85); margin-bottom: 6px; }
    .prize .v{ font-size: 12px; color: rgba(255,255,255,.75); line-height:1.35; }

    .cta-row{
      margin-top:auto;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 12px;
    }
    .cta-left{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: rgba(255,255,255,.80);
      font-size: 12px;
    }
    .cta-right{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    .link{
      color: rgba(0,255,255,.95);
      text-decoration:none;
      font-weight:700;
    }
    .link:hover{ text-decoration:underline; }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 90;
      padding: 16px;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width: min(720px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal-hd h3{ font-size: 14px; }
    .x{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
      font-weight:700;
    }
    .modal-bd{ padding: 14px; }
    .small{ font-size:12px; color: rgba(255,255,255,.70); line-height:1.45; }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; }

    .check{
      display:flex; gap:10px; align-items:flex-start;
      margin-top: 8px;
      color: rgba(255,255,255,.75);
      font-size: 12px;
    }
    .check input{ width:auto; margin-top: 2px; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>

  <!-- Firebase (compat) - same as index prezentare ok.html -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // Firebase init (same project)
    window.firebaseConfig = {
      apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
      authDomain: "stancubyt-fc2b9.firebaseapp.com",
      projectId: "stancubyt-fc2b9",
      storageBucket: "stancubyt-fc2b9.firebasestorage.app",
      messagingSenderId: "263244200492",
      appId: "1:263244200492:web:28adf253b726cfdafaaf89",
      measurementId: "G-272S9HSY3K"
    };
    try{
      if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
    }catch(e){
      console.warn("Firebase init warning:", e);
    }
  </script>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="SBYT" onerror="this.style.display='none'">
        </div>
        <div>
          <h1>Giveaway & PromoÈ›ii</h1>
          <div class="sub">Campanii atractive â€¢ participare rapidÄƒ â€¢ clasament & referral</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="authPill">ğŸ”’ Neautentificat</div>

        <!-- Admin buttons (appear after login + admin) -->
        <button class="btn btn-accent admin-only" id="btnAddPromo" onclick="openAdminForm('promo')">â• AdaugÄƒ PromoÈ›ie</button>
        <button class="btn btn-accent admin-only" id="btnAddGiveaway" onclick="openAdminForm('giveaway')">ğŸ AdaugÄƒ Giveaway</button>
        <button class="btn btn-ghost admin-only" id="btnLogout" onclick="adminSignOut()">IeÈ™i</button>
      </div>
    </div>

    <div class="hero">
      <div class="hero-inner">
        <div>
          <h2>FÄƒ-È›i comunitatea sÄƒ revinÄƒ zilnic ğŸ§ ğŸ®</h2>
          <p>
            Construim promoÈ›ii ca Ã®n jocuri: <b>premii clare</b>, <b>timp limitat</b>, <b>tensiune (countdown)</b>,
            <b>progres</b> È™i <b>recompense extra</b> prin referral.
            Participarea e uÈ™oarÄƒ: completezi formularul, primeÈ™ti un cod È™i poÈ›i invita prieteni.
          </p>
          <div class="quick">
            <span class="tag">â³ UrgenÈ›Äƒ: â€se terminÄƒ Ã®n curÃ¢ndâ€</span>
            <span class="tag">ğŸ† Status: Live / Expirat</span>
            <span class="tag">ğŸ”¥ Bonus: Top 5 + urmÄƒtoarele 10</span>
            <span class="tag">ğŸ¯ CTA: buton â€ParticipÄƒâ€</span>
          </div>
          <div class="hint">Admin: autentificÄƒ-te ca Ã®n pagina â€Prezentareâ€ È™i vei vedea butoanele de adÄƒugare.</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Admin / Login -->
      <div class="panel admin-col">
        <div class="hd">
          <h3>Admin â€¢ Autentificare</h3>
          <span class="pill" id="adminBadge">â€”</span>
        </div>
        <div class="bd">
          <div class="login-box" id="loginBox">
            <div class="row two">
              <input id="adminEmail" type="email" placeholder="Email admin" autocomplete="username">
              <input id="adminPass" type="password" placeholder="ParolÄƒ" autocomplete="current-password">
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="button" onclick="adminSignIn()">ğŸ”‘ AutentificÄƒ</button>
            </div>
            <div id="adminLoginMsg" class="msg" style="display:none;"></div>
            <div class="small">
              DacÄƒ vezi erori de tip <span class="mono">Missing or insufficient permissions</span>, Ã®nseamnÄƒ cÄƒ <b>Firestore Rules</b>
              nu permit scriere Ã®n <span class="mono">promos</span> pentru contul cu care eÈ™ti logat.
            </div>
          </div>

          <!-- Admin form -->
          <div class="admin-only" id="adminForm" style="margin-top:14px;">
            <div class="msg ok" id="adminFormTitle" style="margin-bottom:10px;">â• AdaugÄƒ campanie</div>

            <div class="row two">
              <select id="promoType">
                <option value="promo">PromoÈ›ie</option>
                <option value="giveaway">Giveaway</option>
              </select>
              <input id="promoEnd" type="datetime-local" placeholder="Data È™i ora expirÄƒrii">
            </div>

            <div class="row">
              <input id="promoTitle" maxlength="120" type="text" placeholder="Titlu (ex: Mega Giveaway SBYT)">
            </div>

            <div class="row">
              <input id="promoTagline" maxlength="160" type="text" placeholder="Tagline (ex: IntrÄƒ Ã®n top È™i ia bonus!)">
            </div>

            <div class="row three">
              <input id="p1" maxlength="160" type="text" placeholder="Premiul I (ex: 10.000 SBYT)">
              <input id="p2" maxlength="160" type="text" placeholder="Premiul II (ex: 5.000 SBYT)">
              <input id="p3" maxlength="160" type="text" placeholder="Premiul III (ex: 2.500 SBYT)">
            </div>
            <div class="row two">
              <input id="pTop5" maxlength="160" type="text" placeholder="Primele 5 locuri (ex: bonus 500 SBYT)">
              <input id="pNext10" maxlength="160" type="text" placeholder="UrmÄƒtoarele 10 locuri (ex: bonus 100 SBYT)">
            </div>

            <div class="row">
              <textarea id="promoRules" placeholder="Regulament & condiÈ›ii (paÈ™i, criterii, eligibilitate, termen, etc.)"></textarea>
            </div>

            <div class="row two">
              <input id="ctaUrl" type="url" placeholder="Link Ã®nregistrare (ex: https://stancubyt.com/#signup)">
              <input id="ctaText" type="text" maxlength="40" placeholder="Text buton (ex: ParticipÄƒ acum!)">
            </div>

            <div class="row two">
              <div>
                <div class="small" style="margin-bottom:6px;">Imagine fundal card (background)</div>
                <input id="bgFile" type="file" accept="image/*">
              </div>
              <div>
                <div class="small" style="margin-bottom:6px;">Banner / cover (opÈ›ional)</div>
                <input id="bannerFile" type="file" accept="image/*">
              </div>
            </div>

            <div class="row" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="button" onclick="saveCampaign()">ğŸ’¾ SalveazÄƒ</button>
              <button class="btn btn-ghost" type="button" onclick="closeAdminForm()">âŒ Ãnchide</button>
            </div>

            <div id="adminSaveMsg" class="msg" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- List -->
      <div class="panel list-col">
        <div class="hd">
          <h3>Campanii active / istorice</h3>
          <div class="pill">ğŸ“Œ Live update</div>
        </div>
        <div class="bd">
          <div id="promoList" class="cards"></div>
          <div id="emptyState" class="msg" style="display:none; margin-top:12px;">
            Nu existÄƒ campanii Ã®ncÄƒ. AutentificÄƒ-te ca admin È™i apasÄƒ â€AdaugÄƒ PromoÈ›ie / Giveawayâ€.
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Participate modal -->
  <div class="modal" id="joinModal" onclick="if(event.target.id==='joinModal') closeJoin()">
    <div class="modal-card">
      <div class="modal-hd">
        <h3 id="joinTitle">ParticipÄƒ</h3>
        <button class="x" onclick="closeJoin()">âœ•</button>
      </div>
      <div class="modal-bd">
        <div id="joinInfo" class="small"></div>
        <div class="hr"></div>

        <div class="row two">
          <input id="joinName" type="text" placeholder="Nume (opÈ›ional)">
          <input id="joinEmail" type="email" placeholder="Email (obligatoriu)">
        </div>
        <div class="row two">
          <input id="joinWallet" type="text" placeholder="Wallet (opÈ›ional, 0x...)">
          <input id="joinReferral" type="text" placeholder="Cod referral (opÈ›ional)">
        </div>

        <div class="check">
          <input id="joinAgree" type="checkbox">
          <label for="joinAgree">Sunt de acord sÄƒ fiu contactat/Äƒ pentru detalii despre campanie È™i confirmare participare.</label>
        </div>

        <div class="row" style="justify-content:flex-end; margin-top:12px;">
          <button class="btn btn-primary" id="joinBtn" type="button" onclick="submitJoin()">âœ… ConfirmÄƒ participarea</button>
          <button class="btn btn-ghost" type="button" onclick="closeJoin()">AnuleazÄƒ</button>
        </div>

        <div id="joinMsg" class="msg" style="display:none; margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   Giveaway & PromoÈ›ii (Firestore + Storage) - functional & pro
   - Firebase config identic cu index prezentare ok.html
   - Admin login + admin whitelist
   - Save campaigns in Firestore: collection promos
   - Upload background/banner to Firebase Storage: promos/{id}/...
   - Render big attractive cards + Participate button -> modal
   - Save participants in subcollection: promos/{id}/participants
   ============================================================ */

const ADMIN_EMAILS = [
  "stancubyt@gmail.com",
  "admin@stancubyt.com"
];

const $ = (id)=>document.getElementById(id);

const auth = (typeof firebase !== 'undefined') ? firebase.auth() : null;
const db = (typeof firebase !== 'undefined') ? firebase.firestore() : null;
const storage = (typeof firebase !== 'undefined') ? firebase.storage() : null;

let __promosUnsub = null;
let __activePromoId = null;
let __activePromo = null;

function showMsg(el, ok, text){
  if (!el) return;
  el.style.display = 'block';
  el.classList.remove('ok','bad');
  el.classList.add(ok ? 'ok' : 'bad');
  el.textContent = text;
}
function hideMsg(el){ if(el) el.style.display='none'; }

async function computeIsAdmin(user){
  if (!user) return false;
  try{
    const token = await user.getIdTokenResult(true);
    if (token && token.claims && token.claims.admin === true) return true;
  }catch(e){}
  const email = (user.email || '').toLowerCase();
  return ADMIN_EMAILS.map(x=>String(x).toLowerCase()).includes(email);
}

function setAdminUI(isAdmin, user){
  // pills
  const pill = $('authPill');
  const badge = $('adminBadge');
  if (pill){
    if (user) pill.textContent = 'âœ… ' + (user.email || 'Autentificat');
    else pill.textContent = 'ğŸ”’ Neautentificat';
  }
  if (badge){
    badge.textContent = isAdmin ? 'â­ Admin activ' : (user ? 'User' : 'â€”');
  }

  // show/hide admin-only elements
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = isAdmin ? '' : 'none';
  });

  // login box is shown even if admin, but message changes
  const loginBox = $('loginBox');
  const adminForm = $('adminForm');
  if (loginBox && isAdmin){
    // keep it visible, but show a small hint
    const msg = $('adminLoginMsg');
    showMsg(msg, true, 'Autentificat ca admin. PoÈ›i adÄƒuga campanii din butoanele de sus.');
  }
  if (adminForm && !isAdmin){
    adminForm.style.display = 'none';
  }
}

async function adminSignIn(){
  try{
    if (!auth){ alert('Firebase Auth nu este Ã®ncÄƒrcat.'); return; }
    const email = (($('adminEmail')?.value)||'').trim();
    const pass = (($('adminPass')?.value)||'');
    const msg = $('adminLoginMsg');
    if (!email || !pass){ showMsg(msg, false, 'CompleteazÄƒ email È™i parolÄƒ.'); return; }
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged updates UI
  }catch(e){
    const msg = $('adminLoginMsg');
    showMsg(msg, false, 'Eroare autentificare: ' + (e?.message || e));
  }
}
async function adminSignOut(){
  try{ await auth?.signOut(); }catch(e){}
}

function openAdminForm(kind){
  const f = $('adminForm');
  if (f) f.style.display = 'block';
  if ($('promoType')) $('promoType').value = (kind === 'giveaway') ? 'giveaway' : 'promo';
  const t = $('adminFormTitle');
  if (t) t.textContent = (kind === 'giveaway') ? 'ğŸ AdaugÄƒ Giveaway' : 'â• AdaugÄƒ PromoÈ›ie';
  hideMsg($('adminSaveMsg'));
}
function closeAdminForm(){
  const f = $('adminForm');
  if (f) f.style.display = 'none';
  hideMsg($('adminSaveMsg'));
}

function safeName(name){
  return String(name || 'file').replace(/[^\w.\-]+/g, '_');
}

async function uploadToStorage(promoId, file, kind){
  if (!storage || !file) return null;
  const path = `promos/${promoId}/${kind}_${Date.now()}_${safeName(file.name)}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  return { url, path, contentType: file.type || 'application/octet-stream', name: safeName(file.name) };
}

function dateTimeLocalToMs(v){
  // v: "YYYY-MM-DDTHH:mm"
  const t = new Date(v).getTime();
  return Number.isFinite(t) ? t : 0;
}

function cleanText(s){ return String(s||'').trim(); }

function campaignValidate(payload){
  if (!payload.title) return 'CompleteazÄƒ titlul.';
  if (!payload.endAt || payload.endAt <= Date.now()) return 'CompleteazÄƒ o datÄƒ de expirare validÄƒ (Ã®n viitor).';
  if (!payload.rules) return 'CompleteazÄƒ regulamentul / condiÈ›iile.';
  // prizes at least P1
  if (!payload.prizes?.p1) return 'CompleteazÄƒ minim Premiul I.';
  return '';
}

async function saveCampaign(){
  const msg = $('adminSaveMsg');
  hideMsg(msg);

  if (!db || !auth?.currentUser){
    showMsg(msg, false, 'Nu eÈ™ti autentificat. LogheazÄƒ-te ca admin.');
    return;
  }
  const isAdmin = await computeIsAdmin(auth.currentUser);
  if (!isAdmin){
    showMsg(msg, false, 'Nu ai drepturi admin pentru a salva.');
    return;
  }

  const type = cleanText($('promoType')?.value || 'promo'); // promo|giveaway
  const endRaw = cleanText($('promoEnd')?.value || '');
  const endAt = dateTimeLocalToMs(endRaw);

  const payload = {
    type,
    title: cleanText($('promoTitle')?.value || ''),
    tagline: cleanText($('promoTagline')?.value || ''),
    endAt,
    endDate: endRaw || null,
    prizes: {
      p1: cleanText($('p1')?.value || ''),
      p2: cleanText($('p2')?.value || ''),
      p3: cleanText($('p3')?.value || ''),
      top5: cleanText($('pTop5')?.value || ''),
      next10: cleanText($('pNext10')?.value || '')
    },
    rules: cleanText($('promoRules')?.value || ''),
    ctaUrl: cleanText($('ctaUrl')?.value || ''),
    ctaText: cleanText($('ctaText')?.value || '') || 'ParticipÄƒ acum!',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdBy: auth.currentUser.uid,
    status: 'active',
    bg: null,
    banner: null
  };

  const vErr = campaignValidate(payload);
  if (vErr){ showMsg(msg, false, vErr); return; }

  const bgFile = $('bgFile')?.files?.[0] || null;
  const bannerFile = $('bannerFile')?.files?.[0] || null;

  try{
    showMsg(msg, true, 'Se salveazÄƒ campania...');

    // 1) create doc first
    const ref = await db.collection('promos').add(payload);

    // 2) uploads (optional) and update
    const updates = {};
    if (bgFile){
      try{
        updates.bg = await uploadToStorage(ref.id, bgFile, 'bg');
      }catch(e){
        console.warn('bg upload fail', e);
      }
    }
    if (bannerFile){
      try{
        updates.banner = await uploadToStorage(ref.id, bannerFile, 'banner');
      }catch(e){
        console.warn('banner upload fail', e);
      }
    }
    if (Object.keys(updates).length){
      await db.collection('promos').doc(ref.id).set(updates, { merge:true });
    }

    showMsg(msg, true, 'âœ… Salvat Ã®n Firestore + Storage. Cardul apare imediat Ã®n listÄƒ.');
    // reset a bit
    $('promoTitle').value = '';
    $('promoTagline').value = '';
    $('promoEnd').value = '';
    $('p1').value = '';
    $('p2').value = '';
    $('p3').value = '';
    $('pTop5').value = '';
    $('pNext10').value = '';
    $('promoRules').value = '';
    $('ctaUrl').value = '';
    $('ctaText').value = '';
    if ($('bgFile')) $('bgFile').value = '';
    if ($('bannerFile')) $('bannerFile').value = '';
  }catch(e){
    console.error('saveCampaign', e);
    showMsg(msg, false, 'âŒ Eroare la salvare (Firestore Rules pentru promos). AsigurÄƒ-te cÄƒ eÈ™ti logat cu email admin È™i rules permit write.');
  }
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"'`=\/]/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
  }[ch]));
}

function formatCountdown(ms){
  if (ms <= 0) return '0d 0h 0m';
  const m = Math.floor(ms/60000);
  const d = Math.floor(m/(60*24));
  const h = Math.floor((m - d*60*24)/60);
  const mm = m - d*60*24 - h*60;
  return `${d}d ${h}h ${mm}m`;
}

function promoBadge(p){
  const now = Date.now();
  const endAt = Number(p.endAt || 0);
  const live = endAt && endAt > now;
  return live ? {cls:'live', txt:'LIVE'} : {cls:'ended', txt:'EXPIRAT'};
}

function promoTypeLabel(type){
  const t = String(type||'promo');
  return (t === 'giveaway') ? 'ğŸ Giveaway' : 'âš¡ PromoÈ›ie';
}

function renderPromos(promos){
  const host = $('promoList');
  const empty = $('emptyState');
  if (!host) return;

  if (!Array.isArray(promos) || !promos.length){
    host.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  const now = Date.now();
  host.innerHTML = promos.map(p=>{
    const id = p._id;
    const badge = promoBadge(p);
    const endAt = Number(p.endAt||0);
    const left = endAt ? (endAt - now) : 0;

    // background
    let bgStyle = '';
    let bgClass = 'promo-bg';
    if (p.bg && p.bg.url){
      bgClass += ' has-img';
      const u = String(p.bg.url).replace(/["'()\\]/g,'');
      bgStyle = `background-image: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.74)), url(${u});`;
    }

    const title = escapeHtml(p.title || 'FÄƒrÄƒ titlu');
    const tagline = escapeHtml(p.tagline || '');
    const rules = escapeHtml(p.rules || '');
    const ctaText = escapeHtml(p.ctaText || 'ParticipÄƒ');
    const ctaUrl = (p.ctaUrl || '').trim();

    const prizes = p.prizes || {};
    const p1 = escapeHtml(prizes.p1 || '');
    const p2 = escapeHtml(prizes.p2 || '');
    const p3 = escapeHtml(prizes.p3 || '');
    const top5 = escapeHtml(prizes.top5 || '');
    const next10 = escapeHtml(prizes.next10 || '');

    const bannerHtml = (p.banner && p.banner.url)
      ? `<div style="margin-top:8px; border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.14);">
           <img src="${String(p.banner.url).replace(/["'()\\]/g,'')}" alt="" style="width:100%; height:140px; object-fit:cover; display:block;">
         </div>`
      : ``;

    const live = endAt && endAt > now;
    const when = p.endDate ? escapeHtml(p.endDate.replace('T',' ')) : (endAt ? new Date(endAt).toLocaleString('ro-RO') : 'â€”');

    const adminBtns = (window.__SBYT_ADMIN)
      ? `<button class="btn btn-ghost" style="padding:10px 12px;" onclick="deleteCampaign('${id}')">ğŸ—‘ï¸ È˜terge</button>`
      : ``;

    const ctaBtn = live
      ? `<button class="btn btn-primary" style="padding:11px 14px;" onclick="openJoin('${id}')">ğŸš€ ${ctaText}</button>`
      : `<button class="btn btn-ghost" style="padding:11px 14px;" disabled>Campanie Ã®nchisÄƒ</button>`;

    const linkHtml = (ctaUrl && live)
      ? `<a class="link" href="${escapeHtml(ctaUrl)}" target="_blank" rel="noopener">Link Ã®nregistrare</a>`
      : '';

    return `
      <div class="promo-card">
        <div class="${bgClass}" style="${bgStyle}"></div>
        <div class="promo-overlay"></div>

        <div class="promo-inner">
          <div class="promo-top">
            <div class="badge ${badge.cls}">
              <span>${promoTypeLabel(p.type)}</span>
              <span>â€¢</span>
              <span>${badge.txt}</span>
            </div>
            <div class="badge ${live?'live':'ended'}" title="Timp rÄƒmas">
              â³ ${live ? formatCountdown(left) : '0d 0h 0m'}
            </div>
          </div>

          <div>
            <div class="promo-title">${title}</div>
            ${tagline ? `<div class="promo-sub">${tagline}</div>` : ''}
          </div>

          ${bannerHtml}

          <div class="promo-meta">
            <span class="chip">ğŸ“… ExpirÄƒ: <b>${when}</b></span>
            <span class="chip">ğŸ¯ MecanicÄƒ: <b>referral + clasament</b></span>
          </div>

          <div class="promo-prizes">
            <div class="prize">
              <b>ğŸ† Premiul I</b>
              <div class="v">${p1 || 'â€”'}</div>
            </div>
            <div class="prize">
              <b>ğŸ¥ˆ Premiul II</b>
              <div class="v">${p2 || 'â€”'}</div>
            </div>
            <div class="prize">
              <b>ğŸ¥‰ Premiul III</b>
              <div class="v">${p3 || 'â€”'}</div>
            </div>
          </div>

          ${(top5 || next10) ? `
            <div class="promo-prizes" style="grid-template-columns: 1fr 1fr;">
              <div class="prize">
                <b>ğŸ”¥ Primele 5 locuri</b>
                <div class="v">${top5 || 'â€”'}</div>
              </div>
              <div class="prize">
                <b>âœ¨ UrmÄƒtoarele 10 locuri</b>
                <div class="v">${next10 || 'â€”'}</div>
              </div>
            </div>
          ` : ''}

          <div class="promo-sub" style="border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); padding:10px 12px; border-radius:18px;">
            <b style="color:rgba(255,255,255,.92)">ğŸ“œ Regulament (pe scurt)</b><br/>
            ${rules ? rules.slice(0, 320) + (rules.length>320?'â€¦':'') : 'â€”'}
          </div>

          <div class="cta-row">
            <div class="cta-left">
              <span>âœ… Participare rapidÄƒ</span>
              <span>â€¢</span>
              <span>ğŸ“© Cod dupÄƒ Ã®nscriere</span>
              ${linkHtml ? `<span>â€¢</span>${linkHtml}` : ''}
            </div>
            <div class="cta-right">
              ${adminBtns}
              ${ctaBtn}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

async function listenPromos(){
  const host = $('promoList');
  if (!db || !host) return;

  if (__promosUnsub){ try{ __promosUnsub(); }catch(e){} __promosUnsub = null; }

  __promosUnsub = db.collection('promos')
    .orderBy('createdAt','desc')
    .onSnapshot((snap)=>{
      const arr = [];
      snap.forEach(doc => arr.push({ _id: doc.id, ...doc.data() }));
      renderPromos(arr);
    }, (err)=>{
      console.error('promos listen', err);
      // show empty + error
      const empty = $('emptyState');
      if (empty){
        empty.style.display = 'block';
        empty.textContent = 'Nu pot citi campaniile (verificÄƒ Firestore Rules pentru read).';
      }
    });
}

async function deleteCampaign(promoId){
  try{
    if (!window.__SBYT_ADMIN){ alert('Doar admin poate È™terge.'); return; }
    if (!db) return;
    if (!confirm('È˜tergi aceastÄƒ campanie?')) return;

    // delete participants + promo doc (batch)
    const partSnap = await db.collection('promos').doc(promoId).collection('participants').get();
    const batch = db.batch();
    partSnap.forEach(d => batch.delete(d.ref));
    batch.delete(db.collection('promos').doc(promoId));
    await batch.commit();
  }catch(e){
    console.error('deleteCampaign', e);
    alert('Eroare la È™tergere (Rules).');
  }
}

/* ---------- Participate flow ---------- */

function openJoin(promoId){
  __activePromoId = promoId;
  // we'll fetch promo doc for full info
  openJoinModalLoading();
  fetchPromoForJoin(promoId);
}
function openJoinModalLoading(){
  $('joinModal')?.classList.add('open');
  hideMsg($('joinMsg'));
  $('joinTitle').textContent = 'ParticipÄƒ';
  $('joinInfo').textContent = 'Se Ã®ncarcÄƒ detaliile campaniei...';
  $('joinBtn').disabled = true;
}
function closeJoin(){
  $('joinModal')?.classList.remove('open');
  __activePromoId = null;
  __activePromo = null;
  // reset
  if ($('joinName')) $('joinName').value = '';
  if ($('joinEmail')) $('joinEmail').value = '';
  if ($('joinWallet')) $('joinWallet').value = '';
  if ($('joinReferral')) $('joinReferral').value = '';
  if ($('joinAgree')) $('joinAgree').checked = false;
  hideMsg($('joinMsg'));
}
async function fetchPromoForJoin(promoId){
  try{
    if (!db) throw new Error('Firestore missing');
    const doc = await db.collection('promos').doc(promoId).get();
    if (!doc.exists) throw new Error('Promo not found');
    const p = { _id: doc.id, ...doc.data() };
    __activePromo = p;

    const now = Date.now();
    const endAt = Number(p.endAt || 0);
    const live = endAt && endAt > now;

    $('joinTitle').textContent = (p.type === 'giveaway' ? 'ğŸ ParticipÄƒ la Giveaway' : 'âš¡ ParticipÄƒ la PromoÈ›ie');
    $('joinInfo').innerHTML = `
      <b>${escapeHtml(p.title || '')}</b><br>
      ${p.tagline ? `<span class="small">${escapeHtml(p.tagline)}</span><br>` : ''}
      <span class="small">â³ ${live ? 'Timp rÄƒmas: <b>'+formatCountdown(endAt-now)+'</b>' : '<b>Campanie expiratÃ£</b>'}</span><br>
      <span class="small">DupÄƒ Ã®nscriere primeÈ™ti un <b>cod unic</b>. DacÄƒ alÈ›ii folosesc codul tÄƒu ca <b>referral</b>, urci Ã®n clasament.</span>
    `;
    $('joinBtn').disabled = !live;
    if (!live){
      showMsg($('joinMsg'), false, 'Campania este expiratÄƒ. Nu se mai pot Ã®nregistra participanÈ›i.');
    }
  }catch(e){
    console.error('fetchPromoForJoin', e);
    $('joinInfo').textContent = 'Nu pot Ã®ncÄƒrca detaliile campaniei.';
    showMsg($('joinMsg'), false, 'Eroare: ' + (e?.message || e));
  }
}

function rid(){
  return (Date.now().toString(36) + Math.random().toString(36).slice(2,10)).toUpperCase();
}
function maskEmail(email){
  email = String(email||"").trim();
  const [u,d] = email.split("@");
  if(!u || !d) return email;
  const u2 = u.length<=2 ? (u[0]||"*")+"*" : u.slice(0,2)+"***";
  const d2 = d.replace(/(^.).*?(\..+$)/, "$1***$2");
  return `${u2}@${d2}`;
}

async function submitJoin(){
  const msg = $('joinMsg');
  hideMsg(msg);

  const promoId = __activePromoId;
  const promo = __activePromo;
  if (!promoId || !promo){
    showMsg(msg, false, 'Nu am identificat campania. Ãnchide È™i Ã®ncearcÄƒ din nou.');
    return;
  }

  const now = Date.now();
  const endAt = Number(promo.endAt || 0);
  if (!endAt || endAt <= now){
    showMsg(msg, false, 'Campania este expiratÄƒ.');
    $('joinBtn').disabled = true;
    return;
  }

  const email = cleanText($('joinEmail')?.value || '');
  const name = cleanText($('joinName')?.value || '');
  const wallet = cleanText($('joinWallet')?.value || '');
  const referral = cleanText($('joinReferral')?.value || '');
  const agree = !!$('joinAgree')?.checked;

  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email || !re.test(email)){
    showMsg(msg, false, 'Introdu un email valid.');
    return;
  }
  if (!agree){
    showMsg(msg, false, 'BifeazÄƒ acordul de contact/confirmare.');
    return;
  }

  if (!db){
    showMsg(msg, false, 'Firestore nu este Ã®ncÄƒrcat.');
    return;
  }

  // create participant
  const code = rid();
  const participant = {
    email,
    emailMasked: maskEmail(email),
    name: name || null,
    wallet: wallet || null,
    code,
    referral: referral || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    $('joinBtn').disabled = true;
    showMsg(msg, true, 'Se salveazÄƒ participarea...');

    await db.collection('promos').doc(promoId).collection('participants').add(participant);

    showMsg(msg, true, `âœ… Ãnscriere confirmatÄƒ! Codul tÄƒu: ${code}`);
    // optional: open mail client
    try{
      const subj = encodeURIComponent(`StancuBYT | Confirmare participare | ${promo.title || 'Campanie'}`);
      const body = encodeURIComponent(
        `Ai fost Ã®nscris/Äƒ la campania: ${promo.title || ''}\n\nCodul tÄƒu: ${code}\nReferral (dÄƒ codul prietenilor): ${code}\n\nSucces!\nâ€” StancuBYT`
      );
      window.location.href = `mailto:${email}?subject=${subj}&body=${body}`;
    }catch(e){}

  }catch(e){
    console.error('submitJoin', e);
    showMsg(msg, false, 'âŒ Eroare la Ã®nscriere (verificÄƒ Firestore Rules pentru participants).');
    $('joinBtn').disabled = false;
  }
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // auth listener
  try{
    auth?.onAuthStateChanged(async (user)=>{
      const isAdmin = await computeIsAdmin(user);
      window.__SBYT_ADMIN = isAdmin;
      setAdminUI(isAdmin, user);
    });
  }catch(e){}

  // start listening promos
  try{ listenPromos(); }catch(e){}
});
</script>
</body>
</html>
