<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StancuBYT | Giveaway & Promo»õii (Firestore /news)</title>

<style>
:root{
  --bg:#0a0a1f;
  --card:#14142b;
  --muted:#9aa0b4;
  --accent:#00ff88;
  --accent2:#00ffff;
  --danger:#ff4d4d;
  --gold: rgba(255,215,0,.18);
  --silver: rgba(192,192,192,.16);
  --bronze: rgba(205,127,50,.16);
}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg);color:#fff}
h1,h2,h3,h4{margin:0 0 10px}
p{margin:0 0 10px;color:rgba(255,255,255,.86)}
button{
  padding:10px 14px;border:none;border-radius:10px;cursor:pointer;
  background:var(--accent);font-weight:800;color:#001b12;
}
button.secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.12)}
button.danger{background:var(--danger);color:#fff}
input,textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
  background:#0f0f25;color:#fff;
}
textarea{min-height:90px;resize:vertical}
.section{max-width:1100px;margin:auto;padding:30px 20px}
.card{background:var(--card);padding:20px;border-radius:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,.08)}
.admin-only{display:none}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:18px}
.badge{
  display:inline-block;padding:4px 10px;border-radius:999px;
  background:rgba(0,255,136,.15);color:var(--accent);font-size:13px;font-weight:800;
  border:1px solid rgba(0,255,136,.18);
}
.badge.expired{background:rgba(255,77,77,.15);color:#ff7a7a;border-color:rgba(255,77,77,.22)}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0}
.table{width:100%;border-collapse:collapse;border-radius:14px;overflow:hidden}
.table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
.table th{background:rgba(255,255,255,.06);color:#fff}
.top1{background:var(--gold)}
.top2{background:var(--silver)}
.top3{background:var(--bronze)}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","CourierNew", monospace}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row > *{flex:1;min-width:180px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.err{color:#ff7a7a;font-weight:800}
.ok{color:#00ff88;font-weight:800}
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase config (din proiectul tƒÉu)
  const firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  // Admin UI gate (DOAR UI, rules-urile tale permit orice user logat sƒÉ scrie √Æn /news)
  const ADMIN_EMAILS = ["stancubyt@gmail.com"];
</script>
</head>

<body>

<div class="section">
  <h1>üéÅ Giveaway & Promo»õii StancuBYT</h1>
  <p class="small">‚úÖ Sincronizare pe toate dispozitivele folosind Firestore √Æn colec»õia <b>/news</b> (compatibil cu rules-urile tale).</p>

  <div id="visitBox" class="small"></div>
  <div id="dbStatus" class="small"></div>

  <div class="actions" style="margin:14px 0 6px">
    <button class="admin-only" onclick="showPromoForm()">‚ûï AdaugƒÉ promo»õie / concurs</button>
    <button class="admin-only secondary" onclick="deleteAllPromosConfirm()">üßπ »òterge toate promo»õiile</button>
  </div>

  <!-- FORM ADMIN -->
  <div id="promoForm" class="card admin-only" style="display:none">
    <h3>AdaugƒÉ promo»õie / concurs</h3>
    <div class="row">
      <input id="pTitle" placeholder="Titlu (ex: Giveaway SBYT)">
      <input type="date" id="pEnd">
    </div>
    <div class="row" style="margin-top:10px">
      <input id="pPrize" placeholder="Premiu (op»õional)">
      <input id="pPointsDefault" type="number" min="0" step="1" value="10" placeholder="Puncte implicite">
    </div>
    <div style="margin-top:10px">
      <textarea id="pDesc" placeholder="Descriere / reguli"></textarea>
    </div>

    <div class="actions" style="margin-top:12px">
      <button onclick="savePromo()">üíæ SalveazƒÉ</button>
      <button class="danger" onclick="cancelPromo()">‚ùå AnuleazƒÉ</button>
    </div>
    <div class="small" style="margin-top:10px">
      * Promo»õiile + √Ænscrierile se salveazƒÉ √Æn colec»õia <b>/news</b>.
    </div>
  </div>

  <!-- LISTA PROMO -->
  <div id="promoList" class="grid"></div>

  <!-- CLASAMENTE PE PROMO»öII -->
  <div class="card">
    <h3>üèÜ Clasamente pe promo»õii</h3>
    <div class="small">Top participan»õi pentru fiecare promo»õie (real-time).</div>
    <div id="allLeaderboards" style="margin-top:12px"></div>
  </div>
</div>

<!-- ADMIN LOGIN -->
<div class="section card">
  <h2>üîê Administrator</h2>
  <div class="row">
    <input id="adminEmail" placeholder="Email admin" autocomplete="username">
    <input id="adminPass" type="password" placeholder="ParolƒÉ" autocomplete="current-password">
  </div>
  <div class="actions" style="margin-top:12px">
    <button onclick="adminSignIn()">Autentificare</button>
    <button onclick="adminSignOut()" id="logoutBtn" class="secondary" style="display:none">Delogare</button>
  </div>
  <p id="adminMsg" class="small" style="margin-top:10px"></p>
</div>

<script>
/* ===================== HELPERS ===================== */
function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
  }[s]));
}
function maskWallet(w){
  const s = String(w||"");
  if(s.length <= 12) return s;
  return s.slice(0,6) + "..." + s.slice(-4);
}
function isAdminUser(user){
  if(!user || !user.email) return false;
  return ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(user.email.toLowerCase());
}
function setDbStatus(ok, msg){
  const el = document.getElementById("dbStatus");
  if(!el) return;
  el.innerHTML = ok ? `<span class="ok">‚úî ${escapeHtml(msg)}</span>` : `<span class="err">‚úñ ${escapeHtml(msg)}</span>`;
}
function nowMs(){ return Date.now(); }

/* ===================== VISITS (stats/visits) ===================== */
async function bumpVisits(){
  try{
    const ref = db.collection("stats").doc("visits");
    await ref.set({ count: firebase.firestore.FieldValue.increment(1), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    ref.onSnapshot(s=>{
      const d = s.data() || {};
      const c = Number(d.count||0);
      document.getElementById("visitBox").innerHTML = `üëÅÔ∏è Vizite: <b>${c.toLocaleString("ro-RO")}</b>`;
    });
  }catch(e){
    console.warn("visits error:", e);
  }
}
bumpVisits();

/* ===================== AUTH ===================== */
window.IS_ADMIN = false;

auth.onAuthStateChanged(user=>{
  const adminOk = isAdminUser(user);
  window.IS_ADMIN = !!adminOk;

  // show/hide admin elements
  document.querySelectorAll('.admin-only')
    .forEach(e=>e.style.display = adminOk ? 'block' : 'none');
  document.querySelectorAll('.actions .admin-only')
    .forEach(e=>e.style.display = adminOk ? 'inline-flex' : 'none');

  document.getElementById('logoutBtn').style.display = user ? 'inline-flex' : 'none';
  document.getElementById('adminMsg').textContent = user
    ? (adminOk ? `Logat admin: ${user.email}` : `Logat (NU admin): ${user.email}`)
    : 'Neautentificat';

  setDbStatus(true, "Conectat. √éncarc promo»õiile din /news ...");
});

/* ===================== LOGIN ===================== */
function adminSignIn(){
  const email = adminEmail.value.trim();
  const pass = adminPass.value;
  if(!email || !pass){ alert("CompleteazƒÉ email »ôi parolƒÉ"); return; }

  auth.signInWithEmailAndPassword(email, pass)
    .then(()=>{ adminPass.value = ""; })
    .catch(e=>alert("Autentificare e»ôuatƒÉ: " + e.message));
}
function adminSignOut(){ auth.signOut(); }

/* ===================== ADMIN FORM ===================== */
function showPromoForm(){ promoForm.style.display="block"; }
function cancelPromo(){
  promoForm.style.display="none";
  pTitle.value=""; pEnd.value=""; pDesc.value=""; pPrize.value="";
  pPointsDefault.value = 10;
}

/* ===================== MODEL (√Æn /news) =====================

/news/{id} pentru promo»õii:
  type: "promo"
  title, end, desc, prize, pointsDefault
  createdAt, createdBy

/news/{id} pentru √Ænscrieri:
  type: "entry"
  promoId: "<id promo>"
  name, wallet, walletLower, points
  joinedAt

===================================================== */

async function savePromo(){
  if(!window.IS_ADMIN){ alert("Doar admin poate adƒÉuga."); return; }
  if(!auth.currentUser){ alert("Trebuie sƒÉ fii logat (rules)."); return; }

  const title = (pTitle.value || "").trim();
  const end = (pEnd.value || "").trim();
  const desc = (pDesc.value || "").trim();
  const prize = (pPrize.value || "").trim();
  const pointsDefault = Math.max(0, parseInt(pPointsDefault.value || "0", 10) || 0);

  if(!title || !end || !desc){
    alert("CompleteazƒÉ titlu, data »ôi descriere.");
    return;
  }

  try{
    await db.collection("news").add({
      type: "promo",
      title, end, desc, prize, pointsDefault,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: auth.currentUser.email || null
    });
    cancelPromo();
  }catch(e){
    console.error(e);
    alert("Eroare la salvare (rules?): " + (e.message || e));
  }
}

async function deletePromo(promoId){
  if(!window.IS_ADMIN){ alert("Doar admin (UI)."); return; }
  if(!auth.currentUser){ alert("Trebuie sƒÉ fii logat."); return; }

  if(!confirm("»òtergi aceastƒÉ promo»õie? (√énscrierile rƒÉm√¢n √Æn /news ca entry. Pot sƒÉ le »ôterg »ôi pe ele dacƒÉ vrei.)")) return;

  try{
    await db.collection("news").doc(promoId).delete();
  }catch(e){
    console.error(e);
    alert("Eroare la »ôtergere: " + (e.message || e));
  }
}

async function deleteAllPromosConfirm(){
  if(!window.IS_ADMIN){ alert("Doar admin (UI)."); return; }
  if(!auth.currentUser){ alert("Trebuie sƒÉ fii logat."); return; }
  if(!confirm("Sigur »ôtergi TOATE promo»õiile?")) return;

  try{
    const snap = await db.collection("news").where("type","==","promo").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("Promo»õiile au fost »ôterse (doar type=promo).");
  }catch(e){
    console.error(e);
    alert("Eroare: " + (e.message || e));
  }
}

/* ===================== PARTICIPARE ===================== */
async function joinPromo(promoId){
  const name = (document.getElementById("jn_"+promoId).value || "").trim();
  const wallet = (document.getElementById("jw_"+promoId).value || "").trim();
  const ptsRaw = (document.getElementById("jp_"+promoId).value || "").trim();

  if(!name || !wallet){
    alert("CompleteazƒÉ nume »ôi wallet.");
    return;
  }

  if(!auth.currentUser){
    alert("Pentru √Ænscriere trebuie autentificare (rules: news write doar auth != null).");
    return;
  }

  const walletLower = wallet.toLowerCase();

