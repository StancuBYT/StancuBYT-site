<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Giveaway & PromoÈ›ii</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    :root{
      --blue-tech:#0066ff;
      --green-growth:#00ff88;
      --purple-innov:#8a2be2;
      --neon-cyan:#00ffff;
      --dark-bg:#0a0a1f;
      --darker-bg:#050510;
      --orange-alert:#ff9500;
      --danger:#ff4d4d;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family: Arial, sans-serif;}
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,102,255,0.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(0,255,136,0.14), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(138,43,226,0.12), transparent 60%),
        linear-gradient(180deg, var(--darker-bg), var(--dark-bg));
      color:#fff;
      padding: 26px 14px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:16px 16px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      position:sticky;top:12px;backdrop-filter: blur(8px);
      z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:40px;height:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
    .brand .t1{font-weight:900;letter-spacing:0.5px;}
    .brand .t2{font-size:12px;opacity:0.8;margin-top:2px;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,0.25);
      font-size:12px;opacity:0.92;
    }
    .chip b{font-weight:800;}
    .btn{
      cursor:pointer;border:none;
      padding:11px 14px;border-radius:12px;
      background:linear-gradient(45deg, var(--blue-tech), var(--green-growth));
      color:#001018;font-weight:900;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:hover{transform: translateY(-1px);filter:brightness(1.05);}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      border:1px solid var(--border);
      color:#fff;font-weight:800;
    }
    .btn.danger{
      background:rgba(255,77,77,0.14);
      border:1px solid rgba(255,77,77,0.35);
      color:#fff;
    }
    .hero{
      text-align:center;
      padding: 28px 10px 10px;
    }
    h1{
      font-size: 2.3rem;
      background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan), var(--purple-innov));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle{opacity:0.85;line-height:1.5;max-width:860px;margin:0 auto;}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      margin-top: 18px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      padding:16px;
      overflow:hidden;
      position:relative;
    }
    .card.has-bg::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.80));
      z-index:0;
    }
    .card > *{position:relative;z-index:1;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;font-weight:900;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      margin-bottom:10px;
    }
    .badge.live{border-color:rgba(0,255,136,0.35);background:rgba(0,255,136,0.10);}
    .badge.dead{border-color:rgba(255,77,77,0.35);background:rgba(255,77,77,0.10);}
    .meta{display:flex;flex-wrap:wrap;gap:10px;opacity:0.9;margin-top:10px;font-size:13px;}
    .meta span{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid var(--border);}
    .kicker{font-weight:900;color:var(--neon-cyan);margin-bottom:8px;}
    .title{font-weight:950;font-size:1.2rem;margin-bottom:6px;}
    .text{opacity:0.9;line-height:1.5;white-space:pre-wrap;}
    .divider{height:1px;background:rgba(255,255,255,0.12);margin:12px 0;}
    .form{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,0.05);
      padding:16px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .row.one{grid-template-columns:1fr;}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#fff;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;}
    label{font-size:12px;opacity:0.85;}
    small.help{display:block;margin-top:8px;opacity:0.75;line-height:1.35;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .admin-login{
      margin-top: 20px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.28);
    }
    .admin-login h2{font-size:1.2rem;margin-bottom:8px;}
    .admin-desc{opacity:0.85;line-height:1.4;margin-bottom:10px;}
    .admin-login-box{display:flex;gap:10px;flex-wrap:wrap;}
    .admin-login-box input{flex:1;min-width:230px;}
    .admin-status-row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;}
    .admin-badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:12px;}
    .admin-badge-on{background:rgba(0,255,156,0.12);border-color:rgba(0,255,156,0.35);}
    .admin-badge-off{background:rgba(255,77,77,0.10);border-color:rgba(255,77,77,0.35);}
    .admin-user-label{opacity:0.85;font-size:12px;}
    .admin-msg{margin-top:10px;font-size:13px;}
    .admin-only{display:none;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      font-size:12px;opacity:0.9;
    }
    .img-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .img-strip img{height:44px;width:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border);opacity:0.95;}
    .rulebox{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,0.22);opacity:0.92;}
  </style>

  <script>
    // EXACT ca in "index prezentare ok.html"
    window.firebaseConfig = {
      apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
      authDomain: "stancubyt-fc2b9.firebaseapp.com",
      projectId: "stancubyt-fc2b9",
      storageBucket: "stancubyt-fc2b9.firebasestorage.app",
      messagingSenderId: "263244200492",
      appId: "1:263244200492:web:28adf253b726cfdafaaf89",
      measurementId: "G-272S9HSY3K"
    };
    try{
      if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
    }catch(e){ console.warn("Firebase init warning:", e); }
  </script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="StancuBYT">
        <div>
          <div class="t1">StancuBYT</div>
          <div class="t2">Giveaway & PromoÈ›ii</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <span class="chip"><span>ğŸ”’</span><b id="topAuth">Neautentificat</b></span>
        <a class="btn secondary" href="https://stancubyt.com" target="_blank" rel="noreferrer">ğŸŒ Website</a>
      </div>
    </div>

    <div class="hero">
      <h1>Giveaway & PromoÈ›ii</h1>
      <div class="subtitle">
        CreeazÄƒ campanii atractive (promoÈ›ii) È™i concursuri cu clasament (giveaway). ParticipanÈ›ii se Ã®nscriu public, iar tu gestionezi totul din panoul admin.
      </div>

      <div class="actions admin-only" style="justify-content:center; margin-top:14px;">
        <button class="btn" type="button" onclick="openPromoForm('promo')">â• AdaugÄƒ PromoÈ›ie</button>
        <button class="btn secondary" type="button" onclick="openPromoForm('giveaway')">ğŸ† AdaugÄƒ Concurs / Giveaway</button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <span class="pill">âš¡ Gamification: puncte, top, praguri</span>
        <span class="pill">ğŸ§  Marketing: hook + urgenÈ›Äƒ + premii pe niveluri</span>
        <span class="pill">ğŸ¨ Vizual: banner + fundaluri</span>
      </div>
    </div>

    <div class="card">
      <div class="kicker">ğŸ“Œ PromoÈ›ii / Giveaway-uri</div>
      <div id="promoList" class="grid"></div>

      <div id="promoForm" class="form admin-only" style="display:none;">
        <div class="kicker">âœ¨ CreeazÄƒ promoÈ›ie / concurs</div>

        <div class="row">
          <div>
            <label>Tip</label>
            <select id="promoKind">
              <option value="promo">ğŸ“£ PromoÈ›ie</option>
              <option value="giveaway">ğŸ Concurs / Giveaway</option>
            </select>
          </div>
          <div>
            <label>Data & ora expirÄƒrii</label>
            <input id="promoEnds" type="datetime-local">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Titlu</label>
            <input id="promoTitle" type="text" maxlength="120" placeholder="Ex: Giveaway SBYT â€” 7 zile + premii pe niveluri">
          </div>
          <div>
            <label>Puncte / acÈ›iune (gamification)</label>
            <input id="promoPoints" type="number" min="1" step="1" value="10" placeholder="Ex: 10">
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Hook (1â€“2 fraze, mesaj scurt de impact)</label>
            <textarea id="promoHook" rows="2" placeholder="Ex: IntrÄƒ Ã®n TOP 5 È™i cÃ¢È™tigÄƒ bonusuri! Fiecare share = +10 puncte."></textarea>
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Descriere (beneficiu + cum funcÈ›ioneazÄƒ)</label>
            <textarea id="promoDesc" placeholder="Ex: ParticipÄƒ, strÃ¢nge puncte È™i intrÄƒ Ã®n clasament. La final, primele locuri primesc premii, iar participanÈ›ii activi primesc bonusuri."></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kicker">ğŸ¨ Vizual (banner + imagini de fundal)</div>
        <div class="row">
          <div>
            <label>Banner (recomandat)</label>
            <input id="promoBanner" type="file" accept="image/*">
          </div>
          <div>
            <label>Imagini fundal (max 3 recomandat)</label>
            <input id="promoBg" type="file" accept="image/*" multiple>
          </div>
        </div>
        <small class="help">DacÄƒ upload-ul Ã®n Storage e blocat de rules, promoÈ›ia se salveazÄƒ fÄƒrÄƒ imagini (poÈ›i adÄƒuga ulterior).</small>

        <div class="divider"></div>

        <div class="kicker">ğŸ† Premii (distribuÈ›ie atractivÄƒ)</div>
        <div class="row">
          <div><label>Premiul I</label><input id="prize1" type="text" maxlength="180" placeholder="Ex: 10.000 SBYT + rol VIP"></div>
          <div><label>Premiul II</label><input id="prize2" type="text" maxlength="180" placeholder="Ex: 5.000 SBYT"></div>
        </div>
        <div class="row">
          <div><label>Premiul III</label><input id="prize3" type="text" maxlength="180" placeholder="Ex: 2.500 SBYT"></div>
          <div><label>Primele 5 locuri (dupÄƒ podium)</label><input id="prizeTop5" type="text" maxlength="180" placeholder="Ex: 500 SBYT fiecare"></div>
        </div>
        <div class="row">
          <div><label>UrmÄƒtoarele 10 locuri</label><input id="prizeNext10" type="text" maxlength="180" placeholder="Ex: 200 SBYT fiecare"></div>
          <div><label>Bonus participare / surprizÄƒ</label><input id="prizeBonus" type="text" maxlength="180" placeholder="Ex: 50 SBYT pentru cei cu min. 3 acÈ›iuni"></div>
        </div>

        <div class="divider"></div>

        <div class="kicker">ğŸ“œ Regulament & condiÈ›ii</div>
        <div class="row one">
          <div>
            <label>Regulament (clar, pe paÈ™i)</label>
            <textarea id="promoRules" placeholder="Ex:
1) IntrÄƒ pe Telegram
2) UrmÄƒreÈ™te Twitter
3) Trimite wallet-ul
4) Fiecare share = +10 puncte
NotÄƒ: o singurÄƒ Ã®nscriere per wallet."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="promoSaveBtn" class="btn" type="button" onclick="savePromo()">ğŸ’¾ SalveazÄƒ</button>
          <button class="btn secondary" type="button" onclick="cancelPromo()">âŒ AnuleazÄƒ</button>
        </div>

        <small class="help">
          SalveazÄƒ Ã®n Firestore: <b>promos</b> (È™i subcolecÈ›ie <b>participants</b>). Scrierea necesitÄƒ autentificare admin.
        </small>
      </div>
    </div>

    <div class="admin-login" id="admin-login">
      <h2>ğŸ” Administrator Login</h2>
      <p class="admin-desc">
        Autentificare (Firebase Auth) necesarÄƒ pentru adÄƒugare/È™tergere concursuri È™i promoÈ›ii.
        Pentru ca salvarea Ã®n Firestore sÄƒ funcÈ›ioneze, contul logat trebuie sÄƒ fie permis de Firestore Rules (de obicei <b>stancubyt@gmail.com</b>).
      </p>

      <div class="admin-login-box">
        <input type="email" id="adminEmail" placeholder="Email administrator" autocomplete="username">
        <input type="password" id="adminPass" placeholder="Parola administrator" autocomplete="current-password">
        <button class="btn" type="button" onclick="adminSignIn()">Autentificare</button>
        <button class="btn secondary" type="button" onclick="adminSignOut()" id="adminLogoutBtn" style="display:none;">Delogare</button>
      </div>

      <div class="admin-status-row">
        <span id="adminStatusBadge" class="admin-badge admin-badge-off">Neautentificat</span>
        <span id="adminUserLabel" class="admin-user-label"></span>
      </div>

      <p id="adminLoginMsg" class="admin-msg"></p>
    </div>

  </div>

<script>
(function(){
  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"'`=\/]/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;','\\':'&#92;'
  }[ch]||ch));

  const ADMIN_EMAIL = "stancubyt@gmail.com"; // EXACT ca in prezentare ok.html (overrides)
  let __unsubPromos = null;

  const auth = ()=> (window.firebase && firebase.auth) ? firebase.auth() : null;
  const fs = ()=> (window.firebase && firebase.firestore) ? firebase.firestore() : null;
  const st = ()=> (window.firebase && firebase.storage) ? firebase.storage() : null;

  function maskEmail(email){
    if(!email) return "";
    const [u,d] = String(email).split("@");
    if(!d) return email;
    const u2 = u.length<=2 ? (u[0]+"*") : (u.slice(0,2) + "*".repeat(Math.min(8,u.length-2)));
    return `${u2}@${d}`;
  }

  function isAdminUser(user){
    return !!(user && user.email && String(user.email).toLowerCase() === ADMIN_EMAIL.toLowerCase());
  }

  function setAdminUI(isAdmin, user){
    const badge = $("adminStatusBadge");
    const label = $("adminUserLabel");
    const msg = $("adminLoginMsg");
    const logoutBtn = $("adminLogoutBtn");
    const topAuth = $("topAuth");

    if(topAuth) topAuth.textContent = user ? (isAdmin ? "Admin activ" : "Autentificat") : "Neautentificat";

    if (badge){
      badge.classList.remove("admin-badge-on","admin-badge-off");
      badge.classList.add(isAdmin ? "admin-badge-on" : "admin-badge-off");
      badge.textContent = isAdmin ? "Autentificat (Admin)" : (user ? "Autentificat (fÄƒrÄƒ admin)" : "Neautentificat");
    }
    if (label) label.textContent = user ? `User: ${maskEmail(user.email||"")}` : "";
    if (logoutBtn) logoutBtn.style.display = user ? "inline-block" : "none";

    if (msg){
      msg.style.color = isAdmin ? "#00ff9c" : "#ff4d4d";
      msg.textContent = user
        ? (isAdmin ? "Mod administrator activ." : `Autentificat, dar fÄƒrÄƒ drepturi admin. (NecesitÄƒ: ${ADMIN_EMAIL})`)
        : "AutentificÄƒ-te cu email + parola (Firebase).";
    }

    document.querySelectorAll(".admin-only").forEach(el=>{
      el.style.display = isAdmin ? "flex" : "none";
      if(el.id === "promoForm") el.style.display = (isAdmin && el.style.display!=="none" && el.getAttribute("data-open")==="1") ? "block" : "none";
    });

    // admin-only in card (form) uses block
    const form = $("promoForm");
    if(form && isAdmin){
      // keep form visibility as set by openPromoForm/cancelPromo
    }else if(form){
      form.style.display = "none";
      form.setAttribute("data-open","0");
    }
  }

  // ===== Auth (1:1, functional) =====
  window.adminSignIn = async function(){
    try{
      const a = auth();
      if(!a) return alert("Firebase Auth nu este incarcat.");
      const emailRaw = ($("adminEmail")?.value || "").trim();
      const email = emailRaw.replace(/\s+/g,"");
      const pass = ($("adminPass")?.value || "");
      const msg = $("adminLoginMsg");

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if(!emailOk){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Email invalid. Scrie ex: stancubyt@gmail.com"; }
        return;
      }
      if(!pass){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Completeaza parola."; }
        return;
      }
      await a.signInWithEmailAndPassword(email, pass);
      if(msg){ msg.style.color="#00ff9c"; msg.textContent="Autentificare reusita."; }
    }catch(e){
      const msg = $("adminLoginMsg");
      if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Eroare autentificare: "+(e?.message||e); }
      console.error("adminSignIn error:", e);
    }
  };

  window.adminSignOut = async function(){
    try{
      const a = auth();
      if(!a) return;
      await a.signOut();
    }catch(e){
      console.error("adminSignOut:", e);
    }
  };

  window.ensureAdminAuth = async function(){
    const a = auth();
    if(!a || !a.currentUser){
      alert("Trebuie sa fii logat ca admin (Firebase).");
      const el = $("admin-login"); if(el) el.scrollIntoView({behavior:"smooth"});
      return false;
    }
    const email = (a.currentUser.email||"").toLowerCase();
    if(email !== ADMIN_EMAIL.toLowerCase()){
      alert("Contul logat nu are drepturi de administrator.");
      return false;
    }
    return true;
  };

  // ===== Promo form open/close =====
  window.openPromoForm = function(kind){
    const form = $("promoForm");
    if(!form) return;
    form.style.display = "block";
    form.setAttribute("data-open","1");
    if(kind) ($("promoKind").value = kind);
    form.scrollIntoView({behavior:"smooth", block:"start"});
  };
  window.cancelPromo = function(){
    const form = $("promoForm");
    if(form){ form.style.display = "none"; form.setAttribute("data-open","0"); }
    ["promoTitle","promoEnds","promoHook","promoDesc","promoRules","prize1","prize2","prize3","prizeTop5","prizeNext10","prizeBonus"].forEach(id=>{
      const el=$(id); if(el) el.value="";
    });
    const pts=$("promoPoints"); if(pts) pts.value="10";
    const b=$("promoBanner"); if(b) b.value="";
    const bg=$("promoBg"); if(bg) bg.value="";
  };

  // ===== Storage upload (safe, doesn't block save) =====
  async function uploadMedia(file){
    if(!file) return "";
    const storage = st();
    if(!storage) return "";
    const safeName = (file.name || "img").replace(/[^\w.\-]+/g, "_");
    // folosim folderul "news/" exact ca in prezentare ok.html (rules deja pregatite)
    const path = "news/" + Date.now() + "_" + safeName;
    const ref = storage.ref().child(path);
    try{
      const task = ref.put(file);
      await Promise.race([task, new Promise((_,rej)=>setTimeout(()=>rej(new Error("upload-timeout")), 8000))]);
      return await ref.getDownloadURL();
    }catch(e){
      console.warn("uploadMedia failed:", e);
      return "";
    }
  }

  function parseEndsToMs(value){
    // value = "YYYY-MM-DDTHH:MM"
    if(!value) return null;
    const ms = Date.parse(value);
    if(Number.isNaN(ms)) return null;
    return ms;
  }

  // ===== Firestore (promos) =====
  async function renderPromos(items){
    const list = $("promoList");
    if(!list) return;
    list.innerHTML = "";

    if(!items.length){
      list.innerHTML = '<div style="opacity:0.85;">Nu existÄƒ promoÈ›ii/concursuri Ã®ncÄƒ.</div>';
      return;
    }

    const now = Date.now();

    for(const p of items){
      const endsAtMs = Number(p.endsAtMs || 0);
      const expired = endsAtMs ? (now > endsAtMs) : false;

      const card = document.createElement("div");
      card.className = "card";

      // fundal din prima imagine bg (daca exista)
      try{
        const bg = Array.isArray(p.bgUrls) && p.bgUrls[0] ? String(p.bgUrls[0]) : "";
        if(bg){
          card.classList.add("has-bg");
          const safeUrl = bg.replace(/["'()\\]/g,"");
          card.style.backgroundImage = `linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.80)), url(${safeUrl})`;
          card.style.backgroundSize = "cover";
          card.style.backgroundPosition = "center";
        }
      }catch(e){}

      const kind = (p.kind || "promo") === "giveaway" ? "ğŸ Concurs / Giveaway" : "ğŸ“£ PromoÈ›ie";
      const status = expired ? "Expirat" : "Activ";
      const endStr = endsAtMs ? new Date(endsAtMs).toLocaleString("ro-RO", {year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}) : "â€”";

      const prizes = p.prizes || {};
      const prizeLines = [
        prizes.p1 ? `ğŸ¥‡ ${esc(prizes.p1)}` : "",
        prizes.p2 ? `ğŸ¥ˆ ${esc(prizes.p2)}` : "",
        prizes.p3 ? `ğŸ¥‰ ${esc(prizes.p3)}` : "",
        prizes.top5 ? `â­ Top 5: ${esc(prizes.top5)}` : "",
        prizes.next10 ? `ğŸ¯ Urm. 10: ${esc(prizes.next10)}` : "",
        prizes.bonus ? `ğŸ Bonus: ${esc(prizes.bonus)}` : "",
      ].filter(Boolean);

      const hook = (p.hook || "").trim();
      const desc = (p.desc || "").trim();
      const rules = (p.rules || "").trim();

      const bannerUrl = (p.bannerUrl || "").trim();
      const bgUrls = Array.isArray(p.bgUrls) ? p.bgUrls.slice(0,6) : [];

      card.innerHTML = `
        <div class="badge ${expired ? "dead":"live"}">${expired ? "â›”":"âœ…"} ${status} â€¢ ${kind}</div>
        <div class="title">${esc(p.title || "FÄƒrÄƒ titlu")}</div>
        ${hook ? `<div class="rulebox" style="margin-top:10px;"><b>Hook:</b> ${esc(hook)}</div>` : ""}
        ${desc ? `<div class="text" style="margin-top:10px;">${esc(desc)}</div>` : ""}
        <div class="meta">
          <span>â³ ExpirÄƒ: <b>${esc(endStr)}</b></span>
          <span>âš¡ Puncte/acÈ›iune: <b>${esc(p.points || 10)}</b></span>
        </div>

        ${bannerUrl ? `<div class="img-strip"><img src="${esc(bannerUrl)}" alt="banner"></div>` : ""}
        ${bgUrls.length ? `<div class="img-strip">${bgUrls.map(u=>`<img src="${esc(u)}" alt="bg">`).join("")}</div>` : ""}

        ${prizeLines.length ? `<div class="divider"></div><div class="kicker">Premii</div><div class="text">${prizeLines.join("\n")}</div>` : ""}

        ${rules ? `<div class="divider"></div><div class="kicker">Regulament</div><div class="text">${esc(rules)}</div>` : ""}

        <div class="divider"></div>
        <div class="kicker">Ãnscriere</div>
        <div class="row">
          <input type="text" id="joinName_${esc(p._id)}" placeholder="Nume" maxlength="80">
          <input type="email" id="joinEmail_${esc(p._id)}" placeholder="Email" maxlength="120">
        </div>
        <div class="row">
          <input type="text" id="joinWallet_${esc(p._id)}" placeholder="Wallet (0x...)" maxlength="64">
          <button class="btn ${expired?'secondary':''}" ${expired?'disabled':''} type="button" style="min-height:44px;" onclick="joinPromo('${esc(p._id)}')">âœ… Ãnscrie-te</button>
        </div>
        <small class="help">DupÄƒ Ã®nscriere primeÈ™ti un cod (ID) È™i se deschide emailul de confirmare.</small>

        <div class="actions" style="justify-content:flex-end;">
          <button class="btn danger admin-only" type="button" onclick="deletePromo('${esc(p._id)}')">ğŸ—‘ï¸ È˜terge</button>
        </div>

        <div id="participants_${esc(p._id)}" style="margin-top:10px;"></div>
      `;

      list.appendChild(card);

      // render participants list
      try{
        await renderParticipants(p._id);
      }catch(e){}
    }

    // show admin-only inside cards too
    const a = auth();
    const isAdmin = isAdminUser(a && a.currentUser ? a.currentUser : null);
    if(isAdmin){
      document.querySelectorAll(".admin-only").forEach(el=>{
        // keep main form display managed elsewhere
        if(el.id !== "promoForm") el.style.display = "inline-flex";
      });
    }
  }

  async function renderParticipants(promoId){
    const db = fs();
    if(!db) return;
    const box = $("participants_"+promoId);
    if(!box) return;

    const snap = await db.collection("promos").doc(promoId).collection("participants").orderBy("createdAtMs","desc").limit(20).get();
    const items=[];
    snap.forEach(d=>items.push({id:d.id, ...d.data()}));

    if(!items.length){
      box.innerHTML = '<div style="opacity:0.75;">ÃncÄƒ nu sunt Ã®nscrieri.</div>';
      return;
    }

    const rows = items.map((it, idx)=>{
      const nm = esc(it.name||"");
      const em = esc(it.email||"");
      const w = esc(it.wallet||"");
      const code = esc(it.code||it.id||"");
      return `<div style="padding:8px 10px;border:1px solid rgba(255,255,255,0.12);border-radius:12px;background:rgba(0,0,0,0.22);margin-top:8px;">
        <b>#${idx+1}</b> ${nm} â€¢ <span style="opacity:0.85;">${em}</span><br>
        <span style="opacity:0.8;font-family:monospace;">${w}</span><br>
        <span class="pill" style="margin-top:6px;">Cod: <b>${code}</b></span>
      </div>`;
    }).join("");

    box.innerHTML = `<div style="font-weight:900; margin-top:10px;">ParticipanÈ›i (ultimii 20)</div>${rows}`;
  }

  async function listenPromos(){
    const db = fs();
    if(!db) return;
    if(__unsubPromos){ try{__unsubPromos();}catch(e){} __unsubPromos=null; }
    __unsubPromos = db.collection("promos").orderBy("createdAtMs","desc").limit(50).onSnapshot(async (snap)=>{
      const items=[];
      snap.forEach(doc=>items.push({_id:doc.id, ...doc.data()}));
      await renderPromos(items);
    }, (err)=>{
      console.error("promos listen:", err);
      const list = $("promoList");
      if(list) list.innerHTML = '<div style="opacity:0.85;">Eroare la Ã®ncÄƒrcare promoÈ›ii. VerificÄƒ consola.</div>';
    });
  }

  // ===== CRUD =====
  window.savePromo = async function(){
    const ok = await window.ensureAdminAuth();
    if(!ok) return;

    const db = fs();
    if(!db) return alert("Firestore indisponibil.");

    const saveBtn = $("promoSaveBtn");
    if(saveBtn){ saveBtn.disabled = true; saveBtn.textContent = "Se salveazÄƒ..."; }

    try{
      const kind = ($("promoKind")?.value || "promo").trim();
      const title = ($("promoTitle")?.value || "").trim();
      const endsVal = ($("promoEnds")?.value || "").trim();
      const points = Number(($("promoPoints")?.value || "10"));
      const hook = ($("promoHook")?.value || "").trim();
      const desc = ($("promoDesc")?.value || "").trim();
      const rules = ($("promoRules")?.value || "").trim();

      if(!title){ alert("CompleteazÄƒ titlul."); return; }
      const endsAtMs = parseEndsToMs(endsVal);
      if(!endsAtMs){ alert("Data expirÄƒrii nu este validÄƒ."); return; }

      // upload visuals (best-effort)
      const bannerFile = $("promoBanner")?.files?.[0] || null;
      const bgFiles = $("promoBg")?.files ? Array.from($("promoBg").files).slice(0,3) : [];

      const bannerUrl = bannerFile ? await uploadMedia(bannerFile) : "";
      const bgUrls = [];
      for(const f of bgFiles){
        const u = await uploadMedia(f);
        if(u) bgUrls.push(u);
      }

      const prizes = {
        p1: ($("prize1")?.value || "").trim(),
        p2: ($("prize2")?.value || "").trim(),
        p3: ($("prize3")?.value || "").trim(),
        top5: ($("prizeTop5")?.value || "").trim(),
        next10: ($("prizeNext10")?.value || "").trim(),
        bonus: ($("prizeBonus")?.value || "").trim(),
      };

      const user = auth().currentUser;
      await db.collection("promos").add({
        kind,
        title,
        endsAtMs,
        endsAtIso: new Date(endsAtMs).toISOString(),
        points: Number.isFinite(points) ? Math.max(1, points) : 10,
        hook, desc, rules,
        bannerUrl: bannerUrl || "",
        bgUrls,
        prizes,
        createdAtMs: Date.now(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: user ? (user.email || "") : ""
      });

      cancelPromo();
      alert("PromoÈ›ia/concursul a fost salvat(Äƒ)!");
    }catch(e){
      console.error("savePromo:", e);
      const user = auth() && auth().currentUser ? auth().currentUser : null;
      const email = user?.email ? String(user.email) : "(neautentificat)";
      alert("Eroare la salvare (verificÄƒ Firestore Rules pentru promos).\n\nUser curent: " + email + "\nAdmin permis: " + ADMIN_EMAIL);
    }finally{
      if(saveBtn){ saveBtn.disabled = false; saveBtn.textContent = "ğŸ’¾ SalveazÄƒ"; }
    }
  };

  window.deletePromo = async function(promoId){
    const ok = await window.ensureAdminAuth();
    if(!ok) return;
    if(!confirm("È˜tergi aceastÄƒ promoÈ›ie/giveaway?")) return;

    const db = fs();
    if(!db) return;

    try{
      // delete participants subcollection + promo doc
      const partSnap = await db.collection("promos").doc(promoId).collection("participants").get();
      const batch = db.batch();
      partSnap.forEach(d=>batch.delete(d.ref));
      batch.delete(db.collection("promos").doc(promoId));
      await batch.commit();
      alert("È˜ters.");
    }catch(e){
      console.error("deletePromo:", e);
      alert("Eroare la È™tergere (Rules/permisiuni).");
    }
  };

  function makeCode(){
    return (Date.now().toString(36) + Math.random().toString(36).slice(2,8)).toUpperCase();
  }

  window.joinPromo = async function(promoId){
    const db = fs();
    if(!db) return alert("Firestore indisponibil.");

    const name = ($("joinName_"+promoId)?.value || "").trim();
    const email = ($("joinEmail_"+promoId)?.value || "").trim();
    const wallet = ($("joinWallet_"+promoId)?.value || "").trim();

    if(!name || !email || !wallet){
      alert("CompleteazÄƒ numele, emailul È™i wallet-ul.");
      return;
    }

    // basic email check
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
      alert("Email invalid.");
      return;
    }

    try{
      const code = makeCode();

      await db.collection("promos").doc(promoId).collection("participants").add({
        name, email, wallet,
        code,
        createdAtMs: Date.now(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // email confirm (mailto)
      const subj = encodeURIComponent("StancuBYT | Confirmare Ã®nscriere");
      const body = encodeURIComponent(
        `Salut ${name},\n\nTe-ai Ã®nscris la promoÈ›ia/concursul StancuBYT.\nCodul tÄƒu: ${code}\nWallet: ${wallet}\n\nSucces!`
      );
      window.location.href = `mailto:${encodeURIComponent(email)}?subject=${subj}&body=${body}`;

      alert("Ãnscriere Ã®nregistratÄƒ! Cod: " + code);
      await renderParticipants(promoId);
    }catch(e){
      console.error("joinPromo:", e);
      alert("Eroare la Ã®nscriere. VerificÄƒ Firestore Rules pentru participants (create public).");
    }
  };

  // ===== Auth state listener =====
  document.addEventListener("DOMContentLoaded", ()=>{
    const a = auth();
    if(a){
      a.onAuthStateChanged((user)=>{
        const admin = isAdminUser(user);
        window.__STBYT_IS_ADMIN__ = admin;
        setAdminUI(admin, user);
      });
    }
    // start promos list
    listenPromos();
  });

})();
</script>
</body>
</html>
