<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Statistici</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1"></script>
  <style>
        /* Variabile culori conform psihologiei marketingului */
        :root {
            --blue-tech: #0066ff;
            --green-growth: #00ff88;
            --purple-innov: #8a2be2;
            --neon-cyan: #00ffff;
            --dark-bg: #0a0a1f;
            --darker-bg: #050510;
            --orange-alert: #ff9500;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }

        body {
            background: var(--dark-bg);
            color: white;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 60%, rgba(0, 255, 136, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 20%);
        }

        .btn-refresh-modern {
            background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 5px 20px rgba(0, 102, 255, 0.3);
        }
        .btn-refresh-modern:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 30px rgba(0, 102, 255, 0.5); }
        .btn-refresh-modern:active { transform: translateY(0) scale(1); }

        .refresh-icon { font-size: 1.3rem; transition: transform 0.5s ease; }
        .btn-refresh-modern:hover .refresh-icon { animation: rotate360 1s linear infinite; }

        .refresh-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 50px;
            background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan));
            opacity: 0;
            z-index: -1;
            animation: pulseEffect 2s infinite;
        }

        @keyframes rotate360 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseEffect { 0% { transform: scale(1); opacity: 0.7; } 100% { transform: scale(1.2); opacity: 0; } }

        .btn-refresh-modern.loading { background: linear-gradient(45deg, #666, #888); cursor: wait; }
        .btn-refresh-modern.loading .refresh-icon { animation: rotate360 1s linear infinite; }
        .btn-refresh-modern.loading .refresh-text { opacity: 0.7; }

        @keyframes successFlash {
            0%, 100% { background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov)); }
            50% { background: linear-gradient(45deg, var(--green-growth), #00cc66); }
        }
        .btn-refresh-modern.success { animation: successFlash 0.5s ease 2; }

        .page-section { min-height: 100vh; padding: 120px 2rem 2rem; max-width: 1200px; margin: 0 auto; display: none; position: relative; overflow: hidden; }
        .active-section { display: block; }

        .data-visualization {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .neon-glow {
            box-shadow: 
                0 0 20px rgba(0, 102, 255, 0.3),
                0 0 40px rgba(0, 255, 136, 0.2),
                inset 0 0 20px rgba(138, 43, 226, 0.1);
        }

        .chart-container { position: relative; height: 400px; margin: 2rem 0; }

        .chart-controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }

        .period-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 102, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .period-btn.active { background: var(--blue-tech); border-color: var(--blue-tech); }
        .period-btn:hover { background: rgba(0, 102, 255, 0.2); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-item { background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--neon-cyan); margin: 0.5rem 0; }

        @media (max-width: 768px) {
            .chart-container { height: 300px; }
            .btn-refresh-modern { padding: 0.8rem 1.5rem; font-size: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>
  <section id="statistici" class="page-section active-section">
        <div style="text-align: center; margin-bottom: 3rem; padding-top: 20px;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">AnalizÄƒ È˜tiinÈ›ificÄƒ Ã®n Timp Real</h1>
            <p>Date live preluate din pool-ul SBYT (GeckoTerminal) + on-chain (RPC) + Etherscan</p>

            <button onclick="fetchAllData()" class="btn-refresh-modern" id="refreshButton">
                <span class="refresh-icon">ðŸ”„</span>
                <span class="refresh-text">ReÃ®mprospÄƒteazÄƒ Datele</span>
                <span class="refresh-pulse"></span>
            </button>
        </div>

        <div class="data-visualization neon-glow">
            <h3>ðŸ“ˆ PreÈ› Ã®n Timp Real</h3>

            <div id="sbyt-price-box" style="margin-top:14px; margin-bottom:10px;">
              <div style="font-size:18px; opacity:.85;">1 SBYT Ã®n USD</div>
              <div id="sbyt-price" style="font-size:32px; font-weight:bold; color:var(--green-growth);">Se Ã®ncarcÄƒ...</div>
            </div>

            <div class="chart-controls">
                <button class="period-btn" onclick="changeChartPeriod('1h')">1H</button>
                <button class="period-btn active" onclick="changeChartPeriod('24h')">24H</button>
                <button class="period-btn" onclick="changeChartPeriod('7d')">7 Zile</button>
                <button class="period-btn" onclick="changeChartPeriod('1m')">1 LunÄƒ</button>
                <button class="period-btn" onclick="changeChartType('candlestick')">LumÃ¢nÄƒri</button>
                <button class="period-btn" onclick="changeChartType('line')">Linie</button>
            </div>

            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div id="priceData" class="loading">Se Ã®ncarcÄƒ datele live...</div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>ðŸ“Š Metrici Contract</h3>
            <div class="stats-grid" id="etherscanStats">
                <div class="stat-item">
                    <div>Holders</div>
                    <div class="stat-value" id="holdersCount">-</div>
                    <div>DeÈ›inÄƒtori</div>
                </div>
                <div class="stat-item">
                    <div>Total Supply REAL</div>
                    <div class="stat-value" id="totalSupply">-</div>
                    <div>SBYT</div>
                </div>
                <div class="stat-item">
                    <div>TranzacÈ›ii</div>
                    <div class="stat-value" id="transactionsCount">-</div>
                    <div>Total TX</div>
                </div>
                <div class="stat-item">
                    <div>Market Cap</div>
                    <div class="stat-value" id="marketCap">-</div>
                    <div>USD</div>
                </div>
                <div class="stat-item">
                    <div>Volum 24h</div>
                    <div class="stat-value" id="volume24h">-</div>
                    <div>USD</div>
                </div>
            </div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>ðŸ“‹ Detalii Contract</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div>
                    <p><strong>Token Name:</strong> <span id="tokenName">StancuBYT</span></p>
                    <p><strong>Symbol:</strong> <span id="tokenSymbol">SBYT</span></p>
                    <p><strong>Decimals:</strong> <span id="tokenDecimals">18</span></p>
                    <p><strong>Creation Date:</strong> <span id="creationDate">-</span></p>
                </div>
                <div>
                    <p><strong>Contract Address:</strong> <span id="contractCreator">0x44Cf220399be798baeaE45fd7C4fF44623713833</span></p>
                    <p><strong>Contract Age:</strong> <span id="contractAge">-</span> zile</p>
                    <p><strong>Last Update:</strong> <span id="lastUpdateTime">-</span></p>
                    <p><strong>Contract verificat pe Etherscan</strong></p>
                </div>
            </div>
        </div>
    </section>

  <script>
/* =========================
   ENDPOINTS (actuale)
   ========================= */
const SBYT_PRICE_ENDPOINT      = "https://europe-west1-stancubyt-fc2b9.cloudfunctions.net/sbytPrice";
const HOLDERS_ENDPOINT         = "https://sbytholdersfree-jfka2frgwa-uc.a.run.app";
const TOTALSUPPLY_ENDPOINT     = "https://sbyttotalsupplyfree-jfka2frgwa-uc.a.run.app";
const TX_ENDPOINT              = "https://sbyttxcountfree-jfka2frgwa-uc.a.run.app";
const CONTRACT_INFO_ENDPOINT   = "https://sbytcontractinfofree-jfka2frgwa-uc.a.run.app";
/* Optional (cand o deployezi): */
const VOLUME24H_ENDPOINT       = "https://europe-west1-stancubyt-fc2b9.cloudfunctions.net/sbytVolume24hFree";

/* =========================
   PRICE HISTORY STORAGE
   ========================= */
const STORAGE_KEY = "sbyt_price_samples_v1"; // [{t: ms, p: number}]
const MAX_KEEP_DAYS = 31;

/* =========================
   UI STATE
   ========================= */
let currentPeriod = "24h";       // "1h" | "24h" | "7d" | "1m"
let currentMode   = "line";      // "line" | "candlestick"
let priceChart    = null;

// for MarketCap
let CURRENT_PRICE_USD = null;
let CURRENT_SUPPLY = null;

function nowMs(){ return Date.now(); }

function loadSamples() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = JSON.parse(raw || "[]");
    if (!Array.isArray(arr)) return [];
    return arr
      .map(s => ({ t: Number(s.t), p: Number(s.p) }))
      .filter(s => Number.isFinite(s.t) && Number.isFinite(s.p))
      .sort((a,b) => a.t - b.t);
  } catch { return []; }
}

function saveSamples(arr) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch {} }

function trimSamples(arr) {
  const cutoff = nowMs() - MAX_KEEP_DAYS * 24*60*60*1000;
  return arr.filter(s => s.t >= cutoff);
}

function addSample(price) {
  let arr = loadSamples();
  arr.push({ t: nowMs(), p: price });
  arr = trimSamples(arr).sort((a,b)=>a.t-b.t);
  if (arr.length > 20000) arr = arr.slice(arr.length - 20000);
  saveSamples(arr);
  return arr;
}

function periodWindowMs(period) {
  switch(period){
    case "1h":  return 1*60*60*1000;
    case "24h": return 24*60*60*1000;
    case "7d":  return 7*24*60*60*1000;
    case "1m":  return 30*24*60*60*1000;
    default:    return 24*60*60*1000;
  }
}

function bucketSizeMs(period) {
  switch(period){
    case "1h":  return 60*1000;          // 1 min
    case "24h": return 15*60*1000;       // 15 min
    case "7d":  return 24*60*60*1000;    // 1 day
    case "1m":  return 24*60*60*1000;    // 1 day
    default:    return 15*60*1000;
  }
}

function fmtLabel(ts){
  const d = new Date(ts);
  if (currentPeriod === "1h" || currentPeriod === "24h") {
    return d.toLocaleTimeString("ro-RO", { hour: "2-digit", minute: "2-digit" });
  }
  if (currentPeriod === "7d") {
    return d.toLocaleDateString("ro-RO", { weekday: "short" });
  }
  return d.toLocaleDateString("ro-RO", { day: "2-digit", month: "2-digit" });
}

function destroyChart() { try { if (priceChart) priceChart.destroy(); } catch {} priceChart = null; }

function buildLineSeries(samples, period) {
  const start = nowMs() - periodWindowMs(period);
  const inRange = samples.filter(s => s.t >= start);
  if (!inRange.length) return { labels: [], values: [] };

  if (period === "7d" || period === "1m") {
    const bms = bucketSizeMs(period);
    const buckets = new Map();
    for (const s of inRange){
      const b = Math.floor(s.t / bms) * bms;
      buckets.set(b, s.p);
    }
    const keys = Array.from(buckets.keys()).sort((a,b)=>a-b);
    return { labels: keys.map(fmtLabel), values: keys.map(k => buckets.get(k)) };
  }

  const maxPoints = 300;
  const step = Math.max(1, Math.floor(inRange.length / maxPoints));
  const labels = [];
  const values = [];
  for (let i=0; i<inRange.length; i+=step){
    labels.push(fmtLabel(inRange[i].t));
    values.push(inRange[i].p);
  }
  const last = inRange[inRange.length-1];
  if (labels[labels.length-1] !== fmtLabel(last.t)) {
    labels.push(fmtLabel(last.t));
    values.push(last.p);
  }
  return { labels, values };
}

function buildCandlesSeries(samples, period) {
  const start = nowMs() - periodWindowMs(period);
  const bms = bucketSizeMs(period);
  const inRange = samples.filter(s => s.t >= start);
  if (!inRange.length) return { labels: [], ohlc: [] };

  const buckets = new Map();
  for (const s of inRange){
    const b = Math.floor(s.t / bms) * bms;
    const cur = buckets.get(b);
    if (!cur) buckets.set(b, { o: s.p, h: s.p, l: s.p, c: s.p });
    else { cur.h = Math.max(cur.h, s.p); cur.l = Math.min(cur.l, s.p); cur.c = s.p; }
  }
  const keys = Array.from(buckets.keys()).sort((a,b)=>a-b);
  return { labels: keys.map(fmtLabel), ohlc: keys.map(k => ({ ...buckets.get(k) })) };
}

function renderPriceChart(samples) {
  const canvas = document.getElementById("priceChart");
  if (!canvas) return;
  if (typeof Chart === "undefined") return;

  const ctx = canvas.getContext("2d");
  destroyChart();

  if (currentMode === "candlestick") {
    const { labels, ohlc } = buildCandlesSeries(samples, currentPeriod);
    priceChart = new Chart(ctx, {
      type: "candlestick",
      data: { labels, datasets: [{ label: "SBYT", data: ohlc }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: false } } }
    });
  } else {
    const { labels, values } = buildLineSeries(samples, currentPeriod);
    priceChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label: "SBYT", data: values, tension: 0.25, pointRadius: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: false } } }
    });
  }
}

function setLastUpdate() {
  const el = document.getElementById("lastUpdateTime");
  if (!el) return;
  el.textContent = new Date().toLocaleString("ro-RO");
}

/* =========================
   MarketCap
   ========================= */
function updateMarketCap() {
  const el = document.getElementById("marketCap");
  if (!el) return;
  if (!Number.isFinite(CURRENT_PRICE_USD) || !Number.isFinite(CURRENT_SUPPLY)) { el.textContent = "â€”"; return; }
  const mc = CURRENT_PRICE_USD * CURRENT_SUPPLY;
  el.textContent = "$" + mc.toLocaleString("ro-RO", { maximumFractionDigits: 0 });
}

/* =========================
   Live updaters
   ========================= */
async function updateSBYTPrice() {
  const priceEl = document.getElementById("sbyt-price");
  if (!priceEl) return;

  try {
    const res = await fetch(SBYT_PRICE_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const data = await res.json();
    if (data && data.ok && data.priceUsd !== undefined) {
      const p = Number(data.priceUsd);
      if (Number.isFinite(p)) {
        priceEl.innerText = "$" + p.toFixed(8);
        CURRENT_PRICE_USD = p;
        updateMarketCap();

        const samples = addSample(p);
        renderPriceChart(samples);
        setLastUpdate();
        return;
      }
    }
    priceEl.innerText = "â€”";
  } catch { priceEl.innerText = "â€”"; }
}

async function updateHolders() {
  const el = document.getElementById("holdersCount");
  if (!el) return;
  el.textContent = "â€¦";
  try {
    const r = await fetch(HOLDERS_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    if (d && d.ok && d.holders != null) el.textContent = Number(d.holders).toLocaleString("ro-RO");
    else el.textContent = "0";
    setLastUpdate();
  } catch { el.textContent = "0"; }
}

async function updateTotalSupply() {
  const el = document.getElementById("totalSupply");
  if (!el) return;
  el.textContent = "â€¦";
  try {
    const r = await fetch(TOTALSUPPLY_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    if (d && d.ok && d.supply != null) {
      const supplyNum = Number(d.supply);
      el.textContent = Number.isFinite(supplyNum) ? supplyNum.toLocaleString("ro-RO") : "â€”";
      CURRENT_SUPPLY = Number.isFinite(supplyNum) ? supplyNum : null;
      updateMarketCap();
    } else {
      el.textContent = "â€”";
      CURRENT_SUPPLY = null;
      updateMarketCap();
    }
    setLastUpdate();
  } catch {
    el.textContent = "â€”";
    CURRENT_SUPPLY = null;
    updateMarketCap();
  }
}

async function updateTransactions() {
  const el = document.getElementById("transactionsCount");
  if (!el) return;
  el.textContent = "â€¦";
  try {
    const r = await fetch(TX_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    if (d && d.ok && d.txCount != null) el.textContent = Number(d.txCount).toLocaleString("ro-RO");
    else el.textContent = "0";
    setLastUpdate();
  } catch { el.textContent = "0"; }
}

async function updateVolume24h() {
  const el = document.getElementById("volume24h");
  if (!el) return;
  el.textContent = "â€¦";
  try {
    const r = await fetch(VOLUME24H_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    if (d && d.ok && d.volume24hUsd != null) {
      const v = Number(d.volume24hUsd);
      el.textContent = Number.isFinite(v) ? ("$" + v.toLocaleString("ro-RO", { maximumFractionDigits: 0 })) : "â€”";
    } else el.textContent = "â€”";
    setLastUpdate();
  } catch { el.textContent = "â€”"; }
}

async function updateContractInfo() {
  const creationEl = document.getElementById("creationDate");
  const ageEl = document.getElementById("contractAge");
  if (creationEl) creationEl.textContent = "â€¦";
  if (ageEl) ageEl.textContent = "â€¦";
  try {
    const r = await fetch(CONTRACT_INFO_ENDPOINT + "?t=" + Date.now(), { cache: "no-store" });
    const d = await r.json();
    if (d && d.ok && d.createdAt) {
      const dt = new Date(d.createdAt);
      if (Number.isFinite(dt.getTime())) {
        if (creationEl) creationEl.textContent = dt.toLocaleDateString("ro-RO");
      } else {
        if (creationEl) creationEl.textContent = "â€”";
      }
      if (ageEl && typeof d.ageDays === "number") ageEl.textContent = Number(d.ageDays).toLocaleString("ro-RO");
      setLastUpdate();
      return;
    }
  } catch {}
  if (creationEl && (creationEl.textContent === "â€¦" || creationEl.textContent === "")) creationEl.textContent = "â€”";
  if (ageEl && (ageEl.textContent === "â€¦" || ageEl.textContent === "")) ageEl.textContent = "â€”";
}

/* =========================
   Buttons
   ========================= */
function syncActiveButtons(){
  document.querySelectorAll(".period-btn").forEach(btn => {
    const oc = (btn.getAttribute("onclick") || "").replace(/\s+/g, "");
    const isPeriod = oc.includes("changeChartPeriod");
    const isType   = oc.includes("changeChartType");
    let active = false;
    if (isPeriod) active = oc.includes(`'${currentPeriod}'`) || oc.includes(`\"${currentPeriod}\"`);
    if (isType)   active = oc.includes(`'${currentMode}'`)   || oc.includes(`\"${currentMode}\"`);
    btn.classList.toggle("active", active);
  });
}

window.changeChartPeriod = function(period){
  currentPeriod = period;
  syncActiveButtons();
  renderPriceChart(loadSamples());
};

window.changeChartType = function(mode){
  currentMode = (mode === "candlestick") ? "candlestick" : "line";
  syncActiveButtons();
  renderPriceChart(loadSamples());
};

window.fetchAllData = async function(){
  const btn = document.getElementById("refreshButton");
  if (btn) btn.classList.add("loading");
  try{
    await Promise.allSettled([
      updateSBYTPrice(),
      updateHolders(),
      updateTotalSupply(),
      updateTransactions(),
      updateContractInfo(),
      updateVolume24h()
    ]);
    if (btn) {
      btn.classList.remove("loading");
      btn.classList.add("success");
      setTimeout(()=>btn.classList.remove("success"), 1200);
    }
  } finally {
    if (btn) btn.classList.remove("loading");
  }
};

/* =========================
   Boot
   ========================= */
document.addEventListener("DOMContentLoaded", () => {
  syncActiveButtons();
  renderPriceChart(loadSamples());

  updateSBYTPrice();
  updateHolders();
  updateTotalSupply();
  updateTransactions();
  updateContractInfo();
  updateVolume24h();

  setInterval(updateSBYTPrice, 30000);
  setInterval(updateHolders, 300000);
  setInterval(updateTotalSupply, 300000);
  setInterval(updateTransactions, 300000);
  setInterval(updateContractInfo, 3600000);
  setInterval(updateVolume24h, 300000);
});
  </script>
</body>
</html>
