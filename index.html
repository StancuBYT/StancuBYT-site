<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StancuBYT | Giveaway & PromoÈ›ii</title>

<style>
:root {
  --bg0:#050510; --bg1:#0a0a1f;
  --txt:rgba(255,255,255,.92); --muted:rgba(255,255,255,.72);
  --stroke: rgba(255,255,255,.14);
  --r: 22px;
  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 8px 26px rgba(0,0,0,.45);
  --neon-cyan:#00ffff; --blue:#0066ff; --green:#00ff88; --purple:#8a2be2; --gold:#ffd166; --orange:#ff9500; --red:#ff4d4d;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
body{
  color:var(--txt);
  background:
    radial-gradient(1000px 520px at 18% 12%, rgba(0,255,255,.12), transparent 60%),
    radial-gradient(900px 480px at 82% 18%, rgba(138,43,226,.16), transparent 60%),
    radial-gradient(1100px 560px at 50% 92%, rgba(0,255,136,.10), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  min-height:100vh;
}
.wrap{max-width:1200px;margin:0 auto;padding:22px 16px 70px}

.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:14px;
  padding:14px 16px;border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  border-radius:var(--r);box-shadow:var(--shadow2);
  position:sticky;top:10px;z-index:30;backdrop-filter:blur(10px);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
  background:
    radial-gradient(circle at 30% 30%, rgba(0,255,255,.45), transparent 52%),
    radial-gradient(circle at 70% 20%, rgba(138,43,226,.45), transparent 55%),
    radial-gradient(circle at 40% 75%, rgba(0,255,136,.35), transparent 58%),
    rgba(255,255,255,.06);
  box-shadow:0 10px 26px rgba(0,0,0,.45);overflow:hidden;
}
.logo img{width:100%;height:100%;object-fit:cover;opacity:.9}
.brand h1{font-size:16px;letter-spacing:.2px}
.brand .sub{font-size:12px;color:var(--muted);margin-top:2px}

.top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--txt);font-size:13px;white-space:nowrap}
.btn{cursor:pointer;border:none;border-radius:14px;padding:11px 14px;color:#061018;font-weight:800;letter-spacing:.2px;box-shadow:0 16px 45px rgba(0,0,0,.45);transition:transform .15s ease, filter .15s ease, opacity .15s ease;display:inline-flex;align-items:center;gap:9px;user-select:none}
.btn:active{transform:translateY(1px) scale(.99)}
.btn:hover{filter:brightness(1.05)}
.btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.3)}
.btn-primary{background:linear-gradient(90deg, rgba(0,255,255,.95), rgba(0,102,255,.95))}
.btn-accent{background:linear-gradient(90deg, rgba(255,209,102,.96), rgba(255,149,0,.96))}
.btn-ghost{color:var(--txt);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);box-shadow:none}

.hero{
  margin-top:16px;border:1px solid var(--stroke);border-radius:var(--r);
  background:
    radial-gradient(680px 340px at 22% 25%, rgba(0,255,255,.16), transparent 60%),
    radial-gradient(680px 340px at 78% 18%, rgba(138,43,226,.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:var(--shadow);overflow:hidden;position:relative
}
.hero:before{content:"";position:absolute;inset:-2px;background:linear-gradient(120deg, rgba(0,255,255,.14), rgba(138,43,226,.14), rgba(0,0,0,.0), rgba(0,255,136,.12));filter:blur(32px);opacity:.8;pointer-events:none}
.hero-inner{position:relative;padding:22px 18px}
.hero h2{font-size:22px;margin-bottom:6px}
.hero p{color:var(--muted);line-height:1.5;max-width:80ch}
.hero .hint{margin-top:10px;font-size:12px;color:rgba(255,255,255,.65)}
.hero .quick{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
.tag{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);font-size:12px;color:rgba(255,255,255,.84)}

.grid{margin-top:18px;display:grid;grid-template-columns:repeat(12,1fr);gap:14px;align-items:start}
.panel{border:1px solid var(--stroke);border-radius:var(--r);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));box-shadow:var(--shadow2);overflow:hidden}
.panel .hd{padding:14px 14px 12px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.panel .hd h3{font-size:14px;letter-spacing:.2px}
.panel .bd{padding:14px}
.left{grid-column:span 4}
.right{grid-column:span 8}
@media(max-width:980px){.left,.right{grid-column:span 12}}

.admin-only{display:none}

.admin-desc{color:var(--muted);margin:8px 0 12px;line-height:1.45}
.admin-login-box{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
.admin-login-box input{padding:12px 14px;width:280px;max-width:92vw;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff;outline:none}
.admin-login-box button{padding:12px 16px;border-radius:10px;border:none;background:#7a5cff;color:#fff;font-weight:700;cursor:pointer}
.admin-login-box button:hover{filter:brightness(1.08)}
.admin-status-row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
.admin-badge{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);font-size:12px}
.admin-badge-on{border-color:rgba(0,255,136,.35);background:rgba(0,255,136,.10)}
.admin-badge-off{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.08)}
.admin-user-label{font-size:12px;color:rgba(255,255,255,.75)}
.admin-msg{margin-top:12px;font-weight:700;text-align:center}

input,select,textarea{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);color:var(--txt);outline:none}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap}
.two>*{flex:1 1 180px}
.three>*{flex:1 1 140px}

.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
@media(max-width:900px){.cards{grid-template-columns:1fr}}

.promo-card{border:1px solid rgba(255,255,255,.16);border-radius:calc(var(--r) + 6px);overflow:hidden;position:relative;box-shadow:var(--shadow);min-height:420px;background:rgba(0,0,0,.25)}
.promo-bg{position:absolute;inset:0;background:
  radial-gradient(700px 360px at 30% 20%, rgba(0,255,255,.18), transparent 60%),
  radial-gradient(740px 360px at 80% 25%, rgba(138,43,226,.20), transparent 60%),
  radial-gradient(760px 380px at 50% 92%, rgba(0,255,136,.15), transparent 60%),
  linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.65));
  filter:saturate(1.05);transform:scale(1.03)
}
.promo-bg.has-img{background-size:cover;background-position:center}
.promo-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.75))}
.promo-inner{position:relative;padding:18px 18px 16px;display:flex;flex-direction:column;gap:12px;height:100%}
.promo-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:rgba(255,255,255,.92)}
.badge.live{background:linear-gradient(90deg, rgba(0,255,136,.18), rgba(0,255,255,.14));border-color:rgba(0,255,136,.30)}
.badge.ended{background:rgba(255,77,77,.10);border-color:rgba(255,77,77,.28)}
.promo-title{font-size:20px;font-weight:900;letter-spacing:.2px;line-height:1.15}
.promo-sub{color:rgba(255,255,255,.78);font-size:13px;line-height:1.5}
.promo-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:rgba(255,255,255,.80);font-size:12px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06)}
.promo-prizes{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.prize{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);border-radius:18px;padding:10px 10px;min-height:78px}
.prize b{display:block;font-size:12px;color:rgba(255,255,255,.88);margin-bottom:6px}
.prize .v{font-size:12px;color:rgba(255,255,255,.75);line-height:1.35}
.cta-row{margin-top:auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,.10);padding-top:12px}
.link{color:rgba(0,255,255,.95);text-decoration:none;font-weight:800}
.link:hover{text-decoration:underline}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;z-index:90;padding:16px}
.modal.open{display:flex}
.modal-card{width:min(720px,100%);border-radius:22px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));box-shadow:var(--shadow);overflow:hidden}
.modal-hd{padding:14px 14px 12px;border-bottom:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:space-between;gap:12px}
.modal-hd h3{font-size:14px}
.x{cursor:pointer;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:rgba(255,255,255,.85);font-weight:800}
.modal-bd{padding:14px}
.small{font-size:12px;color:rgba(255,255,255,.72);line-height:1.45}
.hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0}
.check{display:flex;gap:10px;align-items:flex-start;margin-top:8px;color:rgba(255,255,255,.75);font-size:12px}
.check input{width:auto;margin-top:2px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // Firebase init 1:1
  firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    storageBucket: "stancubyt-fc2b9.firebasestorage.app",
    messagingSenderId: "263244200492",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89",
    measurementId: "G-272S9HSY3K"
  };
  try {
    if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  } catch(e) {}
</script>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo"><img src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="SBYT" onerror="this.style.display='none'"></div>
      <div>
        <h1>Giveaway & PromoÈ›ii</h1>
        <div class="sub">Carduri mari â€¢ efecte moderne â€¢ participare instant</div>
      </div>
    </div>

    <div class="top-actions">
      <div class="pill" id="authPill">ğŸ”’ Neautentificat</div>

      <div class="admin-only" style="display:none; gap:10px; align-items:center;" id="adminButtons">
        <button class="btn btn-accent" type="button" onclick="openAdminForm('promo')">â• AdaugÄƒ PromoÈ›ie</button>
        <button class="btn btn-accent" type="button" onclick="openAdminForm('giveaway')">ğŸ AdaugÄƒ Giveaway</button>
      </div>
    </div>
  </div>

  <div class="hero">
    <div class="hero-inner">
      <h2>PromoÈ›ii care â€œprindâ€ (psihologie + design modern)</h2>
      <p>
        Fiecare card are <b>fundal + banner</b>, <b>premii pe nivele</b>, <b>urgenta (countdown)</b> È™i
        <b>buton ParticipÄƒ</b> cu formular. Salvarea se face Ã®n <b>Firestore: promos</b> È™i imaginile Ã®n <b>Storage</b>.
      </p>
      <div class="quick">
        <span class="tag">â³ Countdown</span>
        <span class="tag">ğŸ”¥ Top 5 + urmÄƒtoarele 10</span>
        <span class="tag">ğŸ† Premii clare</span>
        <span class="tag">ğŸš€ CTA: ParticipÄƒ</span>
      </div>
      <div class="hint">Admin: autentificarea de mai jos este 1:1 ca Ã®n fiÈ™ierele tale.</div>
    </div>
  </div>

  <div class="grid">
    <div class="panel left">
      <div class="hd"><h3>Admin</h3><span class="pill" id="adminPill">â€”</span></div>
      <div class="bd">
        <section class="admin-login" id="admin-login">
<h2>ğŸ” Administrator Login</h2>
<p class="admin-desc">Autentificare necesara pentru adaugare/stergere membri, anunturi, noutati, giveaway si promotii.</p>
<div class="admin-login-box">
<input autocomplete="username" id="adminEmail" placeholder="Email administrator" type="email"/>
<input autocomplete="current-password" id="adminPass" placeholder="Parola administrator" type="password"/>
<button onclick="adminSignIn()" type="button">Autentificare</button>
<button id="adminLogoutBtn" onclick="adminSignOut()" style="display:none;" type="button">Delogare</button>
</div>
<div class="admin-status-row">
<span class="admin-badge admin-badge-off" id="adminStatusBadge">Neautentificat</span>
<span class="admin-user-label" id="adminUserLabel"></span>
</div>
<p class="admin-msg" id="adminLoginMsg"></p>

</section>

        <div class="admin-only" id="adminFormWrap" style="display:none; margin-top:14px;">
          <div class="pill" id="adminFormTitle">â• AdaugÄƒ campanie</div>
          <div class="row two" style="margin-top:10px;">
            <select id="promoType">
              <option value="promo">PromoÈ›ie</option>
              <option value="giveaway">Giveaway</option>
            </select>
            <input id="promoEnds" type="datetime-local" />
          </div>

          <div class="row" style="margin-top:10px;">
            <input id="promoTitle" type="text" maxlength="120" placeholder="Titlu (ex: Mega Giveaway SBYT)">
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="promoPrize" type="text" maxlength="160" placeholder="Premiu principal (rezumat) (ex: 10.000 SBYT)">
          </div>
          <div class="row" style="margin-top:10px;">
            <textarea id="promoDesc" placeholder="Descriere scurtÄƒ, incitantÄƒ (ce cÃ¢È™tigi, ce trebuie sÄƒ faci)"></textarea>
          </div>

          <div class="row three" style="margin-top:10px;">
            <input id="p1" type="text" placeholder="Premiul I">
            <input id="p2" type="text" placeholder="Premiul II">
            <input id="p3" type="text" placeholder="Premiul III">
          </div>
          <div class="row two" style="margin-top:10px;">
            <input id="pTop5" type="text" placeholder="Primele 5 locuri dupÄƒ premii">
            <input id="pNext10" type="text" placeholder="UrmÄƒtoarele 10 locuri">
          </div>

          <div class="row" style="margin-top:10px;">
            <textarea id="promoRules" placeholder="Regulament & condiÈ›ii (clar, pe paÈ™i)"></textarea>
          </div>

          <div class="row two" style="margin-top:10px;">
            <input id="ctaText" type="text" placeholder="Text buton (ex: ParticipÄƒ acum!)">
            <input id="ctaUrl" type="url" placeholder="Link Ã®nregistrare (opÈ›ional)">
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <div class="small" style="margin-bottom:6px;">Imagine fundal (background)</div>
              <input id="promoBg" type="file" accept="image/*">
            </div>
            <div>
              <div class="small" style="margin-bottom:6px;">Banner (cover)</div>
              <input id="promoBanner" type="file" accept="image/*">
            </div>
          </div>

          <div class="row two" style="margin-top:10px;">
            <input id="promoPoints" type="number" value="10" min="1" placeholder="Puncte per participare (opÈ›ional)">
            <button class="btn btn-primary" type="button" onclick="savePromo()">ğŸ’¾ SalveazÄƒ</button>
          </div>
          <p class="admin-msg" id="saveMsg" style="display:none;"></p>
        </div>
      </div>
    </div>

    <div class="panel right">
      <div class="hd"><h3>Campanii</h3><span class="pill">ğŸ“Œ Live</span></div>
      <div class="bd">
        <div id="promoList" class="cards"></div>
        <div id="emptyState" class="small" style="display:none;">Nu existÄƒ campanii Ã®ncÄƒ.</div>
      </div>
    </div>
  </div>
</div>

<!-- Participate modal -->
<div class="modal" id="joinModal" onclick="if(event.target.id==='joinModal') closeJoin()">
  <div class="modal-card">
    <div class="modal-hd">
      <h3 id="joinTitle">ParticipÄƒ</h3>
      <button class="x" onclick="closeJoin()">âœ•</button>
    </div>
    <div class="modal-bd">
      <div id="joinInfo" class="small"></div>
      <div class="hr"></div>
      <div class="row two">
        <input id="joinName" type="text" placeholder="Nume (opÈ›ional)">
        <input id="joinEmail" type="email" placeholder="Email (obligatoriu)">
      </div>
      <div class="row two" style="margin-top:10px;">
        <input id="joinWallet" type="text" placeholder="Wallet (opÈ›ional)">
        <input id="joinReferral" type="text" placeholder="Cod referral (opÈ›ional)">
      </div>
      <div class="check">
        <input id="joinAgree" type="checkbox">
        <label for="joinAgree">Sunt de acord sÄƒ fiu contactat/Äƒ pentru confirmarea participÄƒrii.</label>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px;">
        <button class="btn btn-primary" id="joinBtn" type="button" onclick="submitJoin()">âœ… ConfirmÄƒ participarea</button>
        <button class="btn btn-ghost" type="button" onclick="closeJoin()">AnuleazÄƒ</button>
      </div>
      <p class="admin-msg" id="joinMsg" style="display:none;"></p>
    </div>
  </div>
</div>

<script>
const ADMIN_EMAILS = ["stancubyt@gmail.com"];

const auth = (typeof firebase !== 'undefined') ? firebase.auth() : null;
const db = (typeof firebase !== 'undefined') ? firebase.firestore() : null;
const storage = (typeof firebase !== 'undefined') ? firebase.storage() : null;

function $(id) { return document.getElementById(id); }

function maskEmail(email) {
  if (!email || typeof email !== 'string') return '';
  const [u, d] = email.split('@');
  if (!d) return email;
  const u2 = u.length <= 2 ? (u[0] + '*') : (u.slice(0,2) + '*'.repeat(Math.min(8, u.length-2)));
  return `${u2}@${d}`;
}


function escapeHtml(s) {
  return String(s||'').replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'}[ch]));
}

function formatCountdown(ms) {
  if (ms <= 0) return '0d 0h 0m';
  const m = Math.floor(ms/60000);
  const d = Math.floor(m/(60*24));
  const h = Math.floor((m - d*60*24)/60);
  const mm = m - d*60*24 - h*60;
  return `${d}d ${h}h ${mm}m`;
}

function setAdminUI(isAdmin, user) {
  const badge = document.getElementById('adminStatusBadge');
  const label = document.getElementById('adminUserLabel');
  const msg = document.getElementById('adminLoginMsg');
  const logoutBtn = document.getElementById('adminLogoutBtn');

  if (badge) {
    badge.classList.remove('admin-badge-on','admin-badge-off');
    badge.classList.add(isAdmin ? 'admin-badge-on' : 'admin-badge-off');
    badge.textContent = isAdmin ? 'Autentificat (Admin)' : 'Neautentificat';
  }
  if (label) {
    label.textContent = user ? `User: ${maskEmail(user.email || '')}` : '';
  }
  if (logoutBtn) logoutBtn.style.display = user ? 'inline-block' : 'none';

  if (msg) {
    msg.style.color = isAdmin ? '#00ff9c' : '#ff4d4d';
    msg.textContent = user
      ? (isAdmin ? 'Mod administrator activ.' : 'Autentificat, dar fara drepturi admin.')
      : 'Autentifica-te cu email + parola (Firebase).';
  }

  // arata/ascunde elemente admin-only daca exista
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? 'block' : 'none';
  });
  try { ensureNewsAdminUI(); } catch(e) {}
  try { loadNews(); } catch(e) {}

}

async function computeIsAdmin(user) {
  if (!user) return false;
  try {
    // 1) custom claim admin
    const token = await user.getIdTokenResult(true);
    if (token && token.claims && token.claims.admin === true) return true;
  } catch (e) {}
  // 2) whitelist email
  const email = (user.email || '').toLowerCase();
  return ADMIN_EMAILS.map(x => String(x).toLowerCase()).includes(email);
}

async function adminSignIn() {
  try {
    if (typeof firebase === 'undefined' || !firebase.auth) {
      alert('Firebase Auth nu este incarcat.');
      return;
    }
    const email = (document.getElementById('adminEmail')?.value || '').trim();
    const pass = (document.getElementById('adminPass')?.value || '');

    if (!email || !pass) {
      const msg = document.getElementById('adminLoginMsg');
      if (msg) { msg.style.color = '#ff4d4d'; msg.textContent = 'Completeaza email si parola.'; }
      return;
    }

    await firebase.auth().signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged va actualiza UI
  } catch (e) {
    const msg = document.getElementById('adminLoginMsg');
    if (msg) { msg.style.color = '#ff4d4d'; msg.textContent = 'Eroare autentificare: ' + (e?.message || e); }
  }
}

async function adminSignOut() {
  try {
    if (typeof firebase === 'undefined' || !firebase.auth) return;
    await firebase.auth().signOut();
  } catch (e) {}
}

function openAdminForm(kind) {
  const wrap = $('adminFormWrap');
  if (wrap) wrap.style.display = 'block';
  const sel = $('promoType');
  if (sel) sel.value = (kind === 'giveaway') ? 'giveaway' : 'promo';
  const t = $('adminFormTitle');
  if (t) t.textContent = (kind === 'giveaway') ? 'ğŸ AdaugÄƒ Giveaway' : 'â• AdaugÄƒ PromoÈ›ie';
}

async function uploadPromoMedia(promoId, file) {
  if (!storage || !file) return null;
  const safeName = String(file.name || 'file').replace(/[^\w.\-]+/g, '_');
  const path = `promos/${promoId}/${Date.now()}_${safeName}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  return { url, path, contentType: file.type || 'application/octet-stream', name: safeName };
}

let __promosUnsub = null;
let __activePromoId = null;
let __activePromo = null;

function cancelPromo() {
  ['promoTitle','promoPrize','promoDesc','promoEnds','p1','p2','p3','pTop5','pNext10','promoRules','ctaText','ctaUrl'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  if ($('promoBg')) $('promoBg').value = '';
  if ($('promoBanner')) $('promoBanner').value = '';
}

async function savePromo() {
  if (!db || !auth?.currentUser) {
    alert('Autentificare necesarÄƒ.');
    return;
  }
  const isAdmin = await computeIsAdmin(auth.currentUser);
  if (!isAdmin) {
    alert('Autentificat, dar fÄƒrÄƒ drepturi admin.');
    return;
  }

  const title = ($('promoTitle')?.value || '').trim();
  const prize = ($('promoPrize')?.value || '').trim();
  const desc = ($('promoDesc')?.value || '').trim();
  const ends = ($('promoEnds')?.value || '').trim();
  const points = parseInt($('promoPoints')?.value || '10', 10) || 10;

  const type = ($('promoType')?.value || 'promo').trim();
  const p1 = ($('p1')?.value || '').trim();
  const p2 = ($('p2')?.value || '').trim();
  const p3 = ($('p3')?.value || '').trim();
  const top5 = ($('pTop5')?.value || '').trim();
  const next10 = ($('pNext10')?.value || '').trim();
  const rules = ($('promoRules')?.value || '').trim();
  const ctaText = ($('ctaText')?.value || '').trim() || 'ParticipÄƒ acum!';
  const ctaUrl = ($('ctaUrl')?.value || '').trim();

  const bgFile = $('promoBg')?.files?.[0] || null;
  const bannerFile = $('promoBanner')?.files?.[0] || null;

  if (!title || !ends || !desc) {
    alert('CompleteazÄƒ titlul, descrierea È™i data expirÄƒrii.');
    return;
  }

  const endsAt = new Date(ends).getTime();
  if (!endsAt || endsAt <= Date.now()) {
    alert('Data expirÄƒrii trebuie sÄƒ fie Ã®n viitor!');
    return;
  }

  try {
    const ref = await db.collection('promos').add({
      title,
      prize: prize || null,
      desc,
      endsAt,
      endDate: ends,
      pointsPerPromotion: points,
      type,
      prizes: { p1: p1||null, p2: p2||null, p3: p3||null, top5: top5||null, next10: next10||null },
      rules: rules || null,
      ctaText,
      ctaUrl: ctaUrl || null,
      createdAt: Date.now(),
      status: 'active',
      bg: null,
      banner: null
    });

    if (bgFile) {
      const bg = await uploadPromoMedia(ref.id, bgFile);
      if (bg) await db.collection('promos').doc(ref.id).update({ bg });
    }
    if (bannerFile) {
      const banner = await uploadPromoMedia(ref.id, bannerFile);
      if (banner) await db.collection('promos').doc(ref.id).update({ banner });
    }

    cancelPromo();
    alert('Giveaway/PromoÈ›ie adÄƒugatÄƒ!');
  } catch (e) {
    console.error("savePromo error:", e);
    alert('Eroare la salvare (verificÄƒ Firestore Rules pentru promos / Storage).');
  }
}

async function deletePromo(promoId) {
  const isAdmin = await computeIsAdmin(auth?.currentUser);
  if (!isAdmin) return;
  if (!confirm('È˜tergi aceastÄƒ promoÈ›ie/giveaway?')) return;
  try {
    await db.collection('promos').doc(promoId).delete();
  } catch(e) {
    console.error(e);
    alert('Eroare la È™tergere (Rules).');
  }
}

function renderPromos(promos) {
  const host = $('promoList');
  const empty = $('emptyState');
  if (!host) return;

  if (!promos || !promos.length) {
    host.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  const now = Date.now();
  host.innerHTML = promos.map(p => {
    const endAt = Number(p.endsAt || p.endAt || 0);
    const live = endAt && endAt > now;
    const left = endAt ? (endAt - now) : 0;

    let bgStyle = '';
    let bgClass = 'promo-bg';
    if (p.bg && p.bg.url) {
      bgClass += ' has-img';
      const u = String(p.bg.url).replace(/["'()\\]/g,'');
      bgStyle = `background-image: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.78)), url(${u});`;
    }

    const bannerHtml = (p.banner && p.banner.url)
      ? `<div style="margin-top:8px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.14)">
           <img src="${String(p.banner.url).replace(/["'()\\]/g,'')}" alt="" style="width:100%;height:160px;object-fit:cover;display:block">
         </div>`
      : ``;

    const badgeCls = live ? 'live' : 'ended';
    const badgeTxt = live ? 'LIVE' : 'EXPIRAT';
    const typeLbl = (String(p.type||'promo')==='giveaway') ? 'ğŸ Giveaway' : 'âš¡ PromoÈ›ie';
    const when = p.endDate ? escapeHtml(String(p.endDate).replace('T',' ')) : (endAt ? new Date(endAt).toLocaleString('ro-RO') : 'â€”');

    const prizes = p.prizes || {};
    const p1 = escapeHtml(prizes.p1 || p.prize || 'â€”');
    const p2 = escapeHtml(prizes.p2 || 'â€”');
    const p3 = escapeHtml(prizes.p3 || 'â€”');
    const top5 = escapeHtml(prizes.top5 || '');
    const next10 = escapeHtml(prizes.next10 || '');

    const rules = escapeHtml(p.rules || '');
    const ctaText = escapeHtml(p.ctaText || 'ParticipÄƒ acum!');
    const ctaUrl = (p.ctaUrl || '').trim();

    const adminBtns = window.__SBYT_ADMIN
      ? `<button class="btn btn-ghost" style="padding:10px 12px" onclick="deletePromo('${p._id}')">ğŸ—‘ï¸ È˜terge</button>`
      : ``;

    const ctaBtn = live
      ? `<button class="btn btn-primary" style="padding:12px 16px" onclick="openJoin('${p._id}')">ğŸš€ ${ctaText}</button>`
      : `<button class="btn btn-ghost" style="padding:12px 16px" disabled>Campanie Ã®nchisÄƒ</button>`;

    const linkHtml = (ctaUrl && live)
      ? `<a class="link" href="${escapeHtml(ctaUrl)}" target="_blank" rel="noopener">Link Ã®nregistrare</a>`
      : '';

    return `
      <div class="promo-card">
        <div class="${bgClass}" style="${bgStyle}"></div>
        <div class="promo-overlay"></div>
        <div class="promo-inner">
          <div class="promo-top">
            <div class="badge ${badgeCls}">${typeLbl} â€¢ ${badgeTxt}</div>
            <div class="badge ${badgeCls}">â³ ${live ? formatCountdown(left) : '0d 0h 0m'}</div>
          </div>

          <div>
            <div class="promo-title">${escapeHtml(p.title||'FÄƒrÄƒ titlu')}</div>
            <div class="promo-sub">${escapeHtml(p.desc||'')}</div>
          </div>

          ${bannerHtml}

          <div class="promo-meta">
            <span class="chip">ğŸ“… ExpirÄƒ: <b>${when}</b></span>
            <span class="chip">ğŸ¯ Bonus: <b>referral + clasament</b></span>
          </div>

          <div class="promo-prizes">
            <div class="prize"><b>ğŸ† Premiul I</b><div class="v">${p1}</div></div>
            <div class="prize"><b>ğŸ¥ˆ Premiul II</b><div class="v">${p2}</div></div>
            <div class="prize"><b>ğŸ¥‰ Premiul III</b><div class="v">${p3}</div></div>
          </div>

          ${(top5||next10) ? `
            <div class="promo-prizes" style="grid-template-columns:1fr 1fr">
              <div class="prize"><b>ğŸ”¥ Primele 5 locuri</b><div class="v">${top5||'â€”'}</div></div>
              <div class="prize"><b>âœ¨ UrmÄƒtoarele 10 locuri</b><div class="v">${next10||'â€”'}</div></div>
            </div>
          ` : ''}

          <div class="promo-sub" style="border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);padding:10px 12px;border-radius:18px">
            <b style="color:rgba(255,255,255,.92)">ğŸ“œ Regulament</b><br>
            ${rules ? (rules.length>320 ? rules.slice(0,320)+'â€¦' : rules) : 'â€”'}
          </div>

          <div class="cta-row">
            <div class="promo-meta">
              <span>âœ… Participare rapidÄƒ</span>
              ${linkHtml ? `<span>â€¢</span>${linkHtml}` : ''}
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              ${adminBtns}
              ${ctaBtn}
            </div>
          </div>

        </div>
      </div>
    `;
  }).join('');
}

function listenPromos() {
  const list = $('promoList');
  if (!list || !db) return;

  if (__promosUnsub) { try { __promosUnsub(); } catch(_) {} __promosUnsub = null; }

  __promosUnsub = db.collection('promos').orderBy('createdAt','desc').onSnapshot(snap => {
    const promos = [];
    snap.forEach(doc => promos.push({ _id: doc.id, ...doc.data() }));
    renderPromos(promos);
  }, err => {
    console.error(err);
    $('emptyState').style.display = 'block';
    $('emptyState').textContent = 'Nu pot citi campaniile (verificÄƒ Firestore Rules pentru read).';
  });
}

function openJoin(promoId) {
  __activePromoId = promoId;
  $('joinModal')?.classList.add('open');
  $('joinMsg').style.display='none';
  $('joinBtn').disabled = true;
  loadJoin(promoId);
}
function closeJoin() {
  $('joinModal')?.classList.remove('open');
  __activePromoId=null; __activePromo=null;
  ['joinName','joinEmail','joinWallet','joinReferral'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  if ($('joinAgree')) $('joinAgree').checked=false;
  $('joinMsg').style.display='none';
}
async function loadJoin(promoId) {
  try {
    const doc = await db.collection('promos').doc(promoId).get();
    if (!doc.exists) throw new Error('Campania nu existÄƒ.');
    const p = { _id: doc.id, ...doc.data() };
    __activePromo = p;
    const now = Date.now();
    const endAt = Number(p.endsAt||0);
    const live = endAt>now;

    $('joinTitle').textContent = (String(p.type)==='giveaway') ? 'ğŸ ParticipÄƒ la Giveaway' : 'âš¡ ParticipÄƒ la PromoÈ›ie';
    $('joinInfo').innerHTML = `<b>${escapeHtml(p.title||'')}</b><br>
      <span class="small">${escapeHtml(p.desc||'')}</span><br>
      <span class="small">â³ ${live ? ('Timp rÄƒmas: <b>'+formatCountdown(endAt-now)+'</b>') : '<b>Campanie expiratÃ£</b>'}</span>`;
    $('joinBtn').disabled = !live;
    if (!live) {
      $('joinMsg').style.display='block';
      $('joinMsg').style.color = '#ff4d4d';
      $('joinMsg').textContent = 'Campania este expiratÄƒ.';
    }
  } catch(e) {
    $('joinInfo').textContent = 'Nu pot Ã®ncÄƒrca detaliile.';
    $('joinMsg').style.display='block';
    $('joinMsg').style.color = '#ff4d4d';
    $('joinMsg').textContent = 'Eroare: ' + (e?.message||e);
  }
}
function rid() {
  return (Date.now().toString(36)+Math.random().toString(36).slice(2,10)).toUpperCase();
}
async function submitJoin() {
  const msg = $('joinMsg');
  msg.style.display='none';

  if (!__activePromoId || !__activePromo) {
    msg.style.display='block'; msg.style.color='#ff4d4d';
    msg.textContent='Nu am identificat campania.'; return;
  }
  const p = __activePromo;
  if (Number(p.endsAt||0) <= Date.now()) {
    msg.style.display='block'; msg.style.color='#ff4d4d';
    msg.textContent='Campania este expiratÄƒ.'; return;
  }

  const email = ($('joinEmail')?.value||'').trim();
  const name = ($('joinName')?.value||'').trim();
  const wallet = ($('joinWallet')?.value||'').trim();
  const referral = ($('joinReferral')?.value||'').trim();
  const agree = !!$('joinAgree')?.checked;

  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email || !re.test(email)) {
    msg.style.display='block'; msg.style.color='#ff4d4d';
    msg.textContent='Introdu un email valid.'; return;
  }
  if (!agree) {
    msg.style.display='block'; msg.style.color='#ff4d4d';
    msg.textContent='BifeazÄƒ acordul.'; return;
  }

  try {
    $('joinBtn').disabled = true;
    const code = rid();
    await db.collection('promos').doc(__activePromoId).collection('participants').add({
      email,
      name: name||null,
      wallet: wallet||null,
      referral: referral||null,
      code,
      createdAt: Date.now()
    });
    msg.style.display='block'; msg.style.color='#00ff9c';
    msg.textContent = 'âœ… Ãnscris! Codul tÄƒu: ' + code;
  } catch(e) {
    console.error(e);
    msg.style.display='block'; msg.style.color='#ff4d4d';
    msg.textContent='Eroare la Ã®nscriere (Rules participants).';
    $('joinBtn').disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  try {
    auth?.onAuthStateChanged(async (user) => {
      const isAdmin = await computeIsAdmin(user);
      window.__SBYT_ADMIN = isAdmin;

      const pill = $('authPill');
      if (pill) pill.textContent = user ? ('âœ… ' + (user.email||'Autentificat')) : 'ğŸ”’ Neautentificat';

      setAdminUI(isAdmin, user);

      const b = $('adminButtons');
      if (b) b.style.display = isAdmin ? 'flex' : 'none';

      const adminPill = $('adminPill');
      if (adminPill) adminPill.textContent = isAdmin ? 'â­ Admin' : (user ? 'User' : 'â€”');
    });
  } catch(e) {}

  try { listenPromos(); } catch(e) {}
});
</script>

</body>
</html>
