<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Promo»õii & Concursuri</title>
  <style>
    :root{
      --blue-tech:#0066ff;
      --green-growth:#00ff88;
      --purple-innov:#8a2be2;
      --neon-cyan:#00ffff;
      --dark-bg:#0a0a1f;
      --darker-bg:#050510;
      --orange-alert:#ff9500;
      --danger:#ff4d4d;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family: Arial, sans-serif;}
    
    /* Particles Background */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -2;
    }
    
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,102,255,0.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(0,255,136,0.14), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(138,43,226,0.12), transparent 60%),
        linear-gradient(180deg, var(--darker-bg), var(--dark-bg));
      color:#fff;
      padding: 26px 14px;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Animated lines background from other code */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 60%, rgba(0, 255, 136, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 50% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 20%);
      z-index: -1;
      pointer-events: none;
    }
    
    .wrap{max-width:1100px;margin:0 auto;}
    
    /* 3D Logo in Topbar */
    .logo-3d-container {
      position: relative;
      width: 50px;
      height: 50px;
      perspective: 1000px;
    }

    .logo-3d {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: rotate3d 8s infinite linear;
    }

    .logo-3d img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: absolute;
      backface-visibility: hidden;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .backnote-orbit {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 70px;
      height: 70px;
      transform: translate(-50%, -50%);
      animation: orbit 6s infinite linear;
    }

    .backnote {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--neon-cyan);
      border-radius: 50%;
      filter: blur(2px);
      opacity: 0.7;
    }

    .backnote:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
    .backnote:nth-child(2) { top: 50%; right: 0; transform: translateY(-50%); }
    .backnote:nth-child(3) { bottom: 0; left: 50%; transform: translateX(-50%); }
    .backnote:nth-child(4) { top: 50%; left: 0; transform: translateY(-50%); }

    @keyframes rotate3d {
      0% { transform: rotateY(0deg) rotateX(5deg); }
      100% { transform: rotateY(360deg) rotateX(5deg); }
    }

    @keyframes orbit {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:16px 16px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      position:sticky;top:12px;backdrop-filter: blur(8px);
      z-index:10;
    }
    
    .brand{display:flex;align-items:center;gap:12px;}
    .brand .t1{font-weight:900;letter-spacing:0.5px;font-size:1.4rem;}
    .brand .t2{font-size:12px;opacity:0.8;margin-top:2px;}
    
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,0.25);
      font-size:12px;opacity:0.92;
    }
    .chip b{font-weight:800;}
    
    .btn{
      cursor:pointer;border:none;
      padding:11px 14px;border-radius:12px;
      background:linear-gradient(45deg, var(--blue-tech), var(--green-growth));
      color:#001018;font-weight:900;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:hover{transform: translateY(-1px);filter:brightness(1.05);}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      border:1px solid var(--border);
      color:#fff;font-weight:800;
    }
    .btn.danger{
      background:rgba(255,77,77,0.14);
      border:1px solid rgba(255,77,77,0.35);
      color:#fff;
    }
    
    .hero{
      text-align:center;
      padding: 28px 10px 10px;
    }
    
    h1{
      font-size: 2.3rem;
      background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan), var(--purple-innov));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    
    .subtitle{opacity:0.85;line-height:1.5;max-width:860px;margin:0 auto;}
    
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      margin-top: 18px;
    }
    
    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      padding:16px;
      overflow:hidden;
      position:relative;
    }
    
    .card.has-bg::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.80));
      z-index:0;
    }
    .card > *{position:relative;z-index:1;}
    
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;font-weight:900;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      margin-bottom:10px;
    }
    .badge.live{border-color:rgba(0,255,136,0.35);background:rgba(0,255,136,0.10);}
    .badge.dead{border-color:rgba(255,77,77,0.35);background:rgba(255,77,77,0.10);}
    
    .meta{display:flex;flex-wrap:wrap;gap:10px;opacity:0.9;margin-top:10px;font-size:13px;}
    .meta span{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid var(--border);}
    
    .kicker{font-weight:900;color:var(--neon-cyan);margin-bottom:8px;}
    .title{font-weight:950;font-size:1.2rem;margin-bottom:6px;}
    .text{opacity:0.9;line-height:1.5;white-space:pre-wrap;}
    .divider{height:1px;background:rgba(255,255,255,0.12);margin:12px 0;}
    
    .form{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,0.05);
      padding:16px;
    }
    
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .row.one{grid-template-columns:1fr;}
    
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#fff;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;}
    label{font-size:12px;opacity:0.85;}
    small.help{display:block;margin-top:8px;opacity:0.75;line-height:1.35;}
    
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    
    .admin-login{
      margin-top: 20px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.28);
    }
    .admin-login h2{font-size:1.2rem;margin-bottom:8px;}
    .admin-desc{opacity:0.85;line-height:1.4;margin-bottom:10px;}
    .admin-login-box{display:flex;gap:10px;flex-wrap:wrap;}
    .admin-login-box input{flex:1;min-width:230px;}
    .admin-status-row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;}
    .admin-badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:12px;}
    .admin-badge-on{background:rgba(0,255,156,0.12);border-color:rgba(0,255,156,0.35);}
    .admin-badge-off{background:rgba(255,77,77,0.10);border-color:rgba(255,77,77,0.35);}
    .admin-user-label{opacity:0.85;font-size:12px;}
    .admin-msg{margin-top:10px;font-size:13px;}
    .admin-only{display:none;}
    
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      font-size:12px;opacity:0.9;
    }
    .img-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .img-strip img{height:44px;width:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border);opacity:0.95;}
    .rulebox{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,0.22);opacity:0.92;}
  
    :root {
      --promo-card-h: 560px;
      --promo-media-h: 200px;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 14px;
    }
    
    .promo-card {
      height: var(--cardH, var(--promo-card-h));
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    
    .promo-media {
      height: var(--mediaH, var(--promo-media-h));
      background: rgba(255,255,255,0.05);
      background-size: cover;
      background-position: center;
      position:relative;
      flex: 0 0 auto;
    }
    
    .promo-overlay {
      position:absolute;
      left: calc(var(--overlayX, 6) * 1%);
      top:  calc(var(--overlayY, 8) * 1%);
      transform: translate(0,0);
      max-width: calc(100% - 12%);
      padding: 8px 10px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      background: rgba(0,0,0,0.35);
      line-height: 1.15;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.55);
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .promo-overlay[data-align="center"] { text-align:center; }
    .promo-overlay[data-align="right"] { text-align:right; }
    
    .promo-body {
      padding: 12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex: 1 1 auto;
      min-height: 0;
    }
    
    .promo-desc {
      opacity: 0.92;
      font-size: 0.98rem;
      overflow:auto;
      padding-right: 4px;
    }
    
    .promo-meta {
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }
    
    .promo-footer {
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex: 0 0 auto;
      background: rgba(0,0,0,0.12);
    }
    
    .join-row {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .join-row.one { grid-template-columns: 1fr; }
    .join-row input, .join-row button { width:100%; }
    
    .leaderboard-mini {
      max-height: 160px;
      overflow:auto;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px;
    }
    
    .leaderboard-mini table {
      width:100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }
    
    .leaderboard-mini th, .leaderboard-mini td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align:left;
      vertical-align: top;
    }
    .leaderboard-mini tr:last-child td { border-bottom:none; }

    .admin-actions {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .admin-actions .btn {
      padding: 10px 12px;
      border-radius: 14px;
    }

    @media (max-width: 520px) {
      :root {
        --promo-card-h: 620px;
        --promo-media-h: 190px;
      }
      .join-row { grid-template-columns: 1fr; }
      .promo-overlay {
        left: calc(var(--overlayX, 6) * 1%);
        top: calc(var(--overlayY, 6) * 1%);
        max-width: calc(100% - 10%);
      }
    }
    
    .promo-media { position: relative; }
    .promo-media .admin-actions{
      position:absolute;
      top:10px; right:10px;
      z-index:4;
      display:flex;
      gap:8px;
    }
    .promo-media .admin-actions .btn{
      padding:10px 12px;
      font-size:0.9rem;
      border-radius:999px;
    }
    
    .promo-leaderboard-out{
      margin-top: 10px;
      margin-bottom: 14px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
    }

    .promo-block{
      margin: 14px 0;
      border-radius: 24px;
      padding: 12px;
      background: transparent;
      border: 2px solid transparent;
      border-image: linear-gradient(135deg,
        rgba(0,255,255,0.95),
        rgba(138,43,226,0.95),
        rgba(0,255,136,0.95),
        rgba(0,102,255,0.95)
      ) 1;
      box-shadow:
        0 0 18px rgba(0,255,255,0.10),
        0 0 26px rgba(138,43,226,0.08);
      display:flex;
      gap: 14px;
      align-items: stretch;
    }
    
    .promo-block > .news-card{
      flex: 1 1 0;
      min-width: 0;
    }
    
    .promo-leaderboard-out{
      flex: 1 1 0;
      min-width: 0;
      border-radius: 22px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
    }
    
    @media (max-width: 980px){
      .promo-block{ flex-direction: column; }
    }

    #promoList{ display:flex !important; flex-direction:column !important; gap: 16px !important; }
    .promo-block{ width:100%; }
    .promo-card{ height: auto !important; min-height: 760px; }
    .promo-content{ overflow: visible !important; gap: 10px; }
    .promo-desc{ max-height: 180px; overflow:auto; padding-right: 6px; }
    .divider{ margin: 10px 0; }
    
    .promo-join .form-row{ align-items: stretch; }
    .promo-join .form-row input{ width: 100%; }
    .promo-join .form-row button{ width: 100%; min-width: 0 !important; }
    
    @media (min-width: 720px){
      .promo-join .form-row{ flex-wrap: nowrap; }
      .promo-join .form-row button{ width: auto; min-width: 160px !important; }
    }

    .prize-item{ display:block; width:100%; white-space:pre-wrap; padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.18); }
    .prize-item b{ font-weight:900; }
    .prize-gold{ border-color: rgba(255,215,0,0.55); box-shadow: 0 0 18px rgba(255,215,0,0.10); }
    .prize-silver{ border-color: rgba(192,192,192,0.55); box-shadow: 0 0 18px rgba(192,192,192,0.08); }
    .prize-bronze{ border-color: rgba(205,127,50,0.55); box-shadow: 0 0 18px rgba(205,127,50,0.08); }
    .prize-tierA{ border-color: rgba(0,255,255,0.45); box-shadow: 0 0 18px rgba(0,255,255,0.08); }
    .prize-tierB{ border-color: rgba(0,255,136,0.40); box-shadow: 0 0 18px rgba(0,255,136,0.06); }
    .prize-tierC{ border-color: rgba(138,43,226,0.40); box-shadow: 0 0 18px rgba(138,43,226,0.06); }
    .prize-subtitle{ font-weight:900; margin: 10px 0 8px; opacity:0.95; }
    
    .promo-card{ min-height: 1320px !important; }
    .promo-content{ overflow: visible !important; }

    .winners-wrap{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    
    .winners-title{
      font-weight: 900;
      margin: 2px 0 8px 0;
    }
    
    .winners-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .winner-row{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .winner-info{
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .winner-name{
      font-weight: 900;
      font-size: 1rem;
    }
    
    .winner-email{
      opacity: 0.8;
      font-size: 0.85rem;
    }
    
    .winner-prize{
      font-weight: 800;
      color: var(--neon-cyan);
      text-align: right;
    }
    
    .winner-row b{ font-weight: 900; }
    
    .winner-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      font-size: 12px;
      font-weight: 800;
    }

    .promo-leaderboard-out{
      display:flex;
      flex-direction:column;
    }
    
    .promo-leaderboard-out .leaderboard-mini{
      flex: 1 1 50%;
      min-height: 260px;
      max-height: none;
      overflow: auto;
    }
    
    .promo-leaderboard-out .winners-wrap{
      flex: 1 1 50%;
      min-height: 260px;
      max-height: none;
      overflow: auto;
    }
    
    @media (max-width: 980px){
      .promo-leaderboard-out .leaderboard-mini{ min-height: 240px; }
      .promo-leaderboard-out .winners-wrap{ min-height: 240px; }
    }

    .winners-prizes-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    
    .winners-prize-category {
      margin-bottom: 5px;
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .prize-icon {
      font-size: 1.2rem;
    }

    /* MODIFICƒÇRI NOI */

    /* Container pentru cele douƒÉ carduri egale */
    .leaderboard-split-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }

    .leaderboard-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .leaderboard-section-title {
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .leaderboard-scrollable {
      flex: 1;
      overflow-y: auto;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px;
    }

    /* Cardul c√¢»ôtigƒÉtori cu efect rainbow */
    .rainbow-card {
      border: 2px solid transparent;
      border-image: linear-gradient(45deg, 
        #ff0000, #ff8800, #ffff00, #00ff00, 
        #0088ff, #0000ff, #8800ff, #ff00ff) 1;
      border-radius: 16px;
      animation: rainbow-border 3s linear infinite;
      background: rgba(0, 0, 0, 0.3);
      box-shadow: 
        0 0 20px rgba(255, 0, 255, 0.3),
        0 0 40px rgba(0, 255, 255, 0.2),
        inset 0 0 20px rgba(0, 0, 0, 0.5);
    }

    @keyframes rainbow-border {
      0% { border-image-source: linear-gradient(45deg, 
        #ff0000, #ff8800, #ffff00, #00ff00, 
        #0088ff, #0000ff, #8800ff, #ff00ff); }
      25% { border-image-source: linear-gradient(45deg, 
        #ff00ff, #ff0000, #ff8800, #ffff00, 
        #00ff00, #0088ff, #0000ff, #8800ff); }
      50% { border-image-source: linear-gradient(45deg, 
        #8800ff, #ff00ff, #ff0000, #ff8800, 
        #ffff00, #00ff00, #0088ff, #0000ff); }
      75% { border-image-source: linear-gradient(45deg, 
        #0000ff, #8800ff, #ff00ff, #ff0000, 
        #ff8800, #ffff00, #00ff00, #0088ff); }
      100% { border-image-source: linear-gradient(45deg, 
        #ff0000, #ff8800, #ffff00, #00ff00, 
        #0088ff, #0000ff, #8800ff, #ff00ff); }
    }

    /* Banner pentru status promo»õie */
    .promo-status-banner {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      text-align: center;
      font-weight: 900;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      animation: phosphorescent-gradient 2s linear infinite;
      color: #000;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .promo-status-banner.in-progress {
      background: linear-gradient(90deg, 
        #00ffff, #00ff88, #00ffff, #00ff88);
      background-size: 300% 100%;
    }

    .promo-status-banner.finalized {
      background: linear-gradient(90deg, 
        #ff4d4d, #ff9500, #ff4d4d, #ff9500);
      background-size: 300% 100%;
      color: #fff;
      text-shadow: 0 0 10px rgba(255,255,255,0.7);
    }

    @keyframes phosphorescent-gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Email prize styling */
    .email-prize-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(45deg, var(--neon-cyan), var(--purple-innov));
      color: #000;
      font-weight: 900;
      font-size: 0.85rem;
      margin-left: 8px;
    }

    .winner-prize-full {
      font-weight: 800;
      color: var(--neon-cyan);
      text-align: right;
      background: rgba(0,0,0,0.3);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,255,255,0.3);
    }

    /* Responsive adjustments */
    @media (max-width: 980px) {
      .leaderboard-scrollable {
        min-height: 200px;
      }
    }

    /* Footer simplificat */
    .footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      opacity: 0.6;
      font-size: 0.9rem;
    }

    /* NOU: Stil pentru puncte »ôi scor */
    .winner-score {
      font-size: 0.8rem;
      opacity: 0.9;
      color: var(--green-growth);
      font-weight: 700;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.3);
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* NOU: Stil pentru dashboard admin c√¢»ôtigƒÉtori */
    .winners-dashboard {
      margin-top: 20px;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: rgba(0,0,0,0.2);
    }

    .winners-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .winner-details-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .winner-details-content {
      background: var(--dark-bg);
      border-radius: 18px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    .winner-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .winner-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .winner-stat-item {
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
    }

  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <!-- Particles.js pentru efectele de fundal -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  
  <!-- Firebase Functions (callable) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

    const cfg = window.firebaseConfig;
    if (!cfg || !cfg.projectId) {
      console.error("Firebase config missing projectId; cannot init Functions.");
    } else {
      let app;
      if (!getApps().length) {
        app = initializeApp(cfg);
      } else {
        app = getApps()[0];
      }

      const functions = getFunctions(app, "europe-west1");

      window.sendPromoSignupEmail = httpsCallable(functions, "sendPromoSignupEmail");
      window.sendPromoWinnerEmail = httpsCallable(functions, "sendPromoWinnerEmail");
      window.sendWinnerNotification = httpsCallable(functions, "sendWinnerNotification");

      console.log("Functions callable ready:", { projectId: cfg.projectId, region: "europe-west1" });
    }
  </script>
  
  <script>
  window.firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    storageBucket: "stancubyt-fc2b9.firebasestorage.app",
    messagingSenderId: "263244200492",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89",
    measurementId: "G-272S9HSY3K"
  };
  try {
    if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
      firebase.initializeApp(window.firebaseConfig);
    }
  } catch (e) {
    console.warn("Firebase init warning:", e);
  }
  </script>
</head>

<body>
  <!-- Particles Background -->
  <div id="particles-js"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo-3d-container">
          <div class="logo-3d">
            <img src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="StancuBYT Logo" onerror="this.src='https://via.placeholder.com/50/0a0a1f/00ff88?text=SBYT'">
          </div>
          <div class="backnote-orbit">
            <div class="backnote"></div>
            <div class="backnote"></div>
            <div class="backnote"></div>
            <div class="backnote"></div>
          </div>
        </div>
        <div>
          <div class="t1">StancuBYT</div>
          <div class="t2">Promo»õii & Concursuri</div>
        </div>
      </div>
      <div class="chip">
        <span>üëë Admin:</span>
        <b id="currentAdminStatus">Offline</b>
      </div>
    </div>

    <div class="hero">
      <h1>üéÅ Promo»õii & Concursuri</h1>
      <p class="subtitle">GestioneazƒÉ »ôi participƒÉ la promo»õii »ôi giveaway-uri cu sistem complet de clasament »ôi premii</p>

      <div class="actions admin-only" style="justify-content:center; margin-top:14px; display:none;">
        <button class="btn" type="button" onclick="openPromoForm('promo')">‚ûï AdaugƒÉ Promo»õie</button>
        <button class="btn secondary" type="button" onclick="openPromoForm('giveaway')">üèÜ AdaugƒÉ Concurs</button>
      </div>
    </div>

    <!-- Dashboard Admin pentru C√¢»ôtigƒÉtori -->
    <div class="winners-dashboard admin-only" style="display:none;">
      <div class="kicker">üèÜ Dashboard C√¢»ôtigƒÉtori</div>
      <div class="winners-controls">
        <button class="btn" onclick="loadAllWinners()">üîÑ Re√ÆncarcƒÉ C√¢»ôtigƒÉtori</button>
        <button class="btn secondary" onclick="exportWinnersToCSV()">üìä Export CSV</button>
      </div>
      <div id="globalWinnersList"></div>
    </div>

    <div class="card">
      <div class="kicker">üìå Promo»õii / Giveaway-uri Active</div>
      <div id="promoList" class="grid"></div>

      <div id="promoForm" class="form admin-only" style="display:none;">
        <div class="kicker">‚ú® CreeazƒÉ promo»õie / concurs</div>

        <div class="row">
          <div>
            <label>Tip</label>
            <select id="promoKind">
              <option value="promo">üì£ Promo»õie</option>
              <option value="giveaway">üéÅ Concurs / Giveaway</option>
            </select>
          </div>
          <div>
            <label>Data & ora expirƒÉrii</label>
            <input id="promoEnds" type="datetime-local">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Titlu</label>
            <input id="promoTitle" type="text" maxlength="120" placeholder="Ex: Giveaway SBYT ‚Äî 7 zile + premii pe niveluri">
          </div>
          <div>
            <label>Puncte / ac»õiune (gamification)</label>
            <input id="promoPoints" type="number" min="1" step="1" value="10" placeholder="Ex: 10">
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Hook (1‚Äì2 fraze, mesaj scurt de impact)</label>
            <textarea id="promoHook" rows="2" placeholder="Ex: IntrƒÉ √Æn TOP 5 »ôi c√¢»ôtigƒÉ bonusuri! Fiecare share = +10 puncte."></textarea>
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Descriere (beneficiu + cum func»õioneazƒÉ)</label>
            <textarea id="promoDesc" placeholder="Ex: ParticipƒÉ, str√¢nge puncte »ôi intrƒÉ √Æn clasament. La final, primele locuri primesc premii, iar participan»õii activi primesc bonusuri."></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kicker">üé® Vizual (banner + imagini de fundal)</div>
        <div class="row">
          <div>
            <label>Banner (recomandat)</label>
            <input id="promoBanner" type="file" accept="image/*">
          </div>
          <div>
            <label>Imagini fundal (max 3 recomandat)</label>
            <input id="promoBg" type="file" accept="image/*" multiple>
          </div>
        </div>
        <small class="help">SalveazƒÉ √Æn Firestore: <b>stats/visits</b> (c√¢mpuri <b>promos</b> + <b>participants</b>). Upload imagini √Æn Storage: <b>/news/**</b>.</small>

        <div class="divider"></div>

        <div class="kicker">üèÜ Premii (distribu»õie atractivƒÉ)</div>
        <div class="row">
          <div><label>Premiul I</label><input id="prize1" type="text" maxlength="180" placeholder="Ex: 10.000 SBYT + rol VIP"></div>
          <div><label>Premiul II</label><input id="prize2" type="text" maxlength="180" placeholder="Ex: 5.000 SBYT"></div>
        </div>
        <div class="row">
          <div><label>Premiul III</label><input id="prize3" type="text" maxlength="180" placeholder="Ex: 2.500 SBYT"></div>
          <div><label>Primele 5 locuri (dupƒÉ podium)</label><input id="prizeTop5" type="text" maxlength="180" placeholder="Ex: 500 SBYT fiecare"></div>
        </div>
        <div class="row">
          <div><label>UrmƒÉtoarele 10 locuri</label><input id="prizeNext10" type="text" maxlength="180" placeholder="Ex: 200 SBYT fiecare"></div>
          <div><label>Bonus participare / surprizƒÉ</label><input id="prizeBonus" type="text" maxlength="180" placeholder="Ex: 50 SBYT pentru cei cu min. 3 ac»õiuni"></div>
        </div>

        <div class="divider"></div>

        <div class="kicker">üìú Regulament & condi»õii</div>
        <div class="row one">
          <div>
            <label>Regulament (clar, pe pa»ôi)</label>
            
<div class="form-row" style="flex-direction:column; gap:10px;">
  <div style="font-weight:900;">üìú Reguli (5 puncte + text)</div>
  <input id="rule1" type="text" placeholder="Regula 1 (ex: UrmƒÉre»ôte contul / Subscribe)" maxlength="120">
  <input id="rule2" type="text" placeholder="Regula 2" maxlength="120">
  <input id="rule3" type="text" placeholder="Regula 3" maxlength="120">
  <input id="rule4" type="text" placeholder="Regula 4" maxlength="120">
  <input id="rule5" type="text" placeholder="Regula 5" maxlength="120">
  <textarea id="rulesText" placeholder="Text reguli (op»õional, 5-6 r√¢nduri)" rows="6" style="width:100%;"></textarea>
</div>

          </div>
        </div>

        <div class="actions">
          <button id="promoSaveBtn" class="btn" type="button" onclick="savePromo()">üíæ SalveazƒÉ</button>
          <button class="btn secondary" type="button" onclick="cancelPromo()">‚ùå AnuleazƒÉ</button>
        </div>

        <small class="help">
          SalveazƒÉ √Æn Firestore: <b>promos</b> (»ôi subcolec»õie <b>participants</b>). Scrierea necesitƒÉ autentificare admin.
        </small>
      </div>
    </div>

    <div class="admin-login" id="admin-login">
      <h2>üîê Administrator Login</h2>
      <div class="admin-login-box">
        <input type="email" id="adminEmail" placeholder="Email administrator" autocomplete="username">
        <input type="password" id="adminPass" placeholder="Parola administrator" autocomplete="current-password">
        <button class="btn" type="button" onclick="adminSignIn()">Autentificare</button>
        <button class="btn secondary" type="button" onclick="adminSignOut()" id="adminLogoutBtn" style="display:none;">Delogare</button>
      </div>

      <div class="admin-status-row">
        <span id="adminStatusBadge" class="admin-badge admin-badge-off">Neautentificat</span>
        <span id="adminUserLabel" class="admin-user-label"></span>
      </div>

      <p id="adminLoginMsg" class="admin-msg"></p>
    </div>

    <div class="footer">
      <div class="footer-inner">
        <span style="opacity:.8;">¬© StancuBYT - Toate drepturile rezervate</span>
      </div>
    </div>
  </div>

<!-- Modal pentru detalii c√¢»ôtigƒÉtor -->
<div id="winnerDetailsModal" class="winner-details-modal" style="display:none;">
  <div class="winner-details-content">
    <div class="winner-details-header">
      <h3>üèÜ Detalii C√¢»ôtigƒÉtor</h3>
      <button class="btn secondary" onclick="closeWinnerDetails()">‚úï</button>
    </div>
    <div id="winnerDetailsContent"></div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;','\\':'&#92;'}[ch]||ch));
  const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

  const ADMIN_EMAIL = "stancubyt@gmail.com";
  const auth = ()=> (window.firebase && firebase.auth) ? firebase.auth() : null;
  const fs = ()=> (window.firebase && firebase.firestore) ? firebase.firestore() : null;
  const st = ()=> (window.firebase && firebase.storage) ? firebase.storage() : null;

  let __isAdmin = false;
  let __user = null;
  let __editingPromoId = null;
  let __statsUnsub = null;
  let __statsCache = { promos: [], participants: {} };
  let __allWinners = [];
  window.__statsCache = __statsCache;

  function statsRef(){
    const d = fs();
    if(!d) return null;
    return d.collection('stats').doc('visits');
  }

  function normalizeStats(data){
    const promos = Array.isArray(data?.promos) ? data.promos : [];
    const participants = (data?.participants && typeof data.participants === 'object') ? data.participants : {};
    return { promos, participants };
  }

  function setAdminUI(isAdmin, user){
    __isAdmin = !!isAdmin;
    __user = user || null;
    window.__SBYT_ADMIN = __isAdmin;
    window.__SBYT_USER_EMAIL = (__user && __user.email) ? __user.email : "";

    document.querySelectorAll('.admin-only').forEach(el=>{
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });

    const badge = $('adminStatusBadge');
    const label = $('adminUserLabel');
    const logoutBtn = $('adminLogoutBtn');
    if (badge) {
      badge.textContent = __isAdmin ? 'Autentificat' : 'Neautentificat';
      badge.className = __isAdmin ? 'admin-badge admin-badge-on' : 'admin-badge admin-badge-off';
    }
    if (label) label.textContent = __isAdmin && user ? user.email : '';
    if (logoutBtn) logoutBtn.style.display = __isAdmin ? 'inline-flex' : 'none';
    
    // Update topbar status
    const topbarStatus = $('currentAdminStatus');
    if (topbarStatus) {
      topbarStatus.textContent = __isAdmin ? 'Online' : 'Offline';
      topbarStatus.style.color = __isAdmin ? '#00ff88' : '#ff4d4d';
    }

    // √éncarcƒÉ c√¢»ôtigƒÉtorii dacƒÉ suntem admin
    if (__isAdmin) {
      loadAllWinners();
    }
  }

  async function computeIsAdmin(user){
    return !!(user && (user.email||'').toLowerCase() === ADMIN_EMAIL.toLowerCase());
  }

  window.adminSignIn = async function adminSignIn(){
    const a = auth();
    const msg = $('adminLoginMsg');
    if(!a) {
      if(msg) msg.textContent = 'Firebase Auth nu este disponibil.';
      return;
    }
    const email = ($('adminEmail')?.value||'').trim();
    const pass  = ($('adminPass')?.value||'').trim();
    if(!email || !pass) {
      if(msg) msg.textContent = 'CompleteazƒÉ email + parolƒÉ.';
      return;
    }
    try {
      await a.signInWithEmailAndPassword(email, pass);
      if(msg) msg.textContent = '';
    } catch(e) {
      console.error('adminSignIn:', e);
      if(msg) msg.textContent = 'Eroare autentificare. VerificƒÉ datele.';
    }
  };

  window.adminSignOut = async function adminSignOut(){
    const a = auth();
    if(!a) return;
    try { await a.signOut(); } catch(e) { console.warn(e); }
  };

  window.openPromoForm = function openPromoForm(kind, promoId){
    const f = $('promoForm');
    if(!f) return;
    __editingPromoId = promoId || null;

    f.style.display = 'block';
    $('promoSaveBtn')?.setAttribute('data-mode', promoId ? 'edit' : 'add');

    if ($('promoKind')) $('promoKind').value = kind || 'promo';

    if(!promoId){
      ['promoEnds','promoTitle','promoPoints','promoHook','promoDesc','prize1','prize2','prize3','promoRules','cardHeight','mediaHeight','overlayText','overlayFontSize','overlayX','overlayY','overlayAlign','overlayColor'].forEach(id=>{ if($(id)) $(id).value=''; });
      if($('promoPoints')) $('promoPoints').value = 10;
      if($('cardHeight')) $('cardHeight').value = 560;
      if($('mediaHeight')) $('mediaHeight').value = 200;
      if($('overlayFontSize')) $('overlayFontSize').value = 22;
      if($('overlayX')) $('overlayX').value = 6;
      if($('overlayY')) $('overlayY').value = 8;
      if($('overlayAlign')) $('overlayAlign').value = 'left';
      if($('overlayColor')) $('overlayColor').value = '#ffffff';
      if($('promoBanner')) $('promoBanner').value = '';
      if($('promoBg')) $('promoBg').value = '';
      return;
    }

    const p = (__statsCache.promos || []).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    if($('promoKind')) $('promoKind').value = p.kind || kind || 'promo';
    if($('promoEnds')) $('promoEnds').value = p.ends || '';
    if($('promoTitle')) $('promoTitle').value = p.title || '';
    if($('promoPoints')) $('promoPoints').value = Number(p.points||10);
    if($('promoHook')) $('promoHook').value = p.hook || '';
    if($('promoDesc')) $('promoDesc').value = p.desc || '';
    if($('prize1')) $('prize1').value = (p.prizes && p.prizes.p1) ? p.prizes.p1 : '';
    if($('prize2')) $('prize2').value = (p.prizes && p.prizes.p2) ? p.prizes.p2 : '';
    if($('prize3')) $('prize3').value = (p.prizes && p.prizes.p3) ? p.prizes.p3 : '';
    if($('prizeTop5')) $('prizeTop5').value = (p.prizes && p.prizes.top5) ? p.prizes.top5 : '';
    if($('prizeNext10')) $('prizeNext10').value = (p.prizes && p.prizes.next10) ? p.prizes.next10 : '';
    if($('prizeBonus')) $('prizeBonus').value = (p.prizes && p.prizes.bonus) ? p.prizes.bonus : '';
    if($('promoRules')) $('promoRules').value = p.rules || '';

    if($('cardHeight')) $('cardHeight').value = p.ui?.cardH ?? 560;
    if($('mediaHeight')) $('mediaHeight').value = p.ui?.mediaH ?? 200;
    if($('overlayText')) $('overlayText').value = p.ui?.overlay?.text ?? '';
    if($('overlayFontSize')) $('overlayFontSize').value = p.ui?.overlay?.size ?? 22;
    if($('overlayX')) $('overlayX').value = p.ui?.overlay?.x ?? 6;
    if($('overlayY')) $('overlayY').value = p.ui?.overlay?.y ?? 8;
    if($('overlayAlign')) $('overlayAlign').value = p.ui?.overlay?.align ?? 'left';
    if($('overlayColor')) $('overlayColor').value = p.ui?.overlay?.color ?? '#ffffff';

    if($('promoBanner')) $('promoBanner').value = '';
    if($('promoBg')) $('promoBg').value = '';
  };

  window.cancelPromo = function cancelPromo(){
    const f = $('promoForm');
    if(f) f.style.display = 'none';
    __editingPromoId = null;
  };

  async function resizeImageFile(file, opts={}){
    const maxW = Number(opts.maxW || 1600);
    const maxH = Number(opts.maxH || 1600);
    const quality = clamp(Number(opts.quality || 0.86), 0.4, 0.92);

    const bmp = await createImageBitmap(file);
    let w = bmp.width, h = bmp.height;
    const ratio = Math.min(maxW / w, maxH / h, 1);
    w = Math.round(w * ratio);
    h = Math.round(h * ratio);

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.drawImage(bmp, 0, 0, w, h);

    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    const name = (file.name || 'image').replace(/\.[^.]+$/, '') + '_resized.jpg';
    return new File([blob], name, { type: 'image/jpeg' });
  }

  async function uploadResizedImage(file, storagePath){
    const storage = st();
    if(!storage) throw new Error('Storage indisponibil');
    const ref = storage.ref().child(storagePath);
    const resized = await resizeImageFile(file, { maxW: 1600, maxH: 1600, quality: 0.86 });
    const snap = await ref.put(resized, { contentType: 'image/jpeg' });
    const url = await snap.ref.getDownloadURL();
    return { url, path: storagePath };
  }

  function makeId(prefix='p'){
    return prefix + '_' + Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(3);
  }

  async function readStatsOnce(){
    const ref = statsRef();
    if(!ref) return { promos: [], participants: {} };
    const doc = await ref.get();
    return normalizeStats(doc.exists ? doc.data() : {});
  }

  async function writeStats(next){
    const ref = statsRef();
    if(!ref) throw new Error('statsRef null');
    await ref.set(next, { merge: true });
  }

  window.savePromo = async function savePromo(){
    if(!__isAdmin) {
      alert('Trebuie sƒÉ fii logat ca admin.');
      return;
    }

    const kind = ($('promoKind')?.value || 'promo').trim();
    const ends = ($('promoEnds')?.value || '').trim();
    const title = ($('promoTitle')?.value || '').trim();
    const points = Number(($('promoPoints')?.value || '10'));
    const hook = ($('promoHook')?.value || '').trim();
    const desc = ($('promoDesc')?.value || '').trim();

    const rulesObj = {
      r1: (document.getElementById('rule1')?.value || '').trim(),
      r2: (document.getElementById('rule2')?.value || '').trim(),
      r3: (document.getElementById('rule3')?.value || '').trim(),
      r4: (document.getElementById('rule4')?.value || '').trim(),
      r5: (document.getElementById('rule5')?.value || '').trim(),
      text: (document.getElementById('rulesText')?.value || '').trim()
    };
    const rulesLegacy = [rulesObj.r1, rulesObj.r2, rulesObj.r3, rulesObj.r4, rulesObj.r5, rulesObj.text].filter(Boolean).join('\n');
    const rules = rulesLegacy;

    if(!title) return alert('CompleteazƒÉ: Titlu');
    if(!desc) return alert('CompleteazƒÉ: Descriere');
    if(!ends) return alert('CompleteazƒÉ: Data & ora expirƒÉrii');

    const ui = {
      cardH: clamp(Number($('cardHeight')?.value || 560), 360, 1200),
      mediaH: clamp(Number($('mediaHeight')?.value || 200), 120, 520),
      overlay: {
        text: ($('overlayText')?.value || '').trim(),
        size: clamp(Number($('overlayFontSize')?.value || 22), 10, 72),
        x: clamp(Number($('overlayX')?.value || 6), 0, 90),
        y: clamp(Number($('overlayY')?.value || 8), 0, 90),
        align: ($('overlayAlign')?.value || 'left'),
        color: ($('overlayColor')?.value || '#ffffff')
      }
    };

    // ASIGURƒÇ-TE CƒÇ PREMIULE SUNT SALVATE CORECT
    const prizes = {
      p1: ($('prize1')?.value || '').trim(),
      p2: ($('prize2')?.value || '').trim(),
      p3: ($('prize3')?.value || '').trim(),
      top5: ($('prizeTop5')?.value || '').trim(),
      next10: ($('prizeNext10')?.value || '').trim(),
      bonus: ($('prizeBonus')?.value || '').trim()
    };

    console.log('Premii salvate:', prizes); // Pentru debugging

    const bannerFile = $('promoBanner')?.files?.[0] || null;
    const bgFiles = Array.from($('promoBg')?.files || []).slice(0, 3);

    try {
      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      const participants = (stats.participants && typeof stats.participants === 'object') ? stats.participants : {};

      const now = Date.now();
      const id = __editingPromoId || makeId(kind==='giveaway' ? 'g' : 'p');

      const idx = promos.findIndex(p => String(p.id) === String(id));
      const prev = idx >= 0 ? promos[idx] : null;

      let banner = prev?.banner || null;
      let bgs = Array.isArray(prev?.bgs) ? prev.bgs : [];

      if (bannerFile) {
        const storagePath = `news/promos/${id}/banner_${Date.now()}_${bannerFile.name}`.replace(/\s+/g,'_');
        banner = await uploadResizedImage(bannerFile, storagePath);
      }
      if (bgFiles.length) {
        const uploads = [];
        for (const f of bgFiles) {
          const storagePath = `news/promos/${id}/bg_${Date.now()}_${f.name}`.replace(/\s+/g,'_');
          uploads.push(uploadResizedImage(f, storagePath));
        }
        bgs = await Promise.all(uploads);
      }

      const promoObj = {
        id,
        kind,
        ends,
        title,
        points: Number.isFinite(points) ? points : 10,
        hook,
        desc,
        rulesObj,
        rules,
        prizes, // ASIGURƒÇ-TE CƒÇ OB»öIUNEA prizes ESTE SALVATƒÇ
        ui,
        banner,
        bgs,
        createdAt: prev?.createdAt || now,
        updatedAt: now
      };

      console.log('Obiect promo salvat:', promoObj); // Pentru debugging

      if (idx >= 0) promos[idx] = promoObj;
      else promos.unshift(promoObj);

      if (!participants[String(id)]) participants[String(id)] = participants[String(id)] || [];

      await writeStats({ promos, participants });
      __editingPromoId = null;
      cancelPromo();
      alert('Salvat ‚úîÔ∏è');
    } catch(e) {
      console.error('savePromo:', e);
      alert('Eroare la salvare (verificƒÉ Auth/Storage).');
    }
  };

  window.editPromo = function editPromo(promoId){
    if(!__isAdmin) return;
    const p = (__statsCache.promos||[]).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    openPromoForm(p.kind || 'promo', promoId);
    $('promoForm')?.scrollIntoView({ behavior:'smooth', block:'start' });
  };

  async function tryDeleteStorageFiles(promo){
    try {
      if(!__isAdmin) return;
      const storage = st();
      if(!storage) return;
      const paths = [];
      if(promo?.banner?.path) paths.push(promo.banner.path);
      if(Array.isArray(promo?.bgs)) promo.bgs.forEach(x=>x?.path && paths.push(x.path));
      for (const p of paths) {
        try { await storage.ref().child(p).delete(); } catch(e) { }
      }
    } catch(e){}
  }

  window.deletePromo = async function deletePromo(promoId){
    if(!__isAdmin) return alert('Doar admin poate »ôterge.');
    if(!confirm('Sigur vrei sƒÉ »ôtergi aceastƒÉ promo»õie/concurs?')) return;

    try {
      const stats = await readStatsOnce();
      const promos = (stats.promos||[]).slice();
      const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};

      const idx = promos.findIndex(p=>String(p.id)===String(promoId));
      const promo = idx>=0 ? promos[idx] : null;
      if(idx>=0) promos.splice(idx,1);
      delete participants[String(promoId)];

      await writeStats({ promos, participants });
      await tryDeleteStorageFiles(promo);
    } catch(e) {
      console.error('deletePromo:', e);
      alert('Eroare la »ôtergere.');
    }
  };

  function maskEmail(em){
    const s = String(em||'');
    const at = s.indexOf('@');
    if(at<=1) return s ? (s[0] + '***') : '';
    const name = s.slice(0, at);
    const dom = s.slice(at);
    return name.slice(0,2) + '***' + dom;
  }
  function maskCode(code){
    const s = String(code||'');
    if(s.length<=2) return s;
    return s.slice(0,2) + '‚Ä¢'.repeat(Math.min(12, s.length-2));
  }
  function genCode(){
    return Math.random().toString(36).slice(2, 10).toUpperCase();
  }

  async function addParticipant(promoId, payload){
    const stats = await readStatsOnce();
    const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};
    const arr = Array.isArray(participants[String(promoId)]) ? participants[String(promoId)].slice() : [];

    const walletKey = String(payload.wallet||'').toLowerCase();
    if(walletKey && arr.some(x => String(x.wallet||'').toLowerCase() === walletKey)) {
      throw new Error('Acest wallet este deja √Ænscris.');
    }

    const emailKey = String(payload.email||'').toLowerCase();
    if(emailKey && arr.some(x => String(x.email||'').toLowerCase() === emailKey)) {
      throw new Error('Acest email este deja √Ænscris.');
    }

    const id = 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
    const code = genCode();
    const participant = {
      id,
      name: payload.name || 'Anonim',
      email: payload.email || '',
      wallet: payload.wallet || '',
      code,
      referral: (payload.referral||'').trim(),
      joinedAt: Date.now()
    };
    arr.push(participant);
    participants[String(promoId)] = arr;

    await writeStats({ participants });
    return participant;
  }

  // Func»õie pentru tabelul cu participan»õi
  function buildParticipantsTable(promoId) {
    const arr = Array.isArray(__statsCache.participants?.[String(promoId)]) ? __statsCache.participants[String(promoId)] : [];
    if(!arr.length) {
      return `<div style="padding:20px;text-align:center;opacity:0.7;">Nu existƒÉ participan»õi √ÆncƒÉ.</div>`;
    }

    const counts = new Map();
    const codeToUser = new Map();
    arr.forEach(u=> {
      const c = String(u.code||'').trim().toUpperCase();
      if(c) codeToUser.set(c, u);
      counts.set(u.id, 0);
    });
    arr.forEach(u=> {
      const ref = String(u.referral||'').trim().toUpperCase();
      if(!ref) return;
      const owner = codeToUser.get(ref);
      if(owner && owner.id !== u.id) {
        counts.set(owner.id, (counts.get(owner.id)||0) + 1);
      }
    });

    const rows = arr.map(u=> {
      const referrals = counts.get(u.id)||0;
      return {
        name: u.name||'Anonim',
        email: u.email||'',
        wallet: u.wallet||'',
        code: u.code||'',
        referrals,
        joinedAt: Number(u.joinedAt||0)
      };
    }).sort((a,b)=> b.referrals - a.referrals || a.joinedAt - b.joinedAt);

    let html = `<table style="width:100%;">
      <thead>
        <tr>
          <th style="padding:8px 6px;">#</th>
          <th style="padding:8px 6px;">Nume</th>
          <th style="padding:8px 6px;">Email</th>
          <th style="padding:8px 6px;">Cod</th>
          <th style="padding:8px 6px;">InvitƒÉri</th>
        </tr>
      </thead>
      <tbody>`;
    
    rows.slice(0, 50).forEach((r,i)=> {
      const topStyle = i===0 ? 'style="background:rgba(255,215,0,0.1);"' : 
                      i===1 ? 'style="background:rgba(192,192,192,0.1);"' : 
                      i===2 ? 'style="background:rgba(205,127,50,0.1);"' : '';
      html += `<tr ${topStyle}>
        <td style="padding:8px 6px; font-weight:${i<3?'900':'700'};">${i+1}</td>
        <td style="padding:8px 6px;">${esc(r.name)}</td>
        <td style="padding:8px 6px; font-size:0.9rem;">${esc(maskEmail(r.email))}</td>
        <td style="padding:8px 6px; font-family:monospace; font-size:0.9rem;">${esc(maskCode(r.code))}</td>
        <td style="padding:8px 6px;"><span class="pill">${r.referrals}</span></td>
      </tr>`;
    });
    
    html += `</tbody></table>`;
    
    if (rows.length > 50) {
      html += `<div style="text-align:center; padding:10px; opacity:0.8;">... »ôi ${rows.length - 50} al»õi participan»õi</div>`;
    }
    
    return html;
  }

  // Func»õie pentru calculul scorurilor
  function calculateScores(participants) {
    const scores = {};
    const codeToEmail = {};
    const referrals = {};
    
    // Mapare cod -> email
    participants.forEach(p => {
      if (p.code && p.email) {
        codeToEmail[p.code.toUpperCase()] = p.email;
      }
    });
    
    // CalculeazƒÉ scorurile bazate pe referral-uri
    participants.forEach(p => {
      if (p.referral && p.email) {
        const referralCode = p.referral.toUpperCase().trim();
        const referrerEmail = codeToEmail[referralCode];
        if (referrerEmail && referrerEmail !== p.email) {
          referrals[referrerEmail] = (referrals[referrerEmail] || 0) + 1;
        }
      }
    });
    
    // Scorul final = 10 puncte + 5 puncte per referral
    participants.forEach(p => {
      if (p.email) {
        scores[p.email] = 10 + (referrals[p.email] || 0) * 5;
      }
    });
    
    return scores;
  }

  // Func»õie pentru calculul numƒÉrului de referral-uri
  function calculateReferrals(email, participants) {
    let count = 0;
    const userCodes = participants
      .filter(p => p.email === email && p.code)
      .map(p => p.code.toUpperCase());
    
    participants.forEach(p => {
      if (p.referral && userCodes.includes(p.referral.toUpperCase().trim())) {
        count++;
      }
    });
    
    return count;
  }

  // Func»õie pentru √ÆncƒÉrcarea tuturor c√¢»ôtigƒÉtorilor
  async function loadAllWinners() {
    if (!__isAdmin) return;
    
    try {
      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos : [];
      
      __allWinners = [];
      
      promos.forEach(promo => {
        if (promo.winners && Object.keys(promo.winners).length > 0) {
          __allWinners.push({
            id: promo.id,
            promoTitle: promo.title || 'Necunoscut',
            timestamp: promo.winners.selectedAt || new Date().toISOString(),
            winners: promo.winners
          });
        }
      });
      
      displayGlobalWinners();
    } catch (error) {
      console.error('Eroare la √ÆncƒÉrcarea c√¢»ôtigƒÉtorilor:', error);
    }
  }

  // Func»õie pentru afi»ôarea c√¢»ôtigƒÉtorilor global
  function displayGlobalWinners() {
    const container = $('#globalWinnersList');
    if (!container) return;
    
    if (__allWinners.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;opacity:0.7;">Nu existƒÉ c√¢»ôtigƒÉtori √Ænregistra»õi.</div>';
      return;
    }
    
    let html = '<div style="display:flex;flex-direction:column;gap:15px;">';
    
    __allWinners.forEach(winnerDoc => {
      const { id, promoTitle, timestamp, winners } = winnerDoc;
      
      html += `
        <div class="card" style="background:rgba(0,0,0,0.3);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="font-weight:900;font-size:1.1rem;">${esc(promoTitle)}</div>
            <div class="pill">${new Date(timestamp).toLocaleString('ro-RO')}</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:10px;">
      `;
      
      // Afi»ôeazƒÉ c√¢»ôtigƒÉtorii pe categorii
      const categories = {
        firstPlace: 'üèÜ Premiul I',
        secondPlace: 'ü•à Premiul II', 
        thirdPlace: 'ü•â Premiul III',
        top5: 'üéñÔ∏è Top 5',
        next10: 'üèÖ Next 10',
        bonus: 'üéÅ Bonus'
      };
      
      Object.entries(categories).forEach(([category, label]) => {
        if (winners[category] && winners[category].length > 0) {
          html += `
            <div style="padding:10px;border:1px solid var(--border);border-radius:10px;">
              <div style="font-weight:800;margin-bottom:5px;">${label}</div>
              ${winners[category].map(winner => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
                  <div>
                    <div style="font-weight:700;">${esc(winner.name)}</div>
                    <div style="font-size:0.8rem;opacity:0.8;">${esc(winner.email)}</div>
                  </div>
                  ${winner.score ? `<div class="score-badge">${winner.score} pts</div>` : '<div class="score-badge">‚Äî</div>'}
                </div>
              `).join('')}
            </div>
          `;
        }
      });
      
      html += `
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;">
            <button class="btn secondary" onclick="viewWinnerDetails('${id}')">üëÅÔ∏è Vezi Detalii</button>
            <button class="btn" onclick="resendWinnerEmails('${id}')">üìß Retrimite Email-uri</button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }

  // Func»õie pentru vizualizarea detaliilor unui c√¢»ôtigƒÉtor
  window.viewWinnerDetails = function(promoId) {
    const winnerDoc = __allWinners.find(w => w.id === promoId);
    if (!winnerDoc) return;
    
    const modal = $('#winnerDetailsModal');
    const content = $('#winnerDetailsContent');
    
    // GƒÉse»ôte promo»õia completƒÉ pentru a ob»õine premiile
    const promo = __statsCache.promos.find(p => p.id === promoId);
    const prizes = promo?.prizes || {};
    
    let html = `
      <div style="margin-bottom:15px;">
        <div style="font-weight:900;font-size:1.2rem;">${esc(winnerDoc.promoTitle)}</div>
        <div style="opacity:0.8;margin-top:5px;">Selecta»õi la: ${new Date(winnerDoc.timestamp).toLocaleString('ro-RO')}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr;gap:15px;">
    `;
    
    // Detalii pentru fiecare categorie
    const categories = {
      firstPlace: { label: 'üèÜ Premiul I', prize: prizes.p1 || '' },
      secondPlace: { label: 'ü•à Premiul II', prize: prizes.p2 || '' },
      thirdPlace: { label: 'ü•â Premiul III', prize: prizes.p3 || '' },
      top5: { label: 'üéñÔ∏è Primele 5 locuri dupƒÉ podium', prize: prizes.top5 || '' },
      next10: { label: 'üèÖ UrmƒÉtoarele 10 locuri', prize: prizes.next10 || '' },
      bonus: { label: 'üéÅ Bonus participare', prize: prizes.bonus || '' }
    };
    
    Object.entries(categories).forEach(([category, info]) => {
      if (winnerDoc.winners[category] && winnerDoc.winners[category].length > 0) {
        html += `
          <div class="winner-stat-item">
            <div style="font-weight:900;margin-bottom:10px;">${info.label}: ${esc(info.prize)}</div>
            ${winnerDoc.winners[category].map(winner => `
              <div style="margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
                <div style="display:flex;justify-content:space-between;">
                  <div>
                    <div style="font-weight:800;">${esc(winner.name)}</div>
                    <div style="font-size:0.85rem;opacity:0.8;">${esc(winner.email)}</div>
                  </div>
                  ${winner.score ? `<div class="score-badge">${winner.score} puncte</div>` : '<div class="score-badge">‚Äî</div>'}
                </div>
                <div style="margin-top:5px;display:flex;gap:10px;font-size:0.85rem;">
                  <span>Referral-uri: ${winner.referrals || 0}</span>
                  <span>Premiu: ${esc(info.prize)}</span>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    });
    
    html += '</div>';
    content.innerHTML = html;
    modal.style.display = 'flex';
  };

  // Func»õie pentru retrimiterea email-urilor
  window.resendWinnerEmails = async function(promoId) {
    if (!__isAdmin) {
      alert('Doar administratorii pot retrimite email-uri.');
      return;
    }
    
    const winnerDoc = __allWinners.find(w => w.id === promoId);
    if (!winnerDoc) return;
    
    if (!confirm(`Sigur dori»õi sƒÉ retrimite»õi email-urile pentru ${winnerDoc.promoTitle}?`)) {
      return;
    }
    
    try {
      const promo = __statsCache.promos.find(p => p.id === promoId);
      if (!promo) {
        alert('Promo»õia nu a fost gƒÉsitƒÉ √Æn cache.');
        return;
      }
      
      // Trimite email-uri pentru fiecare c√¢»ôtigƒÉtor
      const prizeMapping = {
        firstPlace: promo.prizes?.p1 || '',
        secondPlace: promo.prizes?.p2 || '',
        thirdPlace: promo.prizes?.p3 || '',
        top5: promo.prizes?.top5 || '',
        next10: promo.prizes?.next10 || '',
        bonus: promo.prizes?.bonus || ''
      };
      
      let emailsSent = 0;
      let errors = 0;
      
      for (const [category, winners] of Object.entries(winnerDoc.winners)) {
        if (category === 'selectedAt') continue;
        
        const prize = prizeMapping[category];
        if (!prize) continue;
        
        for (const winner of winners) {
          if (winner.email) {
            try {
              // Folose»ôte sendPromoWinnerEmail pentru compatibilitate
              if (typeof window.sendPromoWinnerEmail === 'function') {
                await window.sendPromoWinnerEmail({
                  toEmail: winner.email,
                  name: winner.name,
                  prize: `${getCategoryLabel(category)}: ${prize}`,
                  promoTitle: promo.title || 'Promo»õie',
                  promoUrl: window.location.href,
                  score: winner.score || 0,
                  referrals: winner.referrals || 0
                });
                emailsSent++;
                console.log(`‚úÖ Email retrimis cƒÉtre: ${winner.email}`);
              } else {
                console.warn('sendPromoWinnerEmail nu este disponibil');
                break;
              }
            } catch (emailErr) {
              console.error(`‚ùå Eroare la retrimiterea email-ului cƒÉtre ${winner.email}:`, emailErr);
              errors++;
            }
          }
        }
      }
      
      alert(`Email-uri retrimise: ${emailsSent} cu succes, ${errors} erori.`);
      
    } catch (error) {
      console.error('Eroare la retrimiterea email-urilor:', error);
      alert('Eroare la retrimiterea email-urilor.');
    }
  };

  function getCategoryLabel(category) {
    const labels = {
      firstPlace: 'üèÜ Premiul I',
      secondPlace: 'ü•à Premiul II',
      thirdPlace: 'ü•â Premiul III',
      top5: 'üéñÔ∏è Primele 5 locuri',
      next10: 'üèÖ UrmƒÉtoarele 10 locuri',
      bonus: 'üéÅ Bonus participare'
    };
    return labels[category] || category;
  }

  // Func»õie pentru export CSV
  window.exportWinnersToCSV = function() {
    if (!__isAdmin) return;
    
    if (__allWinners.length === 0) {
      alert('Nu existƒÉ date de exportat.');
      return;
    }
    
    let csv = 'Promo»õie,Email,Nume,Premiu,Scor,Referral-uri,Data\n';
    
    __allWinners.forEach(winnerDoc => {
      const { promoTitle, timestamp, winners } = winnerDoc;
      const promo = __statsCache.promos.find(p => p.id === winnerDoc.id);
      const prizes = promo?.prizes || {};
      
      const categories = {
        firstPlace: prizes.p1 || 'Premiul I',
        secondPlace: prizes.p2 || 'Premiul II',
        thirdPlace: prizes.p3 || 'Premiul III',
        top5: prizes.top5 || 'Top 5',
        next10: prizes.next10 || 'Next 10',
        bonus: prizes.bonus || 'Bonus'
      };
      
      Object.entries(categories).forEach(([category, prize]) => {
        if (winners[category]) {
          winners[category].forEach(winner => {
            csv += `"${promoTitle}","${winner.email}","${winner.name}","${prize}",${winner.score || 0},${winner.referrals || 0},"${new Date(timestamp).toLocaleString('ro-RO')}"\n`;
          });
        }
      });
    });
    
    // CreazƒÉ »ôi descarcƒÉ fi»ôierul
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `castigatori_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  window.closeWinnerDetails = function() {
    $('#winnerDetailsModal').style.display = 'none';
  };

  // Func»õie nouƒÉ pentru afi»ôarea c√¢»ôtigƒÉtorilor √Æn ordinea premiilor
  function buildWinnersSection(promo) {
    if (!promo.winners || Object.keys(promo.winners).length === 0) {
      return `<div style="padding:20px;text-align:center;opacity:0.7;">Nu existƒÉ c√¢»ôtigƒÉtori selecta»õi √ÆncƒÉ.</div>`;
    }

    const winners = promo.winners;
    let html = `
      <div class="winners-prizes-grid">
    `;

    // Premiul I
    if (winners.firstPlace && winners.firstPlace.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">üèÜ</span> Premiul I: ${esc(promo.prizes?.p1 || '‚Äî')}
        </div>
      `;
      winners.firstPlace.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.p1 || '‚Äî')}</div>
          </div>
        `;
      });
    }

    // Premiul II
    if (winners.secondPlace && winners.secondPlace.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">ü•à</span> Premiul II: ${esc(promo.prizes?.p2 || '‚Äî')}
        </div>
      `;
      winners.secondPlace.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.p2 || '‚Äî')}</div>
          </div>
        `;
      });
    }

    // Premiul III
    if (winners.thirdPlace && winners.thirdPlace.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">ü•â</span> Premiul III: ${esc(promo.prizes?.p3 || '‚Äî')}
        </div>
      `;
      winners.thirdPlace.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.p3 || '‚Äî')}</div>
          </div>
        `;
      });
    }

    // Primele 5 locuri dupƒÉ podium
    if (winners.top5 && winners.top5.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">üéñÔ∏è</span> Primele 5 locuri dupƒÉ podium: ${esc(promo.prizes?.top5 || '‚Äî')}
        </div>
      `;
      winners.top5.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.top5 || '‚Äî')}</div>
          </div>
        `;
      });
    }

    // UrmƒÉtoarele 10 locuri
    if (winners.next10 && winners.next10.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">üèÖ</span> UrmƒÉtoarele 10 locuri: ${esc(promo.prizes?.next10 || '‚Äî')}
        </div>
      `;
      winners.next10.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.next10 || '‚Äî')}</div>
          </div>
        `;
      });
    }

    // Bonus participare
    if (winners.bonus && winners.bonus.length > 0) {
      html += `
        <div class="winners-prize-category">
          <span class="prize-icon">üéÅ</span> Bonus participare / surprizƒÉ random: ${esc(promo.prizes?.bonus || '‚Äî')}
        </div>
      `;
      winners.bonus.forEach(winner => {
        html += `
          <div class="winner-row">
            <div class="winner-info">
              <div class="winner-name">${esc(winner.name)}</div>
              <div class="winner-email">${esc(maskEmail(winner.email))}</div>
              ${winner.score ? `<div class="winner-score">Scor: ${winner.score} puncte (${winner.referrals || 0} referral-uri)</div>` : ''}
            </div>
            <div class="winner-prize-full">${esc(promo.prizes?.bonus || '‚Äî')}</div>
          </div>
        `;
      });
    }

    html += `</div>`;
    return html;
  }

  function pickMediaUrl(p){
    return p?.banner?.url || (Array.isArray(p?.bgs) && p.bgs[0]?.url) || '';
  }

  function parseEndsMs(ends){
    try{
      if(!ends) return NaN;
      if(typeof ends === "object"){
        if(typeof ends.toDate === "function") return ends.toDate().getTime();
        if(typeof ends.seconds === "number") return ends.seconds*1000;
      }
      if(typeof ends === "number") return ends;
      const s = String(ends).trim();
      const d1 = new Date(s);
      if(!isNaN(d1.getTime())) return d1.getTime();
      const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})(?:,?\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        const dd = parseInt(m[1],10);
        const mm = parseInt(m[2],10);
        const yy = parseInt(m[3],10);
        const hh = m[4] ? parseInt(m[4],10) : 0;
        const mi = m[5] ? parseInt(m[5],10) : 0;
        const ss = m[6] ? parseInt(m[6],10) : 0;
        return new Date(yy, mm-1, dd, hh, mi, ss).getTime();
      }
      return NaN;
    }catch(e){ return NaN; }
  }
  function isExpiredPromo(p){
    const ms = parseEndsMs(p && p.ends);
    return Number.isFinite(ms) ? (Date.now() >= ms) : false;
  }
  function formatEndsLocal(ends){
    const ms = parseEndsMs(ends);
    if(!Number.isFinite(ms)) return "‚Äî";
    return new Date(ms).toLocaleString("ro-RO");
  }

  function renderPromos(){
    const list = $('promoList');
    if(!list) return;
    const promos = Array.isArray(__statsCache.promos) ? __statsCache.promos : [];
    list.innerHTML = '';

    if(!promos.length){
      list.innerHTML = `<div style="opacity:.85; padding:10px;">Nu existƒÉ promo»õii/concursuri √ÆncƒÉ.</div>`;
      return;
    }

    promos.forEach(p=> {
      const mediaUrl = pickMediaUrl(p);
      const ui = p.ui || {};
      const cardH = clamp(Number(ui.cardH ?? 560), 360, 1200);
      const mediaH = clamp(Number(ui.mediaH ?? 200), 120, 520);
      const overlay = ui.overlay || {};
      const overlayText = (overlay.text||'').trim();
      const overlaySize = clamp(Number(overlay.size ?? 22), 10, 72);
      const overlayX = clamp(Number(overlay.x ?? 6), 0, 90);
      const overlayY = clamp(Number(overlay.y ?? 8), 0, 90);
      const overlayAlign = (overlay.align || 'left');
      const overlayColor = (overlay.color || '#ffffff');

      const isExpired = isExpiredPromo(p);
      
      const wrap = document.createElement('div');
      wrap.className = 'card promo-card';
      wrap.style.setProperty('--cardH', cardH + 'px');
      wrap.style.setProperty('--mediaH', mediaH + 'px');
      wrap.innerHTML = `
        <div class="promo-media" style="${mediaUrl ? `background-image:url('${esc(mediaUrl)}')` : ''}">

          <div class="admin-actions admin-only">
            <button class="btn secondary" type="button" onclick="editPromo('${esc(p.id)}')">‚úèÔ∏è EditeazƒÉ</button>
            <button class="btn" type="button" onclick="deletePromo('${esc(p.id)}')">üóëÔ∏è »òterge</button>
          </div>

          ${overlayText ? `
            <div class="promo-overlay" data-align="${esc(overlayAlign)}" style="color:${esc(overlayColor)}; font-size:${overlaySize}px; --overlayX:${overlayX}; --overlayY:${overlayY};">
              ${esc(overlayText)}
            </div>` : ''}
        </div>

        <div class="promo-body">
          <div class="promo-meta">
            <span class="pill">${p.kind==='giveaway' ? 'üéÅ Giveaway' : 'üì£ Promo»õie'}</span>
            <span class="pill">‚è≥ ${ isExpired ? (p.kind==='giveaway' ? 'Giveaway √Æncheiat' : 'Promo»õie √ÆncheiatƒÉ') : formatEndsLocal(p.ends) }</span>
            <span class="pill">‚≠ê +${Number(p.points||10)} puncte</span>
          </div>

          <div style="font-weight:800; font-size:1.05rem;">${esc(p.title||'')}</div>
          ${p.hook ? `<div style="opacity:.95; font-weight:700;">${esc(p.hook)}</div>` : ''}
          
          <div class="promo-desc">${esc(p.desc||'')}</div>

          <div class="divider"></div>

          <div style="margin-top:14px;">
            <div style="font-weight:900; margin-bottom:10px;">üèÜ Premii</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="prize-item prize-gold">üèÜ <b>Premiul I:</b> ${esc(p.prizes?.p1 || '‚Äî')}</div>
              <div class="prize-item prize-silver">ü•à <b>Premiul II:</b> ${esc(p.prizes?.p2 || '‚Äî')}</div>
              <div class="prize-item prize-bronze">ü•â <b>Premiul III:</b> ${esc(p.prizes?.p3 || '‚Äî')}</div>
              <div class="prize-item prize-tierA">üéñÔ∏è <b>Primele 5 locuri dupƒÉ podium:</b> ${esc(p.prizes?.top5 || '‚Äî')}</div>
              <div class="prize-item prize-tierB">üèÖ <b>UrmƒÉtoarele 10 locuri:</b> ${esc(p.prizes?.next10 || '‚Äî')}</div>
              <div class="prize-item prize-tierC">üéÅ <b>Bonus participare / surprizƒÉ random:</b> ${esc(p.prizes?.bonus || '‚Äî')}</div>
            </div>

            <div class="divider"></div>
            <div class="kicker">üìú Reguli</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>1.</b> ${esc((p.rulesObj&&p.rulesObj.r1)||'‚Äî')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>2.</b> ${esc((p.rulesObj&&p.rulesObj.r2)||'‚Äî')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>3.</b> ${esc((p.rulesObj&&p.rulesObj.r3)||'‚Äî')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>4.</b> ${esc((p.rulesObj&&p.rulesObj.r4)||'‚Äî')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>5.</b> ${esc((p.rulesObj&&p.rulesObj.r5)||'‚Äî')}</div>
              <div class="pill" style="display:block; width:100%; white-space:pre-wrap;"><b>Text:</b> ${esc((p.rulesObj&&p.rulesObj.text)||'‚Äî')}</div>
            </div>

            <div class="divider"></div>
            <div class="kicker">‚úÖ √énscriere</div>
            <div class="join-row">
              <input id="name_${esc(p.id)}" type="text" placeholder="Nume" maxlength="80">
              <input id="email_${esc(p.id)}" type="email" placeholder="Email" maxlength="120">
            </div>
            <div class="join-row">
              <input id="wallet_${esc(p.id)}" type="text" placeholder="Wallet (0x...)" maxlength="80">
              <input id="ref_${esc(p.id)}" type="text" placeholder="Referral (op»õional)" maxlength="40">
            </div>
            <div class="join-row one">
              <button class="btn" type="button" ${ isExpired ? 'disabled title="√énscrieri √Ænchise"' : '' } onclick="joinPromo('${esc(p.id)}')">‚úÖ √énscrie-te</button>
            </div>
            
            <!-- Banner status promo»õie -->
            <div class="promo-status-banner ${isExpired ? 'finalized' : 'in-progress'}">
              ${isExpired ? 'üéâ FINALIZAT' : 'üöÄ √éN CURS'}
            </div>
          </div>
        </div>
      `;

      const block = document.createElement('div');
      block.className = 'promo-block';
      block.appendChild(wrap);
      
      // Cardul clasament √ÆmpƒÉr»õit √Æn douƒÉ
      const lbOut = document.createElement('div');
      lbOut.className = 'promo-leaderboard-out';
      lbOut.innerHTML = `
        <div class="leaderboard-split-container">
          <div class="leaderboard-section">
            <div class="leaderboard-section-title">üë• Participan»õi</div>
            <div class="leaderboard-scrollable" id="lb_participants_${esc(p.id)}">
              ${buildParticipantsTable(p.id)}
            </div>
          </div>
          
          <div class="leaderboard-section">
            <div class="leaderboard-section-title">üèÜ C√¢»ôtigƒÉtori</div>
            <div class="leaderboard-scrollable rainbow-card" id="lb_winners_${esc(p.id)}">
              ${buildWinnersSection(p)}
            </div>
          </div>
        </div>
        
        ${__isAdmin && isExpired && !p.winners ? `
          <div style="margin-top:15px; padding:12px; border-radius:12px; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1);">
            <div style="font-weight:700; margin-bottom:8px;">üéØ Selectare C√¢»ôtigƒÉtori</div>
            <div style="opacity:0.8; font-size:0.9rem; margin-bottom:10px;">Promo»õia s-a √Æncheiat. Po»õi selecta c√¢»ôtigƒÉtorii acum.</div>
            <button class="btn" type="button" onclick="selectWinners('${esc(p.id)}')">üé≤ SelecteazƒÉ C√¢»ôtigƒÉtori</button>
            <div id="winners_preview_${esc(p.id)}" style="margin-top:10px;"></div>
          </div>
        ` : ''}
      `;
      
      block.appendChild(lbOut);
      list.appendChild(block);
    });

    document.querySelectorAll('.admin-only').forEach(el=>{
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });
  }

  window.joinPromo = async function joinPromo(promoId){
    try{
      const C = (window.__statsCache || __statsCache || {promos:[]});
      const promo = (C.promos||[]).find(p=>String(p.id)===String(promoId));
      if(promo && promo.ends){
        const endsMs = new Date(promo.ends).getTime();
        if(Number.isFinite(endsMs) && Date.now() >= endsMs){
          return alert(promo.kind==='giveaway' ? 'Giveaway √Æncheiat. √énscrierile sunt √Ænchise.' : 'Promo»õie √ÆncheiatƒÉ. √énscrierile sunt √Ænchise.');
        }
      }
    }catch(e){}

    const name = ($(`name_${promoId}`)?.value || '').trim();
    const email = ($(`email_${promoId}`)?.value || '').trim();
    const wallet = ($(`wallet_${promoId}`)?.value || '').trim();
    const referral = ($(`ref_${promoId}`)?.value || '').trim();

    if(!name) return alert('CompleteazƒÉ numele.');
    if(!email) return alert('CompleteazƒÉ email.');

    try {
      const u = await addParticipant(promoId, { name, email, wallet, referral });
      $(`name_${promoId}`).value = '';
      $(`email_${promoId}`).value = '';
      $(`wallet_${promoId}`).value = '';
      $(`ref_${promoId}`).value = '';

      alert(`√énscriere reu»ôitƒÉ!\nCodul tƒÉu: ${u.code}`);
      
      // ActualizeazƒÉ lista de participan»õi
      const participantsDiv = document.getElementById(`lb_participants_${promoId}`);
      if (participantsDiv) {
        participantsDiv.innerHTML = buildParticipantsTable(promoId);
      }
      
      // === TRIMITE EMAIL LA √éNSCRIERE ===
      try {
        if (typeof window.sendPromoSignupEmail === 'function') {
          const promo = (__statsCache.promos || []).find(x => String(x.id) === String(promoId)) || {};
          await window.sendPromoSignupEmail({
            toEmail: email,
            name: name,
            referralCode: u.code,
            promoTitle: promo.title || (promo.kind === 'giveaway' ? 'Giveaway' : 'Promo»õie'),
            promoEndsAt: promo.ends || null,
            promoUrl: window.location.href
          });
          console.log('Email de √Ænscriere trimis cƒÉtre:', email);
        } else {
          console.warn('sendPromoSignupEmail callable nu este disponibil.');
        }
      } catch (mailErr) {
        console.warn('Eroare la trimiterea email-ului de √Ænscriere:', mailErr);
      }
      
    } catch(e) {
      console.error('joinPromo:', e);
      alert(e?.message || 'Eroare la √Ænscriere.');
    }
  };

  function startStatsListener(){
    const ref = statsRef();
    if(!ref) return;

    if(__statsUnsub) { try{__statsUnsub();}catch(e){} __statsUnsub=null; }

    __statsUnsub = ref.onSnapshot(snap=>{
      const data = snap.exists ? snap.data() : {};
      __statsCache = normalizeStats(data);
      renderPromos();
    }, err=>{
      console.warn('stats onSnapshot error:', err);
      readStatsOnce().then(x=>{ __statsCache=x; renderPromos(); }).catch(()=>{});
    });
  }

  function injectExtraFields(){
    const form = $('promoForm');
    if(!form) return;

    if ($('cardHeight')) return;

    const block = document.createElement('div');
    block.innerHTML = `
      <div class="divider"></div>
      <div class="kicker">üìê Dimensiuni card & text peste imagine</div>

      <div class="row">
        <div>
          <label>√énƒÉl»õime card (px)</label>
          <input id="cardHeight" type="number" min="360" max="1200" step="10" value="560" placeholder="Ex: 560">
        </div>
        <div>
          <label>√énƒÉl»õime imagine (px)</label>
          <input id="mediaHeight" type="number" min="120" max="520" step="10" value="200" placeholder="Ex: 200">
        </div>
      </div>

      <div class="row one">
        <div>
          <label>Text peste imagine (op»õional)</label>
          <textarea id="overlayText" rows="2" placeholder="Ex: üî• Ultimele 48h ‚Äî IntrƒÉ √Æn TOP 5!"></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>MƒÉrime font (px)</label>
          <input id="overlayFontSize" type="number" min="10" max="72" step="1" value="22">
        </div>
        <div>
          <label>Culoare text</label>
          <input id="overlayColor" type="color" value="#ffffff">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Pozi»õie X (0-90%)</label>
          <input id="overlayX" type="number" min="0" max="90" step="1" value="6">
        </div>
        <div>
          <label>Pozi»õie Y (0-90%)</label>
          <input id="overlayY" type="number" min="0" max="90" step="1" value="8">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Aliniere</label>
          <select id="overlayAlign">
            <option value="left">St√¢nga</option>
            <option value="center">Centru</option>
            <option value="right">Dreapta</option>
          </select>
        </div>
        <div>
          <label>Preview rapid</label>
          <button class="btn secondary" type="button" onclick="previewOverlay()">üëÅÔ∏è Preview</button>
        </div>
      </div>
    `;

    const actions = form.querySelector('.actions');
    if(actions) form.insertBefore(block, actions);
    else form.appendChild(block);
  }

  window.previewOverlay = function previewOverlay(){
    const txt = ($('overlayText')?.value||'').trim();
    if(!txt) return alert('CompleteazƒÉ mai √Ænt√¢i "Text peste imagine".');
    alert('Textul va apƒÉrea peste imagine √Æn card dupƒÉ salvare.');
  };

  // Func»õii pentru selectarea »ôi salvarea c√¢»ôtigƒÉtorilor
  async function getPromoDataFromFirestore(promoId){
    try {
      const db = fs();
      if(!db) throw new Error("Firestore nu este disponibil");
      
      const statsDoc = await db.collection('stats').doc('visits').get();
      if(!statsDoc.exists) throw new Error("Documentul stats/visits nu existƒÉ");
      
      const data = statsDoc.data();
      const promos = Array.isArray(data?.promos) ? data.promos : [];
      const participants = (data?.participants && typeof data.participants === 'object') ? data.participants : {};
      
      const promo = promos.find(p => String(p.id) === String(promoId));
      if(!promo) throw new Error("Promo»õia nu a fost gƒÉsitƒÉ");
      
      const promoParticipants = Array.isArray(participants[String(promoId)]) ? participants[String(promoId)] : [];
      
      return { promo, participants: promoParticipants };
    } catch(error) {
      console.error("Eroare la citirea din Firestore:", error);
      throw error;
    }
  }

  function __hash32(str){
    str = String(str || "");
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  
  function __mulberry32(seed){
    let a = seed >>> 0;
    return function(){
      a |= 0; a = (a + 0x6D2B79F5) | 0;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function __buildScores(arr){
    const codeToUser = new Map();
    arr.forEach(u=>{
      const c = String(u?.code||"").trim();
      if(c) codeToUser.set(c, u);
    });

    const scoreByCode = new Map();
    const tieTimeByCode = new Map();

    arr.forEach(u=>{
      const ref = String(u?.referral||"").trim();
      if(!ref) return;
      const own = String(u?.code||"").trim();
      if(own && own === ref) return;

      const owner = codeToUser.get(ref);
      if(!owner) return;

      const ownerCode = String(owner.code);
      scoreByCode.set(ownerCode, (scoreByCode.get(ownerCode)||0)+1);

      const t = u?.joinedAt || u?.createdAt || Date.now();
      const prev = tieTimeByCode.get(ownerCode);
      if(!prev || t < prev) tieTimeByCode.set(ownerCode, t);
    });

    return { codeToUser, scoreByCode, tieTimeByCode };
  }

  async function __isAdminNow(){
    try{
      if (window.__SBYT_ADMIN === true) return true;
      if (typeof __isAdmin !== "undefined" && __isAdmin === true) return true;
      if (window.firebase && firebase.auth) {
        const u = firebase.auth().currentUser;
        if (u && u.email && String(u.email).toLowerCase() === "stancubyt@gmail.com") return true;
      }
    }catch(e){}
    return false;
  }

  window.selectWinners = async function selectWinners(promoId){
    if(!__isAdminNow()) { 
      alert('Trebuie sƒÉ fii logat ca admin.');
      return;
    }

    try{
      const box = document.getElementById(`winners_preview_${promoId}`);
      if(!box) {
        alert("Containerul pentru preview nu a fost gƒÉsit.");
        return;
      }
      
      box.innerHTML = `<div style="padding:20px;text-align:center;opacity:0.8;">‚è≥ Se calculeazƒÉ c√¢»ôtigƒÉtorii...</div>`;
      
      let promo, participants;
      
      try {
        const data = await getPromoDataFromFirestore(promoId);
        promo = data.promo;
        participants = data.participants;
        
        const idx = (window.__statsCache.promos || []).findIndex(p => String(p.id) === String(promoId));
        if(idx >= 0) {
          window.__statsCache.promos[idx] = promo;
        }
        window.__statsCache.participants[String(promoId)] = participants;
        
      } catch(firestoreError) {
        console.warn("Nu s-au putut ob»õine datele din Firestore, folosim cache:", firestoreError);
        
        promo = (window.__statsCache && window.__statsCache.promos || []).find(p=>String(p.id)===String(promoId));
        participants = Array.isArray(window.__statsCache.participants?.[String(promoId)]) ? window.__statsCache.participants[String(promoId)] : [];
      }
      
      if(!promo) {
        box.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;">‚ùå Promo»õia nu a fost gƒÉsitƒÉ. √éncarcƒÉ din nou pagina.</div>`;
        return;
      }
      
      if(!participants || participants.length === 0) {
        box.innerHTML = `<div style="padding:20px;text-align:center;opacity:0.8;">üìù Nu existƒÉ participan»õi √ÆncƒÉ.</div>`;
        return;
      }

      const { scoreByCode } = __buildScores(participants);
      
      const ranking = participants
        .filter(u=>u && u.code)
        .map(u=>{
          const code = String(u.code);
          return {
            ...u,
            score: scoreByCode.get(code) || 0
          };
        })
        .sort((a,b)=> b.score - a.score || a.joinedAt - b.joinedAt);

      const seed = `${promoId}|${promo.ends||""}|${participants.length}`;
      const rng = __mulberry32(__hash32(seed));

      const firstPlace = ranking.slice(0, 1).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const secondPlace = ranking.slice(1, 2).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const thirdPlace = ranking.slice(2, 3).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const remaining = ranking.slice(3);
      
      const top5 = [];
      const poolTop5 = remaining.slice();
      for(let i=0; i<Math.min(5, poolTop5.length); i++) {
        const idx = Math.floor(rng() * poolTop5.length);
        const u = poolTop5.splice(idx, 1)[0];
        top5.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const next10 = [];
      const poolNext10 = poolTop5.slice();
      for(let i=0; i<Math.min(10, poolNext10.length); i++) {
        const idx = Math.floor(rng() * poolNext10.length);
        const u = poolNext10.splice(idx, 1)[0];
        next10.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const bonus = [];
      const poolBonus = poolNext10.slice();
      if(poolBonus.length > 0) {
        const idx = Math.floor(rng() * poolBonus.length);
        const u = poolBonus[idx];
        bonus.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }

      const winners = {
        firstPlace,
        secondPlace,
        thirdPlace,
        top5,
        next10,
        bonus,
        selectedAt: new Date().toISOString()
      };

      box.innerHTML = `
        <div style="margin-bottom:15px;">
          <div style="font-weight:900; margin-bottom:10px;">üéØ C√¢»ôtigƒÉtori selecta»õi</div>
          <div style="opacity:0.8; font-size:0.9rem;">Ace»ôti c√¢»ôtigƒÉtori au fost selecta»õi automat. ApasƒÉ "SalveazƒÉ" pentru a finaliza.</div>
        </div>
        ${buildWinnersSection({ ...promo, winners })}
        <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" onclick="saveWinners('${esc(promoId)}')">üíæ SalveazƒÉ C√¢»ôtigƒÉtori</button>
          <button class="btn secondary" onclick="this.parentElement.parentElement.innerHTML=''">‚ùå AnuleazƒÉ</button>
        </div>
        <div id="save_winners_msg_${esc(promoId)}" style="margin-top:10px;"></div>
      `;
      
      box.scrollIntoView({ behavior:"smooth", block:"nearest" });
      
    }catch(e){
      console.error("Eroare la selectarea c√¢»ôtigƒÉtorilor:", e);
      const box = document.getElementById(`winners_preview_${promoId}`);
      if(box) {
        box.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;">‚ùå Eroare: ${esc(e?.message || "NecunoscutƒÉ")}</div>`;
      }
    }
  };

  window.saveWinners = async function saveWinners(promoId){
    if(!__isAdminNow()) { 
      alert('Trebuie sƒÉ fii logat ca admin.');
      return;
    }

    const msgBox = document.getElementById(`save_winners_msg_${promoId}`);
    if(msgBox) msgBox.innerHTML = `<div style="opacity:0.8;">‚è≥ Se salveazƒÉ c√¢»ôtigƒÉtorii...</div>`;

    try {
      const data = await getPromoDataFromFirestore(promoId);
      const promo = data.promo;
      const participants = data.participants;

      const { scoreByCode } = __buildScores(participants);
      
      const ranking = participants
        .filter(u=>u && u.code)
        .map(u=>{
          const code = String(u.code);
          return {
            ...u,
            score: scoreByCode.get(code) || 0
          };
        })
        .sort((a,b)=> b.score - a.score || a.joinedAt - b.joinedAt);

      const seed = `${promoId}|${promo.ends||""}|${participants.length}`;
      const rng = __mulberry32(__hash32(seed));

      const firstPlace = ranking.slice(0, 1).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const secondPlace = ranking.slice(1, 2).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const thirdPlace = ranking.slice(2, 3).map(u => ({
        name: u.name,
        email: u.email,
        score: scoreByCode.get(String(u.code)) || 0,
        referrals: calculateReferrals(u.email, participants)
      }));
      
      const remaining = ranking.slice(3);
      
      const top5 = [];
      const poolTop5 = remaining.slice();
      for(let i=0; i<Math.min(5, poolTop5.length); i++) {
        const idx = Math.floor(rng() * poolTop5.length);
        const u = poolTop5.splice(idx, 1)[0];
        top5.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const next10 = [];
      const poolNext10 = poolTop5.slice();
      for(let i=0; i<Math.min(10, poolNext10.length); i++) {
        const idx = Math.floor(rng() * poolNext10.length);
        const u = poolNext10.splice(idx, 1)[0];
        next10.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }
      
      const bonus = [];
      const poolBonus = poolNext10.slice();
      if(poolBonus.length > 0) {
        const idx = Math.floor(rng() * poolBonus.length);
        const u = poolBonus[idx];
        bonus.push({
          name: u.name,
          email: u.email,
          score: scoreByCode.get(String(u.code)) || 0,
          referrals: calculateReferrals(u.email, participants)
        });
      }

      const winners = {
        firstPlace,
        secondPlace,
        thirdPlace,
        top5,
        next10,
        bonus,
        selectedAt: new Date().toISOString()
      };

      // SalveazƒÉ √Æn stats/visits
      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      
      const idx = promos.findIndex(p => String(p.id) === String(promoId));
      if(idx >= 0) {
        promos[idx].winners = winners;
        
        await writeStats({ 
          promos,
          participants: stats.participants
        });
        
        if(msgBox) msgBox.innerHTML = `<div style="color:#00ff88; font-weight:700;">‚úÖ C√¢»ôtigƒÉtorii au fost salva»õi!</div>`;
        
        // Re√ÆncarcƒÉ lista globalƒÉ de c√¢»ôtigƒÉtori
        await loadAllWinners();
        
        setTimeout(() => {
          const previewBox = document.getElementById(`winners_preview_${promoId}`);
          if(previewBox) previewBox.innerHTML = '';
          
          // ActualizeazƒÉ sec»õiunea c√¢»ôtigƒÉtori
          const winnersDiv = document.getElementById(`lb_winners_${promoId}`);
          if(winnersDiv) {
            const promoWithWinners = { ...promos[idx], winners };
            winnersDiv.innerHTML = buildWinnersSection(promoWithWinners);
          }
          
          // Ascunde butonul de selectare
          const selectButtonContainer = document.querySelector(`[onclick="selectWinners('${promoId}')"]`)?.parentElement?.parentElement;
          if(selectButtonContainer) {
            selectButtonContainer.style.display = 'none';
          }
        }, 1500);

        // === TRIMITE EMAIL-URI C√Ç»òTIGƒÇTORILOR CU PREMIUL SPECIFIC ===
        try {
          if (typeof window.sendPromoWinnerEmail === 'function') {
            const prizeMapping = {
              firstPlace: promo.prizes?.p1 || '',
              secondPlace: promo.prizes?.p2 || '',
              thirdPlace: promo.prizes?.p3 || '',
              top5: promo.prizes?.top5 || '',
              next10: promo.prizes?.next10 || '',
              bonus: promo.prizes?.bonus || ''
            };

            let emailsSent = 0;
            let errors = 0;

            for (const [category, winnersArray] of Object.entries(winners)) {
              if (category === 'selectedAt') continue;
              
              const prize = prizeMapping[category];
              if (!prize) continue;
              
              for (const winner of winnersArray) {
                if (winner.email) {
                  try {
                    await window.sendPromoWinnerEmail({
                      toEmail: winner.email,
                      name: winner.name,
                      prize: `${getCategoryLabel(category)}: ${prize}`,
                      score: winner.score || 0,
                      referrals: winner.referrals || 0,
                      promoTitle: promo.title || (promo.kind === 'giveaway' ? 'Giveaway' : 'Promo»õie'),
                      promoUrl: window.location.href,
                      winnerType: category
                    });
                    emailsSent++;
                    console.log(`‚úÖ Email trimis cƒÉtre: ${winner.email} pentru ${category}`);
                  } catch(emailErr) {
                    console.error(`‚ùå Eroare la trimiterea email-ului cƒÉtre ${winner.email}:`, emailErr);
                    errors++;
                  }
                }
              }
            }

            console.log(`üìß Total email-uri trimise: ${emailsSent}, erori: ${errors}`);
            
            if (errors > 0) {
              alert(`C√¢»ôtigƒÉtorii au fost salva»õi, dar ${errors} email-uri nu au putut fi trimise.`);
            } else {
              alert(`‚úÖ C√¢»ôtigƒÉtorii salva»õi »ôi ${emailsSent} email-uri trimise cu succes!`);
            }
          } else {
            console.warn('‚ö†Ô∏è sendPromoWinnerEmail callable nu este disponibil.');
            alert('‚úÖ C√¢»ôtigƒÉtorii salva»õi, dar func»õia de email nu este disponibilƒÉ.');
          }
        } catch(emailError) {
          console.warn('‚ùå Eroare generalƒÉ la trimiterea email-urilor:', emailError);
          alert('‚úÖ C√¢»ôtigƒÉtorii salva»õi, dar a apƒÉrut o eroare la trimiterea email-urilor.');
        }
      } else {
        if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b;">‚ùå Promo»õia nu a fost gƒÉsitƒÉ.</div>`;
      }
    } catch(e) {
      console.error("‚ùå Eroare la salvarea c√¢»ôtigƒÉtorilor:", e);
      if(msgBox) msgBox.innerHTML = `<div style="color:#ff6b6b;">‚ùå Eroare: ${esc(e?.message || "NecunoscutƒÉ")}</div>`;
    }
  };

  function initParticles() {
    if (typeof particlesJS !== 'undefined') {
      particlesJS('particles-js', {
        particles: {
          number: { value: 80, density: { enable: true, value_area: 800 } },
          color: { value: ["#0066ff", "#00ff88", "#8a2be2"] },
          shape: { type: "circle" },
          opacity: { value: 0.5, random: true },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 150,
            color: "#00ffff",
            opacity: 0.2,
            width: 1
          },
          move: {
            enable: true,
            speed: 2,
            direction: "none",
            random: true,
            straight: false,
            out_mode: "out",
            bounce: false
          }
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" }
          }
        }
      });
    }
  }

  function boot(){
    initParticles();
    injectExtraFields();
    startStatsListener();

    const a = auth();
    if(a) {
      a.onAuthStateChanged(async (user)=>{
        const isAdmin = await computeIsAdmin(user);
        setAdminUI(isAdmin, user);
      });
    } else {
      setAdminUI(false, null);
    }
  }

  document.addEventListener('DOMContentLoaded', boot);

  if(!window.__expiryUiTimer){
    window.__expiryUiTimer = setInterval(()=>{ try{ renderPromos(); }catch(e){} }, 120000);
  }
})();
</script>
</body>
</html>
