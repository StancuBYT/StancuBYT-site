<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StancuBYT | Token Digital Avansat</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1"></script>
    <style>
        /* Variabile culori conform psihologiei marketingului */
        :root {
            --blue-tech: #0066ff;
            --green-growth: #00ff88;
            --purple-innov: #8a2be2;
            --neon-cyan: #00ffff;
            --dark-bg: #0a0a1f;
            --darker-bg: #050510;
            --orange-alert: #ff9500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: white;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 60%, rgba(0, 255, 136, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 20%);
        }

        /* Particle Animation Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Logo Background pentru Hero Section */
        .hero-logo-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }

        .logo-3d-bg {
            width: 100%;
            height: 100%;
            position: relative;
            animation: float3d 20s infinite ease-in-out;
        }

        .logo-3d-bg img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            filter: blur(1px) brightness(1.2);
        }

        @keyframes float3d {
            0%, 100% { 
                transform: translateY(0px) rotateX(0deg) rotateY(0deg); 
            }
            25% { 
                transform: translateY(-20px) rotateX(5deg) rotateY(5deg); 
            }
            50% { 
                transform: translateY(0px) rotateX(0deg) rotateY(10deg); 
            }
            75% { 
                transform: translateY(20px) rotateX(-5deg) rotateY(5deg); 
            }
        }

        /* 3D Logo Animation */
        .logo-3d-container {
            position: relative;
            width: 80px;
            height: 80px;
            perspective: 1000px;
        }

        .logo-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: rotate3d 8s infinite linear;
        }

        .logo-3d img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            backface-visibility: hidden;
        }

        .backnote-orbit {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            animation: orbit 6s infinite linear;
        }

        .backnote {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--neon-cyan);
            border-radius: 50%;
            filter: blur(2px);
            opacity: 0.7;
        }

        .backnote:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
        .backnote:nth-child(2) { top: 50%; right: 0; transform: translateY(-50%); }
        .backnote:nth-child(3) { bottom: 0; left: 50%; transform: translateX(-50%); }
        .backnote:nth-child(4) { top: 50%; left: 0; transform: translateY(-50%); }

        @keyframes rotate3d {
            0% { transform: rotateY(0deg) rotateX(5deg); }
            100% { transform: rotateY(360deg) rotateX(5deg); }
        }

        @keyframes orbit {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Buton Modern Re√ÆmprospƒÉteazƒÉ Datele */
        .btn-refresh-modern {
            background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 5px 20px rgba(0, 102, 255, 0.3);
        }

        .btn-refresh-modern:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 102, 255, 0.5);
        }

        .btn-refresh-modern:active {
            transform: translateY(0) scale(1);
        }

        .refresh-icon {
            font-size: 1.3rem;
            transition: transform 0.5s ease;
        }

        .btn-refresh-modern:hover .refresh-icon {
            animation: rotate360 1s linear infinite;
        }

        .refresh-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 50px;
            background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan));
            opacity: 0;
            z-index: -1;
            animation: pulseEffect 2s infinite;
        }

        @keyframes rotate360 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulseEffect {
            0% { 
                transform: scale(1); 
                opacity: 0.7; 
            }
            100% { 
                transform: scale(1.2); 
                opacity: 0; 
            }
        }

        /* Loading animation pentru buton */
        .btn-refresh-modern.loading {
            background: linear-gradient(45deg, #666, #888);
            cursor: wait;
        }

        .btn-refresh-modern.loading .refresh-icon {
            animation: rotate360 1s linear infinite;
        }

        .btn-refresh-modern.loading .refresh-text {
            opacity: 0.7;
        }

        /* Animatie pentru actualizare succes */
        @keyframes successFlash {
            0%, 100% { 
                background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov)); 
            }
            50% { 
                background: linear-gradient(45deg, var(--green-growth), #00cc66); 
            }
        }

        .btn-refresh-modern.success {
            animation: successFlash 0.5s ease 2;
        }

        /* Navigation - Scientific Style */
        .scientific-nav {
            background: rgba(10, 10, 31, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--blue-tech);
            position: fixed;
            width: 100%;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--blue-tech), var(--green-growth));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-links a:hover {
            background: rgba(0, 102, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-links a::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(45deg, var(--blue-tech), var(--green-growth));
            transition: width 0.3s ease;
        }

        .nav-links a:hover::before {
            width: 100%;
        }

        /* Main Content Sections */
        .page-section {
            min-height: 100vh;
            padding: 120px 2rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .active-section {
            display: block;
        }

        /* Hero Section - Prezentare */
        .hero {
            text-align: center;
            padding-top: 150px;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: 4.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--blue-tech), var(--green-growth), var(--purple-innov));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 102, 255, 0.3);
            position: relative;
            z-index: 2;
        }

        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(45deg); }
        }

        /* Sectiune Noutati */
        .news-section {
            margin: 3rem 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(0, 255, 136, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--green-growth);
        }

        .news-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .news-controls {
            display: flex;
            gap: 1rem;
        }

        .news-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 102, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .news-btn:hover {
            background: rgba(0, 102, 255, 0.2);
            transform: translateY(-2px);
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .news-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 102, 255, 0.2);
            transition: all 0.3s ease;
        }

        .news-card:hover {
            transform: translateY(-5px);
            border-color: var(--green-growth);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.1);
        }

        .news-card.pinned {
            border: 2px solid var(--orange-alert);
            background: rgba(255, 149, 0, 0.05);
        }

        .news-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .badge-update {
            background: rgba(0, 102, 255, 0.2);
            color: var(--blue-tech);
            border: 1px solid var(--blue-tech);
        }

        .badge-announcement {
            background: rgba(255, 149, 0, 0.2);
            color: var(--orange-alert);
            border: 1px solid var(--orange-alert);
        }

        .badge-event {
            background: rgba(0, 255, 136, 0.2);
            color: var(--green-growth);
            border: 1px solid var(--green-growth);
        }

        .news-date {
            font-size: 0.85rem;
            color: #888;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .news-form {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row input {
            flex: 1;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .form-row input:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            outline: none;
        }

        /* Contor Vizite */
        .visit-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(10, 10, 31, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--blue-tech);
            border-radius: 15px;
            padding: 0.8rem 1.2rem;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .visit-counter:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 102, 255, 0.3);
        }

        .counter-icon {
            animation: pulse 2s infinite;
        }

        .token-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-10px);
            border-color: var(--green-growth);
        }

        /* Social Links in Hero */
        .social-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 102, 255, 0.3);
        }

        .social-btn:hover {
            background: rgba(0, 102, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 102, 255, 0.3);
        }

        /* Buton Uniswap */
        .uniswap-btn {
            background: linear-gradient(45deg, #ff007a, #8a2be2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 1rem 0;
            font-weight: bold;
        }

        .uniswap-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 0, 122, 0.4);
        }

        /* Scientific Data Visualization */
        .data-visualization {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .chart-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .period-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 102, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            background: var(--blue-tech);
            border-color: var(--blue-tech);
        }

        .period-btn:hover {
            background: rgba(0, 102, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--neon-cyan);
            margin: 0.5rem 0;
        }

        .neon-glow {
            box-shadow: 
                0 0 20px rgba(0, 102, 255, 0.3),
                0 0 40px rgba(0, 255, 136, 0.2),
                inset 0 0 20px rgba(138, 43, 226, 0.1);
        }

        /* Status Indicators */
        .status-online {
            color: #00ff88;
            animation: pulse 2s infinite;
        }

        .status-offline {
            color: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Token Price Display */
        .price-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .price-change {
            font-size: 1.2rem;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .positive { color: #00ff88; background: rgba(0, 255, 136, 0.1); }
        .negative { color: #ff4444; background: rgba(255, 68, 68, 0.1); }

        /* Whitepaper Specific Styles */
        .whitepaper-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-top: 20px;
        }

        .whitepaper-logo {
            width: 150px;
            height: 150px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov));
            padding: 15px;
            box-shadow: 0 0 40px rgba(0, 102, 255, 0.4);
        }

        .whitepaper-logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .toc {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            border-left: 4px solid var(--green-growth);
        }

        .toc h3 {
            margin-bottom: 1rem;
            color: var(--neon-cyan);
        }

        .toc ul {
            columns: 2;
            column-gap: 3rem;
        }

        .toc li {
            margin-bottom: 0.8rem;
            break-inside: avoid;
        }

        .toc a {
            color: white;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: var(--neon-cyan);
            text-decoration: underline;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(0, 102, 255, 0.2);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-cyan);
        }

        .section-card h3 {
            color: var(--green-growth);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .whitepaper-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            overflow: hidden;
        }

        .whitepaper-table th {
            background: linear-gradient(45deg, var(--blue-tech), var(--purple-innov));
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: bold;
        }

        .whitepaper-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .whitepaper-table tr:last-child td {
            border-bottom: none;
        }

        .whitepaper-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 0.2rem;
        }

        .badge-success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--green-growth);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .badge-warning {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }

        .badge-info {
            background: rgba(0, 204, 255, 0.2);
            color: var(--neon-cyan);
            border: 1px solid rgba(0, 204, 255, 0.3);
        }

        .roadmap-timeline {
            position: relative;
            padding-left: 30px;
            margin: 2rem 0;
        }

        .roadmap-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--blue-tech), var(--purple-innov));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .timeline-date {
            font-weight: bold;
            color: var(--green-growth);
            margin-bottom: 0.5rem;
        }

        .download-btn {
            background: linear-gradient(45deg, var(--green-growth), var(--blue-tech));
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--neon-cyan);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            outline: none;
        }

        .social-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .social-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .social-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 102, 255, 0.2);
            border-color: var(--blue-tech);
        }

        .social-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .required {
            color: #ff4444;
        }

        .contact-card {
            background: rgba(255,255,255,0.03);
            padding: 1rem;
            border-radius: 10px;
            border-left: 3px solid;
            margin-bottom: 1rem;
        }

        .contact-card.business {
            border-color: var(--green-growth);
            background: rgba(0, 255, 136, 0.05);
        }

        .contact-card.partnership {
            border-color: var(--blue-tech);
            background: rgba(0, 102, 255, 0.05);
        }

        .contact-card.security {
            border-color: var(--purple-innov);
            background: rgba(138, 43, 226, 0.05);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .time-item {
            text-align: center;
            padding: 1rem;
        }

        .time-item .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .hero h1 {
                font-size: 2.8rem;
            }

            .hero-logo-bg {
                width: 400px;
                height: 400px;
            }

            .token-info-grid {
                grid-template-columns: 1fr;
            }

            .price-display {
                font-size: 2rem;
            }

            .chart-container {
                height: 300px;
            }

            .btn-refresh-modern {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }

            .contact-grid {
                grid-template-columns: 1fr;
            }

            .social-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .toc ul {
                columns: 1;
            }

            .whitepaper-table {
                font-size: 0.9rem;
            }

            .whitepaper-table th,
            .whitepaper-table td {
                padding: 0.5rem;
            }

            .news-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .visit-counter {
                bottom: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .hero h1 {
                font-size: 2.2rem;
            }

            .nav-links a {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .social-grid {
                grid-template-columns: 1fr;
            }

            .whitepaper-logo {
                width: 100px;
                height: 100px;
            }
        }
    
        .form-group select option {
            background: var(--darker-bg);
            color: #ffffff;
        }

    
/* ====== ADMIN LOGIN + ADMIN ONLY ====== */
.admin-login{
  margin-top: 80px;
  padding: 40px 20px;
  background: linear-gradient(135deg, #1e1e2f, #2b2b45);
  border-top: 2px solid rgba(122,92,255,.8);
  text-align: center;
  border-radius: 16px;
}
.admin-login h2{ color:#fff; margin:0 0 10px; }
.admin-login .admin-desc{ color:#cfcfe8; margin:0 0 18px; opacity:.9; }
.admin-login-box{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
.admin-login-box input{
  padding:12px 14px; width:280px; max-width:92vw;
  border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25); color:#fff; outline:none;
}
.admin-login-box button{
  padding:12px 16px; border-radius:10px; border:none;
  background:#7a5cff; color:#fff; font-weight:700; cursor:pointer;
}
.admin-login-box button:hover{ filter: brightness(1.08); }
.admin-msg{ margin-top:12px; font-weight:700; }
.admin-pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px; font-size:.9rem;
  background: rgba(0,255,136,.12); color:#00ff88; border:1px solid rgba(0,255,136,.22);
}
.admin-pill.off{
  background: rgba(255,77,77,.12); color:#ff4d4d; border-color: rgba(255,77,77,.22);
}
.admin-only{ display:none; }

/* ====== TROPHY BUTTON (Giveaway add) ====== */
.trophy-btn{
  padding: 10px 14px !important;
  display:inline-flex; align-items:center; justify-content:center; gap:10px;
  min-width: 54px;
}
.trophy-btn .trophy-wrap{ font-size: 1.2rem; }
.trophy-btn .trophy-logo{
  width: 22px; height: 22px; border-radius: 6px;
  box-shadow: 0 0 12px rgba(0,255,136,.25);
}
.table-responsive{ overflow-x:auto; width:100%; }
.lb-table{ width:100%; border-collapse: collapse; }
.lb-table th,.lb-table td{ padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; }
.lb-top1{ background: rgba(255,215,0,.12); }
.lb-top2{ background: rgba(192,192,192,.12); }
.lb-top3{ background: rgba(205,127,50,.12); }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

</style>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  // Firebase init (must run before any firebase.auth()/firestore/storage usage)
  window.firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    storageBucket: "stancubyt-fc2b9.firebasestorage.app",
    messagingSenderId: "263244200492",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89",
    measurementId: "G-272S9HSY3K"
  };
  try {
    if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
      firebase.initializeApp(window.firebaseConfig);
    }
  } catch (e) {
    console.warn("Firebase init warning:", e);
  }
</script>
</head>

<body>
    <div id="particles-js"></div>

    <div class="visit-counter" id="visitCounter">
        <span class="counter-icon">üëÅÔ∏è</span>
        <span id="visitCount">0</span> vizite
    </div>

    <nav class="scientific-nav">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-3d-container">
                    <div class="logo-3d">
                        <img src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="StancuBYT Logo" onerror="this.src='https://via.placeholder.com/80/0a0a1f/00ff88?text=SBYT'">
                    </div>
                    <div class="backnote-orbit">
                        <div class="backnote"></div>
                        <div class="backnote"></div>
                        <div class="backnote"></div>
                        <div class="backnote"></div>
                    </div>
                </div>
                <div class="logo-text">StancuBYT</div>
            </div>
            <div class="nav-links">
                <a href="#giveaway" onclick="showSection('giveaway')">Giveaway & Promo»õii</a>
            </div>
        </div>
    </nav>


<!-- Giveaway & Promo»õii Section -->
    <section id="giveaway" class="page-section active-section">
        <div style="text-align: center; margin-bottom: 3rem; padding-top: 20px;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Giveaway & Promo»õii
            </h1>
            <p style="opacity: 0.8;">Promo»õii active, √Ænscrieri »ôi clasamente</p>

            <div style="margin-top: 1rem; display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
                <button class="news-btn admin-only" onclick="requestPassword('promoAdd')" data-admin-display="inline-flex">‚ûï AdaugƒÉ promo»õie</button>
                <button class="news-btn trophy-btn admin-only" onclick="requestPassword('giveawayAdd')" title="Adauga giveaway" data-admin-display="inline-flex"><span class="trophy-wrap">üèÜ</span><img class="trophy-logo" src="https://i.ibb.co/Zzb6ZTG0/logo.png" alt="SBYT" /></button>
                </div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>üìå Promo»õii / Giveaway-uri</h3>
            <div id="promoList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem; margin-top:1rem;"></div>

            <div id="promoForm" style="display:none; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
    <h3 style="margin-bottom: 1rem; color: var(--neon-cyan);">Adauga promotie / giveaway</h3>

    <div class="form-row">
        <input type="text" id="promoTitle" placeholder="Titlu (ex: Giveaway SBYT)" maxlength="120">
        <input type="datetime-local" id="promoEnds" placeholder="Data si ora expirarii">
    </div>

    <div class="form-row">
        <input type="text" id="promoPrize" placeholder="Premiu (ex: 5000 SBYT + bonusuri)" maxlength="160">
        <input type="number" id="promoPoints" min="1" step="1" value="10" placeholder="Puncte / promovare">
    </div>

    <div class="form-row">
        <textarea id="promoDesc" placeholder="Descriere (reguli, pasi, detalii, conditii)" rows="4" style="width:100%;"></textarea>
    </div>

    <div class="form-row">
        <input type="file" id="promoMedia" accept="image/*,video/*">
    </div>

    <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-top:1rem;">
        <button class="news-btn" onclick="savePromo()">üíæ Salveaza</button>
        <button class="news-btn" onclick="cancelPromo()">‚ùå Anuleaza</button>
    </div>

    <small style="display:block; margin-top:0.8rem; opacity:0.75;">
        Media (foto/video) se incarca in Firebase Storage (doar admin). Participantii se inscriu public, cu ID automat.
    </small>
</div>
        </div>

        <div class="data-visualization neon-glow">
            <h3>üèÜ Clasament participan»õi</h3>
            
            <div id="leaderboard" style="margin-top:1rem;"></div>
        </div>
    </section>

<!-- ADMIN LOGIN (ca in index prezentare ok.html) -->
<section id="admin-login" class="admin-login">
  <h2>üîê Administrator Login</h2>
  <p class="admin-desc">Autentificare (Firebase Auth) necesara pentru adaugare/stergere membri, anunturi, noutati, giveaway si promotii.</p>

  <div class="admin-login-box">
    <input type="email" id="adminEmail" placeholder="Email administrator" autocomplete="username" />
    <input type="password" id="adminPass" placeholder="Parola administrator" autocomplete="current-password" />
    <button type="button" onclick="adminSignIn()">Autentificare</button>
    <button type="button" onclick="adminSignOut()" id="adminLogoutBtn" style="display:none;">Delogare</button>
  </div>

  <div class="admin-status-row">
    <span id="adminStatusBadge" class="admin-badge admin-badge-off">Neautentificat</span>
    <span id="adminUserLabel" class="admin-user-label"></span>
  </div>

  <p id="adminLoginMsg" class="admin-msg"></p>
</section>

<script>
  // Minimal navigation helper for single-page build
  function showSection(id){
    const sec = document.getElementById(id);
    if (!sec) return;
    document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active-section'));
    sec.classList.add('active-section');
    window.location.hash = '#'+id;
  }
  // Ensure giveaway visible on load
  window.addEventListener('load', ()=>showSection('giveaway'));
</script>

<!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // =============================================
        // CONFIGURARE
        // =============================================
        const CONTRACT_ADDRESS = '0x44Cf220399be798baeaE45fd7C4fF44623713833';
        const ETHERSCAN_PROXY = 'https://us-central1-stancubyt-64c78.cloudfunctions.net/etherscanProxy';
const ETHERSCAN_API_KEY = ''; // not used client-side (Cloud Function holds the key)

async function etherscanProxyRequest(module, action, params = {}) {
  const u = new URL(ETHERSCAN_PROXY);
  u.searchParams.set('module', module);
  u.searchParams.set('action', action);
  for (const [k,v] of Object.entries(params)) {
    if (v === undefined || v === null || v === '') continue;
    u.searchParams.set(k, String(v));
  }
  const r = await fetch(u.toString());
  const j = await r.json().catch(() => null);
  if (!j) throw new Error('Etherscan proxy: invalid JSON');
  // Etherscan returns {status:"1", message:"OK", result:"..."} or status:"0"
  if (j.status && j.status !== '1') {
    throw new Error((j.result && typeof j.result === 'string' ? j.result : j.message) || 'Etherscan proxy failed');
  }
  return j;
}
        const ADMIN_PASSWORD = 'ParolaCripto24091980.';

        // Chei storage
        const LS_NEWS = 'stancubyt_news';
        const LS_VISITS = 'stancubyt_visits';
        const LS_PROMOS = 'stancubyt_promos';

        // =============================================
        // UTILITARE
        // =============================================
        function $(id) { return document.getElementById(id); }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"'`=\/]/g, s => ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
            }[s]));
        }

        function verifyPassword() {
  try {
    // Firebase admin gate (nu mai cerem parola prin prompt)
    if (typeof firebase === 'undefined' || !firebase.auth) {
      alert('Firebase Auth nu este incarcat. Verifica includerea firebase-auth-compat.js.');
      return false;
    }
    if (!window.__SBYT_ADMIN || window.__SBYT_ADMIN !== true) {
      alert('Actiune restrictionata. Autentifica-te ca administrator (jos, pe pagina Prezentare).');
      try {
        showSection('prezentare');
        setTimeout(() => document.getElementById('admin-login')?.scrollIntoView({behavior:'smooth', block:'start'}), 150);
      } catch(e){}
      return false;
    }
    return true;
  } catch (e) {
    alert('Eroare verificare admin: ' + (e?.message || e));
    return false;
  }
}

// Router simplu (evitƒÉ bug-uri)
        function showSection(sectionId) {
            try {
                const sections = document.querySelectorAll('.page-section');
                sections.forEach(s => s.classList.remove('active-section'));

                const target = document.getElementById(sectionId);
                if (target) {
                    target.classList.add('active-section');
                    // update hash fƒÉrƒÉ sƒÉ sarƒÉ pagina
                    if (location.hash !== '#' + sectionId) history.replaceState(null, '', '#' + sectionId);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // fallback la prezentare
                    const prez = document.getElementById('prezentare');
                    if (prez) prez.classList.add('active-section');
                    if (location.hash !== '#prezentare') history.replaceState(null, '', '#prezentare');
                }
            } catch (e) {
                console.error('showSection error:', e);
            }
        }

        // La √ÆncƒÉrcare ‚Äì dacƒÉ existƒÉ hash, mergi acolo
        function initRouting() {
            const id = (location.hash || '').replace('#', '').trim();
            if (id && document.getElementById(id)) showSection(id);
            else showSection('prezentare');
        }

        // =============================================
        // CONTOR VIZITE (local ‚Äì varianta B)
        // =============================================
        function updateVisitCounter() {
            try {
                let visits = parseInt(localStorage.getItem(LS_VISITS) || '0', 10);
                visits += 1;
                localStorage.setItem(LS_VISITS, String(visits));

                // suport pentru diferite id-uri existente √Æn layout
                const el = $('visitCount') || $('visitsCount') || $('visitCounter') || $('visits');
                if (el) el.textContent = visits.toLocaleString('ro-RO');
            } catch (e) {
                console.error('visit counter:', e);
            }
        }

        // =============================================
        // NOUƒÇ»öI & ANUN»öURI (local ‚Äì varianta B)
        // =============================================
        function seedNewsIfMissing() {
            const existing = localStorage.getItem(LS_NEWS);
            if (existing) return;

            const initial = [
                {
                    id: 1,
                    title: 'Lansare OficialƒÉ StancuBYT!',
                    content: 'Tokenul StancuBYT a fost lansat oficial pe Ethereum. Contract verificat pe Etherscan.',
                    type: 'announcement',
                    date: new Date().toISOString(),
                    pinned: true
                },
                {
                    id: 2,
                    title: 'Listare pe Uniswap V3',
                    content: 'SBYT este acum listat pe Uniswap V3. Po»õi cumpƒÉra tokenul direct din site.',
                    type: 'update',
                    date: new Date(Date.now() - 86400000).toISOString(),
                    pinned: false
                }
            ];
            localStorage.setItem(LS_NEWS, JSON.stringify(initial));
        }

        function loadNews() {
            try {
                seedNewsIfMissing();
                const news = JSON.parse(localStorage.getItem(LS_NEWS) || '[]');

                // Sortare: pinned, apoi recent
                news.sort((a, b) => {
                    if (!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
                    return new Date(b.date) - new Date(a.date);
                });

                const container = $('newsContainer');
                if (!container) return;
                container.innerHTML = '';

                news.forEach(item => {
                    const badgeClass = item.type === 'announcement' ? 'badge-announcement' :
                                     item.type === 'event' ? 'badge-event' : 'badge-update';
                    const badgeText = item.type === 'announcement' ? 'Anun»õ Important' :
                                    item.type === 'event' ? 'Eveniment' : 'Update';
                    const cardClass = item.pinned ? 'news-card pinned' : 'news-card';

                    const card = document.createElement('div');
                    card.className = cardClass;

                    card.innerHTML = `
                        <div class="news-badge ${badgeClass}">${badgeText}</div>
                        <h4 style="margin-bottom: 0.5rem; color: white;">${escapeHtml(item.title)}</h4>
                        <p style="opacity: 0.9; line-height: 1.5;">${escapeHtml(item.content)}</p>
                        <div class="news-date">
                            <span>üìÖ</span>
                            ${new Date(item.date).toLocaleDateString('ro-RO', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' })}
                        </div>
                        <div style="display:flex; gap:10px; margin-top: 1rem; flex-wrap:wrap;">
                            <button class="news-btn" onclick="deleteNews(${Number(item.id)})">üóëÔ∏è »òterge</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error('loadNews:', e);
            }
        }

        function addNews() {
            if (!verifyPassword()) return;
            const f = $('newsForm');
            if (f) f.style.display = 'block';
        }

        function cancelAddNews() {
            const f = $('newsForm');
            if (f) f.style.display = 'none';
            if ($('newsTitle')) $('newsTitle').value = '';
            if ($('newsContent')) $('newsContent').value = '';
            if ($('pinNews')) $('pinNews').checked = false;
            if ($('newsType')) $('newsType').value = 'update';
        }

        function saveNews() {
            if (!verifyPassword()) return;

            const title = ($('newsTitle')?.value || '').trim();
            const content = ($('newsContent')?.value || '').trim();
            const type = $('newsType')?.value || 'update';
            const pinned = !!$('pinNews')?.checked;

            if (!title || !content) {
                alert('CompleteazƒÉ titlul »ôi con»õinutul!');
                return;
            }

            try {
                const existing = JSON.parse(localStorage.getItem(LS_NEWS) || '[]');
                const newId = existing.length ? Math.max(...existing.map(n => Number(n.id) || 0)) + 1 : 1;

                existing.push({
                    id: newId,
                    title,
                    content,
                    type,
                    date: new Date().toISOString(),
                    pinned
                });

                localStorage.setItem(LS_NEWS, JSON.stringify(existing));
                cancelAddNews();
                loadNews();
                alert('Anun»õul a fost adƒÉugat!');
            } catch (e) {
                console.error('saveNews:', e);
                alert('Eroare la salvare.');
            }
        }

        function deleteNews(id) {
            if (!verifyPassword()) return;
            if (!confirm('Sigur vrei sƒÉ »ôtergi acest anun»õ?')) return;

            try {
                const existing = JSON.parse(localStorage.getItem(LS_NEWS) || '[]');
                const filtered = existing.filter(n => Number(n.id) !== Number(id));
                localStorage.setItem(LS_NEWS, JSON.stringify(filtered));
                loadNews();
            } catch (e) {
                console.error('deleteNews:', e);
            }
        }

        function clearNews() {
            if (!verifyPassword()) return;
            if (!confirm('Sigur vrei sƒÉ »ôtergi TOATE anun»õurile?')) return;
            localStorage.removeItem(LS_NEWS);
            loadNews();
        }

        // Pentru butoanele existente √Æn HTML (care apeleazƒÉ requestPassword)
        async function requestPassword(action, id) {
            // pƒÉstrƒÉm compatibilitatea cu HTML-ul existent
            if (action === 'add') return addNews();
            if (action === 'clear') return clearNews();

            // Giveaway / promo
            if (action === 'promoAdd') return showPromoForm();
            if (action === 'promoClear') return clearPromos();

            // fallback
            if (action === 'deleteNews') return deleteNews(id);
        }

        // =============================================
        // GIVEAWAY & PROMO»öII (local ‚Äì varianta B)
        // =============================================
        // ===== Firestore sync for promos + participants (uses stats/visits to match your Firestore rules) =====
        let __PROMOS_CACHE = [];
        let __PART_CACHE = {}; // { promoId: [participants] }
        let __SYNC_READY = false;

        function getPromos() {
            return Array.isArray(__PROMOS_CACHE) ? __PROMOS_CACHE : [];
        }
        async function setPromos(arr) {
            __PROMOS_CACHE = Array.isArray(arr) ? arr : [];
            // local fallback (optional)
            try { localStorage.setItem(LS_PROMOS, JSON.stringify(__PROMOS_CACHE)); } catch(_) {}
            if (typeof db !== 'undefined' && db) {
                await db.collection('stats').doc('visits').set({ promos: __PROMOS_CACHE }, { merge: true });
            }
        }
  // (participants storage handled by Firestore sync layer above)
    map[promoId] = arr || [];
    localStorage.setItem(LS_PROMO_PART, JSON.stringify(map));
  }

  // --- Giveaway/Promo UI (override stable) ---
  // showPromoForm poate primi tip: 'promo' / 'giveaway'
  window.showPromoForm = function(type){
    if (!verifyPassword()) return;
    const f = $('promoForm');
    if (f) f.style.display='block';
    if ($('promoType')) $('promoType').value = type || 'promo';
  };

  window.savePromo = function(){
    if (!verifyPassword()) return;

    const title = ($('promoTitle')?.value || '').trim();
    const endDate = ($('promoEndDate')?.value || '').trim();
    const desc = ($('promoDesc')?.value || '').trim();
    const type = ($('promoType')?.value || 'promo').trim();

    const prize1 = ($('promoPrize1')?.value || '').trim();
    const prize2 = ($('promoPrize2')?.value || '').trim();
    const prize3 = ($('promoPrize3')?.value || '').trim();
    const prize4 = ($('promoPrize4')?.value || '').trim();

    if (!title || !endDate){
      alert('Completeaza titlul si data de expirare.');
      return;
    }

    const promos = getPromos();
    const id = Date.now();
    promos.push({ id, type, title, desc, endDate, prizes:{p1:prize1,p2:prize2,p3:prize3,p4:prize4} });
    setPromos(promos);

    // reset form
    if ($('promoForm')) $('promoForm').style.display='none';
    ['promoTitle','promoEndDate','promoDesc','promoPrize1','promoPrize2','promoPrize3','promoPrize4'].forEach(x=>{ if($(x)) $(x).value=''; });

    renderPromos();
    renderLeaderboard();
    alert('Salvat.');
  };

  window.deletePromo = function(promoId){
    if (!verifyPassword()) return;
    if (!confirm('Stergi aceasta promotie/giveaway?')) return;
    const promos = getPromos().filter(p => Number(p.id) !== Number(promoId));
    setPromos(promos);
    // sterge si participantii
    setParticipants(String(promoId), []);
    renderPromos();
    renderLeaderboard();
  };

  window.joinPromo = function(promoId){
    const name = ($('joinName_' + promoId)?.value || '').trim();
    const email = ($('joinEmail_' + promoId)?.value || '').trim();
    const wallet = ($('joinWallet_' + promoId)?.value || '').trim();
    const referral = ($('joinReferral_' + promoId)?.value || '').trim().toUpperCase();

    if (!name || !email || !wallet){
      alert('Completeaza nume, email si wallet.');
      return;
    }

    const promos = getPromos();
    const p = promos.find(x => Number(x.id) === Number(promoId));
    if (!p) return;

    // expirare: dupa data setata nu mai acceptam inscrieri
    const end = new Date(p.endDate + 'T23:59:59');
    if (Date.now() > end.getTime()){
      alert('Aceasta promotie/giveaway este expirata. Nu mai accepta inscrieri.');
      return;
    }

    const participants = getParticipants(String(promoId));

    // validate referral: accepta DOAR coduri existente (generate anterior)
    if (referral){
      const exists = participants.some(u => String(u.code||'').toUpperCase() === referral);
      if (!exists){
        alert('Codul Referal nu este valid. Trebuie sa fie un cod generat anterior.');
        return;
      }
    }

    const code = randCode();
    participants.push({
      id: Date.now() + '_' + Math.random().toString(16).slice(2),
      name, email, wallet,
      code,
      referral: referral || '',
      createdAt: Date.now()
    });
    setParticipants(String(promoId), participants);

    // clear inputs
    ['joinName_','joinEmail_','joinWallet_','joinReferral_'].forEach(pref=>{
      const el=$(pref+promoId); if(el) el.value='';
    });

    renderPromos();
    renderLeaderboard();
    alert('Inscriere reusita! Codul tau: ' + code);
  };

  window.renderPromos = function(){
    const list = $('promoList');
    if (!list) return;
    const promos = getPromos();

    if (!promos.length){
      list.innerHTML = '<div style="opacity:0.85;">Nu exista promotii/giveaway-uri inca.</div>';
      return;
    }

    promos.sort((a,b)=> new Date(a.endDate) - new Date(b.endDate));
    list.innerHTML = '';

    promos.forEach(p=>{
      const end = new Date(p.endDate + 'T23:59:59');
      const expired = Date.now() > end.getTime();
      const part = getParticipants(String(p.id));

      const prizes = p.prizes || {};
      const prizesHtml = (prizes.p1||prizes.p2||prizes.p3||prizes.p4) ? `
        <div style="margin-top:10px; padding:10px; border:1px solid rgba(255,255,255,.10); border-radius:12px; background:rgba(255,255,255,.03);">
          <div style="font-weight:800; margin-bottom:6px;">üèÖ Premii</div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:8px;">
            <div><b>Loc 1:</b> ${escapeHtml(prizes.p1||'-')}</div>
            <div><b>Loc 2:</b> ${escapeHtml(prizes.p2||'-')}</div>
            <div><b>Loc 3:</b> ${escapeHtml(prizes.p3||'-')}</div>
            <div><b>Loc 4:</b> ${escapeHtml(prizes.p4||'-')}</div>
          </div>
        </div>` : '';

      const partHtml = part.length ? `
        <div style="margin-top:12px; font-size:.95rem;">
          <div style="font-weight:800; margin-bottom:6px;">üë• Participanti (${part.length})</div>
          <div class="table-responsive">
            <table class="lb-table">
              <thead><tr>
                <th>#</th><th>Nume</th><th>Email</th><th>Cod</th><th>Referal</th>
              </tr></thead>
              <tbody>
                ${part.slice().sort((a,b)=>a.createdAt-b.createdAt).map((u,i)=>`
                  <tr>
                    <td>${i+1}</td>
                    <td>${escapeHtml(u.name)}</td>
                    <td class="mono">${escapeHtml(maskEmail(u.email))}</td>
                    <td class="mono">${escapeHtml(u.code)}</td>
                    <td class="mono">${escapeHtml(u.referral||'-')}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>` : `<div style="margin-top:10px; opacity:.85;">Nu exista participanti inca.</div>`;

      const adminBtns = `
        <div class="admin-only" style="margin-top:12px; text-align:right;">
          <button class="news-btn" onclick="deletePromo(${Number(p.id)})">üóëÔ∏è Sterge</button>
        </div>`;

      const card = document.createElement('div');
      card.className = 'news-card neon-glow';
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
          <div>
            <div style="font-size:1.15rem; font-weight:900;">
              ${p.type === 'giveaway' ? 'üéÅ' : 'üì£'} ${escapeHtml(p.title)}
              ${expired ? '<span style="margin-left:8px; font-size:.85rem; color:#ff4d4d;">(Expirat)</span>' : ''}
            </div>
            <div style="opacity:.85; margin-top:6px;">${escapeHtml(p.desc||'')}</div>
            <div style="opacity:.85; margin-top:10px;"><b>Expira:</b> ${escapeHtml(p.endDate)}</div>
          </div>
        </div>

        ${prizesHtml}

        <div style="margin-top:14px; padding:12px; border:1px solid rgba(255,255,255,.10); border-radius:12px; background:rgba(0,0,0,.18);">
          <div style="font-weight:900; margin-bottom:10px;">üìù Inscriere</div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">
            <input id="joinName_${p.id}" placeholder="Nume" />
            <input id="joinEmail_${p.id}" placeholder="Email" />
            <input id="joinWallet_${p.id}" placeholder="Wallet" />
            <input id="joinReferral_${p.id}" placeholder="Referal (optional)" />
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button class="news-btn" onclick="joinPromo(${Number(p.id)})" ${expired?'disabled style="opacity:.5; cursor:not-allowed;"':''}>‚úÖ Inscrie-te</button>
          </div>
          <div style="opacity:.75; font-size:.9rem; margin-top:8px;">
            Referal: accepta doar coduri generate anterior (de la participanti deja inscrisi).
          </div>
        </div>

        ${partHtml}
        ${adminBtns}
      `;
      list.appendChild(card);
    });

    // refresh admin visibility
    if (isAdmin()) showAdminOnly(); else hideAdminOnly();
  };

  // --- Leaderboard by referrals (top 1-3 highlighted) ---
  window.renderLeaderboard = function(){
    const root = $('leaderboard');
    if (!root) return;
    const promos = getPromos();
    if (!promos.length){
      root.innerHTML = '<div style="opacity:0.85;">Nu exista clasamente inca.</div>';
      return;
    }

    let html = '';
    promos.sort((a,b)=> new Date(a.endDate) - new Date(b.endDate));

    promos.forEach(p=>{
      const part = getParticipants(String(p.id));
      // compute referral counts by code
      const counts = {};
      part.forEach(u => { counts[String(u.code).toUpperCase()] = 0; });
      part.forEach(u=>{
        const ref = String(u.referral||'').toUpperCase();
        if (ref && typeof counts[ref] === 'number') counts[ref] += 1;
      });

      const rows = part.map(u => ({
        name: u.name,
        email: u.email,
        code: u.code,
        referrals: counts[String(u.code).toUpperCase()] || 0
      })).sort((a,b)=> b.referrals - a.referrals);

      const prizes = p.prizes || {};
      const prizeNote = (prizes.p1||prizes.p2||prizes.p3) ? `
        <div style="opacity:.85; margin-top:6px; font-size:.95rem;">
          <b>Premii:</b> #1 ${escapeHtml(prizes.p1||'-')} ¬∑ #2 ${escapeHtml(prizes.p2||'-')} ¬∑ #3 ${escapeHtml(prizes.p3||'-')} ¬∑ #4 ${escapeHtml(prizes.p4||'-')}
        </div>` : '';

      html += `
        <div class="neon-glow" style="padding:16px; border-radius:16px; margin-bottom:14px; background:rgba(255,255,255,.02);">
          <div style="font-weight:1000; font-size:1.1rem;">
            ${p.type === 'giveaway' ? 'üéÅ' : 'üì£'} ${escapeHtml(p.title)}
          </div>
          ${prizeNote}
          <div class="table-responsive" style="margin-top:12px;">
            <table class="lb-table">
              <thead>
                <tr>
                  <th>Loc</th><th>Nume</th><th>Email</th><th>Cod</th><th>Inscrieri cu codul</th>
                </tr>
              </thead>
              <tbody>
                ${
                  (rows.length ? rows : [{name:'-',email:'',code:'',referrals:0}]).map((r, idx)=>{
                    const cls = idx===0?'lb-top1':idx===1?'lb-top2':idx===2?'lb-top3':'';
                    return `<tr class="${cls}">
                      <td><b>${rows.length? (idx+1): '-'}</b></td>
                      <td>${escapeHtml(r.name)}</td>
                      <td class="mono">${rows.length? escapeHtml(maskEmail(r.email)) : '-'}</td>
                      <td class="mono">${rows.length? escapeHtml(r.code) : '-'}</td>
                      <td><b>${rows.length? r.referrals : '-'}</b></td>
                    </tr>`;
                  }).join('')
                }
              </tbody>
            </table>
          </div>
          <div style="opacity:.75; font-size:.9rem; margin-top:8px;">
            Clasamentul se calculeaza dupa numarul de inscrieri care folosesc codul tau in campul Referal.
          </div>
        </div>
      `;
    });

    root.innerHTML = html;
  };

  // --- Team members: fallback localStorage to avoid (Rules) ---
  function getTeam(){
    try{ return JSON.parse(localStorage.getItem(LS_TEAM) || '[]'); } catch { return []; }
  }
  function setTeam(arr){ localStorage.setItem(LS_TEAM, JSON.stringify(arr||[])); }

  // daca exista UI de "save member", prindem butonul prin id-uri comune
  window.saveTeamMemberLocal = function(){
    if (!verifyPassword()) return;

    const name = ($('memberName')?.value || $('teamName')?.value || '').trim();
    const role = ($('memberRole')?.value || $('teamRole')?.value || '').trim();
    const bio  = ($('memberBio')?.value  || $('teamBio')?.value  || '').trim();
    const joinDate = ($('memberJoinDate')?.value || $('teamJoinDate')?.value || isoToday()).trim();
    const img = ($('memberImage')?.value || $('teamImage')?.value || '').trim();

    if (!name || !role){
      alert('Completeaza minim Nume si Rol.');
      return;
    }

    const team = getTeam();
    team.push({ id: Date.now(), name, role, bio, joinDate, img });
    setTeam(team);

    ['memberName','memberRole','memberBio','memberJoinDate','memberImage','teamName','teamRole','teamBio','teamJoinDate','teamImage'].forEach(id=>{
      const el=$(id); if(el) el.value='';
    });

    if (typeof window.renderTeamLocal === 'function') window.renderTeamLocal();
    alert('Membru salvat (local).');
  };

  // Fortam butonul existent (saveTeamMember) sa foloseasca varianta local (evita Rules)
  window.saveTeamMember = window.saveTeamMemberLocal;
  window.deleteTeamMember = window.deleteTeamMemberLocal;


  window.deleteTeamMemberLocal = function(memberId){
    if (!verifyPassword()) return;
    if (!confirm('Stergi acest membru?')) return;
    const team = getTeam().filter(m => Number(m.id)!==Number(memberId));
    setTeam(team);
    if (typeof window.renderTeamLocal === 'function') window.renderTeamLocal();
  };

  window.renderTeamLocal = function(){
    const list = document.getElementById('teamList') || document.getElementById('teamMembers') || document.getElementById('teamContainer');
    if (!list) return;
    const team = getTeam();
    if (!team.length){
      list.innerHTML = '<div style="opacity:0.85;">Nu exista membri adaugati inca.</div>';
      return;
    }
    list.innerHTML = '';
    team.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'news-card neon-glow';
      card.innerHTML = `
        <div style="display:flex; gap:14px; align-items:flex-start;">
          <div style="width:64px; height:64px; border-radius:14px; overflow:hidden; background:rgba(255,255,255,.05); flex:0 0 auto;">
            ${m.img ? `<img src="${escapeHtml(m.img)}" style="width:100%;height:100%;object-fit:cover;" alt=""/>` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;opacity:.7;">üë§</div>`}
          </div>
          <div style="flex:1;">
            <div style="font-weight:1000; font-size:1.05rem;">${escapeHtml(m.name)}</div>
            <div style="opacity:.85; margin-top:4px;">${escapeHtml(m.role)}</div>
            ${m.bio ? `<div style="opacity:.8; margin-top:8px;">${escapeHtml(m.bio)}</div>`:''}
            <div style="opacity:.7; margin-top:8px; font-size:.9rem;">üìÖ ${escapeHtml(m.joinDate||'')}</div>
          </div>
        </div>
        <div class="admin-only" style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button class="news-btn" onclick="deleteTeamMemberLocal(${Number(m.id)})">üóëÔ∏è Sterge</button>
        </div>
      `;
      list.appendChild(card);
    });

    if (isAdmin()) showAdminOnly(); else hideAdminOnly();
  };

  // Incarca giveaway/promo + leaderboard la intrare in sectiune
  const origShowSection = window.showSection;
  window.showSection = function(sectionId){
    if (typeof origShowSection === 'function') origShowSection(sectionId);
    if (sectionId === 'giveaway'){
      try{ renderPromos(); renderLeaderboard(); }catch(e){ console.warn(e); }
    }
    if (sectionId === 'whitepaper'){
      try{ renderTeamLocal(); }catch(e){}
    }
  };

  // --- Contact privacy checkbox fix ---
  function patchContact(){
    // cauta formularul de contact si checkbox-ul
    const form = document.getElementById('quickContactForm') || document.querySelector('form#contactForm') || document.querySelector('form[data-contact]');
    const checkbox = document.getElementById('privacyAgree') || document.getElementById('confAgree') || document.querySelector('input[type="checkbox"][name*="conf"]') || document.querySelector('input[type="checkbox"][id*="agree"]');
    const msg = document.getElementById('contactMsg') || document.getElementById('contactStatus') || document.querySelector('#contact .form-msg');

    if (!form) return;

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const agreed = checkbox ? checkbox.checked : false;
      if (!agreed){
        alert('Bifeaza acordul de confidentialitate.');
        if (msg) { msg.textContent='Bifeaza acordul de confidentialitate.'; msg.style.color='#ff4d4d'; }
        return;
      }
      // Daca proiectul tau trimitea prin fetch, aici pastram comportamentul existent (daca exista handler).
      // Fallback: mailto
      const name = (document.getElementById('contactName')?.value || '').trim();
      const email = (document.getElementById('contactEmail')?.value || '').trim();
      const message = (document.getElementById('contactMessage')?.value || '').trim();

      const subj = encodeURIComponent('StancuBYT | Contact');
      const body = encodeURIComponent(`Nume: ${name}\nEmail: ${email}\n\nMesaj:\n${message}`);
      window.location.href = `mailto:contact@stancubyt.com?subject=${subj}&body=${body}`;
      if (msg){ msg.textContent='Se deschide clientul de email pentru trimitere.'; msg.style.color='#00ff88'; }
    }, {capture:true});
  }
  document.addEventListener('DOMContentLoaded', patchContact);

  // --- Stats + total supply: robust refresh if API key missing ---
  const origFetchAllData = window.fetchAllData;
  window.fetchAllData = async function(){
    if (typeof origFetchAllData === 'function'){
      try{ await origFetchAllData(); }catch(e){ console.warn(e); }
    }
    // daca supplyValue a ramas "Se incarca..." si nu avem cheie, explicam
    const supply = document.getElementById('supplyValue');
    if (supply && /incar/i.test(supply.textContent||'') && (!window.ETHERSCAN_API_KEY || window.ETHERSCAN_API_KEY==='YOUR_ETHERSCAN_API_KEY')){
      supply.textContent = 'Seteaza ETHERSCAN_API_KEY';
    }
  };

})();
</script>


<script>
/* ============================================================
   SBYT V4 PATCH (Firebase Auth + Firestore cross-device + Etherscan live)
   Admin account: stancubyt@gmail.com
   ============================================================ */

(function(){
  // ---------- Helpers ----------
  function $(id){ return document.getElementById(id); }
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"'`=\/]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
    }[s]));
  }
  function maskEmail(email){
    if (!email || typeof email !== 'string') return '';
    const [u, d] = email.split('@');
    if (!d) return email;
    const left = u.length <= 2 ? (u[0] + '*') : (u.slice(0,2) + '*'.repeat(Math.min(6, u.length-2)));
    return `${left}@${d}`;
  }
  function isExpired(endDate){
    if (!endDate) return false;
    const end = new Date(endDate + 'T23:59:59');
    return new Date() > end;
  }
  async function uidSafe(){ try{ return firebase?.auth()?.currentUser?.uid || null; }catch(e){ return null; } }

  // ---------- Firebase presence ----------
  async function hasFirestore(){
    try{ return typeof firebase !== 'undefined' && !!firebase.firestore; }catch(e){ return false; }
  }
  async function db(){ return firebase.firestore(); }

  // ---------- Etherscan LIVE ----------
  // IMPORTANT: set your key (optional) in localStorage 'SBYT_ETHERSCAN_KEY' or edit below.
  const CONTRACT_ADDR = "0x44Cf220399be798baeaE45fd7C4fF44623713833";
  const ETHERSCAN_KEY = (localStorage.getItem('SBYT_ETHERSCAN_KEY') || '').trim(); // leave blank if you want (may be rate-limited)
  async function fetchEtherscan(url){
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('Etherscan HTTP ' + r.status);
    return await r.json();
  }
  async function formatTokensFromWei(weiStr, decimals=18){
    try{
      const s = String(weiStr || '0');
      // simple big int formatting without floating errors
      const pad = decimals;
      const neg = s.startsWith('-');
      const x = neg ? s.slice(1) : s;
      const z = x.padStart(pad+1,'0');
      const intPart = z.slice(0, -pad);
      const frac = z.slice(-pad).replace(/0+$/,'');
      const out = frac ? `${intPart}.${frac}` : intPart;
      return neg ? '-' + out : out;
    }catch(e){ return String(weiStr||'0'); }
  }
  async function updateTotalSupplyReal(){
    // tries stats/tokensupply
    const el = document.querySelector('[data-total-supply-real], #totalSupplyReal, #totalSupplyRealValue, #totalSupplyRealText');
    try{
      const j = await etherscanProxyRequest('stats','tokensupply',{ contractaddress: CONTRACT_ADDR });
      if (j && j.status === "1" && j.result){
        const val = formatTokensFromWei(j.result, 18);
        const pretty = Number(val).toLocaleString(undefined, { maximumFractionDigits: 4 });
        if (el) el.textContent = pretty + " SBYT";
        const el2 = document.getElementById('totalSupplyReal');
        if (el2) el2.textContent = pretty + " SBYT";
      }
    }catch(e){
      // keep existing UI if any
    }
  }
  async function updateStatsFromEtherscan(){
    // Minimal live update for supply + (optional) holders/transfers if elements exist in page
    await updateTotalSupplyReal();

    // holders count: omitted (endpoint often restricted); keep UI as-is if present.

// transfers count (account/tokentx)
try{
  const j = await etherscanProxyRequest('account','tokentx',{ contractaddress: CONTRACT_ADDR, page: 1, offset: 1, sort: 'desc' });
  // Etherscan returns array in result; total count not provided. We'll approximate by reading a separate element if any.
  // If you need exact transfers count, store it server-side. Here we just mark "LIVE".
  const elT = document.getElementById('totalTransfers');
  if (elT) elT.textContent = 'LIVE';
}catch(e){ }
}

  // ---------- Contact checkbox FIX ----------
  function patchQuickContact(){
    // If you had a handler that blocks even when checked, we ensure checkbox is read correctly.
    const form = document.querySelector('#quickContactForm, form[data-quick-contact]');
    if (!form) return;

    const agree = form.querySelector('input[type="checkbox"][name="privacy"], #privacyAgree, #agreePrivacy');
    const msg = form.querySelector('#quickContactMsg, .quick-contact-msg');

    form.addEventListener('submit', function(ev){
      if (agree && !agree.checked){
        ev.preventDefault();
        if (msg) { msg.textContent = "Bifeaza acordul de confidentialitate"; msg.style.color = "#ff4d4d"; }
        return;
      }
      // allow submit; if no backend, fallback mailto
      // (do not prevent default here)
    }, true);
  }

  // ---------- Firestore data model ----------
  // Collection: promos (docs: {type:'promo'|'giveaway', title, startDate, endDate, prizes:{p1,p2,p3,p4}, createdAt})
  // Subcollection: promos/{id}/participants (docs: {email, code, referral, createdAt})
  // Collection: announcements, news, team (optional if present in your UI)

  async function loadPromosFS(){
    if (!hasFirestore()) return null;
    const snap = await db().collection('promos').orderBy('createdAt','desc').get();
    const arr = [];
    snap.forEach(d => {
      const x = d.data() || {};
      arr.push({ id: d.id, ...x });
    });
    return arr;
  }
  async function loadParticipantsFS(promoId){
    if (!hasFirestore()) return [];
    const snap = await db().collection('promos').doc(promoId).collection('participants').orderBy('createdAt','asc').get();
    const arr = [];
    snap.forEach(d => arr.push({ id:d.id, ...(d.data()||{}) }));
    return arr;
  }
  async function addParticipantFS(promoId, participant){
    if (!hasFirestore()) throw new Error("Firestore indisponibil");
    const ref = db().collection('promos').doc(promoId).collection('participants');
    const doc = await ref.add({ ...participant, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    return doc.id;
  }
  async function deletePromoFS(promoId){
    if (!hasFirestore()) throw new Error("Firestore indisponibil");
    // delete doc (participants subcollection remains unless you use a function); UI-level delete only
    await db().collection('promos').doc(promoId).delete();
  }

  // ---------- Referral ranking ----------
  function buildRanking(participants){
    // points for a participant = how many entries used their code as referral
    const byReferral = new Map(); // referralCode -> count
    participants.forEach(p=>{
      const ref = (p.referral || '').trim();
      if (!ref) return;
      byReferral.set(ref, (byReferral.get(ref)||0)+1);
    });

    const arr = participants.map(p=>{
      const code = (p.code || '').trim();
      const points = code ? (byReferral.get(code) || 0) : 0;
      return { ...p, points };
    }).sort((a,b)=> (b.points - a.points) || String(a.email||'').localeCompare(String(b.email||'')));

    return arr;
  }

  // ---------- UI render: leaderboard per promo ----------
  async function renderLeaderboardPerPromo(){
    const lb = $('leaderboard');
    if (!lb) return;

    // load promos from Firestore if possible; else fallback to existing getPromos()
    let promos = null;
    try{
      promos = await loadPromosFS();
    }catch(e){ promos = null; }

    if (!promos){
      // fallback to legacy local promos if they exist
      try{ promos = (window.getPromos ? window.getPromos() : []); }catch(e){ promos = []; }
      // normalize ids
      promos = (promos||[]).map((p, i)=> ({ id: p.id || p.promoId || ('local_'+i), ...p }));
    }

    if (!promos.length){
      lb.innerHTML = `<div style="opacity:0.85;">Nu exista giveaway/promotii inca.</div>`;
      return;
    }

    let out = '';
    for (const p of promos){
      const title = p.title || p.name || 'Fara titlu';
      const type = p.type || p.promoType || 'promo';
      const endDate = p.endDate || p.end || '';
      let participants = [];

      try{
        participants = await loadParticipantsFS(p.id);
      }catch(e){
        // fallback local participants if exists
        try{
          if (window.getParticipants) participants = window.getParticipants(p.id) || [];
          else participants = p.participants || [];
        }catch(err){ participants = p.participants || []; }
      }

      const rank = buildRanking(participants);
      const prizes = p.prizes || { p1:p.prize1, p2:p.prize2, p3:p.prize3, p4:p.prize4 };

      out += `<div class="data-visualization neon-glow" style="margin-top:1rem; padding:1rem;">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:800; font-size:1.05rem;">${type === 'giveaway' ? 'üèÜ Giveaway' : 'üéÅ Promotie'}: ${escapeHtml(title)}</div>
            <div style="opacity:0.8; font-size:0.9rem;">Expira: <b>${escapeHtml(endDate || '-')}</b></div>
          </div>
          <div style="opacity:0.9; font-size:0.9rem;">
            <div><b>Premii:</b></div>
            <div>1: ${escapeHtml(prizes?.p1 || '-')} | 2: ${escapeHtml(prizes?.p2 || '-')} | 3: ${escapeHtml(prizes?.p3 || '-')} | 4: ${escapeHtml(prizes?.p4 || '-')}</div>
          </div>
        </div>

        ${rank.length ? `
          <div class="table-container" style="margin-top:0.8rem;">
            <table class="whitepaper-table">
              <tr><th>#</th><th>Email</th><th>Cod</th><th>Referral folosit</th><th>Puncte</th></tr>
              ${rank.map((u, i)=>{
                const cls = (i===0) ? 'style="background:rgba(255,215,0,0.15); font-weight:800;"'
                          : (i===1) ? 'style="background:rgba(192,192,192,0.12); font-weight:800;"'
                          : (i===2) ? 'style="background:rgba(205,127,50,0.12); font-weight:800;"'
                          : '';
                return `<tr ${cls}>
                  <td>${i+1}</td>
                  <td>${escapeHtml(maskEmail(u.email||''))}</td>
                  <td><code>${escapeHtml(maskRefCode(u.code||''))}</code></td>
                  <td><code>${escapeHtml(maskRefCode(((u.referral||'').trim()||'-')))}</code></td>
                  <td><b>${Number(u.points||0)}</b></td>
                </tr>`;
              }).join('')}
            </table>
          </div>
        ` : `<div style="margin-top:0.8rem; opacity:0.85;">Nu exista participanti inca.</div>`}
      </div>`;
    }

    lb.innerHTML = out;
  }

  // Override old leaderboard renderer
  window.renderLeaderboard = function(){ renderLeaderboardPerPromo(); };

  // ---------- Enforce expiry + referral validation on join ----------
  // If your existing join handler uses window.joinPromo(promoId, data), we wrap it.
  const prevJoin = window.joinPromo;
  window.joinPromo = async function(promoId, data){
    // data: {email, code, referral, ...}
    try{
      // load promo to check expiry
      let promo = null;
      if (hasFirestore()){
        const doc = await db().collection('promos').doc(promoId).get();
        if (doc.exists) promo = { id: doc.id, ...(doc.data()||{}) };
      }
      if (!promo){
        // fallback legacy
        const promos = window.getPromos ? window.getPromos() : [];
        promo = (promos||[]).find(x => (x.id===promoId || x.promoId===promoId));
      }
      if (promo && isExpired(promo.endDate || promo.end)){
        alert('Inscrierile sunt inchise. Giveaway/Promotia a expirat.');
        return;
      }

      // referral must exist (generated previously)
      const referral = (data?.referral || '').trim();
      if (referral){
        let allCodes = new Set();
        if (hasFirestore()){
          const parts = await loadParticipantsFS(promoId);
          parts.forEach(p => { if (p.code) allCodes.add(String(p.code).trim()); });
        }else{
          const parts = window.getParticipants ? (window.getParticipants(promoId)||[]) : [];
          parts.forEach(p => { if (p.code) allCodes.add(String(p.code).trim()); });
        }
        if (!allCodes.has(referral)){
          alert('Cod referral invalid. Introdu un cod existent (generat anterior).');
          return;
        }
      }

      // store participant in Firestore if available (cross-device)
      if (hasFirestore()){
        await addParticipantFS(promoId, {
          email: String(data?.email || '').trim(),
          code: String(data?.code || '').trim(),
          referral: referral
        });
        // refresh leaderboard
        renderLeaderboardPerPromo();
        // refresh promo lists if you render them elsewhere
        if (window.renderPromos) window.renderPromos();
        return;
      }

      // fallback to old behavior
      if (typeof prevJoin === 'function') return prevJoin(promoId, data);
    } catch (e){
      // fallback to old behavior
      if (typeof prevJoin === 'function') return prevJoin(promoId, data);
      console.error(e);
      alert('Eroare la inscriere. Verifica setarile Firebase/Rules.');
    }
  };

  // ---------- Admin-only add/delete for promos (Firestore) ----------
  const prevSavePromo = window.savePromo;
  window.savePromo = async function(){
    // expects existing form fields; we keep your UI but save to Firestore if admin
    try{
      if (!window.__SBYT_ADMIN){
        alert('Actiune permisa doar administratorului. Autentifica-te.');
        return;
      }
      // read fields if exist
      const type = ($('promoType')?.value || 'promo').trim();
      const title = ($('promoTitle')?.value || '').trim();
      const startDate = ($('promoStart')?.value || $('promoStartDate')?.value || '').trim();
      const endDate = ($('promoEnd')?.value || $('promoEndDate')?.value || '').trim();

      const p1 = ($('prize1')?.value || $('promoPrize1')?.value || '').trim();
      const p2 = ($('prize2')?.value || $('promoPrize2')?.value || '').trim();
      const p3 = ($('prize3')?.value || $('promoPrize3')?.value || '').trim();
      const p4 = ($('prize4')?.value || $('promoPrize4')?.value || '').trim();

      if (!title || !endDate){
        alert('Completeaza minim Titlu si Data expirarii.');
        return;
      }

      if (hasFirestore()){
        await db().collection('promos').add({
          type,
          title,
          startDate: startDate || null,
          endDate,
          prizes: { p1, p2, p3, p4 },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: uidSafe() || null
        });
        // hide form if exists
        const f = $('promoForm'); if (f) f.style.display='none';
        // refresh
        renderLeaderboardPerPromo();
        if (window.renderPromos) window.renderPromos();
        alert('Salvat in Firebase (cross-device).');
        return;
      }

      if (typeof prevSavePromo === 'function') return prevSavePromo();
    } catch(e){
      console.error(e);
      alert('Eroare la salvare promotie/giveaway (Rules/Auth). Vezi regulile Firestore.');
    }
  };

  // delete promo/giveaway
  window.deletePromo = async function(promoId){
    try{
      if (!window.__SBYT_ADMIN){
        alert('Actiune permisa doar administratorului. Autentifica-te.');
        return;
      }
      if (!confirm('Stergi acest giveaway/promotie?')) return;
      if (hasFirestore()){
        await deletePromoFS(promoId);
        renderLeaderboardPerPromo();
        if (window.renderPromos) window.renderPromos();
        return;
      }
      // fallback legacy
      if (window.deletePromoLocal) return window.deletePromoLocal(promoId);
    }catch(e){
      console.error(e);
      alert('Eroare la stergere (Rules).');
    }
  };

  // ---------- Admin panel (hidden) ----------
  function injectAdminPanel(){
    // add at bottom of presentation if not exists
    if (document.getElementById('adminPanel')) return;
    const pres = document.querySelector('#presentation, section[data-page="presentation"], section#prezentare');
    if (!pres) return;

    const wrap = document.createElement('section');
    wrap.id = 'adminPanel';
    wrap.className = 'admin-login';
    wrap.innerHTML = `
      <h2>üîê Administrator</h2>
      <p class="admin-desc">Autentificare Firebase (Email/Parola) pentru administrare (membri, anunturi, noutati, giveaway, promotii).</p>

      <div class="admin-login-box">
        <input type="email" id="adminEmail" placeholder="Email (ex: stancubyt@gmail.com)" />
        <input type="password" id="adminPass" placeholder="Parola" />
        <button id="adminLoginBtn" type="button">Autentificare</button>
        <button id="adminLogoutBtn" type="button" style="display:none;">Delogare</button>
      </div>

      <div style="margin-top:10px;">
        <span id="adminBadge" style="font-weight:800;">Neautentificat</span>
        <span id="adminUserLabel" style="margin-left:10px; opacity:0.85;"></span>
      </div>
      <p id="adminLoginMsg" class="admin-msg"></p>

      <div class="admin-only" style="display:none; margin-top:18px;">
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button type="button" onclick="window.showTeamForm && window.showTeamForm()">üë• Adauga membru</button>
          <button type="button" onclick="window.showAnnouncementForm && window.showAnnouncementForm()">üì¢ Adauga anunt</button>
          <button type="button" onclick="window.showNewsForm && window.showNewsForm()">üì∞ Adauga noutate</button>
          <button type="button" onclick="window.showPromoForm && window.showPromoForm('giveaway')">üèÜ Adauga giveaway</button>
          <button type="button" onclick="window.showPromoForm && window.showPromoForm('promo')">üéÅ Adauga promotie</button>
        </div>
      </div>
      <div style="opacity:0.8; margin-top:10px; font-size:0.9rem;">
        Tip: pentru Etherscan live, seteaza cheia in browser: <code>localStorage.SBYT_ETHERSCAN_KEY = "CHEIA_TA"</code>
      </div>
    `;
    pres.appendChild(wrap);

    // hook buttons to existing auth functions if present
    const loginBtn = document.getElementById('adminLoginBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');
    if (loginBtn){
      loginBtn.addEventListener('click', async ()=>{
        try{
          if (!firebase?.auth) { alert('Firebase Auth nu este incarcat.'); return; }
          const email = (document.getElementById('adminEmail')?.value || '').trim();
          const pass = (document.getElementById('adminPass')?.value || '').trim();
          await firebase.auth().signInWithEmailAndPassword(email, pass);
        }catch(e){
          alert('Eroare autentificare: ' + (e?.message || e));
        }
      });
    }
    if (logoutBtn){
      logoutBtn.addEventListener('click', async ()=>{
        try{ await firebase.auth().signOut(); }catch(e){}
      });
    }

    // keep status updated
    try{
      firebase.auth().onAuthStateChanged(async (user)=>{
        let isAdmin = false;
        try{
          if (user){
            // whitelist fallback
            isAdmin = (user.email || '').toLowerCase() === 'stancubyt@gmail.com';
            // custom claim if exists
            const t = await user.getIdTokenResult(true);
            if (t?.claims?.admin === true) isAdmin = true;
          }
        }catch(e){}
        window.__SBYT_ADMIN = !!isAdmin;

        const badge = document.getElementById('adminBadge');
        const label = document.getElementById('adminUserLabel');
        const msg = document.getElementById('adminLoginMsg');
        const lo = document.getElementById('adminLogoutBtn');

        if (badge) badge.textContent = isAdmin ? 'Autentificat (Admin)' : 'Neautentificat';
        if (label) label.textContent = user ? `User: ${maskEmail(user.email||'')}` : '';
        if (lo) lo.style.display = user ? 'inline-block' : 'none';
        if (msg){
          msg.style.color = isAdmin ? '#00ff9c' : '#ff4d4d';
          msg.textContent = user ? (isAdmin ? 'Mod administrator activ.' : 'Autentificat, dar fara drepturi admin.') : 'Autentifica-te cu email + parola (Firebase).';
        }

        document.querySelectorAll('.admin-only').forEach(el=>{
          el.style.display = isAdmin ? 'block' : 'none';
        });
      });
    }catch(e){}
  }

  // ---------- Trophy icon replace ----------
  function patchAddGiveawayButton(){
    // Replace "adauga giveaway" text with trophy + SBYT logo if button exists
    const btns = Array.from(document.querySelectorAll('button, a, .btn')).filter(b => /adauga\s+gi?veaway/i.test((b.textContent||'').trim()));
    if (!btns.length) return;
    const logoUrl = (window.SBYT_LOGO_URL || 'https://i.ibb.co/Zzb6ZTG0/logo.png');
    btns.forEach(b=>{
      b.innerHTML = `üèÜ <img src="${logoUrl}" alt="SBYT" style="height:18px; width:18px; vertical-align:middle; margin:0 6px; border-radius:4px;">`;
      b.setAttribute('title','Adauga Giveaway');
    });
  }

  // ---------- Firestore rules help (comment in console) ----------
  function printRulesHint(){
    // Shows what you need to paste in Firestore Rules to fix "Rules" errors.
    console.log(`
SBYT Firestore Rules (exemplu) - seteaza admin doar pentru stancubyt@gmail.com:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null
        && request.auth.token.email == "stancubyt@gmail.com";
      // SAU: request.auth.token.admin == true (custom claim)
    }

    match /news/promos/{promoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      match /participants/{pid} {
        allow read: if true;
        allow create: if true; // inscriere publica
        allow delete, update: if isAdmin();
      }
    }

    match /team/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    match /announcements/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    match /news/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
    `);
  }

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    injectAdminPanel();
    patchQuickContact();
    patchAddGiveawayButton();
    printRulesHint();

    // leaderboard + stats live
    try{ renderLeaderboardPerPromo(); }catch(e){}
    try{ updateStatsFromEtherscan(); }catch(e){}
  });

})();
</script>


<script>
/* ============================
   STBYT PATCH v1 (2025-12-25)
   Fix: admin auth, Firestore collections (promos, stats), remove Ethplorer/CMC embeds, stable updates.
   ============================ */

(function(){
  const ADMIN_EMAIL = "stancubyt@gmail.com";
  const TOKEN_ADDR = "0x44Cf220399be798baeaE45fd7C4fF44623713833";
  const ETHERSCAN_PROXY = "https://us-central1-stancubyt-64c78.cloudfunctions.net/etherscanProxy";

  // helpers
  const $ = (id)=>document.getElementById(id);
  const now = ()=>Date.now();
  const rid = ()=> (now().toString(36)+Math.random().toString(36).slice(2,10)).toUpperCase();

  function maskEmail(email){
    email = String(email||"").trim();
    const [u,d] = email.split("@");
    if(!u || !d) return email;
    const u2 = u.length<=2 ? (u[0]||"*")+"*" : u.slice(0,2)+"***";
    const d2 = d.replace(/(^.).*?(\..+$)/, "$1***$2");
    return `${u2}@${d2}`;
  }

  // firebase globals (compatible with old code)
  const auth = ()=> (window.firebase?.auth ? window.firebase.auth() : null);
  const fs = ()=> (window.firebase?.firestore ? window.firebase.firestore() : null);

  // admin state
  window.__STBYT_IS_ADMIN__ = false;

  function setAdminUI(isAdmin){
    window.__STBYT_IS_ADMIN__ = !!isAdmin;
    document.querySelectorAll(".admin-only").forEach(el=>{
      el.style.display = isAdmin ? "" : "none";
    });
    const badge = $("adminStatusBadge");
    if(badge){
      badge.textContent = isAdmin ? "‚úÖ Autentificat (Admin)" : "üîí Neautentificat";
      badge.style.color = isAdmin ? "#00ff9c" : "#ffb84d";
    }
  }

  // override admin sign-in (fix invalid-email by validation)
  window.adminSignIn = async function(){
    try{
      const a = auth();
      if(!a) return alert("Firebase Auth nu este incarcat.");
      const emailRaw = ($("adminEmail")?.value || "").trim();
      const email = emailRaw.replace(/\s+/g,"");
      const pass = ($("adminPass")?.value || "");
      const msg = $("adminLoginMsg");

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if(!emailOk){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Email invalid. Scrie ex: stancubyt@gmail.com"; }
        return;
      }
      if(!pass){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Completeaza parola."; }
        return;
      }

      await a.signInWithEmailAndPassword(email, pass);
      if(msg){ msg.style.color="#00ff9c"; msg.textContent="Autentificare reusita."; }
    }catch(e){
      const msg = $("adminLoginMsg");
      if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Eroare autentificare: "+(e?.message||e); }
      console.error("adminSignIn error:", e);
    }
  };

  window.adminSignOut = async function(){
    try{
      const a = auth();
      if(!a) return;
      await a.signOut();
    }catch(e){
      console.error("adminSignOut:", e);
    }
  };

  // unified admin guard (NO local password)
  window.ensureAdminAuth = async function(){
    const a = auth();
    if(!a || !a.currentUser){
      alert("Trebuie sa fii logat ca admin (Firebase).");
      location.hash = "#prezentare";
      const el = $("admin-login"); if(el) el.scrollIntoView({behavior:"smooth"});
      return false;
    }
    const email = (a.currentUser.email||"").toLowerCase();
    if(email !== ADMIN_EMAIL.toLowerCase()){
      alert("Contul logat nu are drepturi de administrator.");
      return false;
    }
    return true;
  };

  // some older code calls verifyPassword()
  window.verifyPassword = function(){
    if(window.__STBYT_IS_ADMIN__) return true;
    alert("Trebuie sa fii logat ca admin (Firebase).");
    location.hash = "#prezentare";
    return false;
  };

  // ===== Firestore doc-based storage =====
  async function statsDocGet(id){
    const db = fs(); if(!db) throw new Error("Firestore not loaded");
    return await db.collection("stats").doc(id).get();
  }
  async function statsDocSet(id, data, merge=true){
    const db = fs(); if(!db) throw new Error("Firestore not loaded");
    return await db.collection("stats").doc(id).set(data, {merge});
  }
  function statsDocListen(id, onData){
    const db = fs(); if(!db) return ()=>{};
    return db.collection("stats").doc(id).onSnapshot(snap=>{
      onData(snap.exists ? snap.data() : {});
    }, err=>{
      console.error(id+" listen:", err);
      // don't crash UI
    });
  }

  // ===== NEWS (stats/news: {items:[...]}) =====
  function renderNewsFromDoc(docData){
    const items = Array.isArray(docData?.items) ? docData.items.slice() : [];
    // sort pinned then createdAt desc
    items.sort((a,b)=>{
      if(!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
      return Number(b.createdAt||0)-Number(a.createdAt||0);
    });
    // reuse existing renderer if exists
    if(typeof window.renderNews === "function"){
      window.renderNews(items.map(x=>({ _id:x.id, ...x, date:x.createdAt })));
      return;
    }
    const container = $("newsList") || $("newsContainer") || $("newsGrid");
    if(!container) return;
    container.innerHTML="";
    items.forEach(it=>{
      const div=document.createElement("div");
      div.className="news-item";
      div.innerHTML = `
        <h3>${(it.title||"")}</h3>
        <p>${(it.content||"")}</p>
        ${window.__STBYT_IS_ADMIN__ ? `<button class="news-btn" onclick="deleteNewsDoc('${it.id}')">üóëÔ∏è Sterge</button>`:""}
      `;
      container.appendChild(div);
    });
  }

  window.loadNews = function(){
    // start listener
    statsDocListen("news", data=>renderNewsFromDoc(data));
  };

  window.saveNews = async function(){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    const title = ($("newsTitle")?.value||"").trim();
    const content = ($("newsContent")?.value||"").trim();
    const type = ($("newsType")?.value||"update");
    const pinned = !!$("pinNews")?.checked;

    if(!title || !content){
      alert("Completeaza titlu si continut.");
      return;
    }

    const snap = await statsDocGet("news");
    const current = snap.exists && Array.isArray(snap.data().items) ? snap.data().items : [];
    const item = { id: rid(), title, content, type, pinned, createdAt: now() };
    current.push(item);
    await statsDocSet("news", { items: current }, true);
    // clear
    if($("newsTitle")) $("newsTitle").value="";
    if($("newsContent")) $("newsContent").value="";
    if($("pinNews")) $("pinNews").checked=false;
    alert("Stire/Noutate salvata.");
  };

  window.deleteNewsDoc = async function(id){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    if(!confirm("Stergi aceasta stire?")) return;
    const snap = await statsDocGet("news");
    const current = snap.exists && Array.isArray(snap.data().items) ? snap.data().items : [];
    const next = current.filter(x=>x.id!==id);
    await statsDocSet("news", { items: next }, true);
  };

  // ===== TEAM (stats/team: {members:[...]}) =====
  function renderTeamFromDoc(docData){
    const members = Array.isArray(docData?.members) ? docData.members.slice() : [];
    members.sort((a,b)=>Number(b.createdAt||0)-Number(a.createdAt||0));
    if(typeof window.renderTeam === "function"){
      window.renderTeam(members.map(m=>({ _id:m.id, ...m })));
      return;
    }
    const container = $("teamList") || $("teamContainer");
    if(!container) return;
    container.innerHTML="";
    members.forEach(m=>{
      const div=document.createElement("div");
      div.className="team-card";
      div.innerHTML = `
        <strong>${m.name||""}</strong> - ${m.role||""}<br/>
        <small>${m.joinDate||""}</small>
        ${window.__STBYT_IS_ADMIN__ ? `<div><button class="news-btn" onclick="deleteTeamMember('${m.id}')">üóëÔ∏è Sterge</button></div>`:""}
      `;
      container.appendChild(div);
    });
  }

  window.loadTeam = function(){
    statsDocListen("team", data=>renderTeamFromDoc(data));
  };

  window.saveTeamMember = async function(){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    const name = ($("teamName")?.value||"").trim();
    const role = ($("teamRole")?.value||"").trim();
    const joinDate = ($("teamJoinDate")?.value||"").trim();
    const avatar = ($("teamAvatar")?.value||"").trim();

    if(!name || !role || !joinDate){
      alert("Completeaza nume, functie si data inscrierii.");
      return;
    }
    const snap = await statsDocGet("team");
    const current = snap.exists && Array.isArray(snap.data().members) ? snap.data().members : [];
    current.push({ id: rid(), name, role, joinDate, avatar: avatar||null, createdAt: now() });
    await statsDocSet("team", { members: current }, true);

    if(typeof window.cancelTeamMember === "function") window.cancelTeamMember();
    alert("Membru salvat (vizibil pe orice device).");
  };

  window.deleteTeamMember = async function(id){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    if(!confirm("Stergi membrul?")) return;
    const snap = await statsDocGet("team");
    const current = snap.exists && Array.isArray(snap.data().members) ? snap.data().members : [];
    await statsDocSet("team", { members: current.filter(x=>x.id!==id) }, true);
  };

  // ===== VISITS (stats/visits: {count}) =====
  window.updateVisitCounter = async function(){
    const db = fs(); if(!db) return;
    const ref = db.collection("stats").doc("visits");
    try{
      const key = "stbyt_visit_"+new Date().toISOString().slice(0,10);
      if(!localStorage.getItem(key)){
        localStorage.setItem(key,"1");
        await db.runTransaction(async t=>{
          const snap = await t.get(ref);
          const c = snap.exists && typeof snap.data().count==="number" ? snap.data().count : 0;
          t.set(ref, {count: c+1}, {merge:true});
        });
      }
      ref.onSnapshot(s=>{
        const c = s.exists && typeof s.data().count==="number" ? s.data().count : 0;
        const el = $("visitsCounter") || $("visitCounter") || $("visitsCount");
        if(el) el.textContent = String(c);
      });
    }catch(e){
      console.error("visit counter:", e);
    }
  };

  // ===== PROMOS (collection promos) =====
  async function promoGetVal(...ids){
    for(const id of ids){
      const el=$(id);
      if(el && typeof el.value!=="undefined") return (el.value||"").trim();
    }
    return "";
  }

  window.savePromo = async function(){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    const db = fs(); if(!db) return alert("Firestore nu e incarcat.");

    const title = promoGetVal("promoTitle");
    const ends = promoGetVal("promoEnds","promoEndDate","promoEndDateTime");
    const desc = promoGetVal("promoDesc"); // optional
    const p1 = promoGetVal("promoPrize1","prize1","promoPrize");
    const p2 = promoGetVal("promoPrize2","prize2");
    const p3 = promoGetVal("promoPrize3","prize3");
    const p4 = promoGetVal("promoPrize4","prize4");

    if(!title || !ends){
      alert("Completeaza minim Titlu si Data expirarii.");
      return;
    }
    const endsAt = new Date(ends).getTime();
    if(!endsAt || Number.isNaN(endsAt)){
      alert("Data expirarii nu este valida.");
      return;
    }

    try{
      await db.collection("promos").add({
        title,
        desc: desc || "",
        endsAt,
        prizes: { p1: p1||"", p2: p2||"", p3: p3||"", p4: p4||"" },
        createdAt: now(),
        participants: [], // {emailMasked, code, referralCode}
        status: "active"
      });
      if(typeof window.cancelPromo === "function") window.cancelPromo();
      alert("Promotia/Giveaway a fost adaugata.");
    }catch(e){
      console.error("savePromo:", e);
      alert("Eroare la salvare (verifica Firestore Rules pentru promos).");
    }
  };

  window.deletePromoDoc = async function(docId){
    const ok = await window.ensureAdminAuth(); if(!ok) return;
    if(!confirm("Stergi aceasta promotie/giveaway?")) return;
    const db = fs(); if(!db) return;
    try{
      await db.collection("promos").doc(docId).delete();
    }catch(e){
      console.error("delete promo:", e);
      alert("Eroare la stergere (Rules).");
    }
  };

  function renderPromosSnapshot(items){
    // try use existing renderer
    if(typeof window.renderPromos === "function"){
      window.renderPromos(items);
      if(typeof window.renderLeaderboard === "function") window.renderLeaderboard();
      return;
    }
    const container = $("promosList") || $("promoList") || $("promosContainer");
    if(!container) return;
    container.innerHTML="";
    items.forEach(p=>{
      const div=document.createElement("div");
      div.className="promo-card";
      const prizes=p.prizes||{};
      div.innerHTML = `
        <h3>${p.title||""}</h3>
        <p>${p.desc||""}</p>
        <div><small>Expira: ${new Date(p.endsAt).toLocaleString()}</small></div>
        <div style="margin-top:8px;">
          <strong>Premii:</strong>
          <div>1: ${prizes.p1||"-"}</div>
          <div>2: ${prizes.p2||"-"}</div>
          <div>3: ${prizes.p3||"-"}</div>
          <div>4: ${prizes.p4||"-"}</div>
        </div>
        ${window.__STBYT_IS_ADMIN__ ? `<button class="news-btn" onclick="deletePromoDoc('${p._id}')">üóëÔ∏è Sterge</button>`:""}
      `;
      container.appendChild(div);
    });
  }

  async function listenPromos(){
    const db = fs(); if(!db) return;
    db.collection("promos").orderBy("createdAt","desc").limit(50).onSnapshot(snap=>{
      const items=[];
      snap.forEach(d=>items.push({_id:d.id, ...d.data()}));
      renderPromosSnapshot(items);
    }, err=>console.error("promos listen:", err));
  }

  // ===== Token stats via etherscanProxy =====
  async function etherscan(module, action, extra={}){
    const params = new URLSearchParams();
    params.set("module", module);
    params.set("action", action);
    if(extra.contractaddress) params.set("contractaddress", extra.contractaddress);
    if(extra.page) params.set("page", String(extra.page));
    if(extra.offset) params.set("offset", String(extra.offset));
    if(extra.sort) params.set("sort", String(extra.sort));
    const url = ETHERSCAN_PROXY + "?" + params.toString();
    const r = await fetch(url);
    if(!r.ok) throw new Error("EtherscanProxy HTTP "+r.status);
    return await r.json();
  }

  async function updateSupplyAndHolders(){
    try{
      const supplyResp = await etherscan("stats","tokensupply",{contractaddress:TOKEN_ADDR});
      const supplyRaw = supplyResp?.result;
      const supply = supplyRaw ? (Number(supplyRaw)/1e18) : null;
      const el = $("totalSupplyReal") || $("totalSupplyRealValue") || $("realTotalSupply");
      if(el && supply!=null) el.textContent = supply.toLocaleString("en-US",{maximumFractionDigits:0})+" SBYT";
    }catch(e){
      console.warn("supply:", e);
    }
    try{
      const holdersResp = await etherscan("stats","tokenholderlist",{contractaddress:TOKEN_ADDR,page:1,offset:1});
      const holders = holdersResp?.result?.length ? holdersResp.result[0]?.HolderCount : null;
      const el = $("holdersCount") || $("totalHolders");
      if(el && holders!=null) el.textContent = String(holders);
    }catch(e){
      // tokenholderlist sometimes not enabled; ignore
    }
  }

  // ETH price + simple chart
  let ethPriceHistory = [];
  async function pushEthPrice(point){
    ethPriceHistory.push(point);
    if(ethPriceHistory.length>60) ethPriceHistory.shift();
    // update DOM
    const priceEl = $("livePrice") || $("ethPrice") || $("priceNow");
    if(priceEl) priceEl.textContent = "$"+point.usd.toFixed(2);
    // if chart exists and there is a renderer
    if(typeof window.updateChartWithSeries === "function"){
      window.updateChartWithSeries(ethPriceHistory);
    }
  }

  async function updateEthPrice(){
    const r = await etherscan("stats","ethprice",{});
    const usd = Number(r?.result?.ethusd || r?.result?.ethusd || 0);
    if(usd>0) pushEthPrice({t:now(), usd});
  }

  window.updateLivePriceAndChart = async function(){
    try{
      await updateEthPrice();
    }catch(e){
      console.warn("Live price update error:", e);
    }
  };

  window.updateLivePriceAndStats = async function(){
    await window.updateLivePriceAndChart();
    await updateSupplyAndHolders();
  };

  // Disable Ethplorer usage (CORS/429)
  window.fetchEthplorerTokenInfo = async function(){ return null; };

  // ===== init =====
  function init(){
    const a = auth();
    if(a){
      a.onAuthStateChanged(u=>{
        const isAdmin = !!u && String(u.email||"").toLowerCase()===ADMIN_EMAIL.toLowerCase();
        setAdminUI(isAdmin);
      });
    }

    // start listeners
    window.loadNews();
    window.loadTeam();
    listenPromos();
    window.updateVisitCounter();

    // token updates
    updateSupplyAndHolders();
    window.updateLivePriceAndChart();
    setInterval(()=>window.updateLivePriceAndChart(), 60*1000);

    // remove/disable coinmarketcap frame if exists
    document.querySelectorAll("iframe").forEach(fr=>{
      const src = (fr.getAttribute("src")||"");
      if(src.includes("coinmarketcap.com") || src.includes("dex.coinmarketcap.com")) {
        fr.remove();
      }
    });
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>


<script>
/* =========================================================
   STBYT PROMO+GIVEAWAY PATCH (Firestore: stats/visits ONLY)
   - Respecta regulile tale actuale:
     match /news/{id} read:true write: auth!=null
     match /stats/visits read:true write:true
   - Promotiile, giveaway-urile, participantii si clasamentele
     se salveaza CROSS-DEVICE in: stats/visits (merge fields)
   - Media (foto/video) se incarca in Firebase Storage (admin only)
   ========================================================= */
(function(){
  // helpers
  const $ = (id)=>document.getElementById(id);
  const safe = (v)=>String(v ?? "");
  const now = ()=>Date.now();
  const rid = ()=> (now().toString(36)+Math.random().toString(36).slice(2,10)).toUpperCase();

  // Firebase handles
  const auth = ()=> (typeof firebase!=="undefined" && firebase.auth) ? firebase.auth() : null;
  const db   = ()=> (typeof firebase!=="undefined" && firebase.firestore) ? firebase.firestore() : null;
  const st   = ()=> (typeof firebase!=="undefined" && firebase.storage) ? firebase.storage() : null;

  const ADMIN_EMAIL = "stancubyt@gmail.com";
  const STATS_DOC_PATH = { col: "stats", doc: "visits" };

  function isAdminUser(u){
    const email = (u?.email || "").toLowerCase();
    return !!u && email === ADMIN_EMAIL.toLowerCase();
  }

  function setAdminUI(isAdmin, user){
    try{
      // badge + user label
      const badge = $("adminStatusBadge");
      const ulabel = $("adminUserLabel");
      const msg = $("adminLoginMsg");
      const logoutBtn = $("adminLogoutBtn");

      if (badge){
        badge.textContent = isAdmin ? "Autentificat" : "Neautentificat";
        badge.classList.toggle("admin-badge-off", !isAdmin);
        badge.classList.toggle("admin-badge-on", isAdmin);
      }
      if (ulabel){
        ulabel.textContent = user ? (" ‚Ä¢ " + user.email) : "";
      }
      if (logoutBtn){
        logoutBtn.style.display = user ? "inline-flex" : "none";
      }
      if (msg){
        msg.style.color = isAdmin ? "#00ff88" : (user ? "#ffcc00" : "#ff4d4d");
        msg.textContent = isAdmin ? "Administrator activ ‚úÖ" : (user ? "E»ôti logat, dar NU e»ôti admin." : "");
      }

      // admin-only blocks
      document.querySelectorAll(".admin-only").forEach(el=>{
        el.style.display = isAdmin ? "" : "none";
      });
      // in unele pagini aveai box separat:
      const promoAdmin = $("promoAdminBox") || $("promoAdmin") || $("promoForm");
      if (promoAdmin){
        // formularul sa fie ascuns by default, dar disponibil doar adminului
        if (!isAdmin){
          promoAdmin.style.display = "none";
        }
      }
    }catch(e){}
  }

  // override adminSignIn / adminSignOut exactly like file-ul functional
  window.adminSignIn = async function(){
    try{
      const a = auth();
      if(!a) return alert("Firebase Auth nu este incarcat.");
      const emailRaw = ($("adminEmail")?.value || "").trim();
      const email = emailRaw.replace(/\s+/g,"");
      const pass  = ($("adminPass")?.value || "");
      const msg = $("adminLoginMsg");

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if(!emailOk){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Email invalid. Scrie ex: stancubyt@gmail.com"; }
        return;
      }
      if(!pass){
        if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Completeaza parola."; }
        return;
      }
      await a.signInWithEmailAndPassword(email, pass);
      if(msg){ msg.style.color="#00ff88"; msg.textContent="Autentificare reusita."; }
    }catch(e){
      const msg = $("adminLoginMsg");
      if(msg){ msg.style.color="#ff4d4d"; msg.textContent="Eroare autentificare: "+(e?.message||e); }
      console.error("adminSignIn error:", e);
    }
  };

  window.adminSignOut = async function(){
    try{
      const a = auth();
      if(!a) return;
      await a.signOut();
    }catch(e){
      console.error("adminSignOut:", e);
    }
  };

  // unified admin guard (NO local password)
  window.ensureAdminAuth = async function(){
    const a = auth();
    if(!a || !a.currentUser){
      alert("Trebuie sa fii logat ca admin (Firebase).");
      const el = $("admin-login"); if(el) el.scrollIntoView({behavior:"smooth"});
      return false;
    }
    if(!isAdminUser(a.currentUser)){
      alert("Contul logat nu are drepturi de administrator.");
      return false;
    }
    return true;
  };

  // compat: unele butoane cheama verifyPassword()
  window.verifyPassword = function(){
    const a = auth();
    if(a && isAdminUser(a.currentUser)) return true;
    alert("Trebuie sa fii logat ca admin (Firebase).");
    return false;
  };

  // ---------- Storage upload (admin only) ----------
  async function uploadPromoMedia(promoId, file){
    const ok = await window.ensureAdminAuth();
    if (!ok) return null;
    const storage = st();
    if (!storage) { alert("Firebase Storage nu este incarcat."); return null; }

    const ext = (file.name || "file").split(".").pop();
    const path = `news/promos/${promoId}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;
    const ref = storage.ref().child(path);

    await ref.put(file);
    const url = await ref.getDownloadURL();
    const type = (file.type || "").startsWith("video/") ? "video" : "image";
    return { url, type, path, name: file.name || null, size: file.size || null };
  }

  // ---------- Firestore stats/visits storage ----------
  function statsRef(){
    const d = db();
    if(!d) return null;
    return d.collection(STATS_DOC_PATH.col).doc(STATS_DOC_PATH.doc);
  }

  async function readStats(){
    const ref = statsRef();
    if(!ref) return { promos: [], promoParticipants: {} };
    const snap = await ref.get();
    const data = snap.exists ? (snap.data() || {}) : {};
    return {
      promos: Array.isArray(data.promos) ? data.promos : [],
      promoParticipants: (data.promoParticipants && typeof data.promoParticipants === "object") ? data.promoParticipants : {},
      count: (typeof data.count === "number") ? data.count : undefined
    };
  }

  async function writeStatsMerge(partial){
    const ref = statsRef();
    if(!ref) throw new Error("Firestore not loaded");
    await ref.set(partial, { merge: true });
  }

  // ---------- PROMOS CRUD (saved in stats/visits) ----------
  async function savePromoToStats(promo){
    // admin only for create/update
    const ok = await window.ensureAdminAuth();
    if(!ok) return;

    const data = await readStats();
    const promos = data.promos.slice();

    const idx = promos.findIndex(p => String(p.id) === String(promo.id));
    if(idx >= 0) promos[idx] = { ...promos[idx], ...promo };
    else promos.push(promo);

    await writeStatsMerge({ promos });
  }

  async function deletePromoFromStats(promoId){
    const ok = await window.ensureAdminAuth();
    if(!ok) return;

    const data = await readStats();
    const promos = (data.promos || []).filter(p => String(p.id) !== String(promoId));
    const map = { ...(data.promoParticipants || {}) };
    delete map[String(promoId)];

    await writeStatsMerge({ promos, promoParticipants: map });
  }

  async function addParticipant(promoId, participant){
    const data = await readStats();
    const map = { ...(data.promoParticipants || {}) };
    const arr = Array.isArray(map[String(promoId)]) ? map[String(promoId)].slice() : [];
    arr.push(participant);
    map[String(promoId)] = arr;
    await writeStatsMerge({ promoParticipants: map });
  }

  // ---------- UI RENDER ----------
  function formatDate(ts){
    try{
      return new Date(ts).toLocaleString("ro-RO",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch(e){ return ""; }
  }

  function renderPromosUI(promos, participantsMap){
    const container = $("promoList") || $("promosList") || $("promosContainer");
    if(!container) return;

    // sort: active first, then newest
    const items = (promos || []).slice().sort((a,b)=>{
      const sa = (a.status||"active")==="active" ? 0 : 1;
      const sb = (b.status||"active")==="active" ? 0 : 1;
      if(sa!==sb) return sa-sb;
      return Number(b.createdAt||0) - Number(a.createdAt||0);
    });

    container.innerHTML = "";
    if(!items.length){
      container.innerHTML = '<div style="opacity:0.85;">Nu existƒÉ promo»õii / concursuri √ÆncƒÉ.</div>';
      return;
    }

    items.forEach(p=>{
      const pid = String(p.id);
      const endsAt = Number(p.endsAt||0);
      const isExpired = endsAt && Date.now() > endsAt;
      const media = p.media || null;

      const card = document.createElement("div");
      card.className = "promo-card";

      // admin actions
      const a = auth();
      const isAdmin = a && isAdminUser(a.currentUser);

      const adminBtns = isAdmin ? `
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="news-btn" onclick="window.__SBYT_EDIT_PROMO && window.__SBYT_EDIT_PROMO('${pid}')">‚úèÔ∏è EditeazƒÉ</button>
          <button class="news-btn" onclick="window.__SBYT_DELETE_PROMO && window.__SBYT_DELETE_PROMO('${pid}')">üóëÔ∏è »òterge</button>
        </div>
      ` : "";

      const joinCount = Array.isArray(participantsMap?.[pid]) ? participantsMap[pid].length : 0;

      const mediaHtml = media?.url ? (
        media.type === "video"
          ? `<video controls style="width:100%; border-radius:12px; margin-top:10px;"><source src="${media.url}"></video>`
          : `<img src="${media.url}" alt="promo" style="width:100%; border-radius:12px; margin-top:10px;"/>`
      ) : "";

      const prizes = p.prizes || {};
      const prizesHtml = [prizes.p1, prizes.p2, prizes.p3, prizes.p4].filter(Boolean).length
        ? `<div style="margin-top:10px; opacity:0.95;">
             <div style="font-weight:800; margin-bottom:6px;">üéÅ Premii</div>
             <ul style="margin-left:18px; opacity:0.9; line-height:1.5;">
               ${prizes.p1 ? `<li><b>Locul 1:</b> ${safe(prizes.p1)}</li>`:""}
               ${prizes.p2 ? `<li><b>Locul 2:</b> ${safe(prizes.p2)}</li>`:""}
               ${prizes.p3 ? `<li><b>Locul 3:</b> ${safe(prizes.p3)}</li>`:""}
               ${prizes.p4 ? `<li><b>Men»õiuni:</b> ${safe(prizes.p4)}</li>`:""}
             </ul>
           </div>`
        : "";

      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h3 style="margin:0;">${safe(p.title||"")}</h3>
          <div style="opacity:0.9; font-weight:700;">${(p.type||"promo")==="giveaway" ? "üèÜ Concurs" : "üéØ Promo»õie"}</div>
        </div>

        <div style="margin-top:8px; opacity:0.9; line-height:1.5;">${safe(p.desc||"")}</div>

        <div style="margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; opacity:0.9;">
          <div>‚è≥ ExpirƒÉ: <b>${endsAt ? formatDate(endsAt) : "-"}</b> ${isExpired ? "<span style='color:#ff4d4d;'> (expirat)</span>" : ""}</div>
          <div>üë• √énscri»ôi: <b>${joinCount}</b></div>
        </div>

        ${prizesHtml}
        ${mediaHtml}

        <div style="margin-top:14px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.10);">
          <div style="font-weight:800; margin-bottom:8px;">üìù √énscriere</div>
          <div class="form-row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <input id="joinName_${pid}" placeholder="Nume" style="flex:1; min-width:180px;" />
            <input id="joinEmail_${pid}" placeholder="Email" style="flex:1; min-width:200px;" />
            <input id="joinWallet_${pid}" placeholder="Wallet" style="flex:1; min-width:220px;" />
            <input id="joinReferral_${pid}" placeholder="Referal (op»õional)" style="flex:1; min-width:160px;" />
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="news-btn" onclick="window.joinPromo && window.joinPromo('${pid}')">‚úÖ √énscrie-te</button>
          </div>
          <small style="display:block; margin-top:8px; opacity:0.75;">
            Codul tƒÉu se genereazƒÉ automat. Referal acceptƒÉ doar coduri deja existente √Æn acea promo»õie.
          </small>
        </div>

        ${adminBtns}
      `;
      container.appendChild(card);
    });
  }

  function renderLeaderboards(promos, participantsMap){
    // In pagina ta ai deja un #leaderboard; aici afisam clasament per promo»õie
    const root = $("leaderboard");
    if(!root) return;

    const items = (promos || []).slice().sort((a,b)=>Number(b.createdAt||0)-Number(a.createdAt||0));
    if(!items.length){
      root.innerHTML = '<div style="opacity:0.85;">Nu existƒÉ clasamente √ÆncƒÉ.</div>';
      return;
    }

    // pentru fiecare promo: calculeaza scor = nr referali (cate inscrieri au pus codul lui)
    const html = items.map(p=>{
      const pid = String(p.id);
      const list = Array.isArray(participantsMap?.[pid]) ? participantsMap[pid].slice() : [];

      // map code->count referrals
      const codeCount = {};
      list.forEach(u=>{
        const ref = safe(u.referral||"").toUpperCase();
        if(ref) codeCount[ref] = (codeCount[ref]||0)+1;
      });

      // build rows with score
      const rows = list.map(u=>{
        const code = safe(u.code||"").toUpperCase();
        const score = code ? (codeCount[code]||0) : 0;
        return { ...u, _score: score, _code: code };
      }).sort((a,b)=> (b._score - a._score) || (Number(b.createdAt||0)-Number(a.createdAt||0)));

      const top = rows.slice(0, 50);

      const tableRows = top.map((u, idx)=>{
        const rank = idx+1;
        const cls = rank===1 ? "lb-top1" : (rank===2 ? "lb-top2" : (rank===3 ? "lb-top3" : ""));
        const email = safe(u.email||"");
        const maskedEmail = email.includes("@") ? (email.slice(0,2)+"***@"+email.split("@")[1]) : email;
        return `
          <tr class="${cls}">
            <td style="width:64px;"><b>#${rank}</b></td>
            <td>${safe(u.name||"")}</td>
            <td class="mono">${maskedEmail}</td>
            <td class="mono">${safe(u.wallet||"")}</td>
            <td class="mono"><b>${safe(u.code||"")}</b></td>
            <td><b>${u._score}</b></td>
          </tr>
        `;
      }).join("");

      return `
        <div class="data-visualization neon-glow" style="margin-top:16px;">
          <h3 style="margin:0 0 10px;">üèÜ Clasament: ${safe(p.title||"")}</h3>
          <div style="opacity:0.85; margin-bottom:10px;">
            Se sorteazƒÉ dupƒÉ <b>numƒÉrul de referali</b> (c√¢te √Ænscrieri au folosit codul tƒÉu).
          </div>
          <div class="table-responsive">
            <table class="lb-table">
              <thead>
                <tr>
                  <th>Loc</th>
                  <th>Nume</th>
                  <th>Email</th>
                  <th>Wallet</th>
                  <th>Cod</th>
                  <th>Referali</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows || `<tr><td colspan="6" style="opacity:0.8;">Nu existƒÉ participan»õi √ÆncƒÉ.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = html;
  }

  // ---------- Public join (saved in stats/visits) ----------
  function randCode(){
    return Math.random().toString(36).slice(2,6).toUpperCase() + "-" + Math.random().toString(36).slice(2,6).toUpperCase();
  }

  window.joinPromo = async function(promoId){
    try{
      const data = await readStats();
      const promos = data.promos || [];
      const p = promos.find(x => String(x.id) === String(promoId));
      if(!p){ alert("Promo»õia nu mai existƒÉ."); return; }

      if (p.endsAt && Date.now() > Number(p.endsAt)){
        alert("AceastƒÉ promo»õie/concurs este expirat(ƒÉ).");
        return;
      }

      const name = ( $("joinName_"+promoId)?.value || "" ).trim();
      const email = ( $("joinEmail_"+promoId)?.value || "" ).trim();
      const wallet = ( $("joinWallet_"+promoId)?.value || "" ).trim();
      const referral = ( $("joinReferral_"+promoId)?.value || "" ).trim().toUpperCase();

      if(!name || !email || !wallet){
        alert("CompleteazƒÉ nume, email »ôi wallet.");
        return;
      }

      const list = Array.isArray(data.promoParticipants?.[String(promoId)]) ? data.promoParticipants[String(promoId)] : [];

      // referral: accepta DOAR coduri existente
      if(referral){
        const exists = list.some(u => safe(u.code||"").toUpperCase() === referral);
        if(!exists){
          alert("Codul Referal nu este valid. Trebuie sƒÉ fie un cod generat anterior √Æn aceastƒÉ promo»õie.");
          return;
        }
      }

      const code = randCode();
      await addParticipant(String(promoId), {
        id: rid(),
        name, email, wallet,
        code,
        referral: referral || "",
        createdAt: Date.now()
      });

      // clear
      ["joinName_","joinEmail_","joinWallet_","joinReferral_"].forEach(pref=>{
        const el = $(pref+promoId); if(el) el.value="";
      });

      alert("√énscriere reu»ôitƒÉ ‚úÖ Codul tƒÉu: " + code);
    }catch(e){
      console.error(e);
      alert("Eroare la √Ænscriere (verificƒÉ conexiunea / Firestore).");
    }
  };

  // ---------- Admin: open promo form ----------
  window.showPromoForm = function(type){
    if(!window.verifyPassword()) return;
    const f = $("promoForm");
    if(f) f.style.display = "block";
    if($("promoType")) $("promoType").value = type || "promo";
  };

  window.cancelPromo = function(){
    const f = $("promoForm");
    if(f) f.style.display = "none";
    const ids = ["promoType","promoTitle","promoDesc","promoEndDate","promoStartDate","promoStart","promoEnd","promoEnds","promoPrize","promoPoints","promoPrize1","promoPrize2","promoPrize3","promoPrize4"];
    ids.forEach(id=>{ const el=$(id); if(el) el.value=""; });
    const media = $("promoMedia") || $("promoMediaInput");
    if(media) media.value = "";
    // remove edit state
    window.__SBYT_EDITING_PROMO_ID = null;
  };

  // Admin: edit helper
  window.__SBYT_EDIT_PROMO = async function(promoId){
    try{
      const ok = await window.ensureAdminAuth();
      if(!ok) return;
      const data = await readStats();
      const p = (data.promos||[]).find(x => String(x.id)===String(promoId));
      if(!p) return;

      window.__SBYT_EDITING_PROMO_ID = String(promoId);

      const f = $("promoForm");
      if(f) f.style.display="block";

      if($("promoType")) $("promoType").value = p.type || "promo";
      if($("promoTitle")) $("promoTitle").value = p.title || "";
      if($("promoDesc")) $("promoDesc").value = p.desc || "";
      // suport mai multe id-uri pentru data:
      if($("promoEndDate")) $("promoEndDate").value = p.endDate || "";
      if($("promoEnds")) {
        // dacƒÉ e datetime-local, convertim
        try{
          const d = new Date(Number(p.endsAt||0));
          const pad = (n)=>String(n).padStart(2,"0");
          const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
          $("promoEnds").value = v;
        }catch(e){}
      }
      // premii
      const pr = p.prizes||{};
      if($("promoPrize1")) $("promoPrize1").value = pr.p1 || "";
      if($("promoPrize2")) $("promoPrize2").value = pr.p2 || "";
      if($("promoPrize3")) $("promoPrize3").value = pr.p3 || "";
      if($("promoPrize4")) $("promoPrize4").value = pr.p4 || "";
    }catch(e){ console.error(e); }
  };

  window.__SBYT_DELETE_PROMO = async function(promoId){
    await deletePromoFromStats(String(promoId));
  };

  // ---------- Admin: save promo (create/update) ----------
  window.savePromo = async function(){
    try{
      const ok = await window.ensureAdminAuth();
      if(!ok) return;

      const type = ($("promoType")?.value || "promo").trim();
      const title = ($("promoTitle")?.value || "").trim();
      const desc  = ($("promoDesc")?.value || "").trim();

      // acceptam fie promoEnds datetime-local, fie promoEndDate text
      const dtLocal = ($("promoEnds")?.value || "").trim();
      const endDateText = ($("promoEndDate")?.value || "").trim();
      let endsAt = 0;

      if(dtLocal){
        const t = new Date(dtLocal).getTime();
        if(!isNaN(t)) endsAt = t;
      }else if(endDateText){
        const t = new Date(endDateText).getTime();
        if(!isNaN(t)) endsAt = t;
      }

      // premii (nou)
      const p1 = ($("promoPrize1")?.value || $("prize1")?.value || "").trim();
      const p2 = ($("promoPrize2")?.value || $("prize2")?.value || "").trim();
      const p3 = ($("promoPrize3")?.value || $("prize3")?.value || "").trim();
      const p4 = ($("promoPrize4")?.value || $("prize4")?.value || "").trim();

      if(!title){
        alert("CompleteazƒÉ titlul.");
        return;
      }
      if(!endsAt){
        alert("CompleteazƒÉ data de expirare.");
        return;
      }
      if(endsAt <= Date.now()){
        alert("Data expirƒÉrii trebuie sƒÉ fie √Æn viitor.");
        return;
      }

      const editingId = window.__SBYT_EDITING_PROMO_ID;
      const promoId = editingId || rid();

      // media upload optional
      const file = $("promoMedia")?.files?.[0] || $("promoMediaInput")?.files?.[0] || null;
      let media = null;
      if(file){
        media = await uploadPromoMedia(promoId, file);
      }else{
        // dacƒÉ editƒÉm, pƒÉstrƒÉm media existentƒÉ
        const data = await readStats();
        const old = (data.promos||[]).find(x => String(x.id)===String(promoId));
        if(old && old.media) media = old.media;
      }

      const promo = {
        id: promoId,
        type: (type === "giveaway") ? "giveaway" : "promo",
        title,
        desc: desc || "",
        endsAt,
        createdAt: now(),
        status: "active",
        prizes: { p1: p1||null, p2: p2||null, p3: p3||null, p4: p4||null },
        media: media || null
      };

      await savePromoToStats(promo);
      window.cancelPromo();
      alert("Salvat √Æn Firebase (cross-device) ‚úÖ");
    }catch(e){
      console.error(e);
      alert("Eroare la salvare promo»õie/concurs (verificƒÉ Auth/Storage).");
    }
  };

  // ---------- LIVE LISTEN (stats/visits) ----------
  let unsubStats = null;

  function startListen(){
    const ref = statsRef();
    if(!ref) return;
    if(unsubStats) { try{unsubStats();}catch(e){} unsubStats=null; }

    unsubStats = ref.onSnapshot((snap)=>{
      const d = snap.exists ? (snap.data() || {}) : {};
      const promos = Array.isArray(d.promos) ? d.promos : [];
      const map = (d.promoParticipants && typeof d.promoParticipants==="object") ? d.promoParticipants : {};

      // Render promos + leaderboards
      renderPromosUI(promos, map);
      renderLeaderboards(promos, map);
    }, (err)=>{
      console.error("stats/visits listen:", err);
    });
  }

  // Auth state
  document.addEventListener("DOMContentLoaded", ()=>{
    try{
      const a = auth();
      if(a){
        a.onAuthStateChanged((user)=>{
          const admin = isAdminUser(user);
          window.__STBYT_IS_ADMIN__ = admin;
          setAdminUI(admin, user);
        });
      }
      startListen();
    }catch(e){}
  });

})();
</script>


<script>
/* ============================================================
   PROMO/GIVEAWAY STORAGE COMPAT (NO RULES CHANGE)
   - Uses ONLY: /stats/visits (allowed write:true in your rules)
   - Keeps Firebase Auth + Storage upload like your working page
   - Data model stored inside stats/visits.promos map
   ============================================================ */

(function(){
  if (typeof firebase === 'undefined' || !firebase.firestore) return;

  const db = firebase.firestore();
  const auth = firebase.auth ? firebase.auth() : null;
  const storage = firebase.storage ? firebase.storage() : null;

  const VISITS_REF = db.collection('stats').doc('visits');

  // show only first 2 chars of referral codes
  window.maskRefCode = function(code){
    const s = String(code||'').trim();
    if (!s || s === '-') return '-';
    const a = s.slice(0,2);
    return a + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  };

  function isAdmin(){
    try { return !!window.__SBYT_ADMIN; } catch(e){ return false; }
  }

  // Load whole promo map
  async function loadAll(){
    const doc = await VISITS_REF.get();
    const data = doc.exists ? (doc.data()||{}) : {};
    const promos = data.promos || {};
    return { data, promos };
  }

  // Real-time listener to re-render promos & leaderboard
  let __promoRtUnsub = null;
  function startPromoRealtime(){
    if (__promoRtUnsub) { try{__promoRtUnsub();}catch(e){} __promoRtUnsub=null; }
    __promoRtUnsub = VISITS_REF.onSnapshot((snap)=>{
      const d = snap.exists ? (snap.data()||{}) : {};
      window.__PROMO_CACHE = d.promos || {};
      try{ if (typeof window.renderPromos === 'function') window.renderPromos(normalizePromos(window.__PROMO_CACHE)); }catch(e){}
      try{ if (typeof window.renderLeaderboard === 'function') window.renderLeaderboard(); }catch(e){}
    }, (err)=>{
      console.error("Promo realtime error:", err);
    });
  }

  function normalizePromos(map){
    const arr = Object.entries(map||{}).map(([id, p])=>({ _id:id, id, ...(p||{}) }));
    // sort by createdAt desc
    arr.sort((a,b)=> (Number(b.createdAt||0) - Number(a.createdAt||0)));
    return arr;
  }

  // Upload media to Storage (same style as your working file)
  async function uploadPromoMedia(promoId, file){
    if (!storage) return null;
    if (!auth || !auth.currentUser) throw new Error("Not authenticated for storage");

    const safeName = (file.name || 'media').replace(/[^\w.\-]+/g,'_').slice(0,80);
    const path = `news/promos/${promoId}/${Date.now()}_${safeName}`;
    const ref = storage.ref().child(path);

    const snap = await ref.put(file, { contentType: file.type || undefined });
    const url = await snap.ref.getDownloadURL();

    return { url, path, contentType: file.type || null, name: file.name || null };
  }

  // Override savePromo to write inside stats/visits.promos
  window.savePromo = async function(){
    try{
      if (!isAdmin()){
        alert('Actiune permisa doar administratorului. Autentifica-te.');
        return;
      }
      if (!auth || !auth.currentUser){
        alert('Trebuie sa fii autentificat (Firebase Auth).');
        return;
      }

      const title = (document.getElementById('promoTitle')?.value || '').trim();
      const prize = (document.getElementById('promoPrize')?.value || '').trim();
      const desc  = (document.getElementById('promoDesc')?.value || '').trim();
      const ends  = (document.getElementById('promoEnds')?.value || '').trim(); // datetime-local
      const points = parseInt(document.getElementById('promoPoints')?.value || '10', 10) || 10;
      const type = (document.getElementById('promoType')?.value || 'promo').trim(); // optional
      const file = document.getElementById('promoMedia')?.files?.[0] || null;

      if (!title || !ends || !desc){
        alert('Completeaza titlul, data si descrierea.');
        return;
      }
      const endsAt = new Date(ends).getTime();
      if (!endsAt || endsAt <= Date.now()){
        alert('Data expirarii trebuie sa fie in viitor.');
        return;
      }

      const promoId = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);

      // create promo
      const promoObj = {
        type: type || 'promo',
        title,
        prize: prize || null,
        desc,
        endsAt,
        pointsPerPromotion: points,
        createdAt: Date.now(),
        createdBy: auth.currentUser.email || null,
        media: null,
        participants: {} // pid -> participant
      };

      await VISITS_REF.set({
        promos: { [promoId]: promoObj }
      }, { merge:true });

      // upload media
      if (file){
        const media = await uploadPromoMedia(promoId, file);
        await VISITS_REF.set({ promos: { [promoId]: { media } } }, { merge:true });
      }

      if (typeof window.cancelPromo === 'function') window.cancelPromo();
      alert('Promotie/concurs adaugat!');
    }catch(e){
      console.error("savePromo (stats/visits) error:", e);
      const msg = String(e && e.message ? e.message : e);
      alert('Eroare la salvare promotie/concurs: ' + msg);
    }
  };

  // Override deletePromo to remove promo from map
  window.deletePromo = async function(promoId){
    try{
      if (!isAdmin()){
        alert('Actiune permisa doar administratorului.');
        return;
      }
      if (!confirm('Stergi aceasta promotie/giveaway?')) return;

      // Firestore field delete needs dot path
      await VISITS_REF.update({ ['promos.' + promoId]: firebase.firestore.FieldValue.delete() });
    }catch(e){
      console.error("deletePromo error:", e);
      alert('Eroare la stergere: ' + (e?.message || e));
    }
  };

  // Override joinPromo: public (rules allow write:true on stats/visits)
  window.joinPromo = async function(promoId){
    try{
      const name = (document.getElementById('joinName_' + promoId)?.value || '').trim();
      const email = (document.getElementById('joinEmail_' + promoId)?.value || '').trim().toLowerCase();
      const wallet = (document.getElementById('joinWallet_' + promoId)?.value || '').trim();
      const referral = (document.getElementById('joinReferral_' + promoId)?.value || '').trim().toUpperCase();

      if (!name || !email || !wallet){
        alert('Completeaza nume, email si wallet.');
        return;
      }

      const { promos } = await loadAll();
      const p = promos[promoId];
      if (!p){ alert('Promotia nu mai exista.'); return; }

      // expiry check
      if (Number(p.endsAt||0) <= Date.now()){
        alert('Aceasta promotie/giveaway este expirata.');
        return;
      }

      const participants = p.participants || {};
      const existingCodes = new Set(Object.values(participants).map(x => String(x.code||'').toUpperCase()).filter(Boolean));

      if (referral){
        if (!existingCodes.has(referral)){
          alert('Codul Referal nu este valid. Trebuie sa fie un cod generat anterior.');
          return;
        }
      }

      const pid = email.replace(/[^\w.\-@]+/g, '_').slice(0,120);
      const prev = participants[pid] || null;

      // generate stable code for participant (keep old if exists)
      const code = prev?.code || (Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8) || ('SB'+Date.now().toString(36).toUpperCase().slice(-6)));

      const newObj = {
        name, email, wallet,
        code,
        referral: referral || '',
        points: prev?.points || 0,
        promotions: prev?.promotions || 0,
        createdAt: prev?.createdAt || Date.now(),
        updatedAt: Date.now()
      };

      // write participant into map
      await VISITS_REF.set({
        promos: { [promoId]: { participants: { [pid]: newObj } } }
      }, { merge:true });

      // clear inputs
      ['joinName_','joinEmail_','joinWallet_','joinReferral_'].forEach(pref=>{
        const el = document.getElementById(pref + promoId); if (el) el.value='';
      });

      alert('Inscriere reusita! Cod: ' + code);
    }catch(e){
      console.error("joinPromo error:", e);
      alert('Eroare inscriere: ' + (e?.message || e));
    }
  };

  // Override leaderboard renderer (referral ranking per promo)
  window.renderLeaderboard = function(){
    try{
      const lb = document.getElementById('leaderboard');
      if (!lb) return;

      const map = window.__PROMO_CACHE || {};
      const promos = normalizePromos(map);

      if (!promos.length){
        lb.innerHTML = '<div style="opacity:0.85;">Nu exista clasamente inca.</div>';
        return;
      }

      // sort by end date
      promos.sort((a,b)=> (Number(a.endsAt||0) - Number(b.endsAt||0)));

      let out = '';
      for (const p of promos){
        const title = p.title || 'Fara titlu';
        const type = p.type || 'promo';
        const endDate = p.endsAt ? new Date(Number(p.endsAt)).toLocaleString('ro-RO') : '-';
        const partObj = p.participants || {};
        const part = Object.values(partObj);

        // referral counts by code
        const counts = {};
        part.forEach(u=>{ counts[String(u.code||'').toUpperCase()] = 0; });
        part.forEach(u=>{
          const ref = String(u.referral||'').toUpperCase();
          if (ref && typeof counts[ref] === 'number') counts[ref] += 1;
        });

        const rows = part.map(u=>({
          email: u.email||'',
          code: u.code||'',
          referral: u.referral||'',
          points: counts[String(u.code||'').toUpperCase()] || 0
        })).sort((a,b)=> b.points - a.points);

        out += `<div class="data-visualization neon-glow" style="margin-top:1rem; padding:1rem;">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800; font-size:1.05rem;">${type === 'giveaway' ? 'üèÜ Giveaway' : 'üéÅ Promotie'}: ${escapeHtml(title)}</div>
              <div style="opacity:0.8; font-size:0.9rem;">Expira: <b>${escapeHtml(endDate)}</b></div>
            </div>
          </div>

          ${rows.length ? `
            <div class="table-container" style="margin-top:0.8rem;">
              <table class="whitepaper-table">
                <tr><th>#</th><th>Email</th><th>Cod</th><th>Referral folosit</th><th>Puncte</th></tr>
                ${rows.map((u, i)=>{
                  const cls = (i===0) ? 'style="background:rgba(255,215,0,0.15); font-weight:800;"'
                            : (i===1) ? 'style="background:rgba(192,192,192,0.12); font-weight:800;"'
                            : (i===2) ? 'style="background:rgba(205,127,50,0.12); font-weight:800;"'
                            : '';
                  return `<tr ${cls}>
                    <td>${i+1}</td>
                    <td>${escapeHtml(maskEmail(u.email||''))}</td>
                    <td><code>${escapeHtml(maskRefCode(u.code||''))}</code></td>
                    <td><code>${escapeHtml(maskRefCode((u.referral||'').trim() || '-'))}</code></td>
                    <td><b>${Number(u.points||0)}</b></td>
                  </tr>`;
                }).join('')}
              </table>
            </div>
          ` : `<div style="margin-top:0.8rem; opacity:0.85;">Nu exista participanti inca.</div>`}
        </div>`;
      }

      lb.innerHTML = out;
    }catch(e){
      console.error("renderLeaderboard override error:", e);
    }
  };

  // kick realtime
  startPromoRealtime();
})();
</script>
</body>
</html>

<script>
function updateLivePriceAndStats(){ return updateLivePriceAndChart(); }

// start cross-device promo sync
try{ startPromoSync(); }catch(e){ console.error(e); }
</script>

</body>
</html>
