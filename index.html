<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StancuBYT | Giveaway & PromoÈ›ii (Firestore)</title>

<style>
:root{
  --bg:#0a0a1f;
  --card:#14142b;
  --muted:#9aa0b4;
  --accent:#00ff88;
  --accent2:#00ffff;
  --danger:#ff4d4d;
  --gold: rgba(255,215,0,.18);
  --silver: rgba(192,192,192,.16);
  --bronze: rgba(205,127,50,.16);
}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg);color:#fff}
h1,h2,h3,h4{margin:0 0 10px}
p{margin:0 0 10px;color:rgba(255,255,255,.86)}
button{
  padding:10px 14px;border:none;border-radius:10px;cursor:pointer;
  background:var(--accent);font-weight:800;color:#001b12;
}
button.secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.12)}
button.danger{background:var(--danger);color:#fff}
input,textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
  background:#0f0f25;color:#fff;
}
textarea{min-height:90px;resize:vertical}
.section{max-width:1100px;margin:auto;padding:30px 20px}
.card{background:var(--card);padding:20px;border-radius:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,.08)}
.admin-only{display:none}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:18px}
.badge{
  display:inline-block;padding:4px 10px;border-radius:999px;
  background:rgba(0,255,136,.15);color:var(--accent);font-size:13px;font-weight:800;
  border:1px solid rgba(0,255,136,.18);
}
.badge.expired{background:rgba(255,77,77,.15);color:#ff7a7a;border-color:rgba(255,77,77,.22)}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0}
.table{width:100%;border-collapse:collapse;border-radius:14px;overflow:hidden}
.table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
.table th{background:rgba(255,255,255,.06);color:#fff}
.top1{background:var(--gold)}
.top2{background:var(--silver)}
.top3{background:var(--bronze)}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row > *{flex:1;min-width:180px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.err{color:#ff7a7a;font-weight:800}
.ok{color:#00ff88;font-weight:800}
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // CONFIG - din proiectul tÄƒu
  const firebaseConfig = {
    apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
    authDomain: "stancubyt-fc2b9.firebaseapp.com",
    projectId: "stancubyt-fc2b9",
    appId: "1:263244200492:web:28adf253b726cfdafaaf89"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  // âœ… Pune aici email-urile care au voie sÄƒ adauge/È™teargÄƒ promoÈ›ii
  const ADMIN_EMAILS = ["stancubyt@gmail.com"];
</script>
</head>

<body>

<div class="section">
  <h1>ğŸ Giveaway & PromoÈ›ii StancuBYT</h1>
  <p class="small">ğŸ”¥ Real-time (Firestore). PromoÈ›iile È™i clasamentele apar pe toate dispozitivele.</p>

  <div id="dbStatus" class="small"></div>

  <div class="actions" style="margin:14px 0 6px">
    <button class="admin-only" onclick="showPromoForm()">â• AdaugÄƒ promoÈ›ie / concurs</button>
    <button class="admin-only secondary" onclick="deleteAllPromosConfirm()">ğŸ§¹ È˜terge toate</button>
  </div>

  <!-- FORM ADMIN -->
  <div id="promoForm" class="card admin-only" style="display:none">
    <h3>AdaugÄƒ promoÈ›ie / concurs</h3>
    <div class="row">
      <input id="pTitle" placeholder="Titlu (ex: Giveaway SBYT)">
      <input type="date" id="pEnd">
    </div>
    <div class="row" style="margin-top:10px">
      <input id="pPrize" placeholder="Premiu (opÈ›ional)">
      <input id="pPointsDefault" type="number" min="0" step="1" value="10" placeholder="Puncte implicite">
    </div>
    <div style="margin-top:10px">
      <textarea id="pDesc" placeholder="Descriere / reguli"></textarea>
    </div>

    <div class="actions" style="margin-top:12px">
      <button onclick="savePromo()">ğŸ’¾ SalveazÄƒ Ã®n Firestore</button>
      <button class="danger" onclick="cancelPromo()">âŒ AnuleazÄƒ</button>
    </div>
    <div class="small" style="margin-top:10px">
      * Doar admin poate crea/È™terge promoÈ›ii. ParticipanÈ›ii se salveazÄƒ per promoÈ›ie.
    </div>
  </div>

  <!-- LISTA PROMO -->
  <div id="promoList" class="grid"></div>

  <!-- CLASAMENTE PE PROMOÈšII -->
  <div class="card">
    <h3>ğŸ† Clasamente pe promoÈ›ii</h3>
    <div class="small">Top participanÈ›i pentru fiecare promoÈ›ie (real-time).</div>
    <div id="allLeaderboards" style="margin-top:12px"></div>
  </div>
</div>

<!-- ADMIN LOGIN -->
<div class="section card">
  <h2>ğŸ” Administrator</h2>
  <div class="row">
    <input id="adminEmail" placeholder="Email admin" autocomplete="username">
    <input id="adminPass" type="password" placeholder="ParolÄƒ" autocomplete="current-password">
  </div>
  <div class="actions" style="margin-top:12px">
    <button onclick="adminSignIn()">Autentificare</button>
    <button onclick="adminSignOut()" id="logoutBtn" class="secondary" style="display:none">Delogare</button>
  </div>
  <p id="adminMsg" class="small" style="margin-top:10px"></p>
</div>

<script>
/* ===================== HELPERS ===================== */
function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
  }[s]));
}
function maskWallet(w){
  const s = String(w||"");
  if(s.length <= 12) return s;
  return s.slice(0,6) + "..." + s.slice(-4);
}
function isAdminUser(user){
  if(!user || !user.email) return false;
  return ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(user.email.toLowerCase());
}
function setDbStatus(ok, msg){
  const el = document.getElementById("dbStatus");
  if(!el) return;
  el.innerHTML = ok ? `<span class="ok">âœ” ${escapeHtml(msg)}</span>` : `<span class="err">âœ– ${escapeHtml(msg)}</span>`;
}

/* ===================== AUTH ===================== */
window.IS_ADMIN = false;

auth.onAuthStateChanged(user=>{
  const adminOk = isAdminUser(user);
  window.IS_ADMIN = !!adminOk;

  // show/hide admin elements
  document.querySelectorAll('.admin-only')
    .forEach(e=>e.style.display = adminOk ? 'block' : 'none');
  document.querySelectorAll('.actions .admin-only')
    .forEach(e=>e.style.display = adminOk ? 'inline-flex' : 'none');

  document.getElementById('logoutBtn').style.display = user ? 'inline-flex' : 'none';
  document.getElementById('adminMsg').textContent = user
    ? (adminOk ? `Logat admin: ${user.email}` : `Logat (NU admin): ${user.email}`)
    : 'Neautentificat';

  // Firestore read test
  setDbStatus(true, "Conectat. Ãncarc promoÈ›iile din Firestore...");
});

/* ===================== LOGIN ===================== */
function adminSignIn(){
  const email = adminEmail.value.trim();
  const pass = adminPass.value;
  if(!email || !pass){ alert("CompleteazÄƒ email È™i parolÄƒ"); return; }

  auth.signInWithEmailAndPassword(email, pass)
    .then(()=>{ adminPass.value = ""; })
    .catch(e=>alert("Autentificare eÈ™uatÄƒ: " + e.message));
}
function adminSignOut(){ auth.signOut(); }

/* ===================== ADMIN FORM ===================== */
function showPromoForm(){ promoForm.style.display="block"; }
function cancelPromo(){
  promoForm.style.display="none";
  pTitle.value=""; pEnd.value=""; pDesc.value=""; pPrize.value="";
  pPointsDefault.value = 10;
}

/* ===================== FIRESTORE STRUCTURA =====================

Collection: promos
  doc promoId:
    title, end (YYYY-MM-DD), desc, prize, pointsDefault, createdAt, createdBy

Subcollection: promos/{promoId}/participants
  doc participantId (walletLower):
    name, wallet, points, joinedAt

===================================================== */

async function savePromo(){
  if(!window.IS_ADMIN){ alert("Doar admin poate adÄƒuga."); return; }

  const title = (pTitle.value || "").trim();
  const end = (pEnd.value || "").trim();
  const desc = (pDesc.value || "").trim();
  const prize = (pPrize.value || "").trim();
  const pointsDefault = Math.max(0, parseInt(pPointsDefault.value || "0", 10) || 0);

  if(!title || !end || !desc){
    alert("CompleteazÄƒ titlu, data È™i descriere.");
    return;
  }

  try{
    await db.collection("promos").add({
      title, end, desc, prize,
      pointsDefault,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: auth.currentUser ? auth.currentUser.email : null
    });
    cancelPromo();
  }catch(e){
    console.error(e);
    alert("Eroare la salvare Ã®n Firestore: " + (e.message || e));
  }
}

async function deletePromo(promoId){
  if(!window.IS_ADMIN){ alert("Doar admin."); return; }
  if(!confirm("È˜tergi aceastÄƒ promoÈ›ie? (participanÈ›ii rÄƒmÃ¢n Ã®n subcolecÈ›ie dacÄƒ nu È™tergem din backend)")) return;

  try{
    await db.collection("promos").doc(promoId).delete();
  }catch(e){
    console.error(e);
    alert("Eroare la È™tergere: " + (e.message || e));
  }
}

async function deleteAllPromosConfirm(){
  if(!window.IS_ADMIN){ alert("Doar admin."); return; }
  if(!confirm("Sigur È™tergi TOATE promoÈ›iile?")) return;

  try{
    const snap = await db.collection("promos").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("PromoÈ›iile au fost È™terse (doar documentele promos).");
  }catch(e){
    console.error(e);
    alert("Eroare la È™tergere: " + (e.message || e));
  }
}

/* ===================== PARTICIPARE ===================== */
async function joinPromo(promoId){
  const name = (document.getElementById("jn_"+promoId).value || "").trim();
  const wallet = (document.getElementById("jw_"+promoId).value || "").trim();
  const ptsRaw = (document.getElementById("jp_"+promoId).value || "").trim();

  if(!name || !wallet){
    alert("CompleteazÄƒ nume È™i wallet.");
    return;
  }
  const walletLower = wallet.toLowerCase();

  try{
    const promoRef = db.collection("promos").doc(promoId);
    const promoDoc = await promoRef.get();
    if(!promoDoc.exists){
      alert("PromoÈ›ia nu mai existÄƒ.");
      return;
    }

    const promo = promoDoc.data();
    const expired = new Date() > new Date((promo.end || "") + "T23:59:59");
    if(expired){
      alert("AceastÄƒ promoÈ›ie este expiratÄƒ.");
      return;
    }

    const pointsDefault = Number(promo.pointsDefault || 0);
    const points = Math.max(0, parseInt(ptsRaw || String(pointsDefault), 10) || 0);

    const partRef = promoRef.collection("participants").doc(walletLower);

    // upsert participant
    await partRef.set({
      name,
      wallet,
      points,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    alert("Ãnscriere salvatÄƒ Ã®n Firestore âœ…");
  }catch(e){
    console.error(e);
    alert("Eroare Ã®nscriere (Firestore Rules?): " + (e.message || e));
  }
}

/* ===================== REAL-TIME RENDER ===================== */
const promoListEl = document.getElementById("promoList");
const allLBEl = document.getElementById("allLeaderboards");

const promoUnsubs = new Map(); // promoId -> unsubscribe participants
let promosUnsub = null;

function cleanupParticipantsListeners(){
  for (const [id, unsub] of promoUnsubs.entries()){
    try{ unsub(); }catch(e){}
  }
  promoUnsubs.clear();
}

function sortParticipantsLocal(arr){
  return [...arr].sort((a,b)=>{
    const pa = Number(a.points)||0;
    const pb = Number(b.points)||0;
    if(pb !== pa) return pb - pa;
    const ta = (a.joinedAtMs||0);
    const tb = (b.joinedAtMs||0);
    return ta - tb;
  });
}

function renderOnePromoCard(promoId, promoData){
  const expired = new Date() > new Date((promoData.end || "") + "T23:59:59");
  const title = escapeHtml(promoData.title || "");
  const desc  = escapeHtml(promoData.desc || "");
  const prize = promoData.prize ? escapeHtml(promoData.prize) : "";
  const pointsDefault = Number(promoData.pointsDefault || 0);

  const card = document.createElement("div");
  card.className = "card";
  card.setAttribute("data-promo-id", promoId);

  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
      <div>
        <span class="badge ${expired?'expired':''}">${expired?'Expirat':'Activ'}</span>
        <h3 style="margin-top:10px">${title}</h3>
        ${prize ? `<div class="small">ğŸ Premiu: <b>${prize}</b></div>` : ``}
        <div class="small">ğŸ“… ExpirÄƒ: ${promoData.end ? new Date(promoData.end).toLocaleDateString("ro-RO") : "-"}</div>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button class="admin-only danger" onclick="deletePromo('${promoId}')">ğŸ—‘ï¸ È˜terge</button>
      </div>
    </div>

    <p style="margin-top:10px">${desc}</p>

    <hr>

    <h4 style="margin-bottom:8px;color:var(--accent2)">Ãnscriere Ã®n aceastÄƒ promoÈ›ie</h4>
    <div class="row">
      <input id="jn_${promoId}" placeholder="Nume">
      <input id="jw_${promoId}" placeholder="Wallet (0x...)">
    </div>
    <div class="row" style="margin-top:10px">
      <input id="jp_${promoId}" type="number" min="0" step="1" placeholder="Puncte (ex: promovÄƒri)">
      <div class="small" style="align-self:center">
        DacÄƒ laÈ™i gol, puncte implicite: <b>${pointsDefault}</b>
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button onclick="joinPromo('${promoId}')">âœ… Ãnscrie-te</button>
    </div>

    <hr>

    <h4 style="color:var(--accent2)">ğŸ† Clasament pentru: ${title}</h4>
    <div id="lb_${promoId}" class="small">Se Ã®ncarcÄƒ...</div>
  `;

  // apply admin visibility
  card.querySelectorAll(".admin-only").forEach(btn=>{
    btn.style.display = window.IS_ADMIN ? "inline-flex" : "none";
  });

  return card;
}

function renderParticipantsLeaderboard(promoId, participants){
  const lbEl = document.getElementById("lb_"+promoId);
  if(!lbEl) return;

  const sorted = sortParticipantsLocal(participants);
  if(!sorted.length){
    lbEl.innerHTML = `<div class="small">ÃncÄƒ nu existÄƒ participanÈ›i.</div>`;
    return;
  }

  let rows = "";
  sorted.slice(0, 50).forEach((u,i)=>{
    const cls = i===0 ? "top1" : i===1 ? "top2" : i===2 ? "top3" : "";
    rows += `
      <tr class="${cls}">
        <td>${i+1}</td>
        <td>${escapeHtml(u.name || "Anonim")}</td>
        <td class="mono">${escapeHtml(maskWallet(u.wallet))}</td>
        <td>${Number(u.points||0).toLocaleString("ro-RO")}</td>
      </tr>`;
  });

  lbEl.innerHTML = `
    <table class="table">
      <tr><th>#</th><th>Nume</th><th>Wallet</th><th>Puncte</th></tr>
      ${rows}
    </table>`;
}

function renderAllLeaderboards(promosMap, participantsMap){
  // promosMap: promoId -> promoData
  // participantsMap: promoId -> participants[]
  allLBEl.innerHTML = "";

  const promoEntries = Array.from(promosMap.entries())
    .sort((a,b)=> new Date(a[1].end || "2100-01-01") - new Date(b[1].end || "2100-01-01"));

  if(!promoEntries.length){
    allLBEl.innerHTML = `<div class="small">Nu existÄƒ promoÈ›ii.</div>`;
    return;
  }

  for (const [promoId, promo] of promoEntries){
    const participants = participantsMap.get(promoId) || [];
    const sorted = sortParticipantsLocal(participants).slice(0, 10);

    let rows = "";
    if(!sorted.length){
      rows = `<tr><td colspan="4" class="small">FÄƒrÄƒ participanÈ›i.</td></tr>`;
    } else {
      sorted.forEach((u,i)=>{
        const cls = i===0 ? "top1" : i===1 ? "top2" : i===2 ? "top3" : "";
        rows += `
          <tr class="${cls}">
            <td>${i+1}</td>
            <td>${escapeHtml(u.name || "Anonim")}</td>
            <td class="mono">${escapeHtml(maskWallet(u.wallet))}</td>
            <td>${Number(u.points||0).toLocaleString("ro-RO")}</td>
          </tr>`;
      });
    }

    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <h4 style="margin-bottom:6px">${escapeHtml(promo.title || "")}</h4>
      <div class="small">ğŸ“… ${promo.end ? new Date(promo.end).toLocaleDateString("ro-RO") : "-"} â€¢ participanÈ›i: <b>${participants.length}</b></div>
      <div style="margin-top:10px">
        <table class="table">
          <tr><th>#</th><th>Nume</th><th>Wallet</th><th>Puncte</th></tr>
          ${rows}
        </table>
      </div>
    `;
    allLBEl.appendChild(wrap);
  }
}

function startRealtime(){
  // opreÈ™te vechiul listener
  if (promosUnsub) { try{ promosUnsub(); }catch(e){} }
  cleanupParticipantsListeners();

  const promosMap = new Map();        // promoId -> promoData
  const participantsMap = new Map();  // promoId -> participants[]

  promosUnsub = db.collection("promos")
    .orderBy("createdAt", "desc")
    .onSnapshot(snap=>{
      promoListEl.innerHTML = "";
      promosMap.clear();

      if(snap.empty){
        promoListEl.innerHTML = `<div class="card"><h3>Nu existÄƒ promoÈ›ii Ã®ncÄƒ.</h3><p class="small">Admin: autentificÄƒ-te È™i apasÄƒ â€AdaugÄƒ promoÈ›ieâ€.</p></div>`;
        allLBEl.innerHTML = `<div class="small">Nu existÄƒ promoÈ›ii.</div>`;
        setDbStatus(true, "Firestore OK. Nu existÄƒ promoÈ›ii Ã®ncÄƒ.");
        cleanupParticipantsListeners();
        return;
      }

      setDbStatus(true, "Firestore OK. PromoÈ›iile sunt sincronizate.");

      // refacem lista promoÈ›ii
      snap.forEach(doc=>{
        const promoId = doc.id;
        const promoData = doc.data() || {};
        promosMap.set(promoId, promoData);

        // card
        const card = renderOnePromoCard(promoId, promoData);
        promoListEl.appendChild(card);

        // subscribe la participanÈ›i (real-time)
        if(!promoUnsubs.has(promoId)){
          const unsub = db.collection("promos").doc(promoId)
            .collection("participants")
            .onSnapshot(psnap=>{
              const arr = [];
              psnap.forEach(pdoc=>{
                const d = pdoc.data() || {};
                arr.push({
                  name: d.name || "",
                  wallet: d.wallet || pdoc.id,
                  points: Number(d.points)||0,
                  joinedAtMs: d.joinedAt && d.joinedAt.toMillis ? d.joinedAt.toMillis() : 0
                });
              });
              participantsMap.set(promoId, arr);
              renderParticipantsLeaderboard(promoId, arr);
              renderAllLeaderboards(promosMap, participantsMap);
            }, err=>{
              console.error("participants onSnapshot error:", err);
            });

          promoUnsubs.set(promoId, unsub);
        }
      });

      renderAllLeaderboards(promosMap, participantsMap);
    }, err=>{
      console.error("promos onSnapshot error:", err);
      setDbStatus(false, "Eroare Firestore: " + (err.message || err));
    });
}

// start
startRealtime();
</script>

</body>
</html>

