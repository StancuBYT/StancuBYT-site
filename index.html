<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StancuBYT | Promo»õii & Concursuri</title>
  <style>

    :root{
      --blue-tech:#0066ff;
      --green-growth:#00ff88;
      --purple-innov:#8a2be2;
      --neon-cyan:#00ffff;
      --dark-bg:#0a0a1f;
      --darker-bg:#050510;
      --orange-alert:#ff9500;
      --danger:#ff4d4d;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family: Arial, sans-serif;}
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,102,255,0.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(0,255,136,0.14), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(138,43,226,0.12), transparent 60%),
        linear-gradient(180deg, var(--darker-bg), var(--dark-bg));
      color:#fff;
      padding: 26px 14px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:16px 16px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      position:sticky;top:12px;backdrop-filter: blur(8px);
      z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:40px;height:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
    .brand .t1{font-weight:900;letter-spacing:0.5px;}
    .brand .t2{font-size:12px;opacity:0.8;margin-top:2px;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,0.25);
      font-size:12px;opacity:0.92;
    }
    .chip b{font-weight:800;}
    .btn{
      cursor:pointer;border:none;
      padding:11px 14px;border-radius:12px;
      background:linear-gradient(45deg, var(--blue-tech), var(--green-growth));
      color:#001018;font-weight:900;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:hover{transform: translateY(-1px);filter:brightness(1.05);}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      border:1px solid var(--border);
      color:#fff;font-weight:800;
    }
    .btn.danger{
      background:rgba(255,77,77,0.14);
      border:1px solid rgba(255,77,77,0.35);
      color:#fff;
    }
    .hero{
      text-align:center;
      padding: 28px 10px 10px;
    }
    h1{
      font-size: 2.3rem;
      background: linear-gradient(45deg, var(--green-growth), var(--neon-cyan), var(--purple-innov));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle{opacity:0.85;line-height:1.5;max-width:860px;margin:0 auto;}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      margin-top: 18px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      padding:16px;
      overflow:hidden;
      position:relative;
    }
    .card.has-bg::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.80));
      z-index:0;
    }
    .card > *{position:relative;z-index:1;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;font-weight:900;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      margin-bottom:10px;
    }
    .badge.live{border-color:rgba(0,255,136,0.35);background:rgba(0,255,136,0.10);}
    .badge.dead{border-color:rgba(255,77,77,0.35);background:rgba(255,77,77,0.10);}
    .meta{display:flex;flex-wrap:wrap;gap:10px;opacity:0.9;margin-top:10px;font-size:13px;}
    .meta span{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid var(--border);}
    .kicker{font-weight:900;color:var(--neon-cyan);margin-bottom:8px;}
    .title{font-weight:950;font-size:1.2rem;margin-bottom:6px;}
    .text{opacity:0.9;line-height:1.5;white-space:pre-wrap;}
    .divider{height:1px;background:rgba(255,255,255,0.12);margin:12px 0;}
    .form{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,0.05);
      padding:16px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .row.one{grid-template-columns:1fr;}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#fff;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;}
    label{font-size:12px;opacity:0.85;}
    small.help{display:block;margin-top:8px;opacity:0.75;line-height:1.35;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .admin-login{
      margin-top: 20px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.28);
    }
    .admin-login h2{font-size:1.2rem;margin-bottom:8px;}
    .admin-desc{opacity:0.85;line-height:1.4;margin-bottom:10px;}
    .admin-login-box{display:flex;gap:10px;flex-wrap:wrap;}
    .admin-login-box input{flex:1;min-width:230px;}
    .admin-status-row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;}
    .admin-badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:12px;}
    .admin-badge-on{background:rgba(0,255,156,0.12);border-color:rgba(0,255,156,0.35);}
    .admin-badge-off{background:rgba(255,77,77,0.10);border-color:rgba(255,77,77,0.35);}
    .admin-user-label{opacity:0.85;font-size:12px;}
    .admin-msg{margin-top:10px;font-size:13px;}
    .admin-only{display:none;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      font-size:12px;opacity:0.9;
    }
    .img-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .img-strip img{height:44px;width:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border);opacity:0.95;}
    .rulebox{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,0.22);opacity:0.92;}
  

  /* === Extra layout fixes (standard cards + mobile) === */
  :root {
    --promo-card-h: 560px;
    --promo-media-h: 200px;
  }
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
    gap: 14px;
  }
  .promo-card {
    height: var(--cardH, var(--promo-card-h));
    display:flex;
    flex-direction:column;
    overflow:hidden;
    position:relative;
  }
  .promo-media {
    height: var(--mediaH, var(--promo-media-h));
    background: rgba(255,255,255,0.05);
    background-size: cover;
    background-position: center;
    position:relative;
    flex: 0 0 auto;
  }
  .promo-overlay {
    position:absolute;
    left: calc(var(--overlayX, 6) * 1%);
    top:  calc(var(--overlayY, 8) * 1%);
    transform: translate(0,0);
    max-width: calc(100% - 12%);
    padding: 8px 10px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.35);
    line-height: 1.15;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    white-space: pre-wrap;
    overflow-wrap:anywhere;
  }
  .promo-overlay[data-align="center"] { text-align:center; }
  .promo-overlay[data-align="right"] { text-align:right; }
  .promo-body {
    padding: 12px 12px 10px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    flex: 1 1 auto;
    min-height: 0; /* important for internal scroll */
  }
  .promo-desc {
    opacity: 0.92;
    font-size: 0.98rem;
    overflow:auto;
    padding-right: 4px;
  }
  .promo-meta {
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .promo-footer {
    padding: 10px 12px 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
    display:flex;
    flex-direction:column;
    gap: 10px;
    flex: 0 0 auto;
    background: rgba(0,0,0,0.12);
  }
  .join-row {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .join-row.one { grid-template-columns: 1fr; }
  .join-row input, .join-row button {
    width:100%;
  }
  .leaderboard-mini {
    max-height: 160px;
    overflow:auto;
    border-radius: 14px;
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 8px;
  }
  .leaderboard-mini table {
    width:100%;
    border-collapse: collapse;
    font-size: 0.92rem;
  }
  .leaderboard-mini th, .leaderboard-mini td {
    padding: 6px 6px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    text-align:left;
    vertical-align: top;
  }
  .leaderboard-mini tr:last-child td { border-bottom:none; }

  .admin-actions {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .admin-actions .btn {
    padding: 10px 12px;
    border-radius: 14px;
  }

  @media (max-width: 520px) {
    :root {
      --promo-card-h: 620px;
      --promo-media-h: 190px;
    }
    .join-row { grid-template-columns: 1fr; }
    .promo-overlay {
      left: calc(var(--overlayX, 6) * 1%);
      top: calc(var(--overlayY, 6) * 1%);
      max-width: calc(100% - 10%);
    }
  }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // Firebase init (preluat din "salvare stergere.html")
    window.firebaseConfig = {
      apiKey: "AIzaSyBPGUlNhohbVrfsIRcIfYAD5Fh7GMZlw2Q",
      authDomain: "stancubyt-fc2b9.firebaseapp.com",
      projectId: "stancubyt-fc2b9",
      storageBucket: "stancubyt-fc2b9.firebasestorage.app",
      messagingSenderId: "263244200492",
      appId: "1:263244200492:web:28adf253b726cfdafaaf89",
      measurementId: "G-272S9HSY3K"
    };
    try {
      if (typeof firebase !== "undefined" && firebase.apps && !firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
    } catch (e) {
      console.warn("Firebase init warning:", e);
    }
  </script>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">üéÅ Promo»õii & Concursuri ‚Äî StancuBYT</div>
      <div class="subtitle">Carduri standard, imagini redimensionate automat, text peste imagine + clasament √Æn fiecare card.</div>

      <div class="actions admin-only" style="justify-content:center; margin-top:14px; display:none;">
        <button class="btn" type="button" onclick="openPromoForm('promo')">‚ûï AdaugƒÉ Promo»õie</button>
        <button class="btn secondary" type="button" onclick="openPromoForm('giveaway')">üèÜ AdaugƒÉ Concurs / Giveaway</button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <span class="pill">üì± Mobile-first</span>
        <span class="pill">üñºÔ∏è Auto-resize imagini</span>
        <span class="pill">üèÜ Clasament per card</span>
      </div>
    </div>

    <div class="card">
      <div class="kicker">üìå Promo»õii / Giveaway-uri</div>
      <div id="promoList" class="grid"></div>

      <div id="promoForm" class="form admin-only" style="display:none;">
        <div class="kicker">‚ú® CreeazƒÉ promo»õie / concurs</div>

        <div class="row">
          <div>
            <label>Tip</label>
            <select id="promoKind">
              <option value="promo">üì£ Promo»õie</option>
              <option value="giveaway">üéÅ Concurs / Giveaway</option>
            </select>
          </div>
          <div>
            <label>Data & ora expirƒÉrii</label>
            <input id="promoEnds" type="datetime-local">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Titlu</label>
            <input id="promoTitle" type="text" maxlength="120" placeholder="Ex: Giveaway SBYT ‚Äî 7 zile + premii pe niveluri">
          </div>
          <div>
            <label>Puncte / ac»õiune (gamification)</label>
            <input id="promoPoints" type="number" min="1" step="1" value="10" placeholder="Ex: 10">
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Hook (1‚Äì2 fraze, mesaj scurt de impact)</label>
            <textarea id="promoHook" rows="2" placeholder="Ex: IntrƒÉ √Æn TOP 5 »ôi c√¢»ôtigƒÉ bonusuri! Fiecare share = +10 puncte."></textarea>
          </div>
        </div>

        <div class="row one">
          <div>
            <label>Descriere (beneficiu + cum func»õioneazƒÉ)</label>
            <textarea id="promoDesc" placeholder="Ex: ParticipƒÉ, str√¢nge puncte »ôi intrƒÉ √Æn clasament. La final, primele locuri primesc premii, iar participan»õii activi primesc bonusuri."></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kicker">üé® Vizual (banner + imagini de fundal)</div>
        <div class="row">
          <div>
            <label>Banner (recomandat)</label>
            <input id="promoBanner" type="file" accept="image/*">
          </div>
          <div>
            <label>Imagini fundal (max 3 recomandat)</label>
            <input id="promoBg" type="file" accept="image/*" multiple>
          </div>
        </div>
        <small class="help">SalveazƒÉ √Æn Firestore: <b>stats/visits</b> (c√¢mpuri <b>promos</b> + <b>participants</b>). Upload imagini √Æn Storage: <b>/news/**</b>.</small>

        <div class="divider"></div>

        <div class="kicker">üèÜ Premii (distribu»õie atractivƒÉ)</div>
        <div class="row">
          <div><label>Premiul I</label><input id="prize1" type="text" maxlength="180" placeholder="Ex: 10.000 SBYT + rol VIP"></div>
          <div><label>Premiul II</label><input id="prize2" type="text" maxlength="180" placeholder="Ex: 5.000 SBYT"></div>
        </div>
        <div class="row">
          <div><label>Premiul III</label><input id="prize3" type="text" maxlength="180" placeholder="Ex: 2.500 SBYT"></div>
          <div><label>Primele 5 locuri (dupƒÉ podium)</label><input id="prizeTop5" type="text" maxlength="180" placeholder="Ex: 500 SBYT fiecare"></div>
        </div>
        <div class="row">
          <div><label>UrmƒÉtoarele 10 locuri</label><input id="prizeNext10" type="text" maxlength="180" placeholder="Ex: 200 SBYT fiecare"></div>
          <div><label>Bonus participare / surprizƒÉ</label><input id="prizeBonus" type="text" maxlength="180" placeholder="Ex: 50 SBYT pentru cei cu min. 3 ac»õiuni"></div>
        </div>

        <div class="divider"></div>

        <div class="kicker">üìú Regulament & condi»õii</div>
        <div class="row one">
          <div>
            <label>Regulament (clar, pe pa»ôi)</label>
            <textarea id="promoRules" placeholder="Ex:
1) IntrƒÉ pe Telegram
2) UrmƒÉre»ôte Twitter
3) Trimite wallet-ul
4) Fiecare share = +10 puncte
NotƒÉ: o singurƒÉ √Ænscriere per wallet."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="promoSaveBtn" class="btn" type="button" onclick="savePromo()">üíæ SalveazƒÉ</button>
          <button class="btn secondary" type="button" onclick="cancelPromo()">‚ùå AnuleazƒÉ</button>
        </div>

        <small class="help">
          SalveazƒÉ √Æn Firestore: <b>promos</b> (»ôi subcolec»õie <b>participants</b>). Scrierea necesitƒÉ autentificare admin.
        </small>
      </div>
    </div>

    <div class="admin-login" id="admin-login">
      <h2>üîê Administrator Login</h2>
      <p class="admin-desc">
        Autentificare (Firebase Auth) necesarƒÉ pentru adƒÉugare/»ôtergere concursuri »ôi promo»õii.
        Pentru ca salvarea √Æn Firestore sƒÉ func»õioneze, contul logat trebuie sƒÉ fie permis de Firestore Rules (de obicei <b>stancubyt@gmail.com</b>).
      </p>

      <div class="admin-login-box">
        <input type="email" id="adminEmail" placeholder="Email administrator" autocomplete="username">
        <input type="password" id="adminPass" placeholder="Parola administrator" autocomplete="current-password">
        <button class="btn" type="button" onclick="adminSignIn()">Autentificare</button>
        <button class="btn secondary" type="button" onclick="adminSignOut()" id="adminLogoutBtn" style="display:none;">Delogare</button>
      </div>

      <div class="admin-status-row">
        <span id="adminStatusBadge" class="admin-badge admin-badge-off">Neautentificat</span>
        <span id="adminUserLabel" class="admin-user-label"></span>
      </div>

      <p id="adminLoginMsg" class="admin-msg"></p>
    </div>

    <div class="footer">
      <div class="footer-inner">
        <span style="opacity:.8;">¬© StancuBYT</span>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;','\\':'&#92;'}[ch]||ch));
  const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

  const ADMIN_EMAIL = "stancubyt@gmail.com";
  const auth = ()=> (window.firebase && firebase.auth) ? firebase.auth() : null;
  const fs = ()=> (window.firebase && firebase.firestore) ? firebase.firestore() : null;
  const st = ()=> (window.firebase && firebase.storage) ? firebase.storage() : null;

  // ===== State =====
  let __isAdmin = false;
  let __user = null;
  let __editingPromoId = null;
  let __statsUnsub = null;
  let __statsCache = { promos: [], participants: {} };

  // IMPORTANT: folosim stats/visits (conform rules trimise de tine)
  function statsRef(){
    const d = fs();
    if(!d) return null;
    return d.collection('stats').doc('visits');
  }

  function normalizeStats(data){
    const promos = Array.isArray(data?.promos) ? data.promos : [];
    const participants = (data?.participants && typeof data.participants === 'object') ? data.participants : {};
    return { promos, participants };
  }

  function setAdminUI(isAdmin, user){
    __isAdmin = !!isAdmin;
    __user = user || null;

    document.querySelectorAll('.admin-only').forEach(el=>{
      // preserve original display type if needed
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });

    const badge = $('adminStatusBadge');
    const label = $('adminUserLabel');
    const logoutBtn = $('adminLogoutBtn');
    if (badge) {
      badge.textContent = __isAdmin ? 'Autentificat' : 'Neautentificat';
      badge.className = __isAdmin ? 'admin-badge admin-badge-on' : 'admin-badge admin-badge-off';
    }
    if (label) label.textContent = __isAdmin && user ? user.email : '';
    if (logoutBtn) logoutBtn.style.display = __isAdmin ? 'inline-flex' : 'none';
  }

  async function computeIsAdmin(user){
    return !!(user && (user.email||'').toLowerCase() === ADMIN_EMAIL.toLowerCase());
  }

  // ===== Admin auth (same as your working files) =====
  window.adminSignIn = async function adminSignIn(){
    const a = auth();
    const msg = $('adminLoginMsg');
    if(!a) {
      if(msg) msg.textContent = 'Firebase Auth nu este disponibil.';
      return;
    }
    const email = ($('adminEmail')?.value||'').trim();
    const pass  = ($('adminPass')?.value||'').trim();
    if(!email || !pass) {
      if(msg) msg.textContent = 'CompleteazƒÉ email + parolƒÉ.';
      return;
    }
    try {
      await a.signInWithEmailAndPassword(email, pass);
      if(msg) msg.textContent = '';
    } catch(e) {
      console.error('adminSignIn:', e);
      if(msg) msg.textContent = 'Eroare autentificare. VerificƒÉ datele.';
    }
  };

  window.adminSignOut = async function adminSignOut(){
    const a = auth();
    if(!a) return;
    try { await a.signOut(); } catch(e) { console.warn(e); }
  };

  // ===== Promo form open/close =====
  window.openPromoForm = function openPromoForm(kind, promoId){
    const f = $('promoForm');
    if(!f) return;
    __editingPromoId = promoId || null;

    // reset
    f.style.display = 'block';
    $('promoSaveBtn')?.setAttribute('data-mode', promoId ? 'edit' : 'add');

    // set kind
    if ($('promoKind')) $('promoKind').value = kind || 'promo';

    // defaults
    if(!promoId){
      // clear fields
      ['promoEnds','promoTitle','promoPoints','promoHook','promoDesc','prize1','prize2','prize3','promoRules','cardHeight','mediaHeight','overlayText','overlayFontSize','overlayX','overlayY','overlayAlign','overlayColor'].forEach(id=>{ if($(id)) $(id).value=''; });
      if($('promoPoints')) $('promoPoints').value = 10;
      if($('cardHeight')) $('cardHeight').value = 560;
      if($('mediaHeight')) $('mediaHeight').value = 200;
      if($('overlayFontSize')) $('overlayFontSize').value = 22;
      if($('overlayX')) $('overlayX').value = 6;
      if($('overlayY')) $('overlayY').value = 8;
      if($('overlayAlign')) $('overlayAlign').value = 'left';
      if($('overlayColor')) $('overlayColor').value = '#ffffff';
      if($('promoBanner')) $('promoBanner').value = '';
      if($('promoBg')) $('promoBg').value = '';
      return;
    }

    // fill for edit
    const p = (__statsCache.promos || []).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    if($('promoKind')) $('promoKind').value = p.kind || kind || 'promo';
    if($('promoEnds')) $('promoEnds').value = p.ends || '';
    if($('promoTitle')) $('promoTitle').value = p.title || '';
    if($('promoPoints')) $('promoPoints').value = Number(p.points||10);
    if($('promoHook')) $('promoHook').value = p.hook || '';
    if($('promoDesc')) $('promoDesc').value = p.desc || '';
    if($('prize1')) $('prize1').value = (p.prizes && p.prizes.p1) ? p.prizes.p1 : '';
    if($('prize2')) $('prize2').value = (p.prizes && p.prizes.p2) ? p.prizes.p2 : '';
    if($('prize3')) $('prize3').value = (p.prizes && p.prizes.p3) ? p.prizes.p3 : '';
    if($('promoRules')) $('promoRules').value = p.rules || '';

    if($('cardHeight')) $('cardHeight').value = p.ui?.cardH ?? 560;
    if($('mediaHeight')) $('mediaHeight').value = p.ui?.mediaH ?? 200;
    if($('overlayText')) $('overlayText').value = p.ui?.overlay?.text ?? '';
    if($('overlayFontSize')) $('overlayFontSize').value = p.ui?.overlay?.size ?? 22;
    if($('overlayX')) $('overlayX').value = p.ui?.overlay?.x ?? 6;
    if($('overlayY')) $('overlayY').value = p.ui?.overlay?.y ?? 8;
    if($('overlayAlign')) $('overlayAlign').value = p.ui?.overlay?.align ?? 'left';
    if($('overlayColor')) $('overlayColor').value = p.ui?.overlay?.color ?? '#ffffff';

    // files remain empty unless replaced
    if($('promoBanner')) $('promoBanner').value = '';
    if($('promoBg')) $('promoBg').value = '';
  };

  window.cancelPromo = function cancelPromo(){
    const f = $('promoForm');
    if(f) f.style.display = 'none';
    __editingPromoId = null;
  };

  // ===== Image resize + upload =====
  async function resizeImageFile(file, opts={}){
    const maxW = Number(opts.maxW || 1600);
    const maxH = Number(opts.maxH || 1600);
    const quality = clamp(Number(opts.quality || 0.86), 0.4, 0.92);

    const bmp = await createImageBitmap(file);
    let w = bmp.width, h = bmp.height;
    const ratio = Math.min(maxW / w, maxH / h, 1);
    w = Math.round(w * ratio);
    h = Math.round(h * ratio);

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.drawImage(bmp, 0, 0, w, h);

    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    const name = (file.name || 'image').replace(/\.[^.]+$/, '') + '_resized.jpg';
    return new File([blob], name, { type: 'image/jpeg' });
  }

  async function uploadResizedImage(file, storagePath){
    const storage = st();
    if(!storage) throw new Error('Storage indisponibil');
    const ref = storage.ref().child(storagePath);
    const resized = await resizeImageFile(file, { maxW: 1600, maxH: 1600, quality: 0.86 });
    const snap = await ref.put(resized, { contentType: 'image/jpeg' });
    const url = await snap.ref.getDownloadURL();
    return { url, path: storagePath };
  }

  // ===== CRUD promos in stats/visits =====
  function makeId(prefix='p'){
    return prefix + '_' + Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(3);
  }

  async function readStatsOnce(){
    const ref = statsRef();
    if(!ref) return { promos: [], participants: {} };
    const doc = await ref.get();
    return normalizeStats(doc.exists ? doc.data() : {});
  }

  async function writeStats(next){
    const ref = statsRef();
    if(!ref) throw new Error('statsRef null');
    await ref.set(next, { merge: true });
  }

  window.savePromo = async function savePromo(){
    if(!__isAdmin) {
      alert('Trebuie sƒÉ fii logat ca admin.');
      return;
    }

    const kind = ($('promoKind')?.value || 'promo').trim();
    const ends = ($('promoEnds')?.value || '').trim();
    const title = ($('promoTitle')?.value || '').trim();
    const points = Number(($('promoPoints')?.value || '10'));
    const hook = ($('promoHook')?.value || '').trim();
    const desc = ($('promoDesc')?.value || '').trim();
    const rules = ($('promoRules')?.value || '').trim();

    // IMPORTANT: fara validari "fantoma" - verificam exact ce trebuie
    if(!title) return alert('CompleteazƒÉ: Titlu');
    if(!desc) return alert('CompleteazƒÉ: Descriere');
    if(!ends) return alert('CompleteazƒÉ: Data & ora expirƒÉrii');

    const ui = {
      cardH: clamp(Number($('cardHeight')?.value || 560), 360, 1200),
      mediaH: clamp(Number($('mediaHeight')?.value || 200), 120, 520),
      overlay: {
        text: ($('overlayText')?.value || '').trim(),
        size: clamp(Number($('overlayFontSize')?.value || 22), 10, 72),
        x: clamp(Number($('overlayX')?.value || 6), 0, 90),
        y: clamp(Number($('overlayY')?.value || 8), 0, 90),
        align: ($('overlayAlign')?.value || 'left'),
        color: ($('overlayColor')?.value || '#ffffff')
      }
    };

    const prizes = {
      p1: ($('prize1')?.value || '').trim(),
      p2: ($('prize2')?.value || '').trim(),
      p3: ($('prize3')?.value || '').trim()
    };

    const bannerFile = $('promoBanner')?.files?.[0] || null;
    const bgFiles = Array.from($('promoBg')?.files || []).slice(0, 3);

    try {
      const stats = await readStatsOnce();
      const promos = Array.isArray(stats.promos) ? stats.promos.slice() : [];
      const participants = (stats.participants && typeof stats.participants === 'object') ? stats.participants : {};

      const now = Date.now();
      const id = __editingPromoId || makeId(kind==='giveaway' ? 'g' : 'p');

      const idx = promos.findIndex(p => String(p.id) === String(id));
      const prev = idx >= 0 ? promos[idx] : null;

      let banner = prev?.banner || null;
      let bgs = Array.isArray(prev?.bgs) ? prev.bgs : [];

      // Upload in /news/** (respectƒÉ storage rules pe care le-ai trimis)
      // banner
      if (bannerFile) {
        const storagePath = `news/promos/${id}/banner_${Date.now()}_${bannerFile.name}`.replace(/\s+/g,'_');
        banner = await uploadResizedImage(bannerFile, storagePath);
      }
      // backgrounds
      if (bgFiles.length) {
        const uploads = [];
        for (const f of bgFiles) {
          const storagePath = `news/promos/${id}/bg_${Date.now()}_${f.name}`.replace(/\s+/g,'_');
          uploads.push(uploadResizedImage(f, storagePath));
        }
        bgs = await Promise.all(uploads);
      }

      const promoObj = {
        id,
        kind,
        ends,
        title,
        points: Number.isFinite(points) ? points : 10,
        hook,
        desc,
        rules,
        prizes,
        ui,
        banner,
        bgs,
        createdAt: prev?.createdAt || now,
        updatedAt: now
      };

      if (idx >= 0) promos[idx] = promoObj;
      else promos.unshift(promoObj);

      // ensure participants map key exists
      if (!participants[String(id)]) participants[String(id)] = participants[String(id)] || [];

      await writeStats({ promos, participants });
      __editingPromoId = null;
      cancelPromo();
      alert('Salvat ‚úîÔ∏è');
    } catch(e) {
      console.error('savePromo:', e);
      alert('Eroare la salvare (verificƒÉ Auth/Storage).');
    }
  };

  // ===== Delete / Edit promo =====
  window.editPromo = function editPromo(promoId){
    if(!__isAdmin) return;
    const p = (__statsCache.promos||[]).find(x=>String(x.id)===String(promoId));
    if(!p) return;
    openPromoForm(p.kind || 'promo', promoId);
    // scroll to form
    $('promoForm')?.scrollIntoView({ behavior:'smooth', block:'start' });
  };

  async function tryDeleteStorageFiles(promo){
    try {
      if(!__isAdmin) return;
      const storage = st();
      if(!storage) return;
      const paths = [];
      if(promo?.banner?.path) paths.push(promo.banner.path);
      if(Array.isArray(promo?.bgs)) promo.bgs.forEach(x=>x?.path && paths.push(x.path));
      for (const p of paths) {
        try { await storage.ref().child(p).delete(); } catch(e) { /* ignore */ }
      }
    } catch(e){}
  }

  window.deletePromo = async function deletePromo(promoId){
    if(!__isAdmin) return alert('Doar admin poate »ôterge.');
    if(!confirm('Sigur vrei sƒÉ »ôtergi aceastƒÉ promo»õie/concurs?')) return;

    try {
      const stats = await readStatsOnce();
      const promos = (stats.promos||[]).slice();
      const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};

      const idx = promos.findIndex(p=>String(p.id)===String(promoId));
      const promo = idx>=0 ? promos[idx] : null;
      if(idx>=0) promos.splice(idx,1);
      delete participants[String(promoId)];

      await writeStats({ promos, participants });
      await tryDeleteStorageFiles(promo);
    } catch(e) {
      console.error('deletePromo:', e);
      alert('Eroare la »ôtergere.');
    }
  };

  // ===== Participants / referral =====
  function maskEmail(em){
    const s = String(em||'');
    const at = s.indexOf('@');
    if(at<=1) return s ? (s[0] + '***') : '';
    const name = s.slice(0, at);
    const dom = s.slice(at);
    return name.slice(0,2) + '***' + dom;
  }
  function maskCode(code){
    const s = String(code||'');
    if(s.length<=2) return s;
    return s.slice(0,2) + '‚Ä¢'.repeat(Math.min(12, s.length-2));
  }
  function genCode(){
    return Math.random().toString(36).slice(2, 10).toUpperCase();
  }

  async function addParticipant(promoId, payload){
    const stats = await readStatsOnce();
    const participants = (stats.participants && typeof stats.participants==='object') ? stats.participants : {};
    const arr = Array.isArray(participants[String(promoId)]) ? participants[String(promoId)].slice() : [];

    // one per wallet
    const walletKey = String(payload.wallet||'').toLowerCase();
    if(walletKey && arr.some(x => String(x.wallet||'').toLowerCase() === walletKey)) {
      throw new Error('Acest wallet este deja √Ænscris.');
    }

    // one per email (optional)
    const emailKey = String(payload.email||'').toLowerCase();
    if(emailKey && arr.some(x => String(x.email||'').toLowerCase() === emailKey)) {
      throw new Error('Acest email este deja √Ænscris.');
    }

    const id = 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
    const code = genCode();
    const participant = {
      id,
      name: payload.name || 'Anonim',
      email: payload.email || '',
      wallet: payload.wallet || '',
      code,
      referral: (payload.referral||'').trim(),
      joinedAt: Date.now()
    };
    arr.push(participant);
    participants[String(promoId)] = arr;

    // keep promos intact
    await writeStats({ participants });
    return participant;
  }

  function buildLeaderboard(promoId){
    const arr = Array.isArray(__statsCache.participants?.[String(promoId)]) ? __statsCache.participants[String(promoId)] : [];
    if(!arr.length) {
      return `<div style="opacity:.85;">Nu existƒÉ participan»õi √ÆncƒÉ.</div>`;
    }

    // referral counts
    const counts = new Map();
    const codeToUser = new Map();
    arr.forEach(u=> {
      const c = String(u.code||'').trim().toUpperCase();
      if(c) codeToUser.set(c, u);
      counts.set(u.id, 0);
    });
    arr.forEach(u=> {
      const ref = String(u.referral||'').trim().toUpperCase();
      if(!ref) return;
      const owner = codeToUser.get(ref);
      if(owner && owner.id !== u.id) {
        counts.set(owner.id, (counts.get(owner.id)||0) + 1);
      }
    });

    const rows = arr.map(u=> {
      const referrals = counts.get(u.id)||0;
      return {
        name: u.name||'Anonim',
        email: u.email||'',
        wallet: u.wallet||'',
        code: u.code||'',
        referrals,
        joinedAt: Number(u.joinedAt||0)
      };
    }).sort((a,b)=> b.referrals - a.referrals || a.joinedAt - b.joinedAt);

    let html = `<table>
      <tr><th>#</th><th>Nume</th><th>Email</th><th>Cod</th><th>InvitƒÉri</th></tr>`;
    rows.slice(0, 20).forEach((r,i)=> {
      const top = i===0 ? 'style="font-weight:800;"' : '';
      html += `<tr ${top}>
        <td>${i+1}</td>
        <td>${esc(r.name)}</td>
        <td>${esc(maskEmail(r.email))}</td>
        <td style="font-family:monospace;">${esc(maskCode(r.code))}</td>
        <td><span class="pill">${r.referrals}</span></td>
      </tr>`;
    });
    html += `</table>`;
    return html;
  }

  // ===== Render promos =====
  function formatEnds(ends){
    if(!ends) return '';
    try {
      const d = new Date(ends);
      if(Number.isNaN(d.getTime())) return ends;
      return d.toLocaleString('ro-RO');
    } catch { return ends; }
  }

  function pickMediaUrl(p){
    return p?.banner?.url || (Array.isArray(p?.bgs) && p.bgs[0]?.url) || '';
  }

  function renderPromos(){
    const list = $('promoList');
    if(!list) return;
    const promos = Array.isArray(__statsCache.promos) ? __statsCache.promos : [];
    list.innerHTML = '';

    if(!promos.length){
      list.innerHTML = `<div style="opacity:.85; padding:10px;">Nu existƒÉ promo»õii/concursuri √ÆncƒÉ.</div>`;
      return;
    }

    promos.forEach(p=> {
      const mediaUrl = pickMediaUrl(p);
      const ui = p.ui || {};
      const cardH = clamp(Number(ui.cardH ?? 560), 360, 1200);
      const mediaH = clamp(Number(ui.mediaH ?? 200), 120, 520);
      const overlay = ui.overlay || {};
      const overlayText = (overlay.text||'').trim();
      const overlaySize = clamp(Number(overlay.size ?? 22), 10, 72);
      const overlayX = clamp(Number(overlay.x ?? 6), 0, 90);
      const overlayY = clamp(Number(overlay.y ?? 8), 0, 90);
      const overlayAlign = (overlay.align || 'left');
      const overlayColor = (overlay.color || '#ffffff');

      const prizes = [];
      if(p.prizes?.p1) prizes.push('ü•á ' + p.prizes.p1);
      if(p.prizes?.p2) prizes.push('ü•à ' + p.prizes.p2);
      if(p.prizes?.p3) prizes.push('ü•â ' + p.prizes.p3);

      const wrap = document.createElement('div');
      wrap.className = 'card promo-card';
      wrap.style.setProperty('--cardH', cardH + 'px');
      wrap.style.setProperty('--mediaH', mediaH + 'px');
      wrap.innerHTML = `
        <div class="promo-media" style="${mediaUrl ? `background-image:url('${esc(mediaUrl)}')` : ''}">
          ${overlayText ? `
            <div class="promo-overlay" data-align="${esc(overlayAlign)}" style="color:${esc(overlayColor)}; font-size:${overlaySize}px; --overlayX:${overlayX}; --overlayY:${overlayY};">
              ${esc(overlayText)}
            </div>` : ''}
        </div>

        <div class="promo-body">
          <div class="promo-meta">
            <span class="pill">${p.kind==='giveaway' ? 'üéÅ Giveaway' : 'üì£ Promo»õie'}</span>
            <span class="pill">‚è≥ ${esc(formatEnds(p.ends))}</span>
            <span class="pill">‚≠ê +${Number(p.points||10)} puncte</span>
          </div>

          <div style="font-weight:800; font-size:1.05rem;">${esc(p.title||'')}</div>
          ${p.hook ? `<div style="opacity:.95; font-weight:700;">${esc(p.hook)}</div>` : ''}
          <div class="promo-desc">${esc(p.desc||'')}</div>

          ${prizes.length ? `<div class="divider"></div><div style="white-space:pre-wrap;">${esc(prizes.join('\n'))}</div>` : ''}

          ${p.rules ? `<div class="divider"></div><div style="white-space:pre-wrap; opacity:.92;"><b>Reguli:</b>\n${esc(p.rules)}</div>` : ''}

          <div class="admin-actions admin-only" style="display:none;">
            <button class="btn secondary" type="button" onclick="editPromo('${esc(p.id)}')">‚úèÔ∏è EditeazƒÉ</button>
            <button class="btn" type="button" onclick="deletePromo('${esc(p.id)}')">üóëÔ∏è »òterge</button>
          </div>
        </div>

        <div class="promo-footer">
          <div style="font-weight:800;">√énscriere</div>
          <div class="join-row">
            <input id="name_${esc(p.id)}" placeholder="Nume">
            <input id="email_${esc(p.id)}" placeholder="Email">
          </div>
          <div class="join-row">
            <input id="wallet_${esc(p.id)}" placeholder="Wallet (op»õional)">
            <input id="ref_${esc(p.id)}" placeholder="Referral (op»õional)">
          </div>
          <div class="join-row one">
            <button class="btn" type="button" onclick="joinPromo('${esc(p.id)}')">‚úÖ √énscrie-mƒÉ</button>
          </div>

          <div style="font-weight:800;">üèÜ Clasament</div>
          <div class="leaderboard-mini" id="lb_${esc(p.id)}">${buildLeaderboard(p.id)}</div>
        </div>
      `;

      list.appendChild(wrap);
    });

    // reapply admin-only after render
    document.querySelectorAll('.admin-only').forEach(el=>{
      const d = el.dataset && el.dataset.adminDisplay ? el.dataset.adminDisplay : (el.classList.contains('actions') ? 'flex' : 'block');
      el.style.display = __isAdmin ? d : 'none';
    });
  }

  window.joinPromo = async function joinPromo(promoId){
    const name = ($(`name_${promoId}`)?.value || '').trim();
    const email = ($(`email_${promoId}`)?.value || '').trim();
    const wallet = ($(`wallet_${promoId}`)?.value || '').trim();
    const referral = ($(`ref_${promoId}`)?.value || '').trim();

    if(!name) return alert('CompleteazƒÉ numele.');
    if(!email) return alert('CompleteazƒÉ email.');

    try {
      const u = await addParticipant(promoId, { name, email, wallet, referral });
      // clear inputs
      $(`name_${promoId}`).value = '';
      $(`email_${promoId}`).value = '';
      $(`wallet_${promoId}`).value = '';
      $(`ref_${promoId}`).value = '';

      alert(`√énscriere reu»ôitƒÉ!\nCodul tƒÉu: ${u.code}`);
    } catch(e) {
      console.error('joinPromo:', e);
      alert(e?.message || 'Eroare la √Ænscriere.');
    }
  };

  // ===== Stats listener =====
  function startStatsListener(){
    const ref = statsRef();
    if(!ref) return;

    if(__statsUnsub) { try{__statsUnsub();}catch(e){} __statsUnsub=null; }

    __statsUnsub = ref.onSnapshot(snap=>{
      const data = snap.exists ? snap.data() : {};
      __statsCache = normalizeStats(data);
      renderPromos();
    }, err=>{
      console.warn('stats onSnapshot error:', err);
      // fallback one-time read
      readStatsOnce().then(x=>{ __statsCache=x; renderPromos(); }).catch(()=>{});
    });
  }

  // ===== Inject the extra form fields into the existing promoForm (from adaugare.html) =====
  function injectExtraFields(){
    const form = $('promoForm');
    if(!form) return;

    // prevent double insert
    if ($('cardHeight')) return;

    const divider = document.createElement('div');
    divider.className = 'divider';

    const block = document.createElement('div');
    block.innerHTML = `
      <div class="divider"></div>
      <div class="kicker">üìê Dimensiuni card & text peste imagine</div>

      <div class="row">
        <div>
          <label>√énƒÉl»õime card (px)</label>
          <input id="cardHeight" type="number" min="360" max="1200" step="10" value="560" placeholder="Ex: 560">
        </div>
        <div>
          <label>√énƒÉl»õime imagine (px)</label>
          <input id="mediaHeight" type="number" min="120" max="520" step="10" value="200" placeholder="Ex: 200">
        </div>
      </div>

      <div class="row one">
        <div>
          <label>Text peste imagine (op»õional)</label>
          <textarea id="overlayText" rows="2" placeholder="Ex: üî• Ultimele 48h ‚Äî IntrƒÉ √Æn TOP 5!"></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>MƒÉrime font (px)</label>
          <input id="overlayFontSize" type="number" min="10" max="72" step="1" value="22">
        </div>
        <div>
          <label>Culoare text</label>
          <input id="overlayColor" type="color" value="#ffffff">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Pozi»õie X (0-90%)</label>
          <input id="overlayX" type="number" min="0" max="90" step="1" value="6">
        </div>
        <div>
          <label>Pozi»õie Y (0-90%)</label>
          <input id="overlayY" type="number" min="0" max="90" step="1" value="8">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Aliniere</label>
          <select id="overlayAlign">
            <option value="left">St√¢nga</option>
            <option value="center">Centru</option>
            <option value="right">Dreapta</option>
          </select>
        </div>
        <div>
          <label>Preview rapid</label>
          <button class="btn secondary" type="button" onclick="previewOverlay()">üëÅÔ∏è Preview</button>
        </div>
      </div>
    `;

    // insert BEFORE the final action buttons
    const actions = form.querySelector('.actions');
    if(actions) form.insertBefore(block, actions);
    else form.appendChild(block);
  }

  window.previewOverlay = function previewOverlay(){
    // quick preview in first card if any, else just ok
    const txt = ($('overlayText')?.value||'').trim();
    if(!txt) return alert('CompleteazƒÉ mai √Ænt√¢i "Text peste imagine".');
    alert('Textul va apƒÉrea peste imagine √Æn card dupƒÉ salvare.');
  };

  // ===== Boot =====
  function boot(){
    injectExtraFields();
    startStatsListener();

    const a = auth();
    if(a) {
      a.onAuthStateChanged(async (user)=>{
        const isAdmin = await computeIsAdmin(user);
        setAdminUI(isAdmin, user);
      });
    } else {
      setAdminUI(false, null);
    }
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body>
</html>
